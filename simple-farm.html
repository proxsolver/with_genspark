<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초롱이의 작은 정원 - EduPet Collection</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 한글 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .font-game {
            font-family: 'Noto Sans KR', 'Comic Sans MS', cursive;
            font-weight: 600;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, 
                #e8f5e8 0%, 
                #f0f9ff 50%, 
                #fef3c7 100%
            );
        }
        
        .plant-pot {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .plant-pot:hover {
            transform: scale(1.05);
        }
        
        .plant-growing {
            animation: gentleGrow 3s ease-in-out infinite alternate;
        }
        
        @keyframes gentleGrow {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }
        
        .plant-happy {
            animation: happyBounce 2s ease-in-out infinite;
        }
        
        @keyframes happyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .water-drop {
            animation: waterFall 1s ease-out;
        }
        
        @keyframes waterFall {
            0% { 
                transform: translateY(-50px) scale(0); 
                opacity: 0; 
            }
            50% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(20px) scale(0.5); 
                opacity: 0; 
            }
        }
        
        .love-heart {
            animation: loveFloat 2s ease-out;
        }
        
        @keyframes loveFloat {
            0% { 
                transform: translateY(0) scale(0); 
                opacity: 0; 
            }
            30% { 
                transform: translateY(-20px) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-60px) scale(0.5); 
                opacity: 0; 
            }
        }
        
        .speech-bubble {
            animation: bubblePop 0.5s ease-out;
        }
        
        @keyframes bubblePop {
            0% { transform: scale(0) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .modal-enter {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .protection-shield {
            animation: protectionFloat 3s ease-out;
        }
        
        @keyframes protectionFloat {
            0% { 
                transform: translate(-50%, 0) scale(0); 
                opacity: 0; 
            }
            20% { 
                transform: translate(-50%, -20px) scale(1.2); 
                opacity: 1; 
            }
            80% { 
                transform: translate(-50%, -30px) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -60px) scale(0.5); 
                opacity: 0; 
            }
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#4CAF50', 600: '#16a34a' },
                        secondary: { 500: '#FF9800', 600: '#ea580c' }
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Firebase 통합 스크립트 -->
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-auth.js"></script>
    <script defer src="firebase-integration.js"></script>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-2xl animate-spin">🌱</div>
            <div class="mt-2 font-bold text-gray-700">데이터를 불러오는 중...</div>
        </div>
    </div>

        <!-- 헤더 -->
        <div class="flex items-center justify-between mb-6">
            <button onclick="window.location.href='index.html'" class="flex items-center space-x-2 p-3 bg-white rounded-xl shadow-md hover:shadow-lg transition-all">
                <span>←</span>
                <span>홈으로</span>
            </button>
            
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-900 font-game">🌱 초롱이의 작은 정원</h1>
                <p class="text-sm text-gray-600">사랑으로 키우는 우리 식물친구들</p>
            </div>
            
            <div class="text-right space-y-2">
                <div class="flex items-center justify-end space-x-2 text-green-600 font-bold">
                    <span>💰</span>
                    <span id="money-count">500</span>
                    <span class="text-sm">원</span>
                </div>
                <div class="flex items-center justify-end space-x-2 text-blue-600 font-bold">
                    <span>💧</span>
                    <span id="water-count">5</span>
                </div>
                <div class="text-xs text-gray-500">돈 / 물방울</div>
            </div>
        </div>

        <!-- 안내 메시지 -->
        <div class="bg-white rounded-xl p-4 mb-6 shadow-md border-l-4 border-green-400">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">💚</span>
                <div>
                    <h3 class="font-bold text-gray-900">정원 가꾸기 안내</h3>
                    <p class="text-sm text-gray-600">
                        최대 2개의 식물을 키울 수 있어요. 물을 주면서 학습하고, 사랑으로 돌봐주세요! 🌿
                    </p>
                </div>
            </div>
        </div>

        <!-- 식물 화분 구역 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 화분 1 -->
            <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-green-200">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">🪴 화분 #1</h3>
                    <div class="text-xs text-gray-500" id="pot1-name">빈 화분</div>
                </div>
                
                <div class="relative">
                    <!-- 화분 영역 -->
                    <div class="plant-pot bg-amber-100 rounded-lg border-4 border-amber-300 h-48 flex flex-col items-center justify-end p-4 relative overflow-hidden" 
                         id="pot1" onclick="interactWithPlant(1)">
                        
                        <!-- 식물 표시 영역 -->
                        <div id="plant1-display" class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
                            <!-- 동적으로 생성 -->
                        </div>
                        
                        <!-- 빈 화분 표시 -->
                        <div id="empty-pot1" class="text-center">
                            <div class="text-4xl mb-2">🕳️</div>
                            <div class="text-sm text-gray-500">씨앗을 심어보세요</div>
                        </div>
                    </div>
                    
                    <!-- 상호작용 버튼들 -->
                    <div class="mt-4 flex justify-center space-x-2" id="pot1-actions">
                        <button onclick="plantSeed(1)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            🌰 씨앗 심기
                        </button>
                    </div>
                </div>
                
                <!-- 식물 정보 -->
                <div id="plant1-info" class="mt-4 text-center hidden">
                    <div class="text-sm text-gray-600" id="plant1-stage">단계: 씨앗</div>
                    <div class="text-sm text-gray-600" id="plant1-grade">등급: ⚪ 일반 • 일일 수익: 0원</div>
                    <div class="text-sm text-gray-600" id="plant1-care">돌봄 정도: 0%</div>
                    <div class="mt-2">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-500" 
                                 id="plant1-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 화분 2 -->
            <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-green-200">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">🪴 화분 #2</h3>
                    <div class="text-xs text-gray-500" id="pot2-name">빈 화분</div>
                </div>
                
                <div class="relative">
                    <!-- 화분 영역 -->
                    <div class="plant-pot bg-amber-100 rounded-lg border-4 border-amber-300 h-48 flex flex-col items-center justify-end p-4 relative overflow-hidden" 
                         id="pot2" onclick="interactWithPlant(2)">
                        
                        <!-- 식물 표시 영역 -->
                        <div id="plant2-display" class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
                            <!-- 동적으로 생성 -->
                        </div>
                        
                        <!-- 빈 화분 표시 -->
                        <div id="empty-pot2" class="text-center">
                            <div class="text-4xl mb-2">🕳️</div>
                            <div class="text-sm text-gray-500">씨앗을 심어보세요</div>
                        </div>
                    </div>
                    
                    <!-- 상호작용 버튼들 -->
                    <div class="mt-4 flex justify-center space-x-2" id="pot2-actions">
                        <button onclick="plantSeed(2)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            🌰 씨앗 심기
                        </button>
                    </div>
                </div>
                
                <!-- 식물 정보 -->
                <div id="plant2-info" class="mt-4 text-center hidden">
                    <div class="text-sm text-gray-600" id="plant2-stage">단계: 씨앗</div>
                    <div class="text-sm text-gray-600" id="plant2-grade">등급: ⚪ 일반 • 일일 수익: 0원</div>
                    <div class="text-sm text-gray-600" id="plant2-care">돌봄 정도: 0%</div>
                    <div class="mt-2">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-500" 
                                 id="plant2-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 물주기 안내 -->
        <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-200">
            <div class="text-center">
                <h3 class="font-bold text-blue-900 mb-2">💧 물주기 방법</h3>
                <p class="text-sm text-blue-700 mb-3">
                    식물을 클릭하면 물을 주면서 학습할 수 있어요!<br>
                    문제의 정답과 해설을 보면서 식물과 함께 배워보세요.
                </p>
                <div class="text-xs text-blue-600">
                    💡 팁: 자주 물을 줄수록 더 예쁜 식물로 자라납니다!
                </div>
            </div>
        </div>
    </div>

    <!-- 씨앗 선택 모달 -->
    <div id="seed-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full modal-enter">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">🌰 씨앗 구매하기</h3>
                <button onclick="closeSeedModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center space-x-2 text-sm text-yellow-800">
                    <span>ℹ️</span>
                    <div>
                        <div class="font-semibold">농장 경제 시스템</div>
                        <div>등급별 성장기간: 일반(3일) • 고급(7일) • 에픽(14일) • 전설(28일) • 1일 미관리 시 등급 하락</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <!-- 일반 등급 (무료) -->
                <button onclick="selectSeed('common', 'mystery')" class="w-full p-4 text-left rounded-lg border-2 border-gray-300 hover:bg-gray-50 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">⚪</span>
                            <div>
                                <div class="font-bold text-gray-800">일반 씨앗</div>
                                <div class="text-sm text-gray-600">3일 성장 • 수확 100원 • 등급하락 없음</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">무료</div>
                        </div>
                    </div>
                </button>
                
                <!-- 고급 등급 -->
                <button onclick="selectSeed('advanced', 'mystery')" class="w-full p-4 text-left rounded-lg border-2 border-blue-300 hover:bg-blue-50 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">🔵</span>
                            <div>
                                <div class="font-bold text-blue-800">고급 씨앗</div>
                                <div class="text-sm text-blue-600">7일 성장 • 수확 1,000원 • 1일 빠지면 일반으로</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-600">100원</div>
                        </div>
                    </div>
                </button>
                
                <!-- 에픽 등급 -->
                <button onclick="selectSeed('epic', 'mystery')" class="w-full p-4 text-left rounded-lg border-2 border-purple-300 hover:bg-purple-50 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">🟣</span>
                            <div>
                                <div class="font-bold text-purple-800">에픽 씨앗</div>
                                <div class="text-sm text-purple-600">14일 성장 • 수확 3,000원 • 1일 빠지면 고급으로</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-purple-600">1,000원</div>
                        </div>
                    </div>
                </button>
                
                <!-- 전설 등급 -->
                <button onclick="selectSeed('legendary', 'mystery')" class="w-full p-4 text-left rounded-lg border-2 border-yellow-300 hover:bg-yellow-50 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">🟡</span>
                            <div>
                                <div class="font-bold text-yellow-800">전설 씨앗</div>
                                <div class="text-sm text-yellow-600">28일 성장 • 수확 10,000원 • 1일 빠지면 에픽으로</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-yellow-600">3,000원</div>
                        </div>
                    </div>
                </button>
            </div>
            
            <div class="mt-4 text-center">
                <div class="text-sm text-gray-500">
                    보유 금액: <span class="font-bold text-green-600" id="modal-money-display">500원</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 물주기 학습 모달 -->
    <div id="watering-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full modal-enter">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2" id="plant-character">🌱</div>
                <h3 class="text-lg font-bold" id="plant-speech">안녕! 나에게 물을 줘!</h3>
            </div>
            
            <!-- 학습 내용 -->
            <div class="bg-blue-50 rounded-lg p-4 mb-4" id="learning-content">
                <div class="font-bold text-blue-900 mb-2" id="question-title">오늘의 학습</div>
                <div class="text-sm text-blue-800 mb-3" id="question-text">
                    문제: 다음 중 'apple'의 뜻은?
                </div>
                <div class="text-sm text-green-800 mb-2" id="answer-text">
                    <strong>정답:</strong> 사과
                </div>
                <div class="text-sm text-gray-700" id="explanation-text">
                    <strong>해설:</strong> Apple은 사과를 의미합니다. 영어에서 가장 기본적인 과일 단어 중 하나예요.
                </div>
            </div>
            
            <div class="text-center mb-4">
                <button onclick="giveWater()" class="px-8 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all">
                    💧 물 주기
                </button>
            </div>
            
            <div class="text-center">
                <button onclick="closeWateringModal()" class="text-gray-500 text-sm hover:text-gray-700">
                    나중에 하기
                </button>
            </div>
        </div>
    </div>

    <!-- 식물 대화 팝업 -->
    <div id="plant-speech-popup" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-white rounded-xl shadow-lg border-2 border-green-300 p-4 z-40">
        <div class="speech-bubble text-center">
            <div class="text-sm font-medium text-gray-800" id="popup-text">안녕하세요!</div>
            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                <div class="w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-green-300"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 게임 상태
        let gameState = {
            water: 5,
            money: 500, // 초기 돈 500원
            plants: {
                1: null,
                2: null
            }
        };

        let currentPot = null;
        let selectedSeedType = null;

        // 등급별 씨앗 데이터 - 새로운 경제 시스템
        const seedGrades = {
            common: {
                name: '일반',
                price: 0,
                color: 'gray',
                icon: '⚪',
                growthDays: 3,
                harvestAmount: 100,
                canDowngrade: false,
                description: '3일 성장 • 수확 100원'
            },
            advanced: {
                name: '고급',
                price: 100,
                color: 'blue', 
                icon: '🔵',
                growthDays: 7,
                harvestAmount: 1000,
                canDowngrade: true,
                downgradeTo: 'common',
                description: '7일 성장 • 수확 1,000원'
            },
            epic: {
                name: '에픽',
                price: 1000,
                color: 'purple',
                icon: '🟣',
                growthDays: 14,
                harvestAmount: 3000,
                canDowngrade: true,
                downgradeTo: 'advanced',
                description: '14일 성장 • 수확 3,000원'
            },
            legendary: {
                name: '전설',
                price: 3000,
                color: 'yellow',
                icon: '🟡',
                growthDays: 28,
                harvestAmount: 10000,
                canDowngrade: true,
                downgradeTo: 'epic',
                description: '28일 성장 • 수확 10,000원'
            }
        };

        // 식물 타입별 데이터  
        const plantTypes = {
            mystery: {
                name: '신비한 식물',
                stages: [
                    { icon: '🌰', name: '씨앗', speech: '안녕! 나는 신비한 씨앗이야!' },
                    { icon: '🌱', name: '새싹', speech: '물을 줘서 고마워! 쑥쑥 자라고 있어!' },
                    { icon: '🌿', name: '줄기', speech: '이제 곧 뭔가 특별한 게 생길 것 같아!' }
                ],
                possibleResults: ['🌸', '🌺', '🌻', '🌷', '🌹', '🪷']
            },
            flower: {
                name: '꽃식물', 
                stages: [
                    { icon: '🌰', name: '꽃씨', speech: '안녕! 나는 예쁜 꽃이 될 씨앗이야!' },
                    { icon: '🌱', name: '꽃새싹', speech: '물을 마시니까 기분이 좋아!' },
                    { icon: '🌿', name: '꽃줄기', speech: '곧 예쁜 꽃이 필 거야!' }
                ],
                possibleResults: ['🌸', '🌺', '🌻', '🌷', '🌹']
            },
            fruit: {
                name: '과일나무',
                stages: [
                    { icon: '🌰', name: '과일씨', speech: '안녕! 나는 맛있는 과일이 될 씨앗이야!' },
                    { icon: '🌱', name: '과일새싹', speech: '물을 주니까 힘이 나!' },
                    { icon: '🌿', name: '과일줄기', speech: '맛있는 과일을 만들어줄게!' }
                ],
                possibleResults: ['🍎', '🍊', '🍌', '🍓', '🍑', '🥝']
            }
        };

        // 학습 문제 샘플 (실제로는 API에서 가져올 것)
        const sampleQuestions = [
            {
                question: "다음 중 'apple'의 뜻은?",
                answer: "사과",
                explanation: "Apple은 사과를 의미합니다. 영어에서 가장 기본적인 과일 단어 중 하나예요."
            },
            {
                question: "'cat'의 뜻은?",
                answer: "고양이", 
                explanation: "Cat은 고양이를 의미합니다. 귀여운 동물이죠!"
            },
            {
                question: "5 + 3 = ?",
                answer: "8",
                explanation: "5와 3을 더하면 8입니다. 간단한 덧셈 문제예요."
            }
        ];

        // 초기화
        async function initializeGarden() {
            await loadGameState();
            updateDisplay();
        }

        // 씨앗 심기
        function plantSeed(potNumber) {
            if (gameState.plants[potNumber]) {
                showPlantSpeech(`화분 ${potNumber}에 이미 식물이 있어요!`);
                return;
            }
            
            currentPot = potNumber;
            
            // 모달에 현재 돈 표시 업데이트
            document.getElementById('modal-money-display').textContent = `${gameState.money}원`;
            document.getElementById('seed-modal').classList.remove('hidden');
        }

        function selectSeed(grade, type) {
            const seedInfo = seedGrades[grade];
            
            // 돈이 부족한지 확인
            if (gameState.money < seedInfo.price) {
                alert(`돈이 부족해요! ${seedInfo.price}원이 필요하지만 ${gameState.money}원만 가지고 있어요.`);
                return;
            }
            
            // 돈 차감
            gameState.money -= seedInfo.price;
            
            selectedSeedType = type;
            
            // 새로운 식물 생성 (새로운 경제 시스템)
            gameState.plants[currentPot] = {
                type: type,
                grade: grade,
                stage: 0,
                care: 0,
                plantedAt: Date.now(),
                lastWatered: 0,
                lastStudied: Date.now(), // 마지막 학습 시간
                finalResult: null,
                growthDays: seedInfo.growthDays,
                harvestAmount: seedInfo.harvestAmount,
                isFullyGrown: false,
                isHarvested: false
            };
            
            closeSeedModal();
            updatePlantDisplay(currentPot);
            updateDisplay();
            
            const message = seedInfo.price > 0 
                ? `${seedInfo.name} 등급 씨앗을 ${seedInfo.price}원에 구매했어요! ${plantTypes[type].stages[0].speech}`
                : `${plantTypes[type].stages[0].speech}`;
            
            showPlantSpeech(message);
            
            saveGameState();
        }

        function closeSeedModal() {
            document.getElementById('seed-modal').classList.add('hidden');
            currentPot = null;
            selectedSeedType = null;
        }

        // 식물과 상호작용
        function interactWithPlant(potNumber) {
            const plant = gameState.plants[potNumber];
            
            if (!plant) {
                plantSeed(potNumber);
                return;
            }

            if (gameState.water <= 0) {
                showPlantSpeech('물이 부족해요! 학습을 완료하면 물을 얻을 수 있어요.');
                return;
            }

            // 물주기 모달 열기
            openWateringModal(potNumber);
        }

        // 물주기 모달 열기
        function openWateringModal(potNumber) {
            const plant = gameState.plants[potNumber];
            const plantInfo = plantTypes[plant.type];
            const currentStage = plantInfo.stages[plant.stage];
            
            // 랜덤 학습 문제 선택
            const question = sampleQuestions[Math.floor(Math.random() * sampleQuestions.length)];
            
            document.getElementById('plant-character').textContent = currentStage.icon;
            document.getElementById('plant-speech').textContent = currentStage.speech;
            document.getElementById('question-text').textContent = question.question;
            document.getElementById('answer-text').innerHTML = `<strong>정답:</strong> ${question.answer}`;
            document.getElementById('explanation-text').innerHTML = `<strong>해설:</strong> ${question.explanation}`;
            
            currentPot = potNumber;
            document.getElementById('watering-modal').classList.remove('hidden');
        }

        function closeWateringModal() {
            document.getElementById('watering-modal').classList.add('hidden');
            currentPot = null;
        }

        // 물 주기
        function giveWater() {
            if (gameState.water <= 0 || !currentPot) return;
            
            const plant = gameState.plants[currentPot];
            const potElement = document.getElementById(`pot${currentPot}`);
            
            // 물 소모
            gameState.water--;
            
            // 식물 돌봄 증가
            plant.care += 20;
            plant.lastWatered = Date.now();
            
            // 물방울 애니메이션
            showWaterAnimation(potElement);
            
            // 하트 애니메이션
            setTimeout(() => {
                showLoveAnimation(potElement);
            }, 500);
            
            // 성장 체크
            checkPlantGrowth(currentPot);
            
            closeWateringModal();
            updateDisplay();
            saveGameState();
            
            showPlantSpeech('고마워! 물이 정말 시원해!');
        }

        // 식물 성장 체크 - 새로운 등급별 성장기간 시스템
        function checkPlantGrowth(potNumber) {
            const plant = gameState.plants[potNumber];
            if (!plant || plant.isHarvested) return;
            
            const plantInfo = plantTypes[plant.type];
            const gradeInfo = seedGrades[plant.grade];
            
            // 경과 일수 계산 (테스트용으로 30배 가속)
            const daysPassed = (Date.now() - plant.plantedAt) / (1000 * 60 * 60 * 24 / 30);
            
            // 성장 단계 결정 (등급별 성장기간에 따라)
            const growthProgress = Math.min(daysPassed / gradeInfo.growthDays, 1);
            const targetStage = Math.floor(growthProgress * (plantInfo.stages.length - 1));
            
            if (targetStage > plant.stage && plant.care >= 20) { // 최소 돌봄 필요
                plant.stage = targetStage;
                showPlantSpeech(`와! 한 단계 더 자랐어요! 이제 ${plantInfo.stages[plant.stage].name}이에요!`);
            }
            
            // 완전 성장 체크
            if (daysPassed >= gradeInfo.growthDays && !plant.isFullyGrown) {
                plant.isFullyGrown = true;
                plant.stage = plantInfo.stages.length - 1;
                determineFinalResult(potNumber);
                
                // 수확 가능 알림
                setTimeout(() => {
                    showPlantSpeech(`🎉 ${gradeInfo.growthDays}일간의 성장이 완료되었어요! 이제 수확할 수 있습니다! 💰${gradeInfo.harvestAmount}원을 받을 수 있어요!`);
                }, 1000);
            }
            
            updatePlantDisplay(potNumber);
        }

        // 최종 결과 결정
        function determineFinalResult(potNumber) {
            const plant = gameState.plants[potNumber];
            const plantInfo = plantTypes[plant.type];
            
            // 돌봄 정도에 따라 더 좋은 결과
            let resultIndex = Math.floor(Math.random() * plantInfo.possibleResults.length);
            
            if (plant.care >= 80) {
                // 80% 이상 돌봄: 더 좋은 결과 확률 증가
                resultIndex = Math.min(resultIndex + 1, plantInfo.possibleResults.length - 1);
            }
            
            plant.finalResult = plantInfo.possibleResults[resultIndex];
            
            setTimeout(() => {
                showPlantSpeech(`짜잔! 내가 바로 ${plant.finalResult}이야! 정성껏 키워줘서 고마워!`);
            }, 1000);
        }

        // 디스플레이 업데이트
        function updateDisplay() {
            document.getElementById('water-count').textContent = gameState.water;
            document.getElementById('money-count').textContent = gameState.money;
            
            // 각 화분 업데이트
            [1, 2].forEach(potNumber => {
                updatePlantDisplay(potNumber);
            });
        }

        function updatePlantDisplay(potNumber) {
            const plant = gameState.plants[potNumber];
            const emptyElement = document.getElementById(`empty-pot${potNumber}`);
            const plantDisplay = document.getElementById(`plant${potNumber}-display`);
            const plantInfo = document.getElementById(`plant${potNumber}-info`);
            const potName = document.getElementById(`pot${potNumber}-name`);
            const actions = document.getElementById(`pot${potNumber}-actions`);
            
            if (!plant) {
                // 빈 화분
                emptyElement.classList.remove('hidden');
                plantDisplay.innerHTML = '';
                plantInfo.classList.add('hidden');
                potName.textContent = '빈 화분';
                actions.innerHTML = `
                    <button onclick="plantSeed(${potNumber})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                        🌰 씨앗 심기
                    </button>
                `;
            } else {
                // 식물이 있는 화분
                emptyElement.classList.add('hidden');
                plantInfo.classList.remove('hidden');
                
                const plantTypeInfo = plantTypes[plant.type];
                const currentStage = plantTypeInfo.stages[plant.stage];
                const gradeInfo = seedGrades[plant.grade];
                
                potName.innerHTML = `${gradeInfo.icon} ${gradeInfo.name} ${plantTypeInfo.name}`;
                
                let displayIcon = currentStage.icon;
                if (plant.finalResult && plant.stage === plantTypeInfo.stages.length - 1) {
                    displayIcon = plant.finalResult;
                }
                
                plantDisplay.innerHTML = `
                    <div class="text-6xl plant-growing ${plant.care > 50 ? 'plant-happy' : ''}">${displayIcon}</div>
                `;
                
                document.getElementById(`plant${potNumber}-stage`).textContent = `단계: ${currentStage.name}`;
                document.getElementById(`plant${potNumber}-care`).textContent = `돌봄 정도: ${Math.min(plant.care, 100)}%`;
                document.getElementById(`plant${potNumber}-progress`).style.width = `${Math.min(plant.care, 100)}%`;
                
                // 등급 및 성장 정보 표시
                const gradeDisplay = document.getElementById(`plant${potNumber}-grade`);
                if (gradeDisplay) {
                    const daysPassed = Math.floor((Date.now() - plant.plantedAt) / (1000 * 60 * 60 * 24 / 30)); // 테스트용 30배 가속
                    const gradeInfo = seedGrades[plant.grade];
                    
                    let gradeText = '';
                    if (plant.isFullyGrown && !plant.isHarvested) {
                        gradeText = `${gradeInfo.icon} ${gradeInfo.name} • 🎉 수확 가능! ${gradeInfo.harvestAmount}원`;
                    } else if (plant.isHarvested) {
                        gradeText = `${gradeInfo.icon} ${gradeInfo.name} • ✅ 수확 완료 (${gradeInfo.harvestAmount}원 획득)`;
                    } else {
                        gradeText = `${gradeInfo.icon} ${gradeInfo.name} • 성장 ${daysPassed}/${gradeInfo.growthDays}일`;
                    }
                    
                    // 보호 상태 표시
                    if (isPlantProtected(potNumber)) {
                        const protectedDays = Math.ceil((plant.protectedUntil - Date.now()) / (1000 * 60 * 60 * 24));
                        gradeText += `<br><div class="text-sm text-purple-600 mt-1">🛡️ ${plant.protectedBy.emoji} ${plant.protectedBy.name}이 보호 중 (${protectedDays}일 남음)</div>`;
                    }
                    
                    gradeDisplay.innerHTML = gradeText;
                }
                
                if (plant.isFullyGrown && !plant.isHarvested) {
                    // 수확 가능
                    actions.innerHTML = `
                        <button onclick="harvestPlant(${potNumber})" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600 transition-all">
                            🌾 수확하기 (${seedGrades[plant.grade].harvestAmount}원)
                        </button>
                    `;
                } else if (plant.isHarvested) {
                    // 수확 완료
                    actions.innerHTML = `
                        <button onclick="removePlant(${potNumber})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            🌱 새 씨앗 심기
                        </button>
                    `;
                } else {
                    // 성장 중
                    let actionsHtml = `
                        <button onclick="interactWithPlant(${potNumber})" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-all mb-2 w-full">
                            💧 물주기
                        </button>
                    `;
                    
                    // 보호되지 않은 식물에만 보호 버튼 표시
                    if (!isPlantProtected(potNumber)) {
                        actionsHtml += `
                            <button onclick="showProtectionDialog(${potNumber})" class="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600 transition-all w-full">
                                🛡️ 동물 보호
                            </button>
                        `;
                    } else {
                        actionsHtml += `
                            <div class="px-3 py-2 bg-purple-100 text-purple-600 rounded-lg text-sm text-center w-full">
                                🛡️ 보호 중
                            </div>
                        `;
                    }
                    
                    actions.innerHTML = actionsHtml;
                }
            }
        }

        // 애니메이션 함수들
        function showWaterAnimation(potElement) {
            const waterDrop = document.createElement('div');
            waterDrop.innerHTML = '💧';
            waterDrop.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 text-2xl water-drop pointer-events-none';
            potElement.appendChild(waterDrop);
            
            setTimeout(() => {
                potElement.removeChild(waterDrop);
            }, 1000);
        }

        function showLoveAnimation(potElement) {
            const heart = document.createElement('div');
            heart.innerHTML = '💚';
            heart.className = 'absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xl love-heart pointer-events-none';
            potElement.appendChild(heart);
            
            setTimeout(() => {
                potElement.removeChild(heart);
            }, 2000);
        }

        // 동물 보호 시스템
        function getProtectiveAnimals() {
            const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
            const collection = animalCollection.collection || {};
            
            const protectiveAnimals = [];
            for (const [animalId, animalData] of Object.entries(collection)) {
                if (animalData.tier === 'epic' || animalData.tier === 'legendary') {
                    protectiveAnimals.push({
                        ...animalData,
                        id: animalId
                    });
                }
            }
            return protectiveAnimals;
        }

        function activateProtection(potNumber, animalId) {
            const plant = gameState.plants[potNumber];
            if (!plant) return false;

            const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
            const animal = animalCollection.collection[animalId];
            
            if (!animal || (animal.tier !== 'epic' && animal.tier !== 'legendary') || animal.count <= 0) {
                alert('이 동물은 보호 능력이 없거나 보유하고 있지 않습니다.');
                return false;
            }

            // 동물 희생 (수량 감소)
            animal.count--;
            if (animal.count <= 0) {
                delete animalCollection.collection[animalId];
                // 명예의 전당에 추가
                if (!animalCollection.hallOfFame) animalCollection.hallOfFame = [];
                animalCollection.hallOfFame.push({
                    ...animal,
                    id: animalId,
                    sacrificedAt: Date.now(),
                    protectedPlant: plant.type,
                    potNumber: potNumber
                });
            }

            // 식물에 보호 상태 추가
            plant.protectedUntil = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7일 보호
            plant.protectedBy = {
                id: animalId,
                name: animal.name,
                emoji: animal.emoji,
                tier: animal.tier
            };

            localStorage.setItem('animalCollection', JSON.stringify(animalCollection));
            saveGameState();

            showProtectionAnimation(potNumber, animal);
            alert(`${animal.emoji} ${animal.name}이(가) ${plant.protectedBy ? plant.protectedBy.name : '식물'}을 7일간 보호합니다!\n이 식물은 등급이 하락하지 않습니다.`);
            
            updatePlantDisplay(potNumber);
            return true;
        }

        function showProtectionAnimation(potNumber, animal) {
            const potElement = document.querySelector(`#pot${potNumber}-container`);
            if (!potElement) return;

            const shield = document.createElement('div');
            shield.innerHTML = `🛡️${animal.emoji}`;
            shield.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 text-2xl protection-shield pointer-events-none';
            potElement.appendChild(shield);
            
            setTimeout(() => {
                if (potElement.contains(shield)) {
                    potElement.removeChild(shield);
                }
            }, 3000);
        }

        function isPlantProtected(potNumber) {
            const plant = gameState.plants[potNumber];
            return plant && plant.protectedUntil && Date.now() < plant.protectedUntil;
        }

        function showProtectionDialog(potNumber) {
            const protectiveAnimals = getProtectiveAnimals();
            if (protectiveAnimals.length === 0) {
                alert('보호 능력을 가진 동물이 없습니다.\n에픽 또는 전설 등급의 동물을 수집하세요!');
                return;
            }

            const plant = gameState.plants[potNumber];
            const plantName = plant ? `${seedGrades[plant.grade].name} ${plantTypes[plant.type].name}` : '식물';
            
            let dialogHtml = `
                <div id="protection-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-sm mx-4">
                        <h3 class="text-lg font-bold mb-4 text-center">🛡️ 식물 보호</h3>
                        <p class="text-sm text-gray-600 mb-4 text-center">${plantName}을(를) 보호할 동물을 선택하세요.<br><span class="text-red-500">선택한 동물은 희생됩니다.</span></p>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
            `;
            
            protectiveAnimals.forEach(animal => {
                const tierColor = animal.tier === 'legendary' ? 'bg-yellow-100 border-yellow-500' : 'bg-purple-100 border-purple-500';
                dialogHtml += `
                    <button onclick="confirmProtection('${potNumber}', '${animal.id}')" 
                            class="w-full p-3 ${tierColor} border-2 rounded-lg text-left hover:scale-105 transition-transform">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">${animal.emoji}</span>
                                <div>
                                    <div class="font-bold">${animal.name}</div>
                                    <div class="text-xs text-gray-600">${animal.tier === 'legendary' ? '전설' : '에픽'} • 파워 ${animal.power}</div>
                                </div>
                            </div>
                            <div class="text-sm font-bold">${animal.count}마리</div>
                        </div>
                    </button>
                `;
            });
            
            dialogHtml += `
                        </div>
                        <button onclick="closeProtectionDialog()" 
                                class="w-full mt-4 p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            취소
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
        }

        function confirmProtection(potNumber, animalId) {
            const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
            const animal = animalCollection.collection[animalId];
            
            if (confirm(`정말로 ${animal.emoji} ${animal.name}을(를) 희생시켜 식물을 보호하시겠습니까?\n\n이 동물은 7일간 식물을 보호한 후 명예의 전당에 기록됩니다.`)) {
                closeProtectionDialog();
                activateProtection(potNumber, animalId);
            }
        }

        function closeProtectionDialog() {
            const dialog = document.getElementById('protection-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function showPlantSpeech(message) {
            const popup = document.getElementById('plant-speech-popup');
            document.getElementById('popup-text').textContent = message;
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
        }

        // 게임 상태 저장/로드
        async function saveGameState() {
            gameState.lastUpdated = Date.now();
            localStorage.setItem('simpleFarmState', JSON.stringify(gameState));
            
            if (typeof eduPetFirebaseIntegration !== 'undefined') {
                await eduPetFirebaseIntegration.saveFarmState(gameState);
            }
        }

        async function loadGameState() {
            const localState = JSON.parse(localStorage.getItem('simpleFarmState'));
            const serverState = await eduPetFirebaseIntegration.loadFarmState();

            if (serverState && (!localState || serverState.lastUpdated >= localState.lastUpdated)) {
                // 서버 데이터가 최신이거나 로컬 데이터가 없을 때
                console.log('서버 데이터로 상태를 초기화합니다.');
                gameState = { ...gameState, ...serverState };
            } else if (localState) {
                // 로컬 데이터가 최신일 때
                console.log('로컬 데이터로 상태를 초기화합니다.');
                gameState = { ...gameState, ...localState };
            }
            
            // 마이그레이션 로직은 유지
            [1, 2].forEach(potNumber => {
                const plant = gameState.plants[potNumber];
                if (plant) {
                    if (!plant.grade) plant.grade = 'common';
                    const gradeInfo = seedGrades[plant.grade];
                    if (!plant.growthDays) plant.growthDays = gradeInfo.growthDays;
                    if (!plant.harvestAmount) plant.harvestAmount = gradeInfo.harvestAmount;
                    if (plant.isFullyGrown === undefined) plant.isFullyGrown = false;
                    if (plant.isHarvested === undefined) plant.isHarvested = false;
                    if (!plant.lastStudied) plant.lastStudied = plant.plantedAt;
                    delete plant.dailyIncome;
                }
            });

            if (gameState.money === undefined) gameState.money = 500;
            delete gameState.monthlyEarnings;
            delete gameState.lastReset;

            // 최종 병합된 상태를 다시 저장하여 동기화
            await saveGameState(); 
        }


        
        // 등급 하락 체크 (매일 25분 학습 미완료 시)
        function checkPlantDowngrade() {
            [1, 2].forEach(potNumber => {
                const plant = gameState.plants[potNumber];
                if (!plant || plant.isHarvested) return;
                
                // 보호 중인 식물은 등급 하락 없음
                if (isPlantProtected(potNumber)) {
                    return;
                }
                
                const lastStudied = plant.lastStudied || plant.plantedAt;
                const daysSinceStudy = (Date.now() - lastStudied) / (1000 * 60 * 60 * 24 / 30); // 테스트용 30배 가속
                
                // 1일 이상 학습 안함 - 등급 하락
                if (daysSinceStudy >= 1) {
                    const currentGradeInfo = seedGrades[plant.grade];
                    
                    // 일반 등급이 아니고 하락 가능한 경우
                    if (currentGradeInfo.canDowngrade && currentGradeInfo.downgradeTo) {
                        const newGrade = currentGradeInfo.downgradeTo;
                        const newGradeInfo = seedGrades[newGrade];
                        
                        plant.grade = newGrade;
                        plant.growthDays = newGradeInfo.growthDays;
                        plant.harvestAmount = newGradeInfo.harvestAmount;
                        
                        // 성장기간이 줄어들었으므로 성장 상태 재계산
                        const daysPassed = (Date.now() - plant.plantedAt) / (1000 * 60 * 60 * 24 / 30); // 테스트용 30배 가속
                        if (daysPassed >= newGradeInfo.growthDays) {
                            plant.isFullyGrown = true;
                        }
                        
                        showPlantSpeech(`${potNumber}번 화분의 식물이 관리 부족으로 ${newGradeInfo.name} 등급으로 하락했어요!`);
                        updatePlantDisplay(potNumber);
                        
                        // 다시 학습 시간 업데이트 (연속 하락 방지)
                        plant.lastStudied = Date.now();
                    } else if (plant.grade === 'common') {
                        // 일반 등급은 성장만 멈춤
                        showPlantSpeech(`${potNumber}번 화분의 일반 식물이 성장을 멈췄어요! 학습을 완료해야 다시 자랍니다.`);
                        plant.lastStudied = Date.now(); // 알림 후 시간 업데이트
                    }
                }
            });
        }
        
        // 학습 완료 시 호출되는 함수 (25분 학습 완료)
        function onStudyComplete() {
            // 모든 식물의 lastStudied 업데이트
            [1, 2].forEach(potNumber => {
                const plant = gameState.plants[potNumber];
                if (plant) {
                    plant.lastStudied = Date.now();
                }
            });
            
            saveGameState();
        }
        
        // 수확 기능
        function harvestPlant(potNumber) {
            const plant = gameState.plants[potNumber];
            if (!plant || !plant.isFullyGrown || plant.isHarvested) return;
            
            const gradeInfo = seedGrades[plant.grade];
            
            // 돈 획득
            gameState.money += gradeInfo.harvestAmount;
            plant.isHarvested = true;
            
            // 수확 애니메이션 및 메시지
            const potElement = document.getElementById(`pot${potNumber}`);
            showHarvestAnimation(potElement, gradeInfo.harvestAmount);
            
            showPlantSpeech(`🎉 수확 완료! ${gradeInfo.harvestAmount}원을 획득했어요! 이제 새로운 씨앗을 심을 수 있습니다.`);
            
            updateDisplay();
            saveGameState();
        }
        
        // 식물 제거 (새 씨앗 심기 위해)
        function removePlant(potNumber) {
            gameState.plants[potNumber] = null;
            updateDisplay();
            saveGameState();
            showPlantSpeech('화분이 비워졌어요! 새로운 씨앗을 심어보세요.');
        }
        
        // 수확 애니메이션
        function showHarvestAnimation(potElement, amount) {
            const coin = document.createElement('div');
            coin.innerHTML = `💰+${amount}원`;
            coin.className = 'absolute bottom-8 left-1/2 transform -translate-x-1/2 text-lg font-bold text-yellow-600 love-heart pointer-events-none';
            potElement.appendChild(coin);
            
            setTimeout(() => {
                if (potElement.contains(coin)) {
                    potElement.removeChild(coin);
                }
            }, 3000);
        }
        
        // 물 충전 (학습 완료 시 호출될 함수)
        function addWater(amount = 3) {
            gameState.water += amount;
            onStudyComplete(); // 학습 완료 처리
            updateDisplay();
            saveGameState();
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            try {
                // eduPetAuth와 eduPetFirebaseIntegration가 정의될 때까지 기다림
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // 인증 상태 리스너를 먼저 설정합니다.
                eduPetAuth.addAuthStateListener(async (state, userData) => {
                    if (state === 'signed_in') {
                        console.log('Auth state is signed in. Initializing garden.');
                        await initializeGarden();
                        loadingOverlay.classList.add('hidden');
                    } else {
                        // 로그인되지 않은 상태 처리
                        console.log('User is not signed in. Running in offline mode.');
                        await initializeGarden(); // 로컬 데이터로만 실행
                        loadingOverlay.classList.add('hidden');
                    }
                });

                // Firebase 통합 기능을 초기화합니다. (이 과정에서 익명 로그인이 트리거됩니다)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration process started.');

            } catch (error) {
                console.error('초기화 중 오류 발생:', error);
                // 오프라인 모드로 계속 진행
                await initializeGarden();
                loadingOverlay.classList.add('hidden');
            }

            // 주기적인 작업들은 여기에서 계속 실행합니다.
            // 초기 등급 하락 체크
            checkPlantDowngrade();

            // 10초마다 식물 상태 체크
            setInterval(() => {
                [1, 2].forEach(potNumber => {
                    if (gameState.plants[potNumber]) {
                        checkPlantGrowth(potNumber);
                    }
                });
            }, 10000);

            // 1시간마다 등급 하락 체크
            setInterval(() => {
                checkPlantDowngrade();
            }, 60 * 60 * 1000);
        });

        // 외부에서 호출할 수 있는 함수들
        window.simpleFarm = {
            addWater: addWater,
            getGameState: () => gameState
        };
    </script>
</body>
</html>