<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식물 정원 - EduPet Collection</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 한글 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f9ff 50%, #fef3c7 100%);
        }

        .plant-pot {
            transition: all 0.3s ease;
        }

        .plant-pot:hover {
            transform: scale(1.02);
        }

        .plant-growing {
            animation: gentleGrow 3s ease-in-out infinite alternate;
        }

        @keyframes gentleGrow {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .water-drop {
            animation: waterFall 1s ease-out;
        }

        @keyframes waterFall {
            0% { transform: translateY(-50px) scale(0); opacity: 0; }
            50% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(20px) scale(0.5); opacity: 0; }
        }

        .love-heart {
            animation: loveFloat 2s ease-out forwards;
        }

        @keyframes loveFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        .plant-happy {
            animation: happyBounce 0.5s ease-in-out 3;
        }

        @keyframes happyBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .plant-mature {
            animation: sparkle 1.5s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); }
        }

        /* 축하 모달 애니메이션 */
        .celebration-modal {
            animation: modalZoomIn 0.5s ease-out;
        }

        @keyframes modalZoomIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* 반짝이 입자 애니메이션 */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }

        /* 빛나는 효과 */
        .glow-pulse {
            animation: glowPulse 1s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1)); }
        }

        /* 스타 폭발 */
        .star-burst {
            animation: starBurst 1s ease-out forwards;
        }

        @keyframes starBurst {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(3) rotate(180deg); opacity: 0; }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- 필수 스크립트 -->
    <script src="firebase-config.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="plant-system.js"></script>
    <script src="daily-reset.js"></script>
    <script src="weakness-learning.js"></script>
</head>
<body class="gradient-bg min-h-screen p-4">
    <div class="container mx-auto max-w-6xl">
        <!-- 헤더 -->
        <div class="flex items-center justify-between mb-6 bg-white rounded-xl p-4 shadow-md">
            <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                ← 홈으로
            </button>

            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-900">🌱 식물 정원</h1>
                <p class="text-sm text-gray-600">학습으로 키우는 나의 식물</p>
            </div>

            <div class="text-right flex items-center space-x-4">
                <div>
                    <div class="text-sm text-gray-600">일일 진행률</div>
                    <div class="font-bold text-blue-600" id="daily-progress">0/9 과목</div>
                </div>
                <button onclick="showResetMenu()" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm border border-red-200">
                    ⚙️
                </button>
            </div>
        </div>

        <!-- 보상 현황 -->
        <div class="bg-white rounded-xl p-4 shadow-md mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm text-gray-600">🎫 성장권</div>
                    <div class="text-2xl font-bold text-green-600" id="growth-tickets">0</div>
                </div>
                <button onclick="showTicketDetails()" class="text-blue-500 text-sm">상세</button>
            </div>
        </div>

        <!-- 다음 보상 안내 -->
        <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-200">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">🎯</span>
                <div>
                    <h3 class="font-bold text-blue-900">다음 보상</h3>
                    <p class="text-sm text-blue-700" id="next-reward">3과목 달성 시: 성장권 1개</p>
                </div>
            </div>
        </div>

        <!-- 식물 화분 영역 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 화분 1 -->
            <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-green-200">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">🪴 화분 #1</h3>
                    <div class="text-xs text-gray-500" id="pot1-name">빈 화분</div>
                </div>

                <div class="relative" id="pot1-container">
                    <!-- 화분 영역 -->
                    <div class="plant-pot bg-amber-100 rounded-lg border-4 border-amber-300 h-48 flex flex-col items-center justify-end p-4 relative overflow-hidden"
                         id="pot1">

                        <!-- 식물 표시 영역 -->
                        <div id="plant1-display" class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
                            <!-- 동적으로 생성 -->
                        </div>

                        <!-- 빈 화분 표시 -->
                        <div id="empty-pot1" class="text-center">
                            <div class="text-4xl mb-2">🕳️</div>
                            <div class="text-sm text-gray-500">씨앗을 심어보세요</div>
                        </div>
                    </div>

                    <!-- 식물 정보 -->
                    <div id="plant1-info" class="mt-4 text-center hidden">
                        <div class="text-sm text-gray-600 mb-2" id="plant1-status">상태: 성장 중</div>

                        <!-- 물 프로그레스 -->
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>💧 물</span>
                                <span id="plant1-water">0/20</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500"
                                     id="plant1-water-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- 시간 정보 -->
                        <div class="text-xs text-gray-600 mb-3" id="plant1-time">
                            ⏰ 남은 시간: 24시간
                        </div>
                    </div>

                    <!-- 상호작용 버튼들 -->
                    <div class="mt-4 flex justify-center space-x-2" id="pot1-actions">
                        <button onclick="plantSeedToPot(1)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            🌰 씨앗 심기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 화분 2 -->
            <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-green-200">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">🪴 화분 #2</h3>
                    <div class="text-xs text-gray-500" id="pot2-name">빈 화분</div>
                </div>

                <div class="relative" id="pot2-container">
                    <!-- 화분 영역 -->
                    <div class="plant-pot bg-amber-100 rounded-lg border-4 border-amber-300 h-48 flex flex-col items-center justify-end p-4 relative overflow-hidden"
                         id="pot2">

                        <!-- 식물 표시 영역 -->
                        <div id="plant2-display" class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
                            <!-- 동적으로 생성 -->
                        </div>

                        <!-- 빈 화분 표시 -->
                        <div id="empty-pot2" class="text-center">
                            <div class="text-4xl mb-2">🕳️</div>
                            <div class="text-sm text-gray-500">씨앗을 심어보세요</div>
                        </div>
                    </div>

                    <!-- 식물 정보 -->
                    <div id="plant2-info" class="mt-4 text-center hidden">
                        <div class="text-sm text-gray-600 mb-2" id="plant2-status">상태: 성장 중</div>

                        <!-- 물 프로그레스 -->
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>💧 물</span>
                                <span id="plant2-water">0/20</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500"
                                     id="plant2-water-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- 시간 정보 -->
                        <div class="text-xs text-gray-600 mb-3" id="plant2-time">
                            ⏰ 남은 시간: 24시간
                        </div>
                    </div>

                    <!-- 상호작용 버튼들 -->
                    <div class="mt-4 flex justify-center space-x-2" id="pot2-actions">
                        <button onclick="plantSeedToPot(2)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            🌰 씨앗 심기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 물주기 안내 -->
        <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-200">
            <div class="text-center">
                <h3 class="font-bold text-blue-900 mb-2">🌱 식물 성장 단계</h3>
                <p class="text-sm text-blue-700 mb-3">
                    식물을 클릭하면 약점 과목 문제와 정답, 해설이 함께 표시됩니다!<br>
                    문제를 읽고 이해한 후 확인 버튼을 누르면 물을 줄 수 있어요.
                </p>
                <div class="flex justify-center items-center space-x-2 text-sm mb-2">
                    <span>🌰 씨앗</span>
                    <span class="text-gray-400">→</span>
                    <span class="text-xs bg-white px-2 py-1 rounded">5회</span>
                    <span class="text-gray-400">→</span>
                    <span>🌱 줄기</span>
                    <span class="text-gray-400">→</span>
                    <span class="text-xs bg-white px-2 py-1 rounded">10회</span>
                    <span class="text-gray-400">→</span>
                    <span>🌳 나무</span>
                    <span class="text-gray-400">→</span>
                    <span class="text-xs bg-white px-2 py-1 rounded">15회</span>
                    <span class="text-gray-400">→</span>
                    <span>🌺 열매/꽃</span>
                </div>
                <div class="text-xs text-blue-600">
                    💡 팁: 틀려도 괜찮아요! 정답과 해설을 보며 학습하고 물을 줄 수 있습니다.
                </div>
            </div>
        </div>

        <!-- 안내 -->
        <div class="bg-white rounded-xl p-4 shadow-md">
            <h3 class="font-bold mb-2">📘 사용 안내</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                <li>• <strong>물주기:</strong> 약점 과목 문제의 정답과 해설을 보며 학습합니다 (무제한)</li>
                <li>• <strong>성장 단계:</strong> 🌰씨앗(5회) → 🌱줄기(10회) → 🌳나무(15회) → 🌺열매/꽃</li>
                <li>• <strong>식물 종류:</strong> 각 단계마다 랜덤하게 다른 모양으로 성장합니다</li>
                <li>• <strong>보상:</strong> 3과목(성장권1), 5과목(일반뽑기), 6과목(성장권1), 9과목(프리미엄뽑기)</li>
            </ul>
        </div>
    </div>

    <!-- 물주기 학습 모달 -->
    <div id="watering-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full modal-enter">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2" id="plant-character">🌱</div>
                <h3 class="text-lg font-bold" id="plant-speech">안녕! 나에게 물을 줘!</h3>
            </div>

            <!-- 학습 내용 -->
            <div class="bg-blue-50 rounded-lg p-4 mb-4" id="learning-content">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2" id="question-subject-icon">📚</span>
                    <div class="font-bold text-blue-900" id="question-title">약점 과목 학습</div>
                </div>
                <div class="text-sm text-blue-800 mb-3" id="question-text">
                    문제가 여기에 표시됩니다
                </div>

                <!-- 정답 및 해설 (학습 모드) -->
                <div class="mb-3 p-3 bg-green-50 border-2 border-green-300 rounded-lg" id="answer-section">
                    <div class="flex items-start space-x-2 mb-2">
                        <span class="text-lg">✅</span>
                        <div>
                            <div class="font-bold text-green-900 mb-1">정답</div>
                            <div class="text-sm text-green-800" id="correct-answer"></div>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2 mt-2 pt-2 border-t border-green-200">
                        <span class="text-lg">💡</span>
                        <div>
                            <div class="font-bold text-blue-900 mb-1">해설</div>
                            <div class="text-sm text-gray-700" id="explanation-text"></div>
                        </div>
                    </div>
                </div>

                <!-- 확인 버튼 (5초 후 활성화) -->
                <button id="water-confirm-btn" onclick="confirmLearningAndWater()" disabled
                        class="w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all">
                    <span id="water-btn-text">💧 문제를 읽어주세요 (<span id="countdown">5</span>초)</span>
                </button>
            </div>

            <div class="text-center">
                <button onclick="closeWateringModal()" class="text-gray-500 text-sm hover:text-gray-700">
                    나중에 하기
                </button>
            </div>
        </div>
    </div>

    <!-- 식물 대화 팝업 -->
    <div id="plant-speech-popup" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-white rounded-xl shadow-lg border-2 border-green-300 p-4 z-40">
        <div class="speech-bubble text-center">
            <div class="text-sm font-medium text-gray-800" id="popup-text">안녕하세요!</div>
            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                <div class="w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-green-300"></div>
            </div>
        </div>
    </div>

    <!-- 성장권 상세 모달 -->
    <div id="ticket-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">🎫 성장권 목록</h3>
                <button onclick="closeTicketModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>

            <div id="ticket-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- 동적으로 생성 -->
            </div>
        </div>
    </div>

    <!-- 초기화 메뉴 모달 -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-red-600">⚙️ 개발자 메뉴</h3>
                <button onclick="closeResetMenu()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>

            <div class="space-y-3">
                <button onclick="resetAllData()" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-left">
                    🗑️ 모든 데이터 초기화
                    <div class="text-xs text-red-100 mt-1">사용자, 식물, 학습 기록 전체 삭제</div>
                </button>

                <button onclick="resetPlants()" class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-left">
                    🌱 식물만 초기화
                    <div class="text-xs text-orange-100 mt-1">모든 식물 제거 (보상은 유지)</div>
                </button>

                <button onclick="resetDaily()" class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-left">
                    📅 일일 진행률 초기화
                    <div class="text-xs text-yellow-100 mt-1">오늘 완료한 과목 리셋</div>
                </button>

                <button onclick="addTestTickets()" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-left">
                    🎫 테스트 성장권 추가
                    <div class="text-xs text-green-100 mt-1">성장권 5개 즉시 지급</div>
                </button>

                <button onclick="skipPlantTime()" class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-left">
                    ⏰ 식물 시간 건너뛰기
                    <div class="text-xs text-blue-100 mt-1">24시간 경과로 설정</div>
                </button>
            </div>

            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                ⚠️ 이 메뉴는 개발/테스트용입니다. 실제 데이터가 삭제될 수 있습니다.
            </div>
        </div>
    </div>

    <!-- 알림 토스트 -->
    <div id="toast" class="hidden fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div id="toast-message"></div>
    </div>

    <!-- 축하 모달 -->
    <div id="celebration-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-yellow-50 to-green-50 rounded-2xl p-8 max-w-md w-full celebration-modal relative overflow-hidden">
            <!-- 배경 장식 -->
            <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>

            <div class="relative z-10">
                <!-- 축하 아이콘 -->
                <div class="text-center mb-4">
                    <div class="text-8xl mb-4 glow-pulse" id="celebration-emoji">🎉</div>
                    <div class="text-2xl font-bold text-gray-800 mb-2" id="celebration-title">축하합니다!</div>
                    <div class="text-lg text-gray-600 mb-4" id="celebration-message">식물이 성장했습니다!</div>
                </div>

                <!-- 변화 표시 -->
                <div class="bg-white rounded-xl p-4 mb-6 shadow-lg">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="text-center">
                            <div class="text-4xl mb-2" id="celebration-before">🌰</div>
                            <div class="text-xs text-gray-500">이전</div>
                        </div>
                        <div class="text-3xl text-green-500">→</div>
                        <div class="text-center">
                            <div class="text-5xl mb-2 glow-pulse" id="celebration-after">🌱</div>
                            <div class="text-xs text-gray-500">현재</div>
                        </div>
                    </div>
                </div>

                <!-- 진행률 표시 -->
                <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <div class="text-sm font-semibold text-gray-700 mb-2" id="celebration-progress">진행률</div>
                        <div class="flex justify-center items-center space-x-2">
                            <div class="flex space-x-1" id="celebration-stages">
                                <!-- 동적 생성 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 다음 목표 -->
                <div class="bg-blue-50 rounded-lg p-3 mb-4 border-2 border-blue-200">
                    <div class="text-center text-sm">
                        <span class="font-semibold text-blue-900">다음 목표:</span>
                        <span class="text-blue-700" id="celebration-next-goal">물 10개 더 주기</span>
                    </div>
                </div>

                <!-- 확인 버튼 -->
                <button onclick="closeCelebrationModal()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                    계속하기 🚀
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPlantId = null;

        // 초기화
        function init() {
            console.log('Initializing plant system...');

            // 스크립트 로딩 확인
            if (typeof plantSystem === 'undefined') {
                console.error('plantSystem is not loaded');
                setTimeout(init, 100);
                return;
            }

            console.log('plantSystem loaded');

            try {
                // 사용자 데이터 가져오기 (없으면 자동 생성)
                currentUser = plantSystem.getUserData();
                console.log('Current user loaded:', currentUser);

                if (!currentUser || !currentUser.userId) {
                    console.error('Failed to load user data');
                    showToast('❌ 사용자 데이터 로드 실패');
                    return;
                }

                // 일일 리셋 체크
                plantSystem.dailyReset(currentUser);
                console.log('Daily reset checked');

                // 사용자 데이터 다시 가져오기 (리셋 후 변경사항 반영)
                currentUser = plantSystem.getUserData();

                // UI 업데이트
                updateDashboard();
                renderPlants();

                // 주기적 업데이트
                setInterval(updateDashboard, 30000); // 30초마다

                console.log('Initialization complete');
                showToast('✅ 시스템 초기화 완료');
            } catch (error) {
                console.error('초기화 오류:', error);
                showToast('❌ 시스템 초기화 실패: ' + error.message);
            }
        }

        // 대시보드 업데이트
        function updateDashboard() {
            try {
                if (!currentUser) {
                    console.warn('currentUser is not set yet');
                    return;
                }

                const dashboard = plantSystem.getDashboardState(currentUser.userId);

                // 일일 진행률
                document.getElementById('daily-progress').textContent = dashboard.learning.progress;

                // 티켓 정보
                document.getElementById('growth-tickets').textContent = dashboard.tickets.growthTickets;

                // 다음 보상
                document.getElementById('next-reward').textContent = dashboard.learning.nextReward.message;

                renderPlants();
            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        }

        // 식물 렌더링 (화분별로)
        function renderPlants() {
            try {
                if (!currentUser) {
                    console.warn('currentUser is not set for renderPlants');
                    return;
                }

                const plants = plantSystem.getUserPlants(currentUser.userId);
                console.log('Rendering plants:', plants);

                // 각 화분 업데이트
                [1, 2].forEach(potNum => {
                    renderPot(potNum, plants);
                });

            } catch (error) {
                console.error('Render plants error:', error);
            }
        }

        // 개별 화분 렌더링
        function renderPot(potNum, allPlants) {
            // potNum에 해당하는 식물 찾기 (간단하게 인덱스로)
            const plantData = allPlants[potNum - 1] || null;

            // getDashboardState에서 가져온 식물 데이터 (timeRemaining 포함)
            const dashboard = plantSystem.getDashboardState(currentUser.userId);
            const plant = dashboard.plants[potNum - 1] || null;

            const emptyElement = document.getElementById(`empty-pot${potNum}`);
            const plantDisplay = document.getElementById(`plant${potNum}-display`);
            const plantInfo = document.getElementById(`plant${potNum}-info`);
            const potName = document.getElementById(`pot${potNum}-name`);
            const actions = document.getElementById(`pot${potNum}-actions`);
            const potElement = document.getElementById(`pot${potNum}`);

            if (!plant) {
                // 빈 화분
                emptyElement.classList.remove('hidden');
                plantDisplay.innerHTML = '';
                plantInfo.classList.add('hidden');
                potName.textContent = '빈 화분';
                potElement.onclick = null;
                actions.innerHTML = `
                    <button onclick="plantSeedToPot(${potNum})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                        🌰 씨앗 심기
                    </button>
                `;
            } else {
                // 식물이 있는 화분
                emptyElement.classList.add('hidden');
                plantInfo.classList.remove('hidden');

                // 식물 표시 (스테이지별 크기 조절)
                const plantEmoji = plant.type || '🌱';
                const stage = plant.stage || 0;
                const sizeClass = ['text-4xl', 'text-5xl', 'text-6xl', 'text-7xl'][stage];

                plantDisplay.innerHTML = `
                    <div class="${sizeClass} plant-growing ${plant.waterCount > 5 ? 'plant-happy' : ''}">${plantEmoji}</div>
                `;

                // 화분 클릭 가능
                if (plant.status === 'PLANTED') {
                    potElement.onclick = () => waterPlantInPot(potNum, plant.id);
                    potElement.style.cursor = 'pointer';
                } else {
                    potElement.onclick = null;
                    potElement.style.cursor = 'default';
                }

                potName.textContent = '성장 중인 식물';

                // 상태 정보 (스테이지 포함)
                const stageNames = ['🌰 씨앗', '🌱 줄기', '🌳 나무', '🌺 완성'];
                const stageName = stageNames[plant.stage || 0] || '🌱 성장 중';

                const statusText = plant.status === 'GROWN'
                    ? '🌺 성장 완료 - 수확 가능!'
                    : `${stageName} 단계`;

                document.getElementById(`plant${potNum}-status`).textContent = statusText;

                // 물 정보 - 모든 단계에서 5번씩
                const maxWater = 5;
                const waterPercent = (plant.waterCount / maxWater) * 100;
                document.getElementById(`plant${potNum}-water`).textContent = `${plant.waterCount}/${maxWater}`;
                document.getElementById(`plant${potNum}-water-bar`).style.width = waterPercent + '%';

                // 시간 정보
                document.getElementById(`plant${potNum}-time`).textContent = `⏰ ${plant.timeRemaining}`;

                // 버튼 (스테이지 기반)
                const maxWaterForStage = 5;

                if (plant.status === 'GROWN') {
                    // 완전히 성장 완료 - 수확 가능
                    actions.innerHTML = `
                        <button onclick="harvestPlant('${plant.id}')" class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition-all">
                            🌺 수확하기
                        </button>
                    `;
                } else {
                    // 성장 중 - 물주기 가능
                    const nextStage = ['🌱 줄기', '🌳 나무', '🌺 열매/꽃', '완성'][plant.stage || 0];
                    actions.innerHTML = `
                        <button onclick="waterPlantInPot(${potNum}, '${plant.id}')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-all">
                            💧 물주기 (${plant.waterCount}/${maxWaterForStage})
                        </button>
                        <div class="text-xs text-gray-500 mt-2">다음: ${nextStage}</div>
                    `;
                }
            }
        }

        // 기존 renderPlants 로직 제거
        function OLD_renderPlants() {
            try {
                if (!currentUser) {
                    console.warn('currentUser is not set for renderPlants');
                    return;
                }

                const plants = plantSystem.getUserPlants(currentUser.userId);
                const container = document.getElementById('OLD-plants-container');

            container.innerHTML = plants.map(plant => {
                const statusColor = {
                    'PLANTED': 'blue',
                    'READY': 'green',
                    'GROWN': 'yellow'
                }[plant.status];

                const statusText = {
                    'PLANTED': '성장 중',
                    'READY': '성장 준비 완료',
                    'GROWN': '성장 완료'
                }[plant.status];

                return `
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <div class="text-6xl mb-2 plant-growing">${plant.type}</div>
                            <div class="text-sm font-semibold text-${statusColor}-600">${statusText}</div>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">물</span>
                                <span class="font-bold">${plant.waterCount}/20</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${plant.waterCount/20*100}%"></div>
                            </div>

                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">시간</span>
                                <span class="font-bold">${plant.timeRemaining}</span>
                            </div>
                        </div>

                        ${plant.status === 'READY' ? `
                            <button onclick="growPlant('${plant.id}')" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600">
                                🌱 성장시키기
                            </button>
                        ` : plant.status === 'PLANTED' ? `
                            <button onclick="waterPlant('${plant.id}')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">
                                💧 물주기 (${plant.waterCount}/20)
                            </button>
                        ` : `
                            <div class="text-center text-sm text-gray-500">
                                수확하여 보상을 받을 수 있습니다
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            } catch (error) {
                console.error('Render plants error:', error);
            }
        }

        // 화분에 씨앗 심기
        function plantSeedToPot(potNum) {
            try {
                if (!currentUser) {
                    showToast('❌ 사용자 정보를 불러오는 중입니다');
                    return;
                }

                // 이미 식물이 있는지 확인
                const plants = plantSystem.getUserPlants(currentUser.userId);
                const existingPlant = plants[potNum - 1];

                if (existingPlant) {
                    showToast('❌ 이미 식물이 심어져 있습니다');
                    return;
                }

                const plant = plantSystem.plantSeed(currentUser.userId);
                console.log('New plant created:', plant);

                showPlantSpeech('안녕! 나를 잘 부탁해!');
                showToast('🌰 씨앗을 심었습니다!');
                updateDashboard();
            } catch (error) {
                console.error('씨앗 심기 오류:', error);
                showToast('❌ 씨앗 심기 실패: ' + error.message);
            }
        }

        // 화분에 물주기
        async function waterPlantInPot(potNum, plantId) {
            try {
                if (!currentUser) {
                    showToast('❌ 사용자 정보를 불러오는 중입니다');
                    return;
                }

                currentPlantId = plantId;

                // 약점 과목 문제 생성 (실제 문제 은행에서 로드)
                const questionData = await weaknessLearning.generateWaterQuestion(currentUser, plantId);

                if (!questionData.success) {
                    showToast('❌ ' + questionData.message);
                    return;
                }

                // 현재 문제의 과목 정보 저장
                window.currentQuestionSubject = questionData.subjectName;
                window.currentQuestionData = questionData;

                // 모달에 문제 표시
                const subjectIcons = {
                    'math': '🔢',
                    'korean': '📚',
                    'english': '🔤',
                    'science': '🔬',
                    'social': '🌍',
                    'history': '📜',
                    'art': '🎨',
                    'music': '🎵',
                    'pe': '⚽'
                };

                document.getElementById('question-subject-icon').textContent = subjectIcons[questionData.subjectId] || '📚';
                document.getElementById('question-title').textContent = questionData.subjectName + ' 학습';
                document.getElementById('question-text').textContent = questionData.question.q;

                // 정답 및 해설 표시 (학습 모드)
                const correctAnswer = questionData.question.a[questionData.question.correct];
                document.getElementById('correct-answer').textContent = `${questionData.question.correct + 1}. ${correctAnswer}`;

                // 해설이 있으면 표시, 없으면 기본 메시지
                const explanation = questionData.question.explanation || '이 문제를 잘 기억하고 이해해보세요!';
                document.getElementById('explanation-text').textContent = explanation;

                // 버튼 초기화 (비활성화 상태로)
                const waterBtn = document.getElementById('water-confirm-btn');
                const waterBtnText = document.getElementById('water-btn-text');
                if (waterBtn) {
                    waterBtn.disabled = true;
                    waterBtn.className = 'w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all';
                }
                if (waterBtnText) {
                    waterBtnText.innerHTML = '💧 문제를 읽어주세요 (<span id="countdown">5</span>초)';
                }

                // 모달 표시 (먼저!)
                document.getElementById('watering-modal').classList.remove('hidden');

                // 5초 카운트다운 시작 (모달 표시 후)
                setTimeout(() => {
                    startWaterButtonCountdown();
                }, 100);

            } catch (error) {
                console.error('물주기 오류:', error);
                showToast('❌ 물주기 실패: ' + error.message);
            }
        }

        // 물주기 버튼 5초 카운트다운
        let countdownInterval = null;
        function startWaterButtonCountdown() {
            const btn = document.getElementById('water-confirm-btn');
            const countdownSpan = document.getElementById('countdown');
            const btnText = document.getElementById('water-btn-text');

            // 요소가 없으면 중단
            if (!btn || !countdownSpan || !btnText) {
                console.warn('카운트다운 요소를 찾을 수 없습니다');
                return;
            }

            let timeLeft = 5;

            // 버튼 비활성화 및 초기화
            btn.disabled = true;
            btn.className = 'w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all';
            countdownSpan.textContent = timeLeft;

            // 기존 타이머가 있다면 정리
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // 1초마다 카운트다운
            countdownInterval = setInterval(() => {
                timeLeft--;

                // 요소 재확인 (모달이 닫혔을 수 있음)
                if (!countdownSpan) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    return;
                }

                countdownSpan.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;

                    // 버튼 활성화
                    if (btn) {
                        btn.disabled = false;
                        btn.className = 'w-full px-4 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-all';
                    }
                    if (btnText) {
                        btnText.innerHTML = '💧 이해했어요! 물주기';
                    }
                }
            }, 1000);
        }

        // 학습 확인 후 물주기 (학습 모드)
        function confirmLearningAndWater() {
            const result = plantSystem.waterPlant(currentPlantId);
            if (result.success) {
                showWaterAnimation();
                showLoveAnimation();

                // 스테이지 변경 체크
                const plant = plantSystem.getPlant(currentPlantId);
                const maxWater = 5;

                if (result.stageChanged) {
                    // 축하 모달 표시
                    closeWateringModal();
                    showCelebrationModal(plant);
                } else {
                    showPlantSpeech(`고마워! 이제 ${result.waterCount}/${maxWater} 물을 받았어!`);
                    showToast(`✅ 학습 완료! 물을 주었습니다 (${result.waterCount}/${maxWater})`);
                    closeWateringModal();
                }

                updateDashboard();

                // 학습 진행도 업데이트 (학습 모드는 항상 true로 처리)
                if (window.currentQuestionSubject) {
                    weaknessLearning.updateLearningProgress(currentUser, window.currentQuestionSubject, true);
                }

                // Firebase 동기화
                if (window.plantSystemFirebase && typeof plantSystemFirebase.savePlantSystemState === 'function') {
                    plantSystemFirebase.savePlantSystemState();
                }
            } else {
                showToast('❌ ' + result.message);
            }
        }

        // 축하 모달 표시
        function showCelebrationModal(plant) {
            const stageNames = ['🌰 씨앗', '🌱 줄기', '🌳 나무', '🌺 열매/꽃'];
            const stageEmojis = ['🌰', '🌱', '🌳', '🌺'];
            const currentStage = plant.stage || 0;
            const prevStage = Math.max(0, currentStage - 1);

            // 모달 내용 설정
            document.getElementById('celebration-emoji').textContent = plant.plantType;
            document.getElementById('celebration-title').textContent = currentStage === 3 ? '🎉 성장 완료!' : '🌱 한 단계 성장!';
            document.getElementById('celebration-message').textContent =
                currentStage === 3
                    ? `${stageNames[currentStage]} 단계에 도달했습니다!`
                    : `${stageNames[prevStage]}에서 ${stageNames[currentStage]}(으)로 자랐어요!`;

            // 이전/현재 모습
            document.getElementById('celebration-before').textContent = stageEmojis[prevStage];
            document.getElementById('celebration-after').textContent = plant.plantType;

            // 진행률 표시
            const stagesHtml = stageEmojis.map((emoji, idx) => {
                const isCompleted = idx < currentStage;
                const isCurrent = idx === currentStage;
                return `
                    <div class="flex flex-col items-center">
                        <div class="text-2xl ${isCurrent ? 'glow-pulse' : ''} ${isCompleted ? 'opacity-50' : ''}">${emoji}</div>
                        ${isCurrent ? '<div class="text-xs text-green-600 font-bold">현재</div>' : ''}
                        ${isCompleted ? '<div class="text-xs text-gray-400">완료</div>' : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('celebration-stages').innerHTML = stagesHtml;

            // 다음 목표
            if (currentStage < 3) {
                const nextWater = [5, 10, 15][currentStage];
                document.getElementById('celebration-next-goal').textContent =
                    `${stageNames[currentStage + 1]} 단계까지 물 ${nextWater}개 더 주기`;
            } else {
                document.getElementById('celebration-next-goal').textContent = '수확 가능! 🎉';
            }

            // 모달 표시
            document.getElementById('celebration-modal').classList.remove('hidden');

            // 컨페티 생성
            createConfetti();

            // 플레이풀한 사운드 효과 (선택적)
            playSuccessSound();
        }

        function closeCelebrationModal() {
            document.getElementById('celebration-modal').classList.add('hidden');
            document.getElementById('confetti-container').innerHTML = '';
        }

        // 컨페티 애니메이션 생성
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = ''; // 초기화

            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];
            const emojis = ['⭐', '✨', '💫', '🌟', '💖', '🎊', '🎉'];

            // 50개의 컨페티 생성
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';

                // 랜덤하게 색상 또는 이모지
                if (Math.random() > 0.5) {
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                } else {
                    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    confetti.style.fontSize = '20px';
                }

                // 랜덤 위치
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';

                // 랜덤 애니메이션 지연
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';

                container.appendChild(confetti);

                // 애니메이션 완료 후 제거
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // 성공 사운드 (Web Audio API 사용 - 간단한 비프음)
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // 경쾌한 3음계
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                let startTime = audioContext.currentTime;

                notes.forEach((freq, idx) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.2);

                    startTime += 0.15;
                });
            } catch (e) {
                console.log('사운드 재생 실패 (선택 기능)');
            }
        }

        function closeWateringModal() {
            // 카운트다운 타이머 정리
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            document.getElementById('watering-modal').classList.add('hidden');
            currentPlantId = null;
        }

        // 식물 성장시키기
        function growPlantInPot(plantId) {
            try {
                if (!currentUser) {
                    showToast('❌ 사용자 정보를 불러오는 중입니다');
                    return;
                }

                // 성장 전 식물 상태 저장
                const plantBefore = plantSystem.getPlant(plantId);
                const stageBefore = plantBefore ? plantBefore.stage : 0;

                const result = plantSystem.growPlant(currentUser, plantId);

                if (result.success) {
                    // 성장 후 식물 상태 가져오기
                    const plantAfter = plantSystem.getPlant(plantId);
                    const stageAfter = plantAfter ? plantAfter.stage : 0;

                    // 스테이지가 변경되었으면 축하 모달 표시
                    if (stageAfter > stageBefore) {
                        showPlantSpeech('와! 한 단계 성장했어요! 🎉');
                        showCelebrationModal(plantAfter);
                    } else {
                        showPlantSpeech('와! 완전히 자랐어요! 수고하셨어요 🎉');
                        showToast('🎉 ' + result.message);
                    }

                    // Firebase 동기화
                    if (window.plantSystemFirebase) {
                        plantSystemFirebase.syncPlantGrowth({plantId});
                    }

                    updateDashboard();
                } else {
                    showToast('❌ ' + result.message);
                }
            } catch (error) {
                console.error('성장 오류:', error);
                showToast('❌ 성장 실패: ' + error.message);
            }
        }

        // 식물 수확
        function harvestPlant(plantId) {
            try {
                if (!currentUser) {
                    showToast('❌ 사용자 정보를 불러오는 중입니다');
                    return;
                }

                const result = plantSystem.harvestPlant(plantId);

                if (result.success) {
                    showPlantSpeech('감사했어요! 또 만나요!');
                    showToast('🌺 ' + result.message);

                    // Firebase 동기화
                    if (window.plantSystemFirebase) {
                        plantSystemFirebase.savePlantSystemState();
                    }

                    updateDashboard();
                } else {
                    showToast('❌ ' + result.message);
                }
            } catch (error) {
                console.error('수확 오류:', error);
                showToast('❌ 수확 실패: ' + error.message);
            }
        }

        // 애니메이션 함수들
        function showWaterAnimation() {
            // 현재 활성화된 화분 찾기
            const plants = plantSystem.getUserPlants(currentUser.userId);
            const activePlantIndex = plants.findIndex(p => p && p.plantId === currentPlantId);

            if (activePlantIndex === -1) return;

            const potNum = activePlantIndex + 1;
            const potElement = document.getElementById(`pot${potNum}`);

            // 물방울 생성
            const droplet = document.createElement('div');
            droplet.textContent = '💧';
            droplet.className = 'water-drop absolute text-4xl';
            droplet.style.left = '50%';
            droplet.style.top = '10px';
            droplet.style.transform = 'translateX(-50%)';

            potElement.appendChild(droplet);

            // 애니메이션 후 제거
            setTimeout(() => {
                droplet.remove();
            }, 1000);
        }

        function showLoveAnimation() {
            // 현재 활성화된 화분 찾기
            const plants = plantSystem.getUserPlants(currentUser.userId);
            const activePlantIndex = plants.findIndex(p => p && p.plantId === currentPlantId);

            if (activePlantIndex === -1) return;

            const potNum = activePlantIndex + 1;
            const potElement = document.getElementById(`pot${potNum}`);

            // 하트 생성
            const heart = document.createElement('div');
            heart.textContent = '💚';
            heart.className = 'love-heart absolute text-3xl';
            heart.style.left = '50%';
            heart.style.bottom = '50%';
            heart.style.transform = 'translateX(-50%)';

            potElement.appendChild(heart);

            // 애니메이션 후 제거
            setTimeout(() => {
                heart.remove();
            }, 2000);
        }

        function showPlantSpeech(message) {
            const popup = document.getElementById('plant-speech-popup');
            const text = document.getElementById('popup-text');

            text.textContent = message;
            popup.classList.remove('hidden');

            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
        }

        // 성장권 상세
        function showTicketDetails() {
            const user = plantSystem.getUserData();
            const currentTime = plantSystem.getCurrentTimestamp();
            const validTickets = user.rewards.growthTickets.filter(t => t.expiresAt > currentTime);

            const listHtml = validTickets.length === 0 ?
                '<div class="text-center text-gray-500 py-4">보유한 성장권이 없습니다</div>' :
                validTickets.map(ticket => {
                    const remaining = ticket.expiresAt - currentTime;
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));

                    return `
                        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-semibold">성장권 #${ticket.ticketId.slice(0, 8)}</div>
                                <div class="text-sm text-red-600">${hours}시간 ${minutes}분 남음</div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('ticket-list').innerHTML = listHtml;
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        function closeTicketModal() {
            document.getElementById('ticket-modal').classList.add('hidden');
        }

        // ===== 개발자 메뉴 =====

        function showResetMenu() {
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeResetMenu() {
            document.getElementById('reset-modal').classList.add('hidden');
        }

        function resetAllData() {
            if (!confirm('⚠️ 모든 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            localStorage.removeItem('plantSystemUser');
            localStorage.removeItem('plantSystemPlants');
            showToast('✅ 모든 데이터가 초기화되었습니다');
            closeResetMenu();

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function resetPlants() {
            if (!confirm('모든 식물을 제거하시겠습니까?')) {
                return;
            }

            localStorage.removeItem('plantSystemPlants');
            showToast('✅ 식물이 초기화되었습니다');
            closeResetMenu();
            updateDashboard();
        }

        function resetDaily() {
            if (!confirm('일일 진행률을 초기화하시겠습니까?')) {
                return;
            }

            const user = plantSystem.getUserData();
            user.daily.completedSubjects = 0;
            user.daily.completedSubjectIds = [];
            user.daily.lastResetDate = plantSystem.getCurrentDate();
            plantSystem.saveUserData(user);

            showToast('✅ 일일 진행률이 초기화되었습니다');
            closeResetMenu();
            updateDashboard();
        }

        function addTestTickets() {
            const user = plantSystem.getUserData();
            const currentTime = plantSystem.getCurrentTimestamp();
            const expiresAt = currentTime + (24 * 60 * 60 * 1000);

            for (let i = 0; i < 5; i++) {
                user.rewards.growthTickets.push({
                    ticketId: plantSystem.generateUUID(),
                    earnedAt: currentTime,
                    expiresAt: expiresAt
                });
            }

            plantSystem.saveUserData(user);
            showToast('✅ 성장권 5개가 추가되었습니다');
            closeResetMenu();
            updateDashboard();
        }

        function skipPlantTime() {
            const plants = plantSystem.getAllPlants();
            let updated = 0;

            Object.values(plants).forEach(plant => {
                if (plant.status === 'PLANTED') {
                    // 24시간 전으로 심은 시간 변경
                    plant.plantedAt = plantSystem.getCurrentTimestamp() - (25 * 60 * 60 * 1000);
                    plantSystem.savePlant(plant);

                    // 상태 재확인
                    plantSystem.checkReadyStatus(plant);
                    plantSystem.savePlant(plant);
                    updated++;
                }
            });

            showToast(`✅ ${updated}개 식물의 시간을 건너뛰었습니다`);
            closeResetMenu();
            updateDashboard();
        }

        // 토스트 알림
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 이벤트 리스너
        window.addEventListener('dailyReset', () => {
            showToast('🌅 일일 초기화 완료');
            updateDashboard();
        });

        window.addEventListener('plantsStatusUpdated', (e) => {
            if (e.detail.updatedCount > 0) {
                showToast(`🌱 ${e.detail.updatedCount}개 식물이 성장 준비 완료!`);
                updateDashboard();
            }
        });

        // 페이지 로드
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
