<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet ÏÜåÏÖú ÌóàÎ∏å üåê</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-leaderboard.js"></script>
    <script src="firebase-social.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .home-btn:hover {
            background: white;
            color: #ff9a9e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .auth-section {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .auth-section.authenticated {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .auth-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .input-group {
            display: flex;
            margin: 10px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-control {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px 0 0 25px;
            font-size: 1rem;
            outline: none;
        }

        .form-control:focus {
            border-color: #007bff;
        }

        .input-group .btn {
            border-radius: 0 25px 25px 0;
            margin: 0;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .user-info {
            flex: 1;
            margin-left: 15px;
        }

        .nickname {
            font-weight: 600;
            font-size: 1.1rem;
            color: #495057;
        }

        .avatar {
            font-size: 2rem;
        }

        .value {
            font-weight: bold;
            color: #007bff;
        }

        .online-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
            margin-left: 10px;
        }

        .online-status.offline {
            background: #6c757d;
        }

        .friends-section, .showoff-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .friend-item, .showoff-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .showoff-item {
            border-left: 4px solid #007bff;
        }

        .showoff-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .showoff-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .showoff-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .animal-showcase {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }

        .animal-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .animal-tier {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .tier-common { background: #28a745; color: white; }
        .tier-rare { background: #007bff; color: white; }
        .tier-epic { background: #6f42c1; color: white; }
        .tier-legendary { background: #fd7e14; color: white; }

        .showoff-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .like-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn:hover {
            color: #c82333;
        }

        .like-btn.liked {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 10% auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                padding: 12px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .home-btn {
                top: 15px;
                left: 15px;
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .leaderboard-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <div style="font-size: 2rem; animation: spin 1s linear infinite;">üåê</div>
            <div style="margin-top: 10px; font-weight: bold; color: #495057;">ÏÜåÏÖú ÌóàÎ∏åÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
    </div>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <div class="container">
        <div class="header">
            <a href="index.html" class="home-btn">üè† ÌôàÏúºÎ°ú</a>
            <h1>üåê EduPet ÏÜåÏÖú ÌóàÎ∏å</h1>
            <p>ÏπúÍµ¨Îì§Í≥º Ìï®Íªò Í≥µÎ∂ÄÌïòÍ≥† Í≤ΩÏüÅÌï¥Î≥¥ÏÑ∏Ïöî!</p>
        </div>

        <!-- Ïù∏Ï¶ù ÏÑπÏÖò -->
        <div id="auth-section" class="auth-section">
            <div id="auth-status" class="auth-status">
                Î°úÎî© Ï§ë...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('leaderboards')">üèÜ ÏàúÏúÑÌëú</button>
            <button class="nav-tab" onclick="showTab('profile')">üë§ ÌîÑÎ°úÌïÑ</button>
            <button class="nav-tab" onclick="showTab('showoff')">üêæ ÏûêÎûëÌïòÍ∏∞</button>
            <button class="nav-tab" onclick="showTab('groups')">üéØ Í∑∏Î£π</button>
        </div>

        <!-- ÏàúÏúÑÌëú ÌÉ≠ -->
        <div id="leaderboards" class="tab-content active">
            <h2>üèÜ Ïã§ÏãúÍ∞Ñ ÏàúÏúÑÌëú</h2>
            
            <div class="leaderboard">
                <h3>üß† ÌÄ¥Ï¶à ÎßàÏä§ÌÑ∞</h3>
                <div id="quiz-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üéØ Ï†ïÌôïÎèÑ ÌÇπ</h3>
                <div id="accuracy-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üí∞ Î∂ÄÏûê Îû≠ÌÇπ</h3>
                <div id="money-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üêæ ÎèôÎ¨º Ïª¨Î†âÌÑ∞</h3>
                <div id="animal-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- ÌîÑÎ°úÌïÑ ÌÉ≠ -->
        <div id="profile" class="tab-content">
            <h2>üë§ ÎÇ¥ ÌîÑÎ°úÌïÑ</h2>

            <div class="friends-section">
                <h3>ÏïÑÎ∞îÌÉÄ ÎèôÎ¨º ÏÑ†ÌÉù</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">ÏàúÏúÑÌëúÏôÄ Í≤åÏãúÎ¨ºÏóê ÌëúÏãúÎê† ÏïÑÎ∞îÌÉÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                <div id="avatar-selection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <!-- ÎèôÎ¨º ÏïÑÎ∞îÌÉÄ Î™©Î°ùÏù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary" style="padding: 12px 40px; font-size: 1.1rem;" onclick="applyAvatarChange()">
                        ‚úÖ Ï†ÅÏö©ÌïòÍ∏∞
                    </button>
                </div>
                <div id="avatar-apply-result" style="margin-top: 15px;"></div>
            </div>

            <div class="friends-section">
                <h3>ÎÇ¥ ÌÜµÍ≥Ñ</h3>
                <div id="profile-stats" class="loading">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- ÏûêÎûëÌïòÍ∏∞ ÌÉ≠ -->
        <div id="showoff" class="tab-content">
            <h2>üêæ ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</h2>
            
            <div class="showoff-section">
                <h3>ÏÉà ÏûêÎûëÌïòÍ∏∞</h3>
                <button class="btn btn-primary" onclick="openShowOffModal()">ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</button>
            </div>

            <div class="showoff-section">
                <h3>ÏµúÍ∑º ÏûêÎûëÌïòÍ∏∞</h3>
                <div id="showoff-list" class="loading">ÏûêÎûëÌïòÍ∏∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- Í∑∏Î£π ÌÉ≠ -->
        <div id="groups" class="tab-content">
            <h2>üéØ ÌïôÏäµ Í∑∏Î£π</h2>
            
            <div class="friends-section">
                <h3>Í∑∏Î£π ÏÉùÏÑ±</h3>
                <div class="input-group">
                    <input type="text" id="group-name" class="form-control" placeholder="Í∑∏Î£π Ïù¥Î¶Ñ ÏûÖÎ†•">
                    <button class="btn btn-primary" onclick="createGroup()">ÏÉùÏÑ±</button>
                </div>
                <div id="create-group-result"></div>
            </div>

            <div class="friends-section">
                <h3>ÎÇ¥ Í∑∏Î£π</h3>
                <div id="groups-list" class="loading">Í∑∏Î£π Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>
    </div>

    <!-- ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ -->
    <div id="showoff-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShowOffModal()">&times;</span>
            <h3>üêæ ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</h3>
            <div id="animal-selection">
                <p>ÏûêÎûëÌï† ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</p>
                <div id="user-animals" class="loading">ÎèôÎ¨º Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
            <div id="showoff-form" style="display: none;">
                <textarea id="showoff-message" placeholder="ÏûêÎûëÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ Ïç®Ï£ºÏÑ∏Ïöî! (200Ïûê Ïù¥ÎÇ¥)" maxlength="200" style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; resize: none;"></textarea>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="submitShowOff()">ÏûêÎûëÌïòÍ∏∞ Í≤åÏãú</button>
                    <button class="btn btn-secondary" onclick="closeShowOffModal()">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let selectedAnimal = null;
        let leaderboardListeners = [];
        let tempSelectedAvatar = null; // ÏûÑÏãú ÏÑ†ÌÉùÎêú ÏïÑÎ∞îÌÉÄ

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        window.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            try {
                // eduPetAuth and eduPetFirebaseIntegrationÍ∞Ä Ï†ïÏùòÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
                console.log('Waiting for Firebase modules to load...');
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 100; // 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                    const interval = setInterval(() => {
                        attempts++;
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            console.log('Firebase modules loaded successfully');
                            clearInterval(interval);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            reject(new Error('Firebase Î™®Îìà Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ'));
                        }
                    }, 50);
                });

                // Ïù∏Ï¶ù ÏÉÅÌÉú Î¶¨Ïä§ÎÑàÎ•º Î®ºÏ†Ä ÏÑ§Ï†ïÌï©ÎãàÎã§.
                eduPetAuth.addAuthStateListener(onAuthStateChanged);
                console.log('Auth state listener added');

                // Firebase ÌÜµÌï© Í∏∞Îä•ÏùÑ Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§. (Ïù¥ Í≥ºÏ†ïÏóêÏÑú ÏùµÎ™Ö Î°úÍ∑∏Ïù∏Ïù¥ Ìä∏Î¶¨Í±∞Îê† Ïàò ÏûàÏäµÎãàÎã§)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                showError('Ïï± Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
                loadingOverlay.style.display = 'none';
            }
        });

        // Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
        async function onAuthStateChanged(state, userData) {
            currentUser = userData;

            if (state === 'signed_in') {
                // localStorageÏóêÏÑú ÌäúÌÜ†Î¶¨ÏñºÏóêÏÑú ÏÑ§Ï†ïÌïú ÎãâÎÑ§ÏûÑ Í∞ÄÏ†∏Ïò§Í∏∞
                let displayName = 'ÏùµÎ™Ö';
                let needsSync = false;

                try {
                    // 1. localStorageÏóêÏÑú Î®ºÏ†Ä ÌôïÏù∏ (ÌäúÌÜ†Î¶¨ÏñºÏóêÏÑú ÏÑ§Ï†ï)
                    const settings = JSON.parse(localStorage.getItem('eduPetSettings') || '{}');
                    if (settings.userName) {
                        displayName = settings.userName;

                        // FirebaseÏóê ÎãâÎÑ§ÏûÑÏù¥ ÏóÜÍ±∞ÎÇò Îã§Î•¥Î©¥ ÎèôÍ∏∞Ìôî ÌïÑÏöî
                        if (!userData?.profile?.nickname || userData.profile.nickname !== displayName) {
                            needsSync = true;
                        }
                    }
                    // 2. localStorageÏóê ÏóÜÏúºÎ©¥ FirebaseÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
                    else if (userData?.profile?.nickname) {
                        displayName = userData.profile.nickname;
                    }

                    // FirebaseÏóê ÎãâÎÑ§ÏûÑ ÎèôÍ∏∞Ìôî (ÎπÑÎèôÍ∏∞)
                    if (needsSync && typeof eduPetAuth !== 'undefined') {
                        console.log('üîÑ Syncing nickname to Firebase:', displayName);
                        eduPetAuth.setNickname(displayName).then(() => {
                            console.log('‚úÖ Firebase ÎãâÎÑ§ÏûÑ ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                        }).catch(err => {
                            console.warn('‚ö†Ô∏è Firebase ÎãâÎÑ§ÏûÑ ÎèôÍ∏∞Ìôî Ïã§Ìå®:', err);
                        });
                    }
                } catch (error) {
                    console.error('ÎãâÎÑ§ÏûÑ Î°úÎìú Ïã§Ìå®:', error);
                    displayName = userData?.profile?.nickname || 'ÏùµÎ™Ö';
                }

                showAuthStatus(`ÌôòÏòÅÌï©ÎãàÎã§, ${displayName}Îãò! üéâ`);
                loadSocialData();
            } else {
                showAuthStatus('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                clearSocialData();
            }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // Ïù∏Ï¶ù ÏÉÅÌÉú ÌëúÏãú
        function showAuthStatus(message) {
            document.getElementById('auth-status').textContent = message;
            
            const authSection = document.getElementById('auth-section');
            if (currentUser) {
                authSection.classList.add('authenticated');
            } else {
                authSection.classList.remove('authenticated');
            }
        }

        // Ïù∏Ï¶ù Ïª®Ìä∏Î°§ ÌëúÏãú (Ï†úÍ±∞Îê® - Î≥ÑÎ™Ö ÏÑ§Ï†ï UI Ï†úÍ±∞)


        // ÏÜåÏÖú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadSocialData() {
            loadLeaderboards();
            loadShowOffs();
            loadProfileData();
        }

        // ÏàúÏúÑÌëú Î°úÎìú
        async function loadLeaderboards() {
            if (typeof eduPetLeaderboard === 'undefined') {
                console.error('eduPetLeaderboardÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }

            const types = ['quiz_score', 'quiz_accuracy', 'money_collector', 'animal_collector'];
            const containers = ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'];

            for (let i = 0; i < types.length; i++) {
                try {
                    console.log(`Loading leaderboard: ${types[i]}`);
                    const leaderboard = await eduPetLeaderboard.getLeaderboard(types[i], 10);
                    displayLeaderboard(leaderboard, containers[i]);
                } catch (error) {
                    console.error(`ÏàúÏúÑÌëú ${types[i]} Î°úÎìú Ïã§Ìå®:`, error);
                    document.getElementById(containers[i]).innerHTML = '<div class="error">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                }
            }
        }

        // ÏàúÏúÑÌëú ÌëúÏãú
        function displayLeaderboard(leaderboard, containerId) {
            const container = document.getElementById(containerId);

            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            console.log('Displaying leaderboard for', containerId, ':', leaderboard);

            const html = leaderboard.map((user, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const onlineStatus = user.isOnline ? 'online' : 'offline';
                const avatarEmoji = getAnimalEmoji(user.avatarAnimal);

                console.log(`User ${user.nickname}: avatarAnimal=${user.avatarAnimal}, emoji=${avatarEmoji}`);

                return `
                    <div class="leaderboard-item">
                        <div class="rank ${rankClass}">${user.rank}</div>
                        <div class="avatar">${avatarEmoji}</div>
                        <div class="user-info">
                            <div class="nickname">
                                ${user.nickname}
                                <span class="online-status ${onlineStatus}"></span>
                            </div>
                        </div>
                        <div class="value">${formatValue(user.value, containerId)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÌîÑÎ°úÌïÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadProfileData() {
            try {
                // ÏïÑÎ∞îÌÉÄ ÎèôÎ¨º Î™©Î°ù Î°úÎìú
                loadAvatarSelection();

                // ÌÜµÍ≥Ñ Î°úÎìú
                loadProfileStats();
            } catch (error) {
                console.error('ÌîÑÎ°úÌïÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏïÑÎ∞îÌÉÄ ÏÑ†ÌÉù UI Î°úÎìú
        function loadAvatarSelection() {
            const avatarContainer = document.getElementById('avatar-selection');
            if (!avatarContainer) return;

            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÎèôÎ¨º ÏïÑÎ∞îÌÉÄ Î™©Î°ù
            const availableAvatars = [
                { id: 'bunny', emoji: 'üê∞', name: 'ÌÜ†ÎÅº' },
                { id: 'cat', emoji: 'üê±', name: 'Í≥†ÏñëÏù¥' },
                { id: 'dog', emoji: 'üê∂', name: 'Í∞ïÏïÑÏßÄ' },
                { id: 'fox', emoji: 'ü¶ä', name: 'Ïó¨Ïö∞' },
                { id: 'lion', emoji: 'ü¶Å', name: 'ÏÇ¨Ïûê' },
                { id: 'tiger', emoji: 'üêÖ', name: 'Ìò∏ÎûëÏù¥' },
                { id: 'bear', emoji: 'üêª', name: 'Í≥∞' },
                { id: 'panda', emoji: 'üêº', name: 'ÌåêÎã§' },
                { id: 'koala', emoji: 'üê®', name: 'ÏΩîÏïåÎùº' },
                { id: 'monkey', emoji: 'üêµ', name: 'ÏõêÏà≠Ïù¥' },
                { id: 'elephant', emoji: 'üêò', name: 'ÏΩîÎÅºÎ¶¨' },
                { id: 'giraffe', emoji: 'ü¶í', name: 'Í∏∞Î¶∞' },
                { id: 'zebra', emoji: 'ü¶ì', name: 'ÏñºÎ£©Îßê' },
                { id: 'horse', emoji: 'üêé', name: 'Îßê' },
                { id: 'cow', emoji: 'üêÑ', name: 'ÏÜå' },
                { id: 'pig', emoji: 'üê∑', name: 'ÎèºÏßÄ' },
                { id: 'sheep', emoji: 'üêë', name: 'Ïñë' },
                { id: 'chicken', emoji: 'üêî', name: 'Îã≠' },
                { id: 'penguin', emoji: 'üêß', name: 'Ìé≠Í∑Ñ' },
                { id: 'owl', emoji: 'ü¶â', name: 'Ïò¨ÎπºÎØ∏' }
            ];

            const currentAvatar = currentUser?.profile?.avatarAnimal || 'bunny';

            // ÏûÑÏãú ÏÑ†ÌÉùÏù¥ ÏóÜÏúºÎ©¥ ÌòÑÏû¨ ÏïÑÎ∞îÌÉÄÎ•º ÏûÑÏãú ÏÑ†ÌÉùÏúºÎ°ú ÏÑ§Ï†ï
            if (!tempSelectedAvatar) {
                tempSelectedAvatar = currentAvatar;
            }

            const html = availableAvatars.map(avatar => {
                const isSelected = avatar.id === tempSelectedAvatar;
                return `
                    <div id="avatar-${avatar.id}" onclick="selectAvatarTemp('${avatar.id}')" style="
                        padding: 15px;
                        background: ${isSelected ? '#007bff' : 'white'};
                        border: 2px solid ${isSelected ? '#007bff' : '#dee2e6'};
                        border-radius: 10px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s;
                        ${isSelected ? 'transform: scale(1.1);' : ''}
                    " onmouseover="this.style.borderColor='#007bff'" onmouseout="if('${avatar.id}' !== '${tempSelectedAvatar}') this.style.borderColor='#dee2e6'">
                        <div style="font-size: 2rem; margin-bottom: 5px;">${avatar.emoji}</div>
                        <div style="font-size: 0.75rem; color: ${isSelected ? 'white' : '#495057'}; font-weight: ${isSelected ? 'bold' : 'normal'};">${avatar.name}</div>
                    </div>
                `;
            }).join('');

            avatarContainer.innerHTML = html;
        }

        // ÏïÑÎ∞îÌÉÄ ÏûÑÏãú ÏÑ†ÌÉù (ÏïÑÏßÅ Ï†ÄÏû• Ïïà Ìï®)
        function selectAvatarTemp(avatarId) {
            if (!currentUser) {
                showError('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }

            tempSelectedAvatar = avatarId;

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('[id^="avatar-"]').forEach(el => {
                const id = el.id.replace('avatar-', '');
                const isSelected = id === avatarId;

                el.style.background = isSelected ? '#007bff' : 'white';
                el.style.borderColor = isSelected ? '#007bff' : '#dee2e6';
                el.style.transform = isSelected ? 'scale(1.1)' : 'scale(1)';

                const nameElement = el.querySelector('div:last-child');
                if (nameElement) {
                    nameElement.style.color = isSelected ? 'white' : '#495057';
                    nameElement.style.fontWeight = isSelected ? 'bold' : 'normal';
                }
            });
        }

        // ÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω Ï†ÅÏö©
        async function applyAvatarChange() {
            const resultDiv = document.getElementById('avatar-apply-result');

            if (!tempSelectedAvatar) {
                resultDiv.innerHTML = '<div class="error">ÏïÑÎ∞îÌÉÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>';
                return;
            }

            if (!currentUser) {
                resultDiv.innerHTML = '<div class="error">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div style="text-align: center; color: #007bff;">Ï†ÅÏö© Ï§ë...</div>';

                // FirebaseÏóê ÏïÑÎ∞îÌÉÄ ÏóÖÎç∞Ïù¥Ìä∏
                await firebase_db.ref(`users/${currentUser.profile.uid}/profile/avatarAnimal`).set(tempSelectedAvatar);

                // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (currentUser.profile) {
                    currentUser.profile.avatarAnimal = tempSelectedAvatar;
                }

                resultDiv.innerHTML = '<div class="success">‚úÖ ÏïÑÎ∞îÌÉÄÍ∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§! ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</div>';

                // 3Ï¥à ÌõÑ Î©îÏãúÏßÄ Ï†úÍ±∞
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('ÏïÑÎ∞îÌÉÄ Ï†ÅÏö© Ïã§Ìå®:', error);
                resultDiv.innerHTML = '<div class="error">ÏïÑÎ∞îÌÉÄ Ï†ÅÏö©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.</div>';
            }
        }


        // ÌîÑÎ°úÌïÑ ÌÜµÍ≥Ñ Î°úÎìú
        async function loadProfileStats() {
            const container = document.getElementById('profile-stats');
            if (!container) return;

            try {
                if (!currentUser) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d;">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>';
                    return;
                }

                const statsSnapshot = await firebase_db.ref(`users/${currentUser.uid}/stats`).once('value');
                const stats = statsSnapshot.val() || {};

                const html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">üß†</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #007bff;">${stats.correctAnswers || 0}</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Ï†ïÎãµ Ïàò</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">üéØ</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${stats.quizAccuracy || 0}%</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Ï†ïÌôïÎèÑ</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">üí∞</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${(stats.moneyCollected || 0).toLocaleString()}Ïõê</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Î≥¥Ïú† Í∏àÏï°</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">üêæ</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #6f42c1;">${stats.animalsCollected || 0}</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">ÏàòÏßëÌïú ÎèôÎ¨º</div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('ÌîÑÎ°úÌïÑ ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
                container.innerHTML = '<div class="error">ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù Î°úÎìú
        async function loadShowOffs() {
            if (typeof eduPetSocial === 'undefined') {
                console.error('eduPetSocialÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                document.getElementById('showoff-list').innerHTML = '<div class="error">ÏÜåÏÖú Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            try {
                console.log('Loading show-offs...');
                const showOffs = await eduPetSocial.getShowOffs(20);
                displayShowOffs(showOffs);
            } catch (error) {
                console.error('ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('showoff-list').innerHTML = '<div class="error">ÏûêÎûëÌïòÍ∏∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù ÌëúÏãú
        function displayShowOffs(showOffs) {
            const container = document.getElementById('showoff-list');

            if (!showOffs || showOffs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏûêÎûëÌïòÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏Î°ú ÏûêÎûëÌï¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            const html = showOffs.map(showOff => {
                const timeAgo = getTimeAgo(showOff.createdAt);
                const isLiked = showOff.likedBy && showOff.likedBy[currentUser?.profile?.uid];
                const isOwner = currentUser && showOff.userId === currentUser.uid;
                const commentCount = showOff.comments ? Object.keys(showOff.comments).length : 0;

                return `
                    <div class="showoff-item" id="showoff-${showOff.id}">
                        <div class="showoff-header">
                            <div class="showoff-user">
                                <div class="avatar">${getAnimalEmoji(showOff.userAvatar)}</div>
                                <div>
                                    <div class="nickname">${showOff.userNickname}</div>
                                    <div class="showoff-time">${timeAgo}${showOff.updatedAt ? ' (ÏàòÏ†ïÎê®)' : ''}</div>
                                </div>
                            </div>
                            ${isOwner ? `
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="editShowOff('${showOff.id}', '${(showOff.message || '').replace(/'/g, "\\'")}')">ÏàòÏ†ï</button>
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteShowOffPost('${showOff.id}')">ÏÇ≠Ï†ú</button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="animal-showcase">
                            <div class="animal-name">${showOff.animal.name}</div>
                            <div class="animal-tier tier-${showOff.animal.tier}">${getTierName(showOff.animal.tier)}</div>
                            <div style="font-size: 3rem; margin: 10px 0;">${showOff.animal.emoji || getAnimalEmoji(showOff.animal.name)}</div>
                            ${showOff.animal.level > 1 ? `<div style="color: #f59e0b; font-weight: bold; margin: 5px 0;">Î†àÎ≤® ${showOff.animal.level} ${'‚≠ê'.repeat(showOff.animal.level)}</div>` : ''}
                            ${showOff.animal.totalPower ? `<div style="color: #8b5cf6; font-weight: bold;">‚ö° ÌååÏõå: ${showOff.animal.totalPower}</div>` : ''}
                        </div>

                        <div id="message-${showOff.id}">
                            ${showOff.message ? `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${showOff.message}</div>` : ''}
                        </div>

                        <div class="showoff-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${showOff.id}')">
                                ‚ù§Ô∏è ${showOff.likes || 0}
                            </button>
                            <button class="like-btn" onclick="toggleComments('${showOff.id}')">
                                üí¨ ${commentCount}
                            </button>
                        </div>

                        <!-- ÎåìÍ∏Ä ÏòÅÏó≠ (Ìï≠ÏÉÅ ÌëúÏãú) -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <!-- ÎåìÍ∏Ä ÏûÖÎ†• (Ìï≠ÏÉÅ Î≥¥ÏûÑ) -->
                            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                                <input type="text" id="comment-input-${showOff.id}" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (100Ïûê Ïù¥ÎÇ¥)" maxlength="100" style="flex: 1; padding: 8px; border: 2px solid #dee2e6; border-radius: 20px;">
                                <button class="btn btn-primary" style="padding: 8px 16px;" onclick="addCommentToShowOff('${showOff.id}')">ÏûëÏÑ±</button>
                            </div>
                            <!-- ÎåìÍ∏Ä Î™©Î°ù (ÌÜ†Í∏Ä Í∞ÄÎä•) -->
                            <div id="comments-${showOff.id}" style="display: none;">
                                <div id="comments-list-${showOff.id}">
                                    <div class="loading">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ Ïó¥Í∏∞
        function openShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'block';
            loadUserAnimals();
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ Îã´Í∏∞
        function closeShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'none';
            selectedAnimal = null;
            document.getElementById('showoff-form').style.display = 'none';
            document.getElementById('animal-selection').style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê ÎèôÎ¨º Î™©Î°ù Î°úÎìú
        function loadUserAnimals() {
            try {
                // animalCollection localStorage ÏÇ¨Ïö© (animal-collection.htmlÍ≥º ÎèôÏùº)
                const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
                const collection = animalCollection.collection || {};

                console.log('Loading user animals from animalCollection:', collection);
                console.log('Collection keys:', Object.keys(collection));

                if (Object.keys(collection).length === 0) {
                    document.getElementById('user-animals').innerHTML =
                        '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏàòÏßëÌïú ÎèôÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§. ÎèôÎ¨º Ïª¨Î†âÏÖòÏóêÏÑú ÎèôÎ¨ºÏùÑ Î™®ÏïÑÎ≥¥ÏÑ∏Ïöî!</p>';
                    return;
                }

                // collection Í∞ùÏ≤¥Îäî { animalId: animalData } ÌòïÌÉú
                // count > 0Ïù∏ ÎèôÎ¨ºÎßå ÌëúÏãú (Ïã§Ï†úÎ°ú ÏÜåÏú†Ìïú ÎèôÎ¨ºÎßå)
                let ownedAnimals = Object.entries(collection).filter(([animalId, animalData]) => {
                    return (animalData.count || 0) > 0;
                });

                console.log('Owned animals (count > 0):', ownedAnimals);

                if (ownedAnimals.length === 0) {
                    document.getElementById('user-animals').innerHTML =
                        '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏàòÏßëÌïú ÎèôÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§. ÎèôÎ¨º Ïª¨Î†âÏÖòÏóêÏÑú ÎèôÎ¨ºÏùÑ Î™®ÏïÑÎ≥¥ÏÑ∏Ïöî!</p>';
                    return;
                }

                // Îì±Í∏â ÌïÑÌÑ∞ Î≤ÑÌäº Ï∂îÍ∞Ä
                const filterButtons = `
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="tier-filter-btn" data-tier="all" style="padding: 8px 16px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 20px; cursor: pointer; font-weight: 600;">Ï†ÑÏ≤¥</button>
                        <button class="tier-filter-btn" data-tier="common" style="padding: 8px 16px; border: 2px solid #28a745; background: white; color: #28a745; border-radius: 20px; cursor: pointer; font-weight: 600;">ÏùºÎ∞ò</button>
                        <button class="tier-filter-btn" data-tier="rare" style="padding: 8px 16px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 20px; cursor: pointer; font-weight: 600;">Î†àÏñ¥</button>
                        <button class="tier-filter-btn" data-tier="epic" style="padding: 8px 16px; border: 2px solid #6f42c1; background: white; color: #6f42c1; border-radius: 20px; cursor: pointer; font-weight: 600;">ÏóêÌîΩ</button>
                        <button class="tier-filter-btn" data-tier="legendary" style="padding: 8px 16px; border: 2px solid #fd7e14; background: white; color: #fd7e14; border-radius: 20px; cursor: pointer; font-weight: 600;">Ï†ÑÏÑ§</button>
                    </div>
                `;

                // ÎèôÎ¨º Î™©Î°ù Ïª®ÌÖåÏù¥ÎÑà (Ïä§ÌÅ¨Î°§ Í∞ÄÎä•)
                const animalListHtml = ownedAnimals.map(([animalId, animalData]) => {
                    // animal-collection.htmlÍ≥º ÎèôÏùºÌïú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÇ¨Ïö©
                    const level = animalData.level || 1;
                    const stars = '‚≠ê'.repeat(level);

                    return `
                        <div class="friend-item animal-item-selectable" data-tier="${animalData.tier}" style="cursor: pointer;" onclick='selectAnimal(${JSON.stringify(animalData).replace(/'/g, "\\'")})'>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 2rem;">${animalData.emoji || 'üêæ'}</div>
                                <div style="flex: 1;">
                                    <div class="nickname">
                                        ${animalData.name}
                                        ${level > 1 ? `<span style="color: #f59e0b; font-size: 0.9rem; margin-left: 5px;">Lv.${level}</span>` : ''}
                                    </div>
                                    <div class="animal-tier tier-${animalData.tier}" style="font-size: 0.8rem; margin-top: 5px;">
                                        ${getTierName(animalData.tier)}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 3px;">
                                        ${stars} | ‚ö°${animalData.totalPower || animalData.power || 1} | ${animalData.count || 1}ÎßàÎ¶¨
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Ïä§ÌÅ¨Î°§ Í∞ÄÎä•Ìïú Ïª®ÌÖåÏù¥ÎÑàÏóê ÎèôÎ¨º Î™©Î°ù Ï∂îÍ∞Ä
                document.getElementById('user-animals').innerHTML = `
                    ${filterButtons}
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid #dee2e6; border-radius: 10px; padding: 10px;">
                        ${animalListHtml}
                    </div>
                `;

                // ÌïÑÌÑ∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                document.querySelectorAll('.tier-filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const selectedTier = this.getAttribute('data-tier');

                        // Î™®Îì† Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
                        document.querySelectorAll('.tier-filter-btn').forEach(b => {
                            const tier = b.getAttribute('data-tier');
                            if (tier === 'all') {
                                b.style.background = 'white';
                                b.style.color = '#007bff';
                            } else if (tier === 'common') {
                                b.style.background = 'white';
                                b.style.color = '#28a745';
                            } else if (tier === 'rare') {
                                b.style.background = 'white';
                                b.style.color = '#007bff';
                            } else if (tier === 'epic') {
                                b.style.background = 'white';
                                b.style.color = '#6f42c1';
                            } else if (tier === 'legendary') {
                                b.style.background = 'white';
                                b.style.color = '#fd7e14';
                            }
                        });

                        // ÏÑ†ÌÉùÎêú Î≤ÑÌäº Í∞ïÏ°∞
                        if (selectedTier === 'all') {
                            this.style.background = '#007bff';
                            this.style.color = 'white';
                        } else if (selectedTier === 'common') {
                            this.style.background = '#28a745';
                            this.style.color = 'white';
                        } else if (selectedTier === 'rare') {
                            this.style.background = '#007bff';
                            this.style.color = 'white';
                        } else if (selectedTier === 'epic') {
                            this.style.background = '#6f42c1';
                            this.style.color = 'white';
                        } else if (selectedTier === 'legendary') {
                            this.style.background = '#fd7e14';
                            this.style.color = 'white';
                        }

                        // ÎèôÎ¨º ÌïÑÌÑ∞ÎßÅ
                        document.querySelectorAll('.animal-item-selectable').forEach(item => {
                            if (selectedTier === 'all' || item.getAttribute('data-tier') === selectedTier) {
                                item.style.display = 'block';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                });

            } catch (error) {
                console.error('ÎèôÎ¨º Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('user-animals').innerHTML = '<div class="error">ÎèôÎ¨º Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÎèôÎ¨º ÏÑ†ÌÉù
        function selectAnimal(animalData) {
            selectedAnimal = animalData;
            console.log('Selected animal:', selectedAnimal);
            document.getElementById('animal-selection').style.display = 'none';
            document.getElementById('showoff-form').style.display = 'block';
        }

        // ÏûêÎûëÌïòÍ∏∞ Ï†úÏ∂ú
        async function submitShowOff() {
            if (!selectedAnimal) {
                showError('ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const message = document.getElementById('showoff-message').value.trim();
            
            try {
                await eduPetSocial.showOffAnimal(selectedAnimal, message);
                showSuccess('ÏûêÎûëÌïòÍ∏∞Í∞Ä Í≤åÏãúÎêòÏóàÏäµÎãàÎã§!');
                closeShowOffModal();
                loadShowOffs(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
                showError('ÏûêÎûëÌïòÍ∏∞ Í≤åÏãúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä
        async function toggleLike(showOffId) {
            try {
                const result = await eduPetSocial.likeShowOff(showOffId);
                if (result) {
                    loadShowOffs(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                }
            } catch (error) {
                showError('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Í≤åÏãúÎ¨º ÏÇ≠Ï†ú
        async function deleteShowOffPost(showOffId) {
            if (!confirm('Ï†ïÎßê Ïù¥ Í≤åÏãúÎ¨ºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await eduPetSocial.deleteShowOff(showOffId);
                showSuccess('Í≤åÏãúÎ¨ºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                loadShowOffs(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
                showError(error.message || 'Í≤åÏãúÎ¨º ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Í≤åÏãúÎ¨º ÏàòÏ†ï
        async function editShowOff(showOffId, currentMessage) {
            const newMessage = prompt('ÏÉà Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (200Ïûê Ïù¥ÎÇ¥):', currentMessage);
            if (newMessage === null) return; // Ï∑®ÏÜå
            if (newMessage.trim() === '') {
                showError('Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                await eduPetSocial.updateShowOff(showOffId, newMessage);
                showSuccess('Í≤åÏãúÎ¨ºÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');

                // Î©îÏãúÏßÄ Î∂ÄÎ∂ÑÎßå ÏóÖÎç∞Ïù¥Ìä∏
                const messageDiv = document.getElementById(`message-${showOffId}`);
                if (messageDiv) {
                    messageDiv.innerHTML = `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${newMessage}</div>`;
                }
            } catch (error) {
                showError(error.message || 'Í≤åÏãúÎ¨º ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // ÎåìÍ∏Ä ÌÜ†Í∏Ä
        async function toggleComments(showOffId) {
            const commentsDiv = document.getElementById(`comments-${showOffId}`);

            if (commentsDiv.style.display === 'none') {
                commentsDiv.style.display = 'block';
                await loadComments(showOffId);
            } else {
                commentsDiv.style.display = 'none';
            }
        }

        // ÎåìÍ∏Ä Î°úÎìú
        async function loadComments(showOffId) {
            try {
                const comments = await eduPetSocial.getComments(showOffId);
                displayComments(showOffId, comments);
            } catch (error) {
                console.error('ÎåìÍ∏Ä Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById(`comments-list-${showOffId}`).innerHTML = '<div class="error">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÎåìÍ∏Ä ÌëúÏãú
        function displayComments(showOffId, comments) {
            const container = document.getElementById(`comments-list-${showOffId}`);

            if (!comments || comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-size: 0.9rem;">ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const html = comments.map(comment => {
                const timeAgo = getTimeAgo(comment.createdAt);
                const isOwner = currentUser && comment.userId === currentUser.uid;

                return `
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="display: flex; gap: 8px;">
                                <div style="font-size: 1.2rem;">${getAnimalEmoji(comment.avatarAnimal)}</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${comment.nickname}</div>
                                    <div style="font-size: 0.9rem; margin-top: 3px;">${comment.message}</div>
                                    <div style="font-size: 0.75rem; color: #6c757d; margin-top: 3px;">${timeAgo}</div>
                                </div>
                            </div>
                            ${isOwner ? `
                                <button class="btn btn-danger" style="padding: 3px 8px; font-size: 0.7rem;" onclick="deleteCommentFromShowOff('${showOffId}', '${comment.id}')">ÏÇ≠Ï†ú</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÎåìÍ∏Ä Ï∂îÍ∞Ä
        async function addCommentToShowOff(showOffId) {
            const input = document.getElementById(`comment-input-${showOffId}`);
            const comment = input.value.trim();

            if (!comment) {
                showError('ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                await eduPetSocial.addComment(showOffId, comment);
                input.value = '';
                await loadComments(showOffId);
                showSuccess('ÎåìÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.');

                // ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                loadShowOffs();
            } catch (error) {
                showError(error.message || 'ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // ÎåìÍ∏Ä ÏÇ≠Ï†ú
        async function deleteCommentFromShowOff(showOffId, commentId) {
            if (!confirm('Ï†ïÎßê Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await eduPetSocial.deleteComment(showOffId, commentId);
                await loadComments(showOffId);
                showSuccess('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');

                // ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                loadShowOffs();
            } catch (error) {
                showError(error.message || 'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Í∑∏Î£π ÏÉùÏÑ±
        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const resultDiv = document.getElementById('create-group-result');
            
            if (!groupName) {
                resultDiv.innerHTML = '<div class="error">Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
                return;
            }

            try {
                await eduPetSocial.createGroup(groupName, 'ÌïôÏäµ Í∑∏Î£π');
                resultDiv.innerHTML = '<div class="success">Í∑∏Î£πÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</div>';
                document.getElementById('group-name').value = '';
                
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠ Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌëúÏãú
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ÏÜåÏÖú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function clearSocialData() {
            // ÏàúÏúÑÌëú Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            leaderboardListeners.forEach(listener => {
                if (listener) eduPetLeaderboard.unsubscribeFromLeaderboard(listener);
            });
            leaderboardListeners = [];

            // ÏΩòÌÖêÏ∏† Ï¥àÍ∏∞Ìôî
            ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
            });

            const showoffList = document.getElementById('showoff-list');
            if (showoffList) showoffList.innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';

            const groupsList = document.getElementById('groups-list');
            if (groupsList) groupsList.innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';

            const profileStats = document.getElementById('profile-stats');
            if (profileStats) profileStats.innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function getAnimalEmoji(animal) {
            // animalÏù¥ Ïù¥ÎØ∏ Ïù¥Î™®ÏßÄÏù∏ Í≤ΩÏö∞ (animalCollectionÏùò emoji ÌïÑÎìú)
            if (typeof animal === 'string' && animal.match(/[\u{1F000}-\u{1F9FF}]/u)) {
                return animal;
            }

            // Î†àÍ±∞Ïãú: ÎèôÎ¨º Ïù¥Î¶ÑÏúºÎ°ú Ïù¥Î™®ÏßÄ Ï∞æÍ∏∞ (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
            const emojiMap = {
                'bunny': 'üê∞', 'cat': 'üê±', 'dog': 'üê∂', 'fox': 'ü¶ä', 'lion': 'ü¶Å',
                'tiger': 'üêÖ', 'bear': 'üêª', 'panda': 'üêº', 'koala': 'üê®', 'monkey': 'üêµ',
                'elephant': 'üêò', 'giraffe': 'ü¶í', 'zebra': 'ü¶ì', 'horse': 'üêé', 'cow': 'üêÑ',
                'pig': 'üê∑', 'sheep': 'üêë', 'chicken': 'üêî', 'penguin': 'üêß', 'owl': 'ü¶â',
            };

            return emojiMap[animal] || 'üêæ';
        }

        function getTierName(tier) {
            const tierNames = {
                'common': 'ÏùºÎ∞ò',
                'rare': 'Î†àÏñ¥',
                'epic': 'ÏóêÌîΩ',
                'legendary': 'Ï†ÑÏÑ§'
            };
            return tierNames[tier] || tier;
        }

        function formatValue(value, containerId) {
            if (containerId.includes('accuracy')) {
                return `${value}%`;
            } else if (containerId.includes('money')) {
                return `${value.toLocaleString()}Ïõê`;
            } else {
                return `${value.toLocaleString()}`;
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days}Ïùº Ï†Ñ`;
            if (hours > 0) return `${hours}ÏãúÍ∞Ñ Ï†Ñ`;
            if (minutes > 0) return `${minutes}Î∂Ñ Ï†Ñ`;
            return 'Î∞©Í∏à Ï†Ñ';
        }

        function showError(message) {
            // Í∞ÑÎã®Ìïú ÏóêÎü¨ ÌëúÏãú (Ïã§Ï†úÎ°úÎäî toastÎÇò Î™®Îã¨ ÏÇ¨Ïö©)
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '300px';
            
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>