<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet ì†Œì…œ í—ˆë¸Œ ğŸŒ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-leaderboard.js"></script>
    <script src="firebase-social.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .home-btn:hover {
            background: white;
            color: #ff9a9e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .auth-section {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .auth-section.authenticated {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .auth-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .input-group {
            display: flex;
            margin: 10px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-control {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px 0 0 25px;
            font-size: 1rem;
            outline: none;
        }

        .form-control:focus {
            border-color: #007bff;
        }

        .input-group .btn {
            border-radius: 0 25px 25px 0;
            margin: 0;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .user-info {
            flex: 1;
            margin-left: 15px;
        }

        .nickname {
            font-weight: 600;
            font-size: 1.1rem;
            color: #495057;
        }

        .avatar {
            font-size: 2rem;
        }

        .value {
            font-weight: bold;
            color: #007bff;
        }

        .online-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
            margin-left: 10px;
        }

        .online-status.offline {
            background: #6c757d;
        }

        .friends-section, .showoff-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .friend-item, .showoff-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .showoff-item {
            border-left: 4px solid #007bff;
        }

        .showoff-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .showoff-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .showoff-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .animal-showcase {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }

        .animal-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .animal-tier {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .tier-common { background: #28a745; color: white; }
        .tier-rare { background: #007bff; color: white; }
        .tier-epic { background: #6f42c1; color: white; }
        .tier-legendary { background: #fd7e14; color: white; }

        .showoff-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .like-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn:hover {
            color: #c82333;
        }

        .like-btn.liked {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 10% auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                padding: 12px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .home-btn {
                top: 15px;
                left: 15px;
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .leaderboard-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <div style="font-size: 2rem; animation: spin 1s linear infinite;">ğŸŒ</div>
            <div style="margin-top: 10px; font-weight: bold; color: #495057;">ì†Œì…œ í—ˆë¸Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <div class="container">
        <div class="header">
            <a href="index.html" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
            <h1>ğŸŒ EduPet ì†Œì…œ í—ˆë¸Œ</h1>
            <p>ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ê³µë¶€í•˜ê³  ê²½ìŸí•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div id="auth-section" class="auth-section">
            <div id="auth-status" class="auth-status">
                ë¡œë”© ì¤‘...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('leaderboards')">ğŸ† ìˆœìœ„í‘œ</button>
            <button class="nav-tab" onclick="showTab('profile')">ğŸ‘¤ í”„ë¡œí•„</button>
            <button class="nav-tab" onclick="showTab('showoff')">ğŸ¾ ìë‘í•˜ê¸°</button>
            <button class="nav-tab" onclick="showTab('groups')">ğŸ¯ ê·¸ë£¹</button>
        </div>

        <!-- ìˆœìœ„í‘œ íƒ­ -->
        <div id="leaderboards" class="tab-content active">
            <h2>ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„í‘œ</h2>
            
            <div class="leaderboard">
                <h3>ğŸ§  í€´ì¦ˆ ë§ˆìŠ¤í„°</h3>
                <div id="quiz-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ¯ ì •í™•ë„ í‚¹</h3>
                <div id="accuracy-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ’° ë¶€ì ë­í‚¹</h3>
                <div id="money-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ¾ ë™ë¬¼ ì»¬ë ‰í„°</h3>
                <div id="animal-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- í”„ë¡œí•„ íƒ­ -->
        <div id="profile" class="tab-content">
            <h2>ğŸ‘¤ ë‚´ í”„ë¡œí•„</h2>

            <div class="friends-section">
                <h3>ì•„ë°”íƒ€ ë™ë¬¼ ì„ íƒ</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">ìˆœìœ„í‘œì™€ ê²Œì‹œë¬¼ì— í‘œì‹œë  ì•„ë°”íƒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div id="avatar-selection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <!-- ë™ë¬¼ ì•„ë°”íƒ€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary" style="padding: 12px 40px; font-size: 1.1rem;" onclick="applyAvatarChange()">
                        âœ… ì ìš©í•˜ê¸°
                    </button>
                </div>
                <div id="avatar-apply-result" style="margin-top: 15px;"></div>
            </div>

            <div class="friends-section">
                <h3>ë‚´ í†µê³„</h3>
                <div id="profile-stats" class="loading">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ìë‘í•˜ê¸° íƒ­ -->
        <div id="showoff" class="tab-content">
            <h2>ğŸ¾ ë™ë¬¼ ìë‘í•˜ê¸°</h2>
            
            <div class="showoff-section">
                <h3>ìƒˆ ìë‘í•˜ê¸°</h3>
                <button class="btn btn-primary" onclick="openShowOffModal()">ë™ë¬¼ ìë‘í•˜ê¸°</button>
            </div>

            <div class="showoff-section">
                <h3>ìµœê·¼ ìë‘í•˜ê¸°</h3>
                <div id="showoff-list" class="loading">ìë‘í•˜ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ê·¸ë£¹ íƒ­ -->
        <div id="groups" class="tab-content">
            <h2>ğŸ¯ í•™ìŠµ ê·¸ë£¹</h2>
            
            <div class="friends-section">
                <h3>ê·¸ë£¹ ìƒì„±</h3>
                <div class="input-group">
                    <input type="text" id="group-name" class="form-control" placeholder="ê·¸ë£¹ ì´ë¦„ ì…ë ¥">
                    <button class="btn btn-primary" onclick="createGroup()">ìƒì„±</button>
                </div>
                <div id="create-group-result"></div>
            </div>

            <div class="friends-section">
                <h3>ë‚´ ê·¸ë£¹</h3>
                <div id="groups-list" class="loading">ê·¸ë£¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ìë‘í•˜ê¸° ëª¨ë‹¬ -->
    <div id="showoff-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShowOffModal()">&times;</span>
            <h3>ğŸ¾ ë™ë¬¼ ìë‘í•˜ê¸°</h3>
            <div id="animal-selection">
                <p>ìë‘í•  ë™ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”:</p>
                <div id="user-animals" class="loading">ë™ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div id="showoff-form" style="display: none;">
                <textarea id="showoff-message" placeholder="ìë‘í•˜ê³  ì‹¶ì€ ë§ì„ ì¨ì£¼ì„¸ìš”! (200ì ì´ë‚´)" maxlength="200" style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; resize: none;"></textarea>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="submitShowOff()">ìë‘í•˜ê¸° ê²Œì‹œ</button>
                    <button class="btn btn-secondary" onclick="closeShowOffModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let selectedAnimal = null;
        let leaderboardListeners = [];
        let tempSelectedAvatar = null; // ì„ì‹œ ì„ íƒëœ ì•„ë°”íƒ€

        // í˜ì´ì§€ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            try {
                // eduPetAuth and eduPetFirebaseIntegrationê°€ ì •ì˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                console.log('Waiting for Firebase modules to load...');
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 100; // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                    const interval = setInterval(() => {
                        attempts++;
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            console.log('Firebase modules loaded successfully');
                            clearInterval(interval);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            reject(new Error('Firebase ëª¨ë“ˆ ë¡œë“œ íƒ€ì„ì•„ì›ƒ'));
                        }
                    }, 50);
                });

                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆë¥¼ ë¨¼ì € ì„¤ì •í•©ë‹ˆë‹¤.
                eduPetAuth.addAuthStateListener(onAuthStateChanged);
                console.log('Auth state listener added');

                // Firebase í†µí•© ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ì´ ê³¼ì •ì—ì„œ ìµëª… ë¡œê·¸ì¸ì´ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

            } catch (error) {
                console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                showError('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                loadingOverlay.style.display = 'none';
            }
        });

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬
        async function onAuthStateChanged(state, userData) {
            currentUser = userData;

            if (state === 'signed_in') {
                // localStorageì—ì„œ íŠœí† ë¦¬ì–¼ì—ì„œ ì„¤ì •í•œ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
                let displayName = 'ìµëª…';
                let needsSync = false;

                try {
                    // 1. localStorageì—ì„œ ë¨¼ì € í™•ì¸ (íŠœí† ë¦¬ì–¼ì—ì„œ ì„¤ì •)
                    const settings = JSON.parse(localStorage.getItem('eduPetSettings') || '{}');
                    if (settings.userName) {
                        displayName = settings.userName;

                        // Firebaseì— ë‹‰ë„¤ì„ì´ ì—†ê±°ë‚˜ ë‹¤ë¥´ë©´ ë™ê¸°í™” í•„ìš”
                        if (!userData?.profile?.nickname || userData.profile.nickname !== displayName) {
                            needsSync = true;
                        }
                    }
                    // 2. localStorageì— ì—†ìœ¼ë©´ Firebaseì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    else if (userData?.profile?.nickname) {
                        displayName = userData.profile.nickname;
                    }

                    // Firebaseì— ë‹‰ë„¤ì„ ë™ê¸°í™” (ë¹„ë™ê¸°)
                    if (needsSync && typeof eduPetAuth !== 'undefined') {
                        console.log('ğŸ”„ Syncing nickname to Firebase:', displayName);
                        eduPetAuth.setNickname(displayName).then(() => {
                            console.log('âœ… Firebase ë‹‰ë„¤ì„ ë™ê¸°í™” ì™„ë£Œ');
                        }).catch(err => {
                            console.warn('âš ï¸ Firebase ë‹‰ë„¤ì„ ë™ê¸°í™” ì‹¤íŒ¨:', err);
                        });
                    }
                } catch (error) {
                    console.error('ë‹‰ë„¤ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
                    displayName = userData?.profile?.nickname || 'ìµëª…';
                }

                showAuthStatus(`í™˜ì˜í•©ë‹ˆë‹¤, ${displayName}ë‹˜! ğŸ‰`);
                loadSocialData();
            } else {
                showAuthStatus('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                clearSocialData();
            }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ì¸ì¦ ìƒíƒœ í‘œì‹œ
        function showAuthStatus(message) {
            document.getElementById('auth-status').textContent = message;
            
            const authSection = document.getElementById('auth-section');
            if (currentUser) {
                authSection.classList.add('authenticated');
            } else {
                authSection.classList.remove('authenticated');
            }
        }

        // ì¸ì¦ ì»¨íŠ¸ë¡¤ í‘œì‹œ (ì œê±°ë¨ - ë³„ëª… ì„¤ì • UI ì œê±°)


        // ì†Œì…œ ë°ì´í„° ë¡œë“œ
        function loadSocialData() {
            loadLeaderboards();
            loadShowOffs();
            loadProfileData();
        }

        // ìˆœìœ„í‘œ ë¡œë“œ
        async function loadLeaderboards() {
            if (typeof eduPetLeaderboard === 'undefined') {
                console.error('eduPetLeaderboardê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const types = ['quiz_score', 'quiz_accuracy', 'money_collector', 'animal_collector'];
            const containers = ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'];

            for (let i = 0; i < types.length; i++) {
                try {
                    console.log(`Loading leaderboard: ${types[i]}`);
                    const leaderboard = await eduPetLeaderboard.getLeaderboard(types[i], 10);
                    displayLeaderboard(leaderboard, containers[i]);
                } catch (error) {
                    console.error(`ìˆœìœ„í‘œ ${types[i]} ë¡œë“œ ì‹¤íŒ¨:`, error);
                    document.getElementById(containers[i]).innerHTML = '<div class="error">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }
        }

        // ìˆœìœ„í‘œ í‘œì‹œ
        function displayLeaderboard(leaderboard, containerId) {
            const container = document.getElementById(containerId);

            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            console.log('Displaying leaderboard for', containerId, ':', leaderboard);

            const html = leaderboard.map((user, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const onlineStatus = user.isOnline ? 'online' : 'offline';
                const avatarEmoji = getAnimalEmoji(user.avatarAnimal);

                console.log(`User ${user.nickname}: avatarAnimal=${user.avatarAnimal}, emoji=${avatarEmoji}`);

                return `
                    <div class="leaderboard-item">
                        <div class="rank ${rankClass}">${user.rank}</div>
                        <div class="avatar">${avatarEmoji}</div>
                        <div class="user-info">
                            <div class="nickname">
                                ${user.nickname}
                                <span class="online-status ${onlineStatus}"></span>
                            </div>
                        </div>
                        <div class="value">${formatValue(user.value, containerId)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
        async function loadProfileData() {
            try {
                // ì•„ë°”íƒ€ ë™ë¬¼ ëª©ë¡ ë¡œë“œ
                loadAvatarSelection();

                // í†µê³„ ë¡œë“œ
                loadProfileStats();
            } catch (error) {
                console.error('í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì•„ë°”íƒ€ ì„ íƒ UI ë¡œë“œ
        function loadAvatarSelection() {
            const avatarContainer = document.getElementById('avatar-selection');
            if (!avatarContainer) return;

            // ì‚¬ìš© ê°€ëŠ¥í•œ ë™ë¬¼ ì•„ë°”íƒ€ ëª©ë¡
            const availableAvatars = [
                { id: 'bunny', emoji: 'ğŸ°', name: 'í† ë¼' },
                { id: 'cat', emoji: 'ğŸ±', name: 'ê³ ì–‘ì´' },
                { id: 'dog', emoji: 'ğŸ¶', name: 'ê°•ì•„ì§€' },
                { id: 'fox', emoji: 'ğŸ¦Š', name: 'ì—¬ìš°' },
                { id: 'lion', emoji: 'ğŸ¦', name: 'ì‚¬ì' },
                { id: 'tiger', emoji: 'ğŸ…', name: 'í˜¸ë‘ì´' },
                { id: 'bear', emoji: 'ğŸ»', name: 'ê³°' },
                { id: 'panda', emoji: 'ğŸ¼', name: 'íŒë‹¤' },
                { id: 'koala', emoji: 'ğŸ¨', name: 'ì½”ì•Œë¼' },
                { id: 'monkey', emoji: 'ğŸµ', name: 'ì›ìˆ­ì´' },
                { id: 'elephant', emoji: 'ğŸ˜', name: 'ì½”ë¼ë¦¬' },
                { id: 'giraffe', emoji: 'ğŸ¦’', name: 'ê¸°ë¦°' },
                { id: 'zebra', emoji: 'ğŸ¦“', name: 'ì–¼ë£©ë§' },
                { id: 'horse', emoji: 'ğŸ', name: 'ë§' },
                { id: 'cow', emoji: 'ğŸ„', name: 'ì†Œ' },
                { id: 'pig', emoji: 'ğŸ·', name: 'ë¼ì§€' },
                { id: 'sheep', emoji: 'ğŸ‘', name: 'ì–‘' },
                { id: 'chicken', emoji: 'ğŸ”', name: 'ë‹­' },
                { id: 'penguin', emoji: 'ğŸ§', name: 'í­ê·„' },
                { id: 'owl', emoji: 'ğŸ¦‰', name: 'ì˜¬ë¹¼ë¯¸' }
            ];

            const currentAvatar = currentUser?.profile?.avatarAnimal || 'bunny';

            // ì„ì‹œ ì„ íƒì´ ì—†ìœ¼ë©´ í˜„ì¬ ì•„ë°”íƒ€ë¥¼ ì„ì‹œ ì„ íƒìœ¼ë¡œ ì„¤ì •
            if (!tempSelectedAvatar) {
                tempSelectedAvatar = currentAvatar;
            }

            const html = availableAvatars.map(avatar => {
                const isSelected = avatar.id === tempSelectedAvatar;
                return `
                    <div id="avatar-${avatar.id}" onclick="selectAvatarTemp('${avatar.id}')" style="
                        padding: 15px;
                        background: ${isSelected ? '#007bff' : 'white'};
                        border: 2px solid ${isSelected ? '#007bff' : '#dee2e6'};
                        border-radius: 10px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s;
                        ${isSelected ? 'transform: scale(1.1);' : ''}
                    " onmouseover="this.style.borderColor='#007bff'" onmouseout="if('${avatar.id}' !== '${tempSelectedAvatar}') this.style.borderColor='#dee2e6'">
                        <div style="font-size: 2rem; margin-bottom: 5px;">${avatar.emoji}</div>
                        <div style="font-size: 0.75rem; color: ${isSelected ? 'white' : '#495057'}; font-weight: ${isSelected ? 'bold' : 'normal'};">${avatar.name}</div>
                    </div>
                `;
            }).join('');

            avatarContainer.innerHTML = html;
        }

        // ì•„ë°”íƒ€ ì„ì‹œ ì„ íƒ (ì•„ì§ ì €ì¥ ì•ˆ í•¨)
        function selectAvatarTemp(avatarId) {
            if (!currentUser) {
                showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            tempSelectedAvatar = avatarId;

            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('[id^="avatar-"]').forEach(el => {
                const id = el.id.replace('avatar-', '');
                const isSelected = id === avatarId;

                el.style.background = isSelected ? '#007bff' : 'white';
                el.style.borderColor = isSelected ? '#007bff' : '#dee2e6';
                el.style.transform = isSelected ? 'scale(1.1)' : 'scale(1)';

                const nameElement = el.querySelector('div:last-child');
                if (nameElement) {
                    nameElement.style.color = isSelected ? 'white' : '#495057';
                    nameElement.style.fontWeight = isSelected ? 'bold' : 'normal';
                }
            });
        }

        // ì•„ë°”íƒ€ ë³€ê²½ ì ìš©
        async function applyAvatarChange() {
            const resultDiv = document.getElementById('avatar-apply-result');

            if (!tempSelectedAvatar) {
                resultDiv.innerHTML = '<div class="error">ì•„ë°”íƒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            if (!currentUser) {
                resultDiv.innerHTML = '<div class="error">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div style="text-align: center; color: #007bff;">ì ìš© ì¤‘...</div>';

                // Firebaseì— ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
                await firebase_db.ref(`users/${currentUser.profile.uid}/profile/avatarAnimal`).set(tempSelectedAvatar);

                // í˜„ì¬ ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸
                if (currentUser.profile) {
                    currentUser.profile.avatarAnimal = tempSelectedAvatar;
                }

                resultDiv.innerHTML = '<div class="success">âœ… ì•„ë°”íƒ€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.</div>';

                // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('ì•„ë°”íƒ€ ì ìš© ì‹¤íŒ¨:', error);
                resultDiv.innerHTML = '<div class="error">ì•„ë°”íƒ€ ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }


        // í”„ë¡œí•„ í†µê³„ ë¡œë“œ
        async function loadProfileStats() {
            const container = document.getElementById('profile-stats');
            if (!container) return;

            try {
                if (!currentUser) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                    return;
                }

                const statsSnapshot = await firebase_db.ref(`users/${currentUser.uid}/stats`).once('value');
                const stats = statsSnapshot.val() || {};

                const html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ§ </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #007bff;">${stats.correctAnswers || 0}</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">ì •ë‹µ ìˆ˜</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ¯</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${stats.quizAccuracy || 0}%</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">ì •í™•ë„</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ’°</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${(stats.moneyCollected || 0).toLocaleString()}ì›</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">ë³´ìœ  ê¸ˆì•¡</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ¾</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #6f42c1;">${stats.animalsCollected || 0}</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">ìˆ˜ì§‘í•œ ë™ë¬¼</div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('í”„ë¡œí•„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = '<div class="error">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìë‘í•˜ê¸° ëª©ë¡ ë¡œë“œ
        async function loadShowOffs() {
            if (typeof eduPetSocial === 'undefined') {
                console.error('eduPetSocialê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                document.getElementById('showoff-list').innerHTML = '<div class="error">ì†Œì…œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            try {
                console.log('Loading show-offs...');
                const showOffs = await eduPetSocial.getShowOffs(20);
                displayShowOffs(showOffs);
            } catch (error) {
                console.error('ìë‘í•˜ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('showoff-list').innerHTML = '<div class="error">ìë‘í•˜ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìë‘í•˜ê¸° ëª©ë¡ í‘œì‹œ
        function displayShowOffs(showOffs) {
            const container = document.getElementById('showoff-list');

            if (!showOffs || showOffs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ì•„ì§ ìë‘í•˜ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ë¡œ ìë‘í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            const html = showOffs.map(showOff => {
                const timeAgo = getTimeAgo(showOff.createdAt);
                const isLiked = showOff.likedBy && showOff.likedBy[currentUser?.profile?.uid];
                const isOwner = currentUser && showOff.userId === currentUser.uid;
                const commentCount = showOff.comments ? Object.keys(showOff.comments).length : 0;

                return `
                    <div class="showoff-item" id="showoff-${showOff.id}">
                        <div class="showoff-header">
                            <div class="showoff-user">
                                <div class="avatar">${getAnimalEmoji(showOff.userAvatar)}</div>
                                <div>
                                    <div class="nickname">${showOff.userNickname}</div>
                                    <div class="showoff-time">${timeAgo}${showOff.updatedAt ? ' (ìˆ˜ì •ë¨)' : ''}</div>
                                </div>
                            </div>
                            ${isOwner ? `
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="editShowOff('${showOff.id}', '${(showOff.message || '').replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteShowOffPost('${showOff.id}')">ì‚­ì œ</button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="animal-showcase">
                            <div class="animal-name">${showOff.animal.name}</div>
                            <div class="animal-tier tier-${showOff.animal.tier}">${getTierName(showOff.animal.tier)}</div>
                            <div style="font-size: 3rem; margin: 10px 0;">${showOff.animal.emoji || getAnimalEmoji(showOff.animal.name)}</div>
                            ${showOff.animal.level > 1 ? `<div style="color: #f59e0b; font-weight: bold; margin: 5px 0;">ë ˆë²¨ ${showOff.animal.level} ${'â­'.repeat(showOff.animal.level)}</div>` : ''}
                            ${showOff.animal.totalPower ? `<div style="color: #8b5cf6; font-weight: bold;">âš¡ íŒŒì›Œ: ${showOff.animal.totalPower}</div>` : ''}
                        </div>

                        <div id="message-${showOff.id}">
                            ${showOff.message ? `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${showOff.message}</div>` : ''}
                        </div>

                        <div class="showoff-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${showOff.id}')">
                                â¤ï¸ ${showOff.likes || 0}
                            </button>
                            <button class="like-btn" onclick="toggleComments('${showOff.id}')">
                                ğŸ’¬ ${commentCount}
                            </button>
                        </div>

                        <!-- ëŒ“ê¸€ ì˜ì—­ (í•­ìƒ í‘œì‹œ) -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <!-- ëŒ“ê¸€ ì…ë ¥ (í•­ìƒ ë³´ì„) -->
                            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                                <input type="text" id="comment-input-${showOff.id}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (100ì ì´ë‚´)" maxlength="100" style="flex: 1; padding: 8px; border: 2px solid #dee2e6; border-radius: 20px;">
                                <button class="btn btn-primary" style="padding: 8px 16px;" onclick="addCommentToShowOff('${showOff.id}')">ì‘ì„±</button>
                            </div>
                            <!-- ëŒ“ê¸€ ëª©ë¡ (í† ê¸€ ê°€ëŠ¥) -->
                            <div id="comments-${showOff.id}" style="display: none;">
                                <div id="comments-list-${showOff.id}">
                                    <div class="loading">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ìë‘í•˜ê¸° ëª¨ë‹¬ ì—´ê¸°
        function openShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'block';
            loadUserAnimals();
        }

        // ìë‘í•˜ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'none';
            selectedAnimal = null;
            document.getElementById('showoff-form').style.display = 'none';
            document.getElementById('animal-selection').style.display = 'block';
        }

        // ì‚¬ìš©ì ë™ë¬¼ ëª©ë¡ ë¡œë“œ
        function loadUserAnimals() {
            try {
                // animalCollection localStorage ì‚¬ìš© (animal-collection.htmlê³¼ ë™ì¼)
                const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
                const collection = animalCollection.collection || {};

                console.log('Loading user animals from animalCollection:', collection);
                console.log('Collection keys:', Object.keys(collection));

                if (Object.keys(collection).length === 0) {
                    document.getElementById('user-animals').innerHTML =
                        '<p style="text-align: center; color: #6c757d;">ì•„ì§ ìˆ˜ì§‘í•œ ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë™ë¬¼ ì»¬ë ‰ì…˜ì—ì„œ ë™ë¬¼ì„ ëª¨ì•„ë³´ì„¸ìš”!</p>';
                    return;
                }

                // collection ê°ì²´ëŠ” { animalId: animalData } í˜•íƒœ
                // count > 0ì¸ ë™ë¬¼ë§Œ í‘œì‹œ (ì‹¤ì œë¡œ ì†Œìœ í•œ ë™ë¬¼ë§Œ)
                let ownedAnimals = Object.entries(collection).filter(([animalId, animalData]) => {
                    return (animalData.count || 0) > 0;
                });

                console.log('Owned animals (count > 0):', ownedAnimals);

                if (ownedAnimals.length === 0) {
                    document.getElementById('user-animals').innerHTML =
                        '<p style="text-align: center; color: #6c757d;">ì•„ì§ ìˆ˜ì§‘í•œ ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë™ë¬¼ ì»¬ë ‰ì…˜ì—ì„œ ë™ë¬¼ì„ ëª¨ì•„ë³´ì„¸ìš”!</p>';
                    return;
                }

                // ë“±ê¸‰ í•„í„° ë²„íŠ¼ ì¶”ê°€
                const filterButtons = `
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="tier-filter-btn" data-tier="all" style="padding: 8px 16px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 20px; cursor: pointer; font-weight: 600;">ì „ì²´</button>
                        <button class="tier-filter-btn" data-tier="common" style="padding: 8px 16px; border: 2px solid #28a745; background: white; color: #28a745; border-radius: 20px; cursor: pointer; font-weight: 600;">ì¼ë°˜</button>
                        <button class="tier-filter-btn" data-tier="rare" style="padding: 8px 16px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 20px; cursor: pointer; font-weight: 600;">ë ˆì–´</button>
                        <button class="tier-filter-btn" data-tier="epic" style="padding: 8px 16px; border: 2px solid #6f42c1; background: white; color: #6f42c1; border-radius: 20px; cursor: pointer; font-weight: 600;">ì—í”½</button>
                        <button class="tier-filter-btn" data-tier="legendary" style="padding: 8px 16px; border: 2px solid #fd7e14; background: white; color: #fd7e14; border-radius: 20px; cursor: pointer; font-weight: 600;">ì „ì„¤</button>
                    </div>
                `;

                // ë™ë¬¼ ëª©ë¡ ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
                const animalListHtml = ownedAnimals.map(([animalId, animalData]) => {
                    // animal-collection.htmlê³¼ ë™ì¼í•œ ë°ì´í„° êµ¬ì¡° ì‚¬ìš©
                    const level = animalData.level || 1;
                    const stars = 'â­'.repeat(level);

                    return `
                        <div class="friend-item animal-item-selectable" data-tier="${animalData.tier}" style="cursor: pointer;" onclick='selectAnimal(${JSON.stringify(animalData).replace(/'/g, "\\'")})'>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 2rem;">${animalData.emoji || 'ğŸ¾'}</div>
                                <div style="flex: 1;">
                                    <div class="nickname">
                                        ${animalData.name}
                                        ${level > 1 ? `<span style="color: #f59e0b; font-size: 0.9rem; margin-left: 5px;">Lv.${level}</span>` : ''}
                                    </div>
                                    <div class="animal-tier tier-${animalData.tier}" style="font-size: 0.8rem; margin-top: 5px;">
                                        ${getTierName(animalData.tier)}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 3px;">
                                        ${stars} | âš¡${animalData.totalPower || animalData.power || 1} | ${animalData.count || 1}ë§ˆë¦¬
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆì— ë™ë¬¼ ëª©ë¡ ì¶”ê°€
                document.getElementById('user-animals').innerHTML = `
                    ${filterButtons}
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid #dee2e6; border-radius: 10px; padding: 10px;">
                        ${animalListHtml}
                    </div>
                `;

                // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                document.querySelectorAll('.tier-filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const selectedTier = this.getAttribute('data-tier');

                        // ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                        document.querySelectorAll('.tier-filter-btn').forEach(b => {
                            const tier = b.getAttribute('data-tier');
                            if (tier === 'all') {
                                b.style.background = 'white';
                                b.style.color = '#007bff';
                            } else if (tier === 'common') {
                                b.style.background = 'white';
                                b.style.color = '#28a745';
                            } else if (tier === 'rare') {
                                b.style.background = 'white';
                                b.style.color = '#007bff';
                            } else if (tier === 'epic') {
                                b.style.background = 'white';
                                b.style.color = '#6f42c1';
                            } else if (tier === 'legendary') {
                                b.style.background = 'white';
                                b.style.color = '#fd7e14';
                            }
                        });

                        // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
                        if (selectedTier === 'all') {
                            this.style.background = '#007bff';
                            this.style.color = 'white';
                        } else if (selectedTier === 'common') {
                            this.style.background = '#28a745';
                            this.style.color = 'white';
                        } else if (selectedTier === 'rare') {
                            this.style.background = '#007bff';
                            this.style.color = 'white';
                        } else if (selectedTier === 'epic') {
                            this.style.background = '#6f42c1';
                            this.style.color = 'white';
                        } else if (selectedTier === 'legendary') {
                            this.style.background = '#fd7e14';
                            this.style.color = 'white';
                        }

                        // ë™ë¬¼ í•„í„°ë§
                        document.querySelectorAll('.animal-item-selectable').forEach(item => {
                            if (selectedTier === 'all' || item.getAttribute('data-tier') === selectedTier) {
                                item.style.display = 'block';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                });

            } catch (error) {
                console.error('ë™ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('user-animals').innerHTML = '<div class="error">ë™ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ë™ë¬¼ ì„ íƒ
        function selectAnimal(animalData) {
            selectedAnimal = animalData;
            console.log('Selected animal:', selectedAnimal);
            document.getElementById('animal-selection').style.display = 'none';
            document.getElementById('showoff-form').style.display = 'block';
        }

        // ìë‘í•˜ê¸° ì œì¶œ
        async function submitShowOff() {
            if (!selectedAnimal) {
                showError('ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const message = document.getElementById('showoff-message').value.trim();
            
            try {
                await eduPetSocial.showOffAnimal(selectedAnimal, message);
                showSuccess('ìë‘í•˜ê¸°ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeShowOffModal();
                loadShowOffs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                showError('ìë‘í•˜ê¸° ê²Œì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¢‹ì•„ìš” í† ê¸€
        async function toggleLike(showOffId) {
            try {
                const result = await eduPetSocial.likeShowOff(showOffId);
                if (result) {
                    loadShowOffs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                showError('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²Œì‹œë¬¼ ì‚­ì œ
        async function deleteShowOffPost(showOffId) {
            if (!confirm('ì •ë§ ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await eduPetSocial.deleteShowOff(showOffId);
                showSuccess('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadShowOffs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                showError(error.message || 'ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²Œì‹œë¬¼ ìˆ˜ì •
        async function editShowOff(showOffId, currentMessage) {
            const newMessage = prompt('ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (200ì ì´ë‚´):', currentMessage);
            if (newMessage === null) return; // ì·¨ì†Œ
            if (newMessage.trim() === '') {
                showError('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                await eduPetSocial.updateShowOff(showOffId, newMessage);
                showSuccess('ê²Œì‹œë¬¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ë©”ì‹œì§€ ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸
                const messageDiv = document.getElementById(`message-${showOffId}`);
                if (messageDiv) {
                    messageDiv.innerHTML = `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${newMessage}</div>`;
                }
            } catch (error) {
                showError(error.message || 'ê²Œì‹œë¬¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ í† ê¸€
        async function toggleComments(showOffId) {
            const commentsDiv = document.getElementById(`comments-${showOffId}`);

            if (commentsDiv.style.display === 'none') {
                commentsDiv.style.display = 'block';
                await loadComments(showOffId);
            } else {
                commentsDiv.style.display = 'none';
            }
        }

        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments(showOffId) {
            try {
                const comments = await eduPetSocial.getComments(showOffId);
                displayComments(showOffId, comments);
            } catch (error) {
                console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById(`comments-list-${showOffId}`).innerHTML = '<div class="error">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ëŒ“ê¸€ í‘œì‹œ
        function displayComments(showOffId, comments) {
            const container = document.getElementById(`comments-list-${showOffId}`);

            if (!comments || comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-size: 0.9rem;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const html = comments.map(comment => {
                const timeAgo = getTimeAgo(comment.createdAt);
                const isOwner = currentUser && comment.userId === currentUser.uid;

                return `
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="display: flex; gap: 8px;">
                                <div style="font-size: 1.2rem;">${getAnimalEmoji(comment.avatarAnimal)}</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${comment.nickname}</div>
                                    <div style="font-size: 0.9rem; margin-top: 3px;">${comment.message}</div>
                                    <div style="font-size: 0.75rem; color: #6c757d; margin-top: 3px;">${timeAgo}</div>
                                </div>
                            </div>
                            ${isOwner ? `
                                <button class="btn btn-danger" style="padding: 3px 8px; font-size: 0.7rem;" onclick="deleteCommentFromShowOff('${showOffId}', '${comment.id}')">ì‚­ì œ</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ëŒ“ê¸€ ì¶”ê°€
        async function addCommentToShowOff(showOffId) {
            const input = document.getElementById(`comment-input-${showOffId}`);
            const comment = input.value.trim();

            if (!comment) {
                showError('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                await eduPetSocial.addComment(showOffId, comment);
                input.value = '';
                await loadComments(showOffId);
                showSuccess('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìë‘í•˜ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadShowOffs();
            } catch (error) {
                showError(error.message || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteCommentFromShowOff(showOffId, commentId) {
            if (!confirm('ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await eduPetSocial.deleteComment(showOffId, commentId);
                await loadComments(showOffId);
                showSuccess('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìë‘í•˜ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadShowOffs();
            } catch (error) {
                showError(error.message || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê·¸ë£¹ ìƒì„±
        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const resultDiv = document.getElementById('create-group-result');
            
            if (!groupName) {
                resultDiv.innerHTML = '<div class="error">ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            try {
                await eduPetSocial.createGroup(groupName, 'í•™ìŠµ ê·¸ë£¹');
                resultDiv.innerHTML = '<div class="success">ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                document.getElementById('group-name').value = '';
                
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ì†Œì…œ ë°ì´í„° ì´ˆê¸°í™”
        function clearSocialData() {
            // ìˆœìœ„í‘œ ë¦¬ìŠ¤ë„ˆ ì œê±°
            leaderboardListeners.forEach(listener => {
                if (listener) eduPetLeaderboard.unsubscribeFromLeaderboard(listener);
            });
            leaderboardListeners = [];

            // ì½˜í…ì¸  ì´ˆê¸°í™”
            ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
            });

            const showoffList = document.getElementById('showoff-list');
            if (showoffList) showoffList.innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';

            const groupsList = document.getElementById('groups-list');
            if (groupsList) groupsList.innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';

            const profileStats = document.getElementById('profile-stats');
            if (profileStats) profileStats.innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getAnimalEmoji(animal) {
            // animalì´ ì´ë¯¸ ì´ëª¨ì§€ì¸ ê²½ìš° (animalCollectionì˜ emoji í•„ë“œ)
            if (typeof animal === 'string' && animal.match(/[\u{1F000}-\u{1F9FF}]/u)) {
                return animal;
            }

            // ë ˆê±°ì‹œ: ë™ë¬¼ ì´ë¦„ìœ¼ë¡œ ì´ëª¨ì§€ ì°¾ê¸° (í•˜ìœ„ í˜¸í™˜ì„±)
            const emojiMap = {
                'bunny': 'ğŸ°', 'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'fox': 'ğŸ¦Š', 'lion': 'ğŸ¦',
                'tiger': 'ğŸ…', 'bear': 'ğŸ»', 'panda': 'ğŸ¼', 'koala': 'ğŸ¨', 'monkey': 'ğŸµ',
                'elephant': 'ğŸ˜', 'giraffe': 'ğŸ¦’', 'zebra': 'ğŸ¦“', 'horse': 'ğŸ', 'cow': 'ğŸ„',
                'pig': 'ğŸ·', 'sheep': 'ğŸ‘', 'chicken': 'ğŸ”', 'penguin': 'ğŸ§', 'owl': 'ğŸ¦‰',
            };

            return emojiMap[animal] || 'ğŸ¾';
        }

        function getTierName(tier) {
            const tierNames = {
                'common': 'ì¼ë°˜',
                'rare': 'ë ˆì–´',
                'epic': 'ì—í”½',
                'legendary': 'ì „ì„¤'
            };
            return tierNames[tier] || tier;
        }

        function formatValue(value, containerId) {
            if (containerId.includes('accuracy')) {
                return `${value}%`;
            } else if (containerId.includes('money')) {
                return `${value.toLocaleString()}ì›`;
            } else {
                return `${value.toLocaleString()}`;
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days}ì¼ ì „`;
            if (hours > 0) return `${hours}ì‹œê°„ ì „`;
            if (minutes > 0) return `${minutes}ë¶„ ì „`;
            return 'ë°©ê¸ˆ ì „';
        }

        function showError(message) {
            // ê°„ë‹¨í•œ ì—ëŸ¬ í‘œì‹œ (ì‹¤ì œë¡œëŠ” toastë‚˜ ëª¨ë‹¬ ì‚¬ìš©)
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '300px';
            
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>