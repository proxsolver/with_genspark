<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet ì†Œì…œ í—ˆë¸Œ ğŸŒ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-auth.js"></script>
    <script defer src="firebase-leaderboard.js"></script>
    <script defer src="firebase-social.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .auth-section {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .auth-section.authenticated {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .auth-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .input-group {
            display: flex;
            margin: 10px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-control {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px 0 0 25px;
            font-size: 1rem;
            outline: none;
        }

        .form-control:focus {
            border-color: #007bff;
        }

        .input-group .btn {
            border-radius: 0 25px 25px 0;
            margin: 0;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .user-info {
            flex: 1;
            margin-left: 15px;
        }

        .nickname {
            font-weight: 600;
            font-size: 1.1rem;
            color: #495057;
        }

        .avatar {
            font-size: 2rem;
        }

        .value {
            font-weight: bold;
            color: #007bff;
        }

        .online-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
            margin-left: 10px;
        }

        .online-status.offline {
            background: #6c757d;
        }

        .friends-section, .showoff-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .friend-item, .showoff-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .showoff-item {
            border-left: 4px solid #007bff;
        }

        .showoff-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .showoff-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .showoff-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .animal-showcase {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }

        .animal-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .animal-tier {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .tier-common { background: #28a745; color: white; }
        .tier-rare { background: #007bff; color: white; }
        .tier-epic { background: #6f42c1; color: white; }
        .tier-legendary { background: #fd7e14; color: white; }

        .showoff-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .like-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn:hover {
            color: #c82333;
        }

        .like-btn.liked {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 10% auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                padding: 12px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .leaderboard-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-2xl animate-spin">ğŸŒ</div>
            <div class="mt-2 font-bold text-gray-700">ì†Œì…œ í—ˆë¸Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ EduPet ì†Œì…œ í—ˆë¸Œ</h1>
            <p>ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ê³µë¶€í•˜ê³  ê²½ìŸí•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div id="auth-section" class="auth-section">
            <div id="auth-status" class="auth-status">
                ë¡œë”© ì¤‘...
            </div>
            <div id="auth-controls">
                <!-- ì¸ì¦ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('leaderboards')">ğŸ† ìˆœìœ„í‘œ</button>
            <button class="nav-tab" onclick="showTab('friends')">ğŸ‘¥ ì¹œêµ¬</button>
            <button class="nav-tab" onclick="showTab('showoff')">ğŸ¾ ìë‘í•˜ê¸°</button>
            <button class="nav-tab" onclick="showTab('groups')">ğŸ¯ ê·¸ë£¹</button>
        </div>

        <!-- ìˆœìœ„í‘œ íƒ­ -->
        <div id="leaderboards" class="tab-content active">
            <h2>ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„í‘œ</h2>
            
            <div class="leaderboard">
                <h3>ğŸ§  í€´ì¦ˆ ë§ˆìŠ¤í„°</h3>
                <div id="quiz-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ¯ ì •í™•ë„ í‚¹</h3>
                <div id="accuracy-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ’° ë¶€ì ë­í‚¹</h3>
                <div id="money-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div class="leaderboard">
                <h3>ğŸ¾ ë™ë¬¼ ì»¬ë ‰í„°</h3>
                <div id="animal-leaderboard" class="loading">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ì¹œêµ¬ íƒ­ -->
        <div id="friends" class="tab-content">
            <h2>ğŸ‘¥ ì¹œêµ¬ ê´€ë¦¬</h2>
            
            <div class="friends-section">
                <h3>ìƒˆ ì¹œêµ¬ ì¶”ê°€</h3>
                <div class="input-group">
                    <input type="text" id="friend-nickname" class="form-control" placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„ ì…ë ¥">
                    <button class="btn btn-primary" onclick="addFriend()">ì¶”ê°€</button>
                </div>
                <div id="add-friend-result"></div>
            </div>

            <div class="friends-section">
                <h3>ë‚´ ì¹œêµ¬ ëª©ë¡</h3>
                <div id="friends-list" class="loading">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ìë‘í•˜ê¸° íƒ­ -->
        <div id="showoff" class="tab-content">
            <h2>ğŸ¾ ë™ë¬¼ ìë‘í•˜ê¸°</h2>
            
            <div class="showoff-section">
                <h3>ìƒˆ ìë‘í•˜ê¸°</h3>
                <button class="btn btn-primary" onclick="openShowOffModal()">ë™ë¬¼ ìë‘í•˜ê¸°</button>
            </div>

            <div class="showoff-section">
                <h3>ìµœê·¼ ìë‘í•˜ê¸°</h3>
                <div id="showoff-list" class="loading">ìë‘í•˜ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ê·¸ë£¹ íƒ­ -->
        <div id="groups" class="tab-content">
            <h2>ğŸ¯ í•™ìŠµ ê·¸ë£¹</h2>
            
            <div class="friends-section">
                <h3>ê·¸ë£¹ ìƒì„±</h3>
                <div class="input-group">
                    <input type="text" id="group-name" class="form-control" placeholder="ê·¸ë£¹ ì´ë¦„ ì…ë ¥">
                    <button class="btn btn-primary" onclick="createGroup()">ìƒì„±</button>
                </div>
                <div id="create-group-result"></div>
            </div>

            <div class="friends-section">
                <h3>ë‚´ ê·¸ë£¹</h3>
                <div id="groups-list" class="loading">ê·¸ë£¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ìë‘í•˜ê¸° ëª¨ë‹¬ -->
    <div id="showoff-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShowOffModal()">&times;</span>
            <h3>ğŸ¾ ë™ë¬¼ ìë‘í•˜ê¸°</h3>
            <div id="animal-selection">
                <p>ìë‘í•  ë™ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”:</p>
                <div id="user-animals" class="loading">ë™ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div id="showoff-form" style="display: none;">
                <textarea id="showoff-message" placeholder="ìë‘í•˜ê³  ì‹¶ì€ ë§ì„ ì¨ì£¼ì„¸ìš”! (200ì ì´ë‚´)" maxlength="200" style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; resize: none;"></textarea>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="submitShowOff()">ìë‘í•˜ê¸° ê²Œì‹œ</button>
                    <button class="btn btn-secondary" onclick="closeShowOffModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let selectedAnimal = null;
        let leaderboardListeners = [];

        // í˜ì´ì§€ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            try {
                // eduPetAuth and eduPetFirebaseIntegrationê°€ ì •ì˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆë¥¼ ë¨¼ì € ì„¤ì •í•©ë‹ˆë‹¤.
                eduPetAuth.addAuthStateListener(onAuthStateChanged);

                // Firebase í†µí•© ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ì´ ê³¼ì •ì—ì„œ ìµëª… ë¡œê·¸ì¸ì´ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

            } catch (error) {
                console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                showError('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                loadingOverlay.classList.add('hidden');
            }
        });

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬
        function onAuthStateChanged(state, userData) {
            currentUser = userData;
            
            if (state === 'signed_in') {
                showAuthStatus(`í™˜ì˜í•©ë‹ˆë‹¤, ${userData?.profile?.nickname || 'ìµëª…'}ë‹˜! ğŸ‰`);
                showAuthControls(true);
                loadSocialData();
            } else {
                showAuthStatus('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                showAuthControls(false);
                clearSocialData();
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // ì¸ì¦ ìƒíƒœ í‘œì‹œ
        function showAuthStatus(message) {
            document.getElementById('auth-status').textContent = message;
            
            const authSection = document.getElementById('auth-section');
            if (currentUser) {
                authSection.classList.add('authenticated');
            } else {
                authSection.classList.remove('authenticated');
            }
        }

        // ì¸ì¦ ì»¨íŠ¸ë¡¤ í‘œì‹œ
        function showAuthControls(isAuthenticated) {
            const controlsDiv = document.getElementById('auth-controls');
            
            if (isAuthenticated) {
                controlsDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div class="input-group">
                            <input type="text" id="nickname-input" class="form-control" placeholder="ë‹‰ë„¤ì„ ì„¤ì • (ì„ íƒì‚¬í•­)" value="${currentUser?.profile?.nickname || ''}">
                            <button class="btn btn-primary" onclick="setNickname()">ì„¤ì •</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
            } else {
                controlsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="signInAnonymously()">ì‹œì‘í•˜ê¸°</button>
                    <p style="margin-top: 10px; color: #6c757d;">ìµëª…ìœ¼ë¡œ ì‹œì‘í•˜ì—¬ ì¹œêµ¬ë“¤ê³¼ ì†Œí†µí•˜ì„¸ìš”!</p>
                `;
            }
        }

        // ìµëª… ë¡œê·¸ì¸
        async function signInAnonymously() {
            showAuthStatus('ë¡œê·¸ì¸ ì¤‘...');
            const success = await eduPetAuth.signInAnonymously();
            if (!success) {
                showError('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë‹‰ë„¤ì„ ì„¤ì •
        async function setNickname() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (!nickname) {
                showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (nickname.length < 2 || nickname.length > 10) {
                showError('ë‹‰ë„¤ì„ì€ 2-10ì ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                await eduPetAuth.setNickname(nickname);
                showSuccess('ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                showAuthStatus(`í™˜ì˜í•©ë‹ˆë‹¤, ${nickname}ë‹˜! ğŸ‰`);
            } catch (error) {
                showError(error.message);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function signOut() {
            await eduPetAuth.signOut();
        }

        // ì†Œì…œ ë°ì´í„° ë¡œë“œ
        function loadSocialData() {
            loadLeaderboards();
            loadFriendsList();
            loadShowOffs();
        }

        // ìˆœìœ„í‘œ ë¡œë“œ
        async function loadLeaderboards() {
            const types = ['quiz_score', 'quiz_accuracy', 'money_collector', 'animal_collector'];
            const containers = ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'];

            for (let i = 0; i < types.length; i++) {
                try {
                    const leaderboard = await eduPetLeaderboard.getLeaderboard(types[i], 10);
                    displayLeaderboard(leaderboard, containers[i]);
                } catch (error) {
                    console.error(`ìˆœìœ„í‘œ ${types[i]} ë¡œë“œ ì‹¤íŒ¨:`, error);
                    document.getElementById(containers[i]).innerHTML = '<div class="error">ìˆœìœ„í‘œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }
        }

        // ìˆœìœ„í‘œ í‘œì‹œ
        function displayLeaderboard(leaderboard, containerId) {
            const container = document.getElementById(containerId);
            
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const html = leaderboard.map((user, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const onlineStatus = user.isOnline ? 'online' : 'offline';
                
                return `
                    <div class="leaderboard-item">
                        <div class="rank ${rankClass}">${user.rank}</div>
                        <div class="avatar">${getAnimalEmoji(user.avatarAnimal)}</div>
                        <div class="user-info">
                            <div class="nickname">
                                ${user.nickname}
                                <span class="online-status ${onlineStatus}"></span>
                            </div>
                        </div>
                        <div class="value">${formatValue(user.value, containerId)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ì¹œêµ¬ ëª©ë¡ ë¡œë“œ
        async function loadFriendsList() {
            try {
                const friends = await eduPetSocial.getFriendsList();
                displayFriendsList(friends);
            } catch (error) {
                console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('friends-list').innerHTML = '<div class="error">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì¹œêµ¬ ëª©ë¡ í‘œì‹œ
        function displayFriendsList(friends) {
            const container = document.getElementById('friends-list');
            
            if (!friends || friends.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            const html = friends.map(friend => {
                const onlineStatus = friend.isOnline ? 'online' : 'offline';
                const statusText = friend.isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
                
                return `
                    <div class="friend-item">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="avatar">${getAnimalEmoji(friend.avatarAnimal)}</div>
                                <div>
                                    <div class="nickname">
                                        ${friend.nickname}
                                        <span class="online-status ${onlineStatus}"></span>
                                        <small style="color: #6c757d;">(${statusText})</small>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6c757d;">
                                        ì •ë‹µ: ${friend.stats.correctAnswers || 0}ê°œ | 
                                        ë™ë¬¼: ${friend.stats.animalsCollected || 0}ë§ˆë¦¬
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFriend('${friend.uid}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ì¹œêµ¬ ì¶”ê°€
        async function addFriend() {
            const nickname = document.getElementById('friend-nickname').value.trim();
            const resultDiv = document.getElementById('add-friend-result');
            
            if (!nickname) {
                resultDiv.innerHTML = '<div class="error">ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            try {
                await eduPetSocial.addFriend(nickname);
                resultDiv.innerHTML = '<div class="success">ì¹œêµ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                document.getElementById('friend-nickname').value = '';
                
                // ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    loadFriendsList();
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // ì¹œêµ¬ ì‚­ì œ
        async function removeFriend(friendUid) {
            if (!confirm('ì •ë§ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await eduPetSocial.removeFriend(friendUid);
                loadFriendsList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                showSuccess('ì¹œêµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                showError('ì¹œêµ¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìë‘í•˜ê¸° ëª©ë¡ ë¡œë“œ
        async function loadShowOffs() {
            try {
                const showOffs = await eduPetSocial.getShowOffs(20);
                displayShowOffs(showOffs);
            } catch (error) {
                console.error('ìë‘í•˜ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('showoff-list').innerHTML = '<div class="error">ìë‘í•˜ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìë‘í•˜ê¸° ëª©ë¡ í‘œì‹œ
        function displayShowOffs(showOffs) {
            const container = document.getElementById('showoff-list');
            
            if (!showOffs || showOffs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ì•„ì§ ìë‘í•˜ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ë¡œ ìë‘í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            const html = showOffs.map(showOff => {
                const timeAgo = getTimeAgo(showOff.createdAt);
                const isLiked = showOff.likedBy && showOff.likedBy[currentUser?.profile?.uid];
                
                return `
                    <div class="showoff-item">
                        <div class="showoff-header">
                            <div class="showoff-user">
                                <div class="avatar">${getAnimalEmoji(showOff.userAvatar)}</div>
                                <div>
                                    <div class="nickname">${showOff.userNickname}</div>
                                    <div class="showoff-time">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="animal-showcase">
                            <div class="animal-name">${showOff.animal.name}</div>
                            <div class="animal-tier tier-${showOff.animal.tier}">${getTierName(showOff.animal.tier)}</div>
                            <div style="font-size: 3rem; margin: 10px 0;">${getAnimalEmoji(showOff.animal.name)}</div>
                        </div>
                        
                        ${showOff.message ? `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${showOff.message}</div>` : ''}
                        
                        <div class="showoff-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${showOff.id}')">
                                â¤ï¸ ${showOff.likes || 0}
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">ğŸ’¬ ëŒ“ê¸€ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ìë‘í•˜ê¸° ëª¨ë‹¬ ì—´ê¸°
        function openShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'block';
            loadUserAnimals();
        }

        // ìë‘í•˜ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'none';
            selectedAnimal = null;
            document.getElementById('showoff-form').style.display = 'none';
            document.getElementById('animal-selection').style.display = 'block';
        }

        // ì‚¬ìš©ì ë™ë¬¼ ëª©ë¡ ë¡œë“œ
        function loadUserAnimals() {
            try {
                const gameState = JSON.parse(localStorage.getItem('eduPetGameState') || '{}');
                const animals = gameState.animals || {};
                
                if (Object.keys(animals).length === 0) {
                    document.getElementById('user-animals').innerHTML = 
                        '<p style="text-align: center; color: #6c757d;">ì•„ì§ ìˆ˜ì§‘í•œ ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë™ë¬¼ ì»¬ë ‰ì…˜ì—ì„œ ë™ë¬¼ì„ ëª¨ì•„ë³´ì„¸ìš”!</p>';
                    return;
                }

                const html = Object.entries(animals).map(([animalName, animalData]) => `
                    <div class="friend-item" style="cursor: pointer;" onclick="selectAnimal('${animalName}', ${JSON.stringify(animalData).replace(/"/g, '&quot;')})">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">${getAnimalEmoji(animalName)}</div>
                            <div>
                                <div class="nickname">${animalData.name}</div>
                                <div class="animal-tier tier-${animalData.tier}" style="font-size: 0.8rem; margin-top: 5px;">${getTierName(animalData.tier)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('user-animals').innerHTML = html;
            } catch (error) {
                console.error('ë™ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('user-animals').innerHTML = '<div class="error">ë™ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ë™ë¬¼ ì„ íƒ
        function selectAnimal(animalName, animalData) {
            selectedAnimal = animalData;
            document.getElementById('animal-selection').style.display = 'none';
            document.getElementById('showoff-form').style.display = 'block';
        }

        // ìë‘í•˜ê¸° ì œì¶œ
        async function submitShowOff() {
            if (!selectedAnimal) {
                showError('ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const message = document.getElementById('showoff-message').value.trim();
            
            try {
                await eduPetSocial.showOffAnimal(selectedAnimal, message);
                showSuccess('ìë‘í•˜ê¸°ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeShowOffModal();
                loadShowOffs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                showError('ìë‘í•˜ê¸° ê²Œì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¢‹ì•„ìš” í† ê¸€
        async function toggleLike(showOffId) {
            try {
                const result = await eduPetSocial.likeShowOff(showOffId);
                if (result) {
                    loadShowOffs(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                showError('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê·¸ë£¹ ìƒì„±
        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const resultDiv = document.getElementById('create-group-result');
            
            if (!groupName) {
                resultDiv.innerHTML = '<div class="error">ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            try {
                await eduPetSocial.createGroup(groupName, 'í•™ìŠµ ê·¸ë£¹');
                resultDiv.innerHTML = '<div class="success">ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                document.getElementById('group-name').value = '';
                
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ì†Œì…œ ë°ì´í„° ì´ˆê¸°í™”
        function clearSocialData() {
            // ìˆœìœ„í‘œ ë¦¬ìŠ¤ë„ˆ ì œê±°
            leaderboardListeners.forEach(listener => {
                if (listener) eduPetLeaderboard.unsubscribeFromLeaderboard(listener);
            });
            leaderboardListeners = [];

            // ì½˜í…ì¸  ì´ˆê¸°í™”
            ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
            });
            
            document.getElementById('friends-list').innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
            document.getElementById('showoff-list').innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
            document.getElementById('groups-list').innerHTML = '<div class="loading">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getAnimalEmoji(animal) {
            const emojiMap = {
                'bunny': 'ğŸ°', 'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'fox': 'ğŸ¦Š', 'lion': 'ğŸ¦',
                'tiger': 'ğŸ…', 'bear': 'ğŸ»', 'panda': 'ğŸ¼', 'koala': 'ğŸ¨', 'monkey': 'ğŸµ',
                'elephant': 'ğŸ˜', 'giraffe': 'ğŸ¦’', 'zebra': 'ğŸ¦“', 'horse': 'ğŸ', 'cow': 'ğŸ„',
                'pig': 'ğŸ·', 'sheep': 'ğŸ‘', 'chicken': 'ğŸ”', 'penguin': 'ğŸ§', 'owl': 'ğŸ¦‰',
                // ë” ë§ì€ ë™ë¬¼ ë§¤í•‘...
            };
            
            return emojiMap[animal] || 'ğŸ¾';
        }

        function getTierName(tier) {
            const tierNames = {
                'common': 'ì¼ë°˜',
                'rare': 'ë ˆì–´',
                'epic': 'ì—í”½',
                'legendary': 'ì „ì„¤'
            };
            return tierNames[tier] || tier;
        }

        function formatValue(value, containerId) {
            if (containerId.includes('accuracy')) {
                return `${value}%`;
            } else if (containerId.includes('money')) {
                return `${value.toLocaleString()}ì›`;
            } else {
                return `${value.toLocaleString()}`;
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days}ì¼ ì „`;
            if (hours > 0) return `${hours}ì‹œê°„ ì „`;
            if (minutes > 0) return `${minutes}ë¶„ ì „`;
            return 'ë°©ê¸ˆ ì „';
        }

        function showError(message) {
            // ê°„ë‹¨í•œ ì—ëŸ¬ í‘œì‹œ (ì‹¤ì œë¡œëŠ” toastë‚˜ ëª¨ë‹¬ ì‚¬ìš©)
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '300px';
            
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>