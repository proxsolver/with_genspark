<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet ÏÜåÏÖú ÌóàÎ∏å üåê</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-auth.js"></script>
    <script defer src="firebase-leaderboard.js"></script>
    <script defer src="firebase-social.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .auth-section {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .auth-section.authenticated {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .auth-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .input-group {
            display: flex;
            margin: 10px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-control {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px 0 0 25px;
            font-size: 1rem;
            outline: none;
        }

        .form-control:focus {
            border-color: #007bff;
        }

        .input-group .btn {
            border-radius: 0 25px 25px 0;
            margin: 0;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .user-info {
            flex: 1;
            margin-left: 15px;
        }

        .nickname {
            font-weight: 600;
            font-size: 1.1rem;
            color: #495057;
        }

        .avatar {
            font-size: 2rem;
        }

        .value {
            font-weight: bold;
            color: #007bff;
        }

        .online-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
            margin-left: 10px;
        }

        .online-status.offline {
            background: #6c757d;
        }

        .friends-section, .showoff-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .friend-item, .showoff-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .showoff-item {
            border-left: 4px solid #007bff;
        }

        .showoff-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .showoff-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .showoff-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .animal-showcase {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }

        .animal-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .animal-tier {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .tier-common { background: #28a745; color: white; }
        .tier-rare { background: #007bff; color: white; }
        .tier-epic { background: #6f42c1; color: white; }
        .tier-legendary { background: #fd7e14; color: white; }

        .showoff-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .like-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn:hover {
            color: #c82333;
        }

        .like-btn.liked {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 10% auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                padding: 12px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .leaderboard-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-2xl animate-spin">üåê</div>
            <div class="mt-2 font-bold text-gray-700">ÏÜåÏÖú ÌóàÎ∏åÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>üåê EduPet ÏÜåÏÖú ÌóàÎ∏å</h1>
            <p>ÏπúÍµ¨Îì§Í≥º Ìï®Íªò Í≥µÎ∂ÄÌïòÍ≥† Í≤ΩÏüÅÌï¥Î≥¥ÏÑ∏Ïöî!</p>
        </div>

        <!-- Ïù∏Ï¶ù ÏÑπÏÖò -->
        <div id="auth-section" class="auth-section">
            <div id="auth-status" class="auth-status">
                Î°úÎî© Ï§ë...
            </div>
            <div id="auth-controls">
                <!-- Ïù∏Ï¶ù Î≤ÑÌäºÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('leaderboards')">üèÜ ÏàúÏúÑÌëú</button>
            <button class="nav-tab" onclick="showTab('friends')">üë• ÏπúÍµ¨</button>
            <button class="nav-tab" onclick="showTab('showoff')">üêæ ÏûêÎûëÌïòÍ∏∞</button>
            <button class="nav-tab" onclick="showTab('groups')">üéØ Í∑∏Î£π</button>
        </div>

        <!-- ÏàúÏúÑÌëú ÌÉ≠ -->
        <div id="leaderboards" class="tab-content active">
            <h2>üèÜ Ïã§ÏãúÍ∞Ñ ÏàúÏúÑÌëú</h2>
            
            <div class="leaderboard">
                <h3>üß† ÌÄ¥Ï¶à ÎßàÏä§ÌÑ∞</h3>
                <div id="quiz-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üéØ Ï†ïÌôïÎèÑ ÌÇπ</h3>
                <div id="accuracy-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üí∞ Î∂ÄÏûê Îû≠ÌÇπ</h3>
                <div id="money-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>

            <div class="leaderboard">
                <h3>üêæ ÎèôÎ¨º Ïª¨Î†âÌÑ∞</h3>
                <div id="animal-leaderboard" class="loading">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- ÏπúÍµ¨ ÌÉ≠ -->
        <div id="friends" class="tab-content">
            <h2>üë• ÏπúÍµ¨ Í¥ÄÎ¶¨</h2>
            
            <div class="friends-section">
                <h3>ÏÉà ÏπúÍµ¨ Ï∂îÍ∞Ä</h3>
                <div class="input-group">
                    <input type="text" id="friend-nickname" class="form-control" placeholder="ÏπúÍµ¨ ÎãâÎÑ§ÏûÑ ÏûÖÎ†•">
                    <button class="btn btn-primary" onclick="addFriend()">Ï∂îÍ∞Ä</button>
                </div>
                <div id="add-friend-result"></div>
            </div>

            <div class="friends-section">
                <h3>ÎÇ¥ ÏπúÍµ¨ Î™©Î°ù</h3>
                <div id="friends-list" class="loading">ÏπúÍµ¨ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- ÏûêÎûëÌïòÍ∏∞ ÌÉ≠ -->
        <div id="showoff" class="tab-content">
            <h2>üêæ ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</h2>
            
            <div class="showoff-section">
                <h3>ÏÉà ÏûêÎûëÌïòÍ∏∞</h3>
                <button class="btn btn-primary" onclick="openShowOffModal()">ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</button>
            </div>

            <div class="showoff-section">
                <h3>ÏµúÍ∑º ÏûêÎûëÌïòÍ∏∞</h3>
                <div id="showoff-list" class="loading">ÏûêÎûëÌïòÍ∏∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- Í∑∏Î£π ÌÉ≠ -->
        <div id="groups" class="tab-content">
            <h2>üéØ ÌïôÏäµ Í∑∏Î£π</h2>
            
            <div class="friends-section">
                <h3>Í∑∏Î£π ÏÉùÏÑ±</h3>
                <div class="input-group">
                    <input type="text" id="group-name" class="form-control" placeholder="Í∑∏Î£π Ïù¥Î¶Ñ ÏûÖÎ†•">
                    <button class="btn btn-primary" onclick="createGroup()">ÏÉùÏÑ±</button>
                </div>
                <div id="create-group-result"></div>
            </div>

            <div class="friends-section">
                <h3>ÎÇ¥ Í∑∏Î£π</h3>
                <div id="groups-list" class="loading">Í∑∏Î£π Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>
    </div>

    <!-- ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ -->
    <div id="showoff-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShowOffModal()">&times;</span>
            <h3>üêæ ÎèôÎ¨º ÏûêÎûëÌïòÍ∏∞</h3>
            <div id="animal-selection">
                <p>ÏûêÎûëÌï† ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</p>
                <div id="user-animals" class="loading">ÎèôÎ¨º Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
            <div id="showoff-form" style="display: none;">
                <textarea id="showoff-message" placeholder="ÏûêÎûëÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ Ïç®Ï£ºÏÑ∏Ïöî! (200Ïûê Ïù¥ÎÇ¥)" maxlength="200" style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; resize: none;"></textarea>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="submitShowOff()">ÏûêÎûëÌïòÍ∏∞ Í≤åÏãú</button>
                    <button class="btn btn-secondary" onclick="closeShowOffModal()">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let selectedAnimal = null;
        let leaderboardListeners = [];

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        window.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            try {
                // eduPetAuth and eduPetFirebaseIntegrationÍ∞Ä Ï†ïÏùòÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // Ïù∏Ï¶ù ÏÉÅÌÉú Î¶¨Ïä§ÎÑàÎ•º Î®ºÏ†Ä ÏÑ§Ï†ïÌï©ÎãàÎã§.
                eduPetAuth.addAuthStateListener(onAuthStateChanged);

                // Firebase ÌÜµÌï© Í∏∞Îä•ÏùÑ Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§. (Ïù¥ Í≥ºÏ†ïÏóêÏÑú ÏùµÎ™Ö Î°úÍ∑∏Ïù∏Ïù¥ Ìä∏Î¶¨Í±∞Îê† Ïàò ÏûàÏäµÎãàÎã§)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                showError('Ïï± Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                loadingOverlay.classList.add('hidden');
            }
        });

        // Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
        function onAuthStateChanged(state, userData) {
            currentUser = userData;
            
            if (state === 'signed_in') {
                showAuthStatus(`ÌôòÏòÅÌï©ÎãàÎã§, ${userData?.profile?.nickname || 'ÏùµÎ™Ö'}Îãò! üéâ`);
                showAuthControls(true);
                loadSocialData();
            } else {
                showAuthStatus('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                showAuthControls(false);
                clearSocialData();
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Ïù∏Ï¶ù ÏÉÅÌÉú ÌëúÏãú
        function showAuthStatus(message) {
            document.getElementById('auth-status').textContent = message;
            
            const authSection = document.getElementById('auth-section');
            if (currentUser) {
                authSection.classList.add('authenticated');
            } else {
                authSection.classList.remove('authenticated');
            }
        }

        // Ïù∏Ï¶ù Ïª®Ìä∏Î°§ ÌëúÏãú
        function showAuthControls(isAuthenticated) {
            const controlsDiv = document.getElementById('auth-controls');
            
            if (isAuthenticated) {
                controlsDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div class="input-group">
                            <input type="text" id="nickname-input" class="form-control" placeholder="ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï (ÏÑ†ÌÉùÏÇ¨Ìï≠)" value="${currentUser?.profile?.nickname || ''}">
                            <button class="btn btn-primary" onclick="setNickname()">ÏÑ§Ï†ï</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="signOut()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                `;
            } else {
                controlsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="signInAnonymously()">ÏãúÏûëÌïòÍ∏∞</button>
                    <p style="margin-top: 10px; color: #6c757d;">ÏùµÎ™ÖÏúºÎ°ú ÏãúÏûëÌïòÏó¨ ÏπúÍµ¨Îì§Í≥º ÏÜåÌÜµÌïòÏÑ∏Ïöî!</p>
                `;
            }
        }

        // ÏùµÎ™Ö Î°úÍ∑∏Ïù∏
        async function signInAnonymously() {
            showAuthStatus('Î°úÍ∑∏Ïù∏ Ï§ë...');
            const success = await eduPetAuth.signInAnonymously();
            if (!success) {
                showError('Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï
        async function setNickname() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (!nickname) {
                showError('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (nickname.length < 2 || nickname.length > 10) {
                showError('ÎãâÎÑ§ÏûÑÏùÄ 2-10Ïûê ÏÇ¨Ïù¥Ïó¨Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            try {
                await eduPetAuth.setNickname(nickname);
                showSuccess('ÎãâÎÑ§ÏûÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!');
                showAuthStatus(`ÌôòÏòÅÌï©ÎãàÎã§, ${nickname}Îãò! üéâ`);
            } catch (error) {
                showError(error.message);
            }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        async function signOut() {
            await eduPetAuth.signOut();
        }

        // ÏÜåÏÖú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadSocialData() {
            loadLeaderboards();
            loadFriendsList();
            loadShowOffs();
        }

        // ÏàúÏúÑÌëú Î°úÎìú
        async function loadLeaderboards() {
            const types = ['quiz_score', 'quiz_accuracy', 'money_collector', 'animal_collector'];
            const containers = ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'];

            for (let i = 0; i < types.length; i++) {
                try {
                    const leaderboard = await eduPetLeaderboard.getLeaderboard(types[i], 10);
                    displayLeaderboard(leaderboard, containers[i]);
                } catch (error) {
                    console.error(`ÏàúÏúÑÌëú ${types[i]} Î°úÎìú Ïã§Ìå®:`, error);
                    document.getElementById(containers[i]).innerHTML = '<div class="error">ÏàúÏúÑÌëúÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                }
            }
        }

        // ÏàúÏúÑÌëú ÌëúÏãú
        function displayLeaderboard(leaderboard, containerId) {
            const container = document.getElementById(containerId);
            
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const html = leaderboard.map((user, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const onlineStatus = user.isOnline ? 'online' : 'offline';
                
                return `
                    <div class="leaderboard-item">
                        <div class="rank ${rankClass}">${user.rank}</div>
                        <div class="avatar">${getAnimalEmoji(user.avatarAnimal)}</div>
                        <div class="user-info">
                            <div class="nickname">
                                ${user.nickname}
                                <span class="online-status ${onlineStatus}"></span>
                            </div>
                        </div>
                        <div class="value">${formatValue(user.value, containerId)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÏπúÍµ¨ Î™©Î°ù Î°úÎìú
        async function loadFriendsList() {
            try {
                const friends = await eduPetSocial.getFriendsList();
                displayFriendsList(friends);
            } catch (error) {
                console.error('ÏπúÍµ¨ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('friends-list').innerHTML = '<div class="error">ÏπúÍµ¨ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÏπúÍµ¨ Î™©Î°ù ÌëúÏãú
        function displayFriendsList(friends) {
            const container = document.getElementById('friends-list');
            
            if (!friends || friends.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏπúÍµ¨Í∞Ä ÏóÜÏäµÎãàÎã§. ÏπúÍµ¨Î•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            const html = friends.map(friend => {
                const onlineStatus = friend.isOnline ? 'online' : 'offline';
                const statusText = friend.isOnline ? 'Ïò®ÎùºÏù∏' : 'Ïò§ÌîÑÎùºÏù∏';
                
                return `
                    <div class="friend-item">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="avatar">${getAnimalEmoji(friend.avatarAnimal)}</div>
                                <div>
                                    <div class="nickname">
                                        ${friend.nickname}
                                        <span class="online-status ${onlineStatus}"></span>
                                        <small style="color: #6c757d;">(${statusText})</small>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6c757d;">
                                        Ï†ïÎãµ: ${friend.stats.correctAnswers || 0}Í∞ú | 
                                        ÎèôÎ¨º: ${friend.stats.animalsCollected || 0}ÎßàÎ¶¨
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFriend('${friend.uid}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÏπúÍµ¨ Ï∂îÍ∞Ä
        async function addFriend() {
            const nickname = document.getElementById('friend-nickname').value.trim();
            const resultDiv = document.getElementById('add-friend-result');
            
            if (!nickname) {
                resultDiv.innerHTML = '<div class="error">ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
                return;
            }

            try {
                await eduPetSocial.addFriend(nickname);
                resultDiv.innerHTML = '<div class="success">ÏπúÍµ¨Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!</div>';
                document.getElementById('friend-nickname').value = '';
                
                // ÏπúÍµ¨ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => {
                    loadFriendsList();
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // ÏπúÍµ¨ ÏÇ≠Ï†ú
        async function removeFriend(friendUid) {
            if (!confirm('Ï†ïÎßê Ïù¥ ÏπúÍµ¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await eduPetSocial.removeFriend(friendUid);
                loadFriendsList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                showSuccess('ÏπúÍµ¨Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                showError('ÏπúÍµ¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù Î°úÎìú
        async function loadShowOffs() {
            try {
                const showOffs = await eduPetSocial.getShowOffs(20);
                displayShowOffs(showOffs);
            } catch (error) {
                console.error('ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('showoff-list').innerHTML = '<div class="error">ÏûêÎûëÌïòÍ∏∞ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™©Î°ù ÌëúÏãú
        function displayShowOffs(showOffs) {
            const container = document.getElementById('showoff-list');
            
            if (!showOffs || showOffs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏûêÎûëÌïòÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏Î°ú ÏûêÎûëÌï¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            const html = showOffs.map(showOff => {
                const timeAgo = getTimeAgo(showOff.createdAt);
                const isLiked = showOff.likedBy && showOff.likedBy[currentUser?.profile?.uid];
                
                return `
                    <div class="showoff-item">
                        <div class="showoff-header">
                            <div class="showoff-user">
                                <div class="avatar">${getAnimalEmoji(showOff.userAvatar)}</div>
                                <div>
                                    <div class="nickname">${showOff.userNickname}</div>
                                    <div class="showoff-time">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="animal-showcase">
                            <div class="animal-name">${showOff.animal.name}</div>
                            <div class="animal-tier tier-${showOff.animal.tier}">${getTierName(showOff.animal.tier)}</div>
                            <div style="font-size: 3rem; margin: 10px 0;">${getAnimalEmoji(showOff.animal.name)}</div>
                        </div>
                        
                        ${showOff.message ? `<div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 10px 0;">${showOff.message}</div>` : ''}
                        
                        <div class="showoff-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${showOff.id}')">
                                ‚ù§Ô∏è ${showOff.likes || 0}
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">üí¨ ÎåìÍ∏Ä Í∏∞Îä• Ï§ÄÎπÑ Ï§ë</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ Ïó¥Í∏∞
        function openShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'block';
            loadUserAnimals();
        }

        // ÏûêÎûëÌïòÍ∏∞ Î™®Îã¨ Îã´Í∏∞
        function closeShowOffModal() {
            document.getElementById('showoff-modal').style.display = 'none';
            selectedAnimal = null;
            document.getElementById('showoff-form').style.display = 'none';
            document.getElementById('animal-selection').style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê ÎèôÎ¨º Î™©Î°ù Î°úÎìú
        function loadUserAnimals() {
            try {
                const gameState = JSON.parse(localStorage.getItem('eduPetGameState') || '{}');
                const animals = gameState.animals || {};
                
                if (Object.keys(animals).length === 0) {
                    document.getElementById('user-animals').innerHTML = 
                        '<p style="text-align: center; color: #6c757d;">ÏïÑÏßÅ ÏàòÏßëÌïú ÎèôÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§. ÎèôÎ¨º Ïª¨Î†âÏÖòÏóêÏÑú ÎèôÎ¨ºÏùÑ Î™®ÏïÑÎ≥¥ÏÑ∏Ïöî!</p>';
                    return;
                }

                const html = Object.entries(animals).map(([animalName, animalData]) => `
                    <div class="friend-item" style="cursor: pointer;" onclick="selectAnimal('${animalName}', ${JSON.stringify(animalData).replace(/"/g, '&quot;')})">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">${getAnimalEmoji(animalName)}</div>
                            <div>
                                <div class="nickname">${animalData.name}</div>
                                <div class="animal-tier tier-${animalData.tier}" style="font-size: 0.8rem; margin-top: 5px;">${getTierName(animalData.tier)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('user-animals').innerHTML = html;
            } catch (error) {
                console.error('ÎèôÎ¨º Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('user-animals').innerHTML = '<div class="error">ÎèôÎ¨º Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ÎèôÎ¨º ÏÑ†ÌÉù
        function selectAnimal(animalName, animalData) {
            selectedAnimal = animalData;
            document.getElementById('animal-selection').style.display = 'none';
            document.getElementById('showoff-form').style.display = 'block';
        }

        // ÏûêÎûëÌïòÍ∏∞ Ï†úÏ∂ú
        async function submitShowOff() {
            if (!selectedAnimal) {
                showError('ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const message = document.getElementById('showoff-message').value.trim();
            
            try {
                await eduPetSocial.showOffAnimal(selectedAnimal, message);
                showSuccess('ÏûêÎûëÌïòÍ∏∞Í∞Ä Í≤åÏãúÎêòÏóàÏäµÎãàÎã§!');
                closeShowOffModal();
                loadShowOffs(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
                showError('ÏûêÎûëÌïòÍ∏∞ Í≤åÏãúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä
        async function toggleLike(showOffId) {
            try {
                const result = await eduPetSocial.likeShowOff(showOffId);
                if (result) {
                    loadShowOffs(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                }
            } catch (error) {
                showError('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // Í∑∏Î£π ÏÉùÏÑ±
        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const resultDiv = document.getElementById('create-group-result');
            
            if (!groupName) {
                resultDiv.innerHTML = '<div class="error">Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
                return;
            }

            try {
                await eduPetSocial.createGroup(groupName, 'ÌïôÏäµ Í∑∏Î£π');
                resultDiv.innerHTML = '<div class="success">Í∑∏Î£πÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</div>';
                document.getElementById('group-name').value = '';
                
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // ÌÉ≠ Ï†ÑÌôò
        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠ Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌëúÏãú
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ÏÜåÏÖú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function clearSocialData() {
            // ÏàúÏúÑÌëú Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            leaderboardListeners.forEach(listener => {
                if (listener) eduPetLeaderboard.unsubscribeFromLeaderboard(listener);
            });
            leaderboardListeners = [];

            // ÏΩòÌÖêÏ∏† Ï¥àÍ∏∞Ìôî
            ['quiz-leaderboard', 'accuracy-leaderboard', 'money-leaderboard', 'animal-leaderboard'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
            });
            
            document.getElementById('friends-list').innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
            document.getElementById('showoff-list').innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
            document.getElementById('groups-list').innerHTML = '<div class="loading">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>';
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function getAnimalEmoji(animal) {
            const emojiMap = {
                'bunny': 'üê∞', 'cat': 'üê±', 'dog': 'üê∂', 'fox': 'ü¶ä', 'lion': 'ü¶Å',
                'tiger': 'üêÖ', 'bear': 'üêª', 'panda': 'üêº', 'koala': 'üê®', 'monkey': 'üêµ',
                'elephant': 'üêò', 'giraffe': 'ü¶í', 'zebra': 'ü¶ì', 'horse': 'üêé', 'cow': 'üêÑ',
                'pig': 'üê∑', 'sheep': 'üêë', 'chicken': 'üêî', 'penguin': 'üêß', 'owl': 'ü¶â',
                // Îçî ÎßéÏùÄ ÎèôÎ¨º Îß§Ìïë...
            };
            
            return emojiMap[animal] || 'üêæ';
        }

        function getTierName(tier) {
            const tierNames = {
                'common': 'ÏùºÎ∞ò',
                'rare': 'Î†àÏñ¥',
                'epic': 'ÏóêÌîΩ',
                'legendary': 'Ï†ÑÏÑ§'
            };
            return tierNames[tier] || tier;
        }

        function formatValue(value, containerId) {
            if (containerId.includes('accuracy')) {
                return `${value}%`;
            } else if (containerId.includes('money')) {
                return `${value.toLocaleString()}Ïõê`;
            } else {
                return `${value.toLocaleString()}`;
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (days > 0) return `${days}Ïùº Ï†Ñ`;
            if (hours > 0) return `${hours}ÏãúÍ∞Ñ Ï†Ñ`;
            if (minutes > 0) return `${minutes}Î∂Ñ Ï†Ñ`;
            return 'Î∞©Í∏à Ï†Ñ';
        }

        function showError(message) {
            // Í∞ÑÎã®Ìïú ÏóêÎü¨ ÌëúÏãú (Ïã§Ï†úÎ°úÎäî toastÎÇò Î™®Îã¨ ÏÇ¨Ïö©)
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '300px';
            
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>