<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ë¯¸ì…˜ - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Plant System -->
    <script src="plant-system.js"></script>
    <script src="weakness-learning.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }

        .mission-card {
            transition: all 0.3s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
        }

        .mission-card.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #10b981 100%);
            border-color: #059669;
        }

        .mission-card.in-progress {
            background: linear-gradient(135deg, #dbeafe 0%, #3b82f6 100%);
            border-color: #2563eb;
            animation: pulse-border 2s infinite;
        }

        .mission-card.pending {
            opacity: 0.7;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #2563eb; }
            50% { border-color: #60a5fa; }
        }

        .reward-animation {
            animation: reward-pop 0.5s ease-out;
        }

        @keyframes reward-pop {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .progress-bar {
            transition: width 0.8s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <div class="text-center mb-6 relative">
            <button onclick="goHome()" class="absolute left-0 top-0 text-2xl hover:scale-110 transition-transform">
                ğŸ 
            </button>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ¯ ì¼ì¼ ë¯¸ì…˜</h1>
            <div class="text-sm text-gray-600" id="mission-date">
                2025ë…„ 10ì›” 9ì¼
            </div>
        </div>

        <!-- Daily Progress Summary -->
        <div class="bg-gradient-to-r from-purple-500 to-blue-500 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold">ğŸ“Š ì˜¤ëŠ˜ì˜ ì§„í–‰ë¥ </h2>
                <div class="text-2xl font-bold" id="overall-progress">0%</div>
            </div>
            <div class="w-full bg-white/30 rounded-full h-4 mb-3">
                <div class="progress-bar bg-white rounded-full h-4" id="overall-progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between text-sm">
                <div>
                    <span id="completed-count">0</span> / <span id="total-count">3</span> ë¯¸ì…˜ ì™„ë£Œ
                </div>
                <div class="flex items-center gap-2">
                    ğŸ íšë“: <span id="rewards-earned" class="font-bold">0</span>
                </div>
            </div>
        </div>

        <!-- Streak Counter -->
        <div class="bg-gradient-to-r from-orange-400 to-red-500 rounded-xl shadow-lg p-4 mb-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="text-4xl">ğŸ”¥</div>
                    <div>
                        <div class="text-sm opacity-90">ì—°ì† ì¶œì„</div>
                        <div class="text-2xl font-bold" id="streak-days">0ì¼</div>
                    </div>
                </div>
                <div class="text-right text-sm opacity-90">
                    <div>ë‹¤ìŒ ë³´ë„ˆìŠ¤ê¹Œì§€</div>
                    <div class="font-bold" id="next-streak-bonus">7ì¼</div>
                </div>
            </div>
        </div>

        <!-- Daily Missions -->
        <div class="space-y-4 mb-6">
            <h2 class="text-lg font-bold text-gray-800">ğŸŒŸ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h2>
            <div id="daily-missions-list">
                <!-- Missions will be populated here -->
            </div>
        </div>

        <!-- Weekly Missions Preview (Coming Soon) -->
        <div class="bg-white/50 rounded-xl p-6 text-center border-2 border-dashed border-gray-300">
            <div class="text-4xl mb-2">ğŸ“…</div>
            <div class="font-bold text-gray-700 mb-1">ì£¼ê°„/ì›”ê°„ ë¯¸ì…˜</div>
            <div class="text-sm text-gray-500">ê³§ ì¶œì‹œë©ë‹ˆë‹¤!</div>
        </div>
    </div>

    <script>
        // ==================== ë¯¸ì…˜ ì‹œìŠ¤í…œ ====================

        // PlantSystem ì¸ìŠ¤í„´ìŠ¤ (plant-system.jsì—ì„œ ì´ë¯¸ ë¡œë“œë¨)
        let plantSystem;

        // í™ˆìœ¼ë¡œ ì´ë™
        function goHome() {
            window.location.href = 'index.html';
        }

        // ë¯¸ì…˜ ì •ì˜
        const MISSION_DEFINITIONS = {
            daily_login: {
                id: 'daily_login',
                type: 'fixed',
                title: 'ğŸ“… ì¶œì„ ì²´í¬',
                description: 'ì˜¤ëŠ˜ë„ EduPetì— ë°©ë¬¸í•´ì£¼ì„¸ìš”!',
                icon: 'ğŸ“…',
                checkCondition: () => true, // í˜ì´ì§€ ë¡œë“œë§Œ í•´ë„ ì™„ë£Œ
                rewards: { normalTickets: 1 },
                autoComplete: true
            },
            daily_weakness: {
                id: 'daily_weakness',
                type: 'fixed',
                title: 'ğŸ¯ ì•½ì  ê³¼ëª© ì •ë³µ',
                description: 'ê°€ì¥ ì•½í•œ ê³¼ëª© 1íšŒ ì™„ë£Œí•˜ê¸°',
                icon: 'ğŸ¯',
                checkCondition: (data) => {
                    const weakestSubject = getWeakestSubject();
                    const completed = data.completedSubjects || [];
                    return completed.includes(weakestSubject);
                },
                rewards: { growthTickets: 1, money: 100 },
                getDynamicDescription: () => {
                    const weakest = getWeakestSubject();
                    const subjectNames = {
                        english: 'ì˜ì–´', math: 'ìˆ˜í•™', science: 'ê³¼í•™',
                        korean: 'êµ­ì–´', social: 'ì‚¬íšŒ', common: 'ìƒì‹',
                        idiom: 'ì‚¬ìì„±ì–´', person: 'ì¸ë¬¼', economy: 'ê²½ì œ',
                        production: 'ìƒì‚°', toeic: 'TOEIC', ai: 'AI'
                    };
                    return `${subjectNames[weakest] || weakest} ê³¼ëª© 1íšŒ ì™„ë£Œí•˜ê¸°`;
                }
            },
            daily_goal: {
                id: 'daily_goal',
                type: 'fixed',
                title: 'ğŸ’ª í•™ìŠµ ëª©í‘œ ë‹¬ì„±',
                description: 'ì˜¤ëŠ˜ ì´ 3ê³¼ëª© ì™„ë£Œí•˜ê¸°',
                icon: 'ğŸ’ª',
                checkCondition: (data) => {
                    return (data.completedCount || 0) >= 3;
                },
                rewards: { water: 10, growthTickets: 1 },
                maxProgress: 3
            }
        };

        // ë¯¸ì…˜ ë°ì´í„° êµ¬ì¡°
        function getMissionSystem() {
            const stored = localStorage.getItem('missionSystem');
            const today = getCurrentDateKST();

            if (!stored) {
                return initializeMissionSystem(today);
            }

            const system = JSON.parse(stored);

            // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ ë¦¬ì…‹
            if (system.lastReset !== today) {
                return initializeMissionSystem(today);
            }

            return system;
        }

        function saveMissionSystem(system) {
            localStorage.setItem('missionSystem', JSON.stringify(system));
        }

        function initializeMissionSystem(today) {
            const prevSystem = JSON.parse(localStorage.getItem('missionSystem') || '{}');
            const prevDate = prevSystem.lastReset;

            // ì—°ì† ì¶œì„ ê³„ì‚°
            let streakDays = prevSystem.streakDays || 0;
            if (prevDate) {
                const yesterday = getYesterdayDateKST();
                if (prevDate === yesterday) {
                    streakDays++; // ì–´ì œ ì ‘ì†í–ˆìœ¼ë©´ ì—°ì† +1
                } else if (prevDate !== today) {
                    streakDays = 1; // ê·¸ ì´ì „ì´ë©´ ë¦¬ì…‹
                }
            } else {
                streakDays = 1; // ì²« ì ‘ì†
            }

            const system = {
                lastReset: today,
                streakDays: streakDays,
                missions: {
                    daily_login: {
                        status: 'pending',
                        progress: 0,
                        completedAt: null,
                        rewardClaimed: false
                    },
                    daily_weakness: {
                        status: 'pending',
                        progress: 0,
                        completedAt: null,
                        rewardClaimed: false
                    },
                    daily_goal: {
                        status: 'pending',
                        progress: 0,
                        completedAt: null,
                        rewardClaimed: false
                    }
                }
            };

            saveMissionSystem(system);
            return system;
        }

        function getCurrentDateKST() {
            const now = new Date();
            const kstOffset = 9 * 60; // KST is UTC+9
            const kstTime = new Date(now.getTime() + (kstOffset + now.getTimezoneOffset()) * 60000);

            // 04:00 ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ê³„ì‚°
            kstTime.setHours(kstTime.getHours() - 4);

            return kstTime.toISOString().split('T')[0];
        }

        function getYesterdayDateKST() {
            const now = new Date();
            const kstOffset = 9 * 60;
            const kstTime = new Date(now.getTime() + (kstOffset + now.getTimezoneOffset()) * 60000);
            kstTime.setHours(kstTime.getHours() - 4);
            kstTime.setDate(kstTime.getDate() - 1);
            return kstTime.toISOString().split('T')[0];
        }

        // ì•½ì  ê³¼ëª© ì°¾ê¸°
        function getWeakestSubject() {
            const userData = plantSystem.getUserData();
            const subjectScores = userData.learning?.subjectScores || {};

            if (Object.keys(subjectScores).length === 0) {
                return 'math'; // ê¸°ë³¸ê°’
            }

            let weakest = null;
            let lowestScore = Infinity;

            for (const [subject, score] of Object.entries(subjectScores)) {
                if (score < lowestScore) {
                    lowestScore = score;
                    weakest = subject;
                }
            }

            return weakest || 'math';
        }

        // ë¯¸ì…˜ ì²´í¬ ë° ì—…ë°ì´íŠ¸
        function checkAndUpdateMissions() {
            const system = getMissionSystem();
            const userData = plantSystem.getUserData();
            const completedSubjects = userData.daily?.completedSubjectIds || [];
            const completedCount = completedSubjects.length;

            let updated = false;

            // ì¶œì„ ì²´í¬ ìë™ ì™„ë£Œ
            if (system.missions.daily_login.status === 'pending') {
                system.missions.daily_login.status = 'completed';
                system.missions.daily_login.progress = 1;
                system.missions.daily_login.completedAt = Date.now();
                updated = true;
            }

            // ì•½ì  ê³¼ëª© ì²´í¬
            const weakestSubject = getWeakestSubject();
            if (completedSubjects.includes(weakestSubject) && system.missions.daily_weakness.status !== 'completed') {
                system.missions.daily_weakness.status = 'completed';
                system.missions.daily_weakness.progress = 1;
                system.missions.daily_weakness.completedAt = Date.now();
                updated = true;
            } else if (completedSubjects.length > 0 && system.missions.daily_weakness.status === 'pending') {
                system.missions.daily_weakness.status = 'in_progress';
            }

            // í•™ìŠµ ëª©í‘œ ì²´í¬
            system.missions.daily_goal.progress = completedCount;
            if (completedCount >= 3 && system.missions.daily_goal.status !== 'completed') {
                system.missions.daily_goal.status = 'completed';
                system.missions.daily_goal.completedAt = Date.now();
                updated = true;
            } else if (completedCount > 0 && system.missions.daily_goal.status === 'pending') {
                system.missions.daily_goal.status = 'in_progress';
            }

            if (updated) {
                saveMissionSystem(system);
            }

            return system;
        }

        // UI ë Œë”ë§
        function renderMissions() {
            const system = checkAndUpdateMissions();
            const container = document.getElementById('daily-missions-list');
            container.innerHTML = '';

            let completedCount = 0;
            let totalRewards = 0;

            for (const [missionId, definition] of Object.entries(MISSION_DEFINITIONS)) {
                const missionData = system.missions[missionId];
                const card = createMissionCard(definition, missionData);
                container.appendChild(card);

                if (missionData.status === 'completed') {
                    completedCount++;
                    if (!missionData.rewardClaimed) {
                        totalRewards++;
                    }
                }
            }

            // ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const totalMissions = Object.keys(MISSION_DEFINITIONS).length;
            const progress = Math.round((completedCount / totalMissions) * 100);

            document.getElementById('overall-progress').textContent = progress + '%';
            document.getElementById('overall-progress-bar').style.width = progress + '%';
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('total-count').textContent = totalMissions;
            document.getElementById('rewards-earned').textContent = totalRewards;

            // ì—°ì† ì¶œì„ í‘œì‹œ
            document.getElementById('streak-days').textContent = system.streakDays + 'ì¼';
            const nextBonus = system.streakDays < 7 ? 7 - system.streakDays : 30 - (system.streakDays % 30);
            document.getElementById('next-streak-bonus').textContent = nextBonus + 'ì¼';

            // ë‚ ì§œ í‘œì‹œ
            const dateStr = new Date().toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('mission-date').textContent = dateStr;
        }

        function createMissionCard(definition, missionData) {
            const card = document.createElement('div');
            const statusClass = missionData.status;
            card.className = `mission-card ${statusClass} bg-white rounded-xl p-5 border-2 shadow-lg`;

            // ë™ì  ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
            const description = definition.getDynamicDescription
                ? definition.getDynamicDescription()
                : definition.description;

            // ì§„í–‰ë¥  ê³„ì‚°
            const maxProgress = definition.maxProgress || 1;
            const currentProgress = missionData.progress || 0;
            const progressPercent = Math.min((currentProgress / maxProgress) * 100, 100);

            // ë³´ìƒ í…ìŠ¤íŠ¸
            const rewardText = getRewardText(definition.rewards);

            // ìƒíƒœ ì•„ì´ì½˜
            let statusIcon = 'â³';
            let statusText = 'ëŒ€ê¸°ì¤‘';
            let statusColor = 'text-gray-500';

            if (missionData.status === 'completed') {
                statusIcon = missionData.rewardClaimed ? 'âœ…' : 'ğŸ';
                statusText = missionData.rewardClaimed ? 'ì™„ë£Œ' : 'ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥';
                statusColor = 'text-green-600 font-bold';
            } else if (missionData.status === 'in_progress') {
                statusIcon = 'âš¡';
                statusText = 'ì§„í–‰ì¤‘';
                statusColor = 'text-blue-600 font-bold';
            }

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="text-4xl">${definition.icon}</div>
                        <div>
                            <div class="font-bold text-gray-800 text-lg">${definition.title}</div>
                            <div class="text-sm text-gray-600">${description}</div>
                        </div>
                    </div>
                    <div class="${statusColor} text-2xl">${statusIcon}</div>
                </div>

                ${maxProgress > 1 ? `
                    <div class="mb-3">
                        <div class="flex items-center justify-between text-sm mb-1">
                            <span class="text-gray-600">ì§„í–‰ë¥ </span>
                            <span class="font-bold">${currentProgress} / ${maxProgress}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 rounded-full h-2"
                                 style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                ` : ''}

                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">ë³´ìƒ:</span>
                        <span class="font-bold text-orange-600">${rewardText}</span>
                    </div>
                    ${missionData.status === 'completed' && !missionData.rewardClaimed ? `
                        <button onclick="claimReward('${definition.id}')"
                                class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg text-sm font-bold hover:from-yellow-500 hover:to-orange-600 transition-all transform hover:scale-105">
                            ìˆ˜ë ¹í•˜ê¸°
                        </button>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function getRewardText(rewards) {
            const parts = [];
            if (rewards.normalTickets) parts.push(`ğŸ«Ã—${rewards.normalTickets}`);
            if (rewards.premiumTickets) parts.push(`ğŸŸï¸Ã—${rewards.premiumTickets}`);
            if (rewards.growthTickets) parts.push(`ğŸŒ±Ã—${rewards.growthTickets}`);
            if (rewards.money) parts.push(`ğŸ’°${rewards.money}ì›`);
            if (rewards.water) parts.push(`ğŸ’§Ã—${rewards.water}`);
            return parts.join(' ');
        }

        // ë³´ìƒ ìˆ˜ë ¹
        function claimReward(missionId) {
            const system = getMissionSystem();
            const mission = system.missions[missionId];
            const definition = MISSION_DEFINITIONS[missionId];

            if (mission.status !== 'completed' || mission.rewardClaimed) {
                return;
            }

            // âœ… ìˆ˜ì •: plantSystem.grantRewards() ì‚¬ìš© (ìë™ ì„±ì¥ ë¡œì§ í¬í•¨)
            const userData = plantSystem.getUserData();
            const rewards = definition.rewards;

            // normalGachaTickets, premiumGachaTickets, growthTicketsë¥¼ grantRewardsì— ë§ê²Œ ë³€í™˜
            const rewardsForPlantSystem = {};

            if (rewards.normalTickets) {
                rewardsForPlantSystem.normalGacha = rewards.normalTickets;
            }
            if (rewards.premiumTickets) {
                rewardsForPlantSystem.premiumGacha = rewards.premiumTickets;
            }
            if (rewards.growthTickets) {
                rewardsForPlantSystem.growthTickets = rewards.growthTickets;
            }

            // plantSystem.grantRewards() ì‚¬ìš© (tryAutoGrowPlants í¬í•¨)
            if (Object.keys(rewardsForPlantSystem).length > 0) {
                plantSystem.grantRewards(userData, rewardsForPlantSystem);
            }

            // moneyì™€ waterëŠ” ê¸°ì¡´ ë°©ì‹ ìœ ì§€
            if (rewards.money) {
                plantSystem.addMoney(rewards.money);
            }
            if (rewards.water) {
                userData.wallet.water = (userData.wallet.water || 0) + rewards.water;
            }

            plantSystem.saveUserData(userData);

            // ë¯¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            mission.rewardClaimed = true;
            saveMissionSystem(system);

            // ì• ë‹ˆë©”ì´ì…˜ ë° ì•Œë¦¼
            alert(`ğŸ‰ ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤!\n${getRewardText(rewards)}`);

            // UI ê°±ì‹ 
            renderMissions();
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // PlantSystem ì´ˆê¸°í™”
            plantSystem = new PlantSystem();

            // ë¯¸ì…˜ ë Œë”ë§
            renderMissions();

            // 10ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  (ë‹¤ë¥¸ íƒ­ì—ì„œ í€´ì¦ˆë¥¼ í’€ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
            setInterval(renderMissions, 10000);
        });

        // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ í•¨ìˆ˜ (quiz-adaptive.htmlì—ì„œ ì‚¬ìš©)
        window.updateMissionProgress = function() {
            renderMissions();
        };
    </script>
</body>
</html>
