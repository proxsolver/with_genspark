<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - EduPet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="plant-system.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6 max-w-2xl">
        <div class="bg-white p-8 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">🔒 EduPet 관리자 페이지</h1>

            <!-- 비밀번호 입력 -->
            <div id="password-section" class="mb-8">
                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">관리자 비밀번호를 입력하세요</label>
                <input type="password" id="admin-password" class="w-full p-2 border border-gray-300 rounded-md" placeholder="비밀번호">
                <button onclick="checkPassword()" class="mt-2 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">인증</button>
            </div>

            <!-- 관리자 기능 (숨김) -->
            <div id="admin-functions" class="hidden">
                <div class="p-4 bg-green-50 border-l-4 border-green-500 mb-6">
                    <p class="text-green-800 font-semibold">✅ 인증되었습니다.</p>
                </div>

                <!-- 내 데이터 초기화 -->
                <div class="mb-8 p-4 border-2 border-red-500 rounded-lg bg-red-50">
                    <h2 class="text-xl font-bold text-red-700 mb-2">🔥 내 데이터 완전 초기화</h2>
                    <p class="text-sm text-red-600 mb-4 font-semibold">⚠️ 위험: 현재 로그인된 사용자의 모든 데이터를 영구 삭제합니다.</p>

                    <div class="bg-white p-3 rounded-lg mb-4 text-sm">
                        <p class="font-bold text-gray-800 mb-2">삭제될 데이터:</p>
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            <li><strong>로컬 데이터:</strong> 식물, 동물, 보상, 학습 기록, 설정</li>
                            <li><strong>Firebase 데이터:</strong> 통계, 프로필, 소셜 데이터, 그룹 멤버십</li>
                            <li><strong>계정 상태:</strong> 튜토리얼 미완료 상태로 리셋</li>
                        </ul>
                    </div>

                    <button onclick="resetMyDataComplete()" class="w-full bg-red-600 text-white py-3 rounded-md hover:bg-red-700 font-bold text-lg">
                        💀 내 데이터 완전 삭제 실행
                    </button>
                </div>

                <!-- 특정 사용자 데이터 삭제 -->
                <div class="mb-8 p-4 border rounded-lg">
                    <h2 class="text-lg font-bold text-purple-600 mb-2">특정 사용자 데이터 삭제</h2>
                    <p class="text-sm text-gray-600 mb-4">삭제할 사용자를 선택하세요. 해당 사용자의 서버 데이터(학습 기록, 재화 등)만 삭제됩니다.</p>
                    <div class="flex gap-2">
                        <select id="user-select-dropdown" class="flex-grow p-2 border border-gray-300 rounded-md">
                            <option value="">사용자 목록을 불러오는 중...</option>
                        </select>
                        <button onclick="deleteOtherUserData()" class="bg-purple-500 text-white px-6 py-2 rounded-md hover:bg-purple-600">삭제 실행</button>
                    </div>
                </div>

                <!-- 개발 도구 -->
                <div class="mb-8 p-4 border rounded-lg bg-blue-50">
                    <h2 class="text-xl font-bold text-blue-700 mb-4">⚙️ 개발 도구</h2>

                    <div class="space-y-3">
                        <button onclick="skipPlantTime()" class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-left">
                            ⏰ 식물 시간 건너뛰기 (24시간)
                            <div class="text-xs text-blue-100 mt-1">모든 식물을 24시간 경과 상태로 변경</div>
                        </button>

                        <button onclick="addTestTickets()" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-left">
                            🎫 테스트 성장권 추가
                            <div class="text-xs text-green-100 mt-1">성장권 5개 즉시 지급</div>
                        </button>

                        <button onclick="addTestMoney()" class="w-full px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 text-left">
                            💰 테스트 돈 추가
                            <div class="text-xs text-pink-100 mt-1">1000원 즉시 지급</div>
                        </button>

                        <button onclick="completeLearningMissions()" class="w-full px-4 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-left">
                            ✅ 학습 미션 모두 완료
                            <div class="text-xs text-indigo-100 mt-1">9과목 모두 완료 처리 (보상 포함)</div>
                        </button>
                    </div>
                </div>

                <!-- 데이터 초기화 도구 -->
                <div class="p-4 border rounded-lg bg-orange-50">
                    <h2 class="text-xl font-bold text-orange-700 mb-4">🗑️ 데이터 초기화 도구</h2>

                    <div class="space-y-3">
                        <button onclick="resetPlants()" class="w-full px-4 py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 text-left">
                            🌱 식물만 초기화
                            <div class="text-xs text-teal-100 mt-1">모든 식물 제거 (보상은 유지)</div>
                        </button>

                        <button onclick="resetDaily()" class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-left">
                            📅 일일 진행률 초기화
                            <div class="text-xs text-yellow-100 mt-1">오늘 완료한 과목 리셋</div>
                        </button>

                        <button onclick="resetLearningMissions()" class="w-full px-4 py-3 bg-slate-500 text-white rounded-lg hover:bg-slate-600 text-left">
                            🔄 학습 미션 초기화
                            <div class="text-xs text-slate-100 mt-1">모든 과목 미완료 상태로 리셋</div>
                        </button>

                        <button onclick="resetAchievements()" class="w-full px-4 py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-left">
                            🏆 업적 데이터 초기화
                            <div class="text-xs text-amber-100 mt-1">업적 및 퀴즈 진행 데이터 삭제</div>
                        </button>

                        <button onclick="resetAnalytics()" class="w-full px-4 py-3 bg-violet-500 text-white rounded-lg hover:bg-violet-600 text-left">
                            📊 분석 데이터 초기화
                            <div class="text-xs text-violet-100 mt-1">학습 분석 히스토리 삭제</div>
                        </button>

                        <button onclick="resetLearningProgress()" class="w-full px-4 py-3 bg-rose-500 text-white rounded-lg hover:bg-rose-600 text-left">
                            📈 학습 진행률 초기화
                            <div class="text-xs text-rose-100 mt-1">과목별 학습 통계 삭제</div>
                        </button>

                        <button onclick="resetMinigames()" class="w-full px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 text-left">
                            🎮 미니게임 진행률 초기화
                            <div class="text-xs text-pink-100 mt-1">미니게임 플레이 횟수 및 통계 리셋</div>
                        </button>
                    </div>
                </div>

                <!-- 홈으로 돌아가기 -->
                <div class="mt-6">
                    <button onclick="window.location.href='index.html'" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        🏠 메인 페이지로 돌아가기
                    </button>
                </div>
            </div>
            <div id="result-message" class="mt-6 text-center"></div>
        </div>
    </div>

    <script>
        // Firebase 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            eduPetAuth.addAuthStateListener((state, user) => {
                if (state !== 'signed_in') {
                    document.getElementById('password-section').innerHTML = '<p class="text-red-500 text-center">이 기능을 사용하려면 먼저 로그인이 필요합니다.</p>';
                }
            });
        });

        function checkPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === '8253') {
                document.getElementById('password-section').classList.add('hidden');
                document.getElementById('admin-functions').classList.remove('hidden');
                // 인증 성공 시 사용자 목록 로드
                loadAllUsers();
            } else {
                alert('비밀번호가 올바르지 않습니다.');
            }
        }

        // 내 데이터 완전 초기화 (로컬 + Firebase)
        async function resetMyDataComplete() {
            const currentUser = eduPetAuth.currentUser;
            if (!currentUser) {
                showMessage('로그인된 사용자가 없습니다.', 'error');
                return;
            }

            // 3단계 확인
            if (!confirm('⚠️ [1단계 확인]\n\n정말로 모든 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            const uid = currentUser.uid;
            const nickname = eduPetAuth.userData?.profile?.nickname || '익명';

            if (!confirm(`⚠️ [2단계 확인]\n\n사용자: ${nickname}\nUID: ${uid}\n\n위 사용자의 모든 데이터를 영구 삭제합니다.\n계속하시겠습니까?`)) {
                return;
            }

            const confirmation = prompt('⚠️ [최종 확인]\n\n정말로 삭제하려면 "삭제"를 입력하세요:');
            if (confirmation !== '삭제') {
                showMessage('❌ 취소되었습니다.', 'error');
                return;
            }

            try {
                showMessage('🔄 데이터 삭제 중... 잠시만 기다려주세요.', 'info');

                // === 1. 로컬 데이터 완전 삭제 ===
                console.log('[관리자] 로컬 데이터 삭제 시작...');

                const allLocalStorageKeys = [
                    // Plant System
                    'plantSystemUser',
                    'plantSystemPlants',

                    // Learning
                    'learningProgress',
                    'selectedSubjects',
                    'extraLearningMode',

                    // Animals
                    'animalCollection',

                    // User Settings
                    'eduPetSettings',
                    'eduPetOnboardingCompleted',

                    // Quiz & Achievements
                    'quizProgress',
                    'achievements',
                    'quizAnalyticsHistory',

                    // Firebase
                    'eduPetFirebaseUser',
                    'firebaseOfflineQueue',

                    // Legacy
                    'simpleFarmState',
                    'eduPetGameState'
                ];

                let deletedLocalCount = 0;
                allLocalStorageKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        deletedLocalCount++;
                        console.log(`  ✅ ${key} 삭제됨`);
                    }
                });

                console.log(`[관리자] 로컬 데이터 ${deletedLocalCount}개 삭제 완료`);

                // === 2. Firebase 데이터 완전 삭제 ===
                console.log('[관리자] Firebase 데이터 삭제 시작...');

                const updates = {};

                // 사용자 프로필 및 통계 삭제
                updates[`users/${uid}`] = null;

                // 닉네임 매핑 삭제
                if (nickname && nickname !== '익명') {
                    updates[`nicknames/${nickname}`] = null;
                }

                // 일일 통계 삭제 (최근 30일)
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    updates[`daily_stats/${dateStr}/${uid}`] = null;
                }

                // 그룹 멤버십 삭제 (사용자가 속한 그룹에서 제거)
                try {
                    const userGroupsSnapshot = await firebase.database().ref(`users/${uid}/social/groups`).once('value');
                    const userGroups = userGroupsSnapshot.val();

                    if (userGroups) {
                        for (const groupId of Object.keys(userGroups)) {
                            updates[`groups/${groupId}/members/${uid}`] = null;
                            updates[`groups/${groupId}/memberCount`] = firebase.database.ServerValue.increment(-1);
                            console.log(`  ✅ 그룹 ${groupId}에서 사용자 제거`);
                        }
                    }
                } catch (error) {
                    console.warn('그룹 멤버십 정리 실패:', error);
                }

                // 자랑하기 게시물 삭제
                try {
                    const showoffsSnapshot = await firebase.database().ref('showoffs').orderByChild('userId').equalTo(uid).once('value');
                    const showoffs = showoffsSnapshot.val();

                    if (showoffs) {
                        Object.keys(showoffs).forEach(showoffId => {
                            updates[`showoffs/${showoffId}`] = null;
                            console.log(`  ✅ 자랑하기 게시물 ${showoffId} 삭제`);
                        });
                    }
                } catch (error) {
                    console.warn('자랑하기 게시물 정리 실패:', error);
                }

                // 일괄 삭제 실행
                await firebase.database().ref().update(updates);
                console.log('[관리자] Firebase 데이터 삭제 완료');

                // === 3. Firebase Auth에서 로그아웃 (선택사항) ===
                // await firebase.auth().signOut();

                showMessage('✅ 모든 데이터가 성공적으로 삭제되었습니다!\n\n3초 후 튜토리얼로 이동합니다...', 'success');

                setTimeout(() => {
                    window.location.href = 'tutorial.html';
                }, 3000);

            } catch (error) {
                console.error('[관리자] 데이터 초기화 오류:', error);
                showMessage(`❌ 데이터 초기화 중 오류 발생:\n${error.message}`, 'error');
            }
        }

        async function deleteOtherUserData() {
            const uidToDelete = document.getElementById('user-select-dropdown').value;
            if (!uidToDelete) {
                showMessage('삭제할 사용자를 선택하세요.', 'error');
                return;
            }

            if (!confirm(`[주의] 정말로 사용자 ${uidToDelete}의 서버 데이터를 모두 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }

            try {
                // 특정 사용자의 Firebase 데이터 삭제 (사용자 노드 전체 삭제)
                const userRef = firebase.database().ref('users/' + uidToDelete);
                await userRef.remove();
                console.log(`Firebase에서 사용자 ${uidToDelete}의 데이터 삭제 완료.`);
                showMessage(`✅ 사용자 ${uidToDelete}의 서버 데이터가 성공적으로 삭제되었습니다.`, 'success');

            } catch (error) {
                console.error('특정 사용자 데이터 삭제 오류:', error);
                showMessage(`❌ 데이터 삭제 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 신규: 모든 사용자 목록을 불러와 드롭다운에 채우는 함수
        async function loadAllUsers() {
            const dropdown = document.getElementById('user-select-dropdown');
            try {
                const usersSnapshot = await firebase.database().ref('users').once('value');
                const users = usersSnapshot.val();
                if (users) {
                    dropdown.innerHTML = '<option value="">-- 삭제할 사용자 선택 --</option>';
                    Object.keys(users).forEach(uid => {
                        const nickname = users[uid].profile?.nickname || '익명';
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = `${nickname} (${uid.substring(0, 8)}...)`;
                        dropdown.appendChild(option);
                    });
                } else {
                    dropdown.innerHTML = '<option value="">사용자를 찾을 수 없습니다.</option>';
                }
            } catch (error) {
                console.error('모든 사용자 목록 로드 실패:', error);
                dropdown.innerHTML = '<option value="">로드 실패</option>';
                showMessage('사용자 목록을 불러오는 데 실패했습니다.', 'error');
            }
        }

        function showMessage(msg, type = 'info') {
            const resultDiv = document.getElementById('result-message');
            resultDiv.textContent = msg;
            if (type === 'success') {
                resultDiv.className = 'mt-6 text-center text-green-600 font-semibold';
            } else if (type === 'error') {
                resultDiv.className = 'mt-6 text-center text-red-600 font-semibold';
            } else {
                resultDiv.className = 'mt-6 text-center text-gray-600';
            }
        }

        // ===== 개발 도구 함수들 =====

        // 식물 시간 건너뛰기
        function skipPlantTime() {
            try {
                const plants = plantSystem.getAllPlants();
                let updated = 0;

                Object.values(plants).forEach(plant => {
                    if (plant.status === 'PLANTED') {
                        plant.plantedAt = plantSystem.getCurrentTimestamp() - (25 * 60 * 60 * 1000);
                        plantSystem.savePlant(plant);
                        plantSystem.checkReadyStatus(plant);
                        plantSystem.savePlant(plant);
                        updated++;
                    }
                });

                showMessage(`✅ ${updated}개 식물의 시간을 건너뛰었습니다`, 'success');
            } catch (error) {
                console.error('시간 건너뛰기 오류:', error);
                showMessage('❌ 시간 건너뛰기 실패: ' + error.message, 'error');
            }
        }

        // 테스트 성장권 추가
        function addTestTickets() {
            try {
                const user = plantSystem.getUserData();
                const currentTime = plantSystem.getCurrentTimestamp();
                const expiresAt = currentTime + (24 * 60 * 60 * 1000);

                for (let i = 0; i < 5; i++) {
                    user.rewards.growthTickets.push({
                        ticketId: plantSystem.generateUUID(),
                        issuedAt: currentTime,
                        expiresAt: expiresAt
                    });
                }

                plantSystem.saveUserData(user);
                showMessage('✅ 성장권 5개가 추가되었습니다', 'success');
            } catch (error) {
                console.error('성장권 추가 오류:', error);
                showMessage('❌ 성장권 추가 실패: ' + error.message, 'error');
            }
        }

        // 테스트 돈 추가
        function addTestMoney() {
            try {
                const user = plantSystem.getUserData();

                if (!user.wallet) {
                    user.wallet = { money: 0, water: 0 };
                }

                user.wallet.money += 1000;
                plantSystem.saveUserData(user);

                showMessage('✅ 1000원이 추가되었습니다', 'success');
            } catch (error) {
                console.error('돈 추가 오류:', error);
                showMessage('❌ 돈 추가 실패: ' + error.message, 'error');
            }
        }

        // 학습 미션 모두 완료
        function completeLearningMissions() {
            try {
                const user = plantSystem.getUserData();

                // 9과목 모두 완료 처리
                const allSubjects = ['english', 'math', 'science', 'korean', 'social', 'common', 'idiom', 'person', 'economy'];

                allSubjects.forEach((subject, index) => {
                    if (!user.daily.completedSubjectIds.includes(subject)) {
                        plantSystem.completeSubject(user, subject, subject);
                    }
                });

                showMessage('✅ 9과목 모두 완료 처리되었습니다 (보상 포함)', 'success');
            } catch (error) {
                console.error('학습 미션 완료 오류:', error);
                showMessage('❌ 학습 미션 완료 실패: ' + error.message, 'error');
            }
        }

        // ===== 데이터 초기화 함수들 =====

        // 식물만 초기화
        function resetPlants() {
            if (!confirm('모든 식물을 제거하시겠습니까?')) {
                return;
            }

            try {
                localStorage.removeItem('plantSystemPlants');
                showMessage('✅ 식물이 초기화되었습니다', 'success');
            } catch (error) {
                console.error('식물 초기화 오류:', error);
                showMessage('❌ 식물 초기화 실패: ' + error.message, 'error');
            }
        }

        // 일일 진행률 초기화
        function resetDaily() {
            if (!confirm('일일 진행률을 초기화하시겠습니까?')) {
                return;
            }

            try {
                const user = plantSystem.getUserData();
                user.daily.completedSubjects = 0;
                user.daily.completedSubjectIds = [];
                user.daily.lastResetDate = plantSystem.getCurrentDate();
                plantSystem.saveUserData(user);

                showMessage('✅ 일일 진행률이 초기화되었습니다', 'success');
            } catch (error) {
                console.error('일일 진행률 초기화 오류:', error);
                showMessage('❌ 일일 진행률 초기화 실패: ' + error.message, 'error');
            }
        }

        // 학습 미션 초기화
        function resetLearningMissions() {
            if (!confirm('모든 학습 미션을 초기화하시겠습니까?\n(보상은 유지됩니다)')) {
                return;
            }

            try {
                const user = plantSystem.getUserData();

                // 일일 진행률만 초기화 (보상은 유지)
                user.daily.completedSubjects = 0;
                user.daily.completedSubjectIds = [];
                user.daily.lastResetDate = plantSystem.getCurrentDate();

                plantSystem.saveUserData(user);

                showMessage('✅ 학습 미션이 초기화되었습니다', 'success');
            } catch (error) {
                console.error('학습 미션 초기화 오류:', error);
                showMessage('❌ 학습 미션 초기화 실패: ' + error.message, 'error');
            }
        }

        // 업적 데이터 초기화
        function resetAchievements() {
            if (!confirm('⚠️ 업적 데이터를 초기화하시겠습니까?\n\n삭제될 데이터:\n- 달성한 업적 목록\n- 퀴즈 진행 통계 (총 정답 수, 세션 수 등)\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            try {
                localStorage.removeItem('achievements');
                localStorage.removeItem('quizProgress');

                showMessage('✅ 업적 데이터가 초기화되었습니다', 'success');
                console.log('[관리자] 업적 데이터 초기화 완료');
            } catch (error) {
                console.error('업적 데이터 초기화 오류:', error);
                showMessage('❌ 업적 데이터 초기화 실패: ' + error.message, 'error');
            }
        }

        // 분석 데이터 초기화
        function resetAnalytics() {
            if (!confirm('⚠️ 학습 분석 데이터를 초기화하시겠습니까?\n\n삭제될 데이터:\n- 학습 세션 히스토리\n- 난이도 조정 기록\n- 완료 타입 분석 데이터\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            try {
                localStorage.removeItem('quizAnalyticsHistory');

                showMessage('✅ 분석 데이터가 초기화되었습니다', 'success');
                console.log('[관리자] 분석 데이터 초기화 완료');
            } catch (error) {
                console.error('분석 데이터 초기화 오류:', error);
                showMessage('❌ 분석 데이터 초기화 실패: ' + error.message, 'error');
            }
        }

        // 학습 진행률 초기화
        function resetLearningProgress() {
            if (!confirm('⚠️ 학습 진행률 데이터를 초기화하시겠습니까?\n\n삭제될 데이터:\n- 과목별 학습 통계\n- 총 문제 수 및 정답 수\n- 연속 학습 기록\n- 일일 활동 데이터\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            try {
                localStorage.removeItem('learningProgress');

                showMessage('✅ 학습 진행률이 초기화되었습니다', 'success');
                console.log('[관리자] 학습 진행률 초기화 완료');
            } catch (error) {
                console.error('학습 진행률 초기화 오류:', error);
                showMessage('❌ 학습 진행률 초기화 실패: ' + error.message, 'error');
            }
        }

        // 미니게임 진행률 초기화
        function resetMinigames() {
            if (!confirm('⚠️ 미니게임 데이터를 초기화하시겠습니까?\n\n삭제될 데이터:\n- 오늘 플레이 횟수 (5회로 리셋)\n- 통계 (플레이 횟수, 최고 기록 등)\n- 획득한 동물 목록 (인형뽑기)\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            try {
                localStorage.removeItem('minigameProgress');

                showMessage('✅ 미니게임 데이터가 초기화되었습니다 (플레이 횟수 5회로 리셋)', 'success');
                console.log('[관리자] 미니게임 진행률 초기화 완료');
            } catch (error) {
                console.error('미니게임 초기화 오류:', error);
                showMessage('❌ 미니게임 초기화 실패: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
