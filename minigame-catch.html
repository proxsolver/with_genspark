<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ë°©ìš¸ ë°›ê¸° ê²Œì„ - EduPet Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #gameCanvas {
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-2xl mx-auto">
        <!-- í—¤ë” -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-3xl">ğŸ’§</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">ë¬¼ë°©ìš¸ ë°›ê¸° ê²Œì„</h1>
                        <p class="text-xs text-gray-600">ë–¨ì–´ì§€ëŠ” ë¬¼ë°©ìš¸ì„ ë°›ì•„ìš”!</p>
                    </div>
                </div>
                <button onclick="goBack()" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm">
                    ëŒì•„ê°€ê¸°
                </button>
            </div>

            <!-- ê²Œì„ ì •ë³´ -->
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-blue-50 rounded-lg p-2">
                    <p class="text-xs text-gray-600">ë‚¨ì€ ì‹œê°„</p>
                    <p class="text-2xl font-bold text-blue-600" id="timer">30</p>
                </div>
                <div class="bg-green-50 rounded-lg p-2">
                    <p class="text-xs text-gray-600">ë°›ì€ ë¬¼</p>
                    <p class="text-2xl font-bold text-green-600" id="score">0</p>
                </div>
                <div class="bg-red-50 rounded-lg p-2">
                    <p class="text-xs text-gray-600">ë†“ì¹œ ë¬¼</p>
                    <p class="text-2xl font-bold text-red-600" id="missed">0</p>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
        <div id="gameArea" style="display: none;">
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <canvas id="gameCanvas" width="400" height="500"></canvas>
                <div class="text-center text-sm text-gray-600 mt-3">
                    <p>â¬…ï¸ ë§ˆìš°ìŠ¤ë‚˜ í„°ì¹˜ë¡œ ë°”êµ¬ë‹ˆë¥¼ ì›€ì§ì´ì„¸ìš” â¡ï¸</p>
                </div>
            </div>
        </div>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="startSection" class="bg-white rounded-2xl shadow-lg p-8 text-center">
            <div class="mb-6">
                <span class="text-6xl">ğŸ’§</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ë¬¼ë°©ìš¸ ë°›ê¸° ì±Œë¦°ì§€!</h2>
            <p class="text-gray-600 mb-6">30ì´ˆ ë™ì•ˆ ìµœëŒ€í•œ ë§ì€ ë¬¼ë°©ìš¸ì„ ë°›ì•„ë³´ì„¸ìš”</p>

            <div class="bg-blue-50 rounded-xl p-4 mb-6">
                <ul class="text-sm text-gray-700 space-y-2 text-left">
                    <li>â€¢ í•˜ëŠ˜ì—ì„œ ë–¨ì–´ì§€ëŠ” ë¬¼ë°©ìš¸ì„ ë°›ì•„ìš”</li>
                    <li>â€¢ ë¬¼ë°©ìš¸ 1ê°œë‹¹ <strong class="text-yellow-600">1ì½”ì¸</strong></li>
                    <li>â€¢ 20ê°œ ì´ìƒ ë°›ìœ¼ë©´ <strong class="text-green-600">ì„±ì¥í‹°ì¼“</strong> (ì£¼ 1íšŒ)</li>
                    <li>â€¢ ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë¬¼ë°©ìš¸ì´ ë¹¨ë¼ì ¸ìš”!</li>
                </ul>
            </div>

            <button onclick="startGame()" class="px-8 py-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold text-lg">
                ê²Œì„ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
    <script src="plant-system.js"></script>
    <script src="minigame-system.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameStarted = false;
        let timeLeft = 30;
        let score = 0;
        let missed = 0;
        let timerInterval = null;
        let animationFrame = null;

        // ê²Œì„ ê°ì²´
        const basket = {
            x: canvas.width / 2 - 40,
            y: canvas.height - 60,
            width: 80,
            height: 20,
            speed: 5
        };

        let drops = [];
        let dropSpeed = 2;
        let lastDropTime = 0;
        const dropInterval = 800; // ë°€ë¦¬ì´ˆ

        function startGame() {
            gameStarted = true;
            timeLeft = 30;
            score = 0;
            missed = 0;
            drops = [];
            dropSpeed = 2;

            document.getElementById('startSection').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            updateUI();
            startTimer();
            gameLoop();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;

                // ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë‚œì´ë„ ì¦ê°€
                if (timeLeft % 10 === 0) {
                    dropSpeed += 0.5;
                }

                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function createDrop() {
            drops.push({
                x: Math.random() * (canvas.width - 20) + 10,
                y: 0,
                radius: 10,
                speed: dropSpeed
            });
        }

        function updateDrops() {
            const now = Date.now();

            // ìƒˆë¡œìš´ ë¬¼ë°©ìš¸ ìƒì„±
            if (now - lastDropTime > dropInterval) {
                createDrop();
                lastDropTime = now;
            }

            // ë¬¼ë°©ìš¸ ì´ë™ ë° ì¶©ëŒ ì²´í¬
            for (let i = drops.length - 1; i >= 0; i--) {
                const drop = drops[i];
                drop.y += drop.speed;

                // ë°”êµ¬ë‹ˆì™€ ì¶©ëŒ ì²´í¬
                if (
                    drop.y + drop.radius >= basket.y &&
                    drop.y - drop.radius <= basket.y + basket.height &&
                    drop.x >= basket.x &&
                    drop.x <= basket.x + basket.width
                ) {
                    score++;
                    document.getElementById('score').textContent = score;
                    drops.splice(i, 1);
                    continue;
                }

                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
                if (drop.y - drop.radius > canvas.height) {
                    missed++;
                    document.getElementById('missed').textContent = missed;
                    drops.splice(i, 1);
                }
            }
        }

        function drawDrop(drop) {
            // ë¬¼ë°©ìš¸ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#3B82F6';
            ctx.beginPath();
            ctx.arc(drop.x, drop.y, drop.radius, 0, Math.PI * 2);
            ctx.fill();

            // í•˜ì´ë¼ì´íŠ¸
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.arc(drop.x - 3, drop.y - 3, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawBasket() {
            // ë°”êµ¬ë‹ˆ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(basket.x, basket.y, basket.width, basket.height);

            // í…Œë‘ë¦¬
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 2;
            ctx.strokeRect(basket.x, basket.y, basket.width, basket.height);
        }

        function draw() {
            // ë°°ê²½ í´ë¦¬ì–´
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // êµ¬ë¦„ ê·¸ë¦¬ê¸°
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.arc(100, 50, 30, 0, Math.PI * 2);
            ctx.arc(130, 50, 25, 0, Math.PI * 2);
            ctx.arc(150, 50, 30, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(300, 80, 25, 0, Math.PI * 2);
            ctx.arc(320, 80, 30, 0, Math.PI * 2);
            ctx.arc(345, 80, 25, 0, Math.PI * 2);
            ctx.fill();

            // ë¬¼ë°©ìš¸ë“¤ ê·¸ë¦¬ê¸°
            drops.forEach(drop => drawDrop(drop));

            // ë°”êµ¬ë‹ˆ ê·¸ë¦¬ê¸°
            drawBasket();
        }

        function gameLoop() {
            if (!gameStarted) return;

            updateDrops();
            draw();

            animationFrame = requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('score').textContent = score;
            document.getElementById('missed').textContent = missed;
        }

        function endGame() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            gameStarted = false;

            // ë³´ìƒ ì§€ê¸‰
            let result = { success: false, message: 'ê²Œì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!' };

            if (typeof minigameSystem !== 'undefined') {
                result = minigameSystem.rewardCatchGame(score);
            }

            // ê²°ê³¼ í‘œì‹œ
            let message = `ğŸ‰ ê²Œì„ ì™„ë£Œ!\n\n`;
            message += `ğŸ’§ ë°›ì€ ë¬¼ë°©ìš¸: ${score}ê°œ\n`;
            message += `âŒ ë†“ì¹œ ë¬¼ë°©ìš¸: ${missed}ê°œ\n\n`;
            message += result.message;

            alert(message);

            // ê²Œì„ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            setTimeout(() => {
                window.location.href = 'minigames.html';
            }, 1000);
        }

        function goBack() {
            if (gameStarted && !confirm('ê²Œì„ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            window.location.href = 'minigames.html';
        }

        // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ë°”êµ¬ë‹ˆ ì´ë™
        canvas.addEventListener('mousemove', (e) => {
            if (!gameStarted) return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;

            basket.x = Math.max(0, Math.min(mouseX - basket.width / 2, canvas.width - basket.width));
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!gameStarted) return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const touchX = touch.clientX - rect.left;

            basket.x = Math.max(0, Math.min(touchX - basket.width / 2, canvas.width - basket.width));
        });
    </script>
</body>
</html>
