<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>적응형 학습 - EduPet Collection</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 한글 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- MathJax for LaTeX support -->
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['\\(','\\)']],
                displayMath: [['\\[','\\]']],
                processEscapes: true
            },
            "HTML-CSS": {
                linebreaks: { automatic: true }
            },
            SVG: {
                linebreaks: { automatic: true }
            }
        });
    </script>

    <!-- 로거 시스템 (가장 먼저 로드) -->
    <script src="logger.js"></script>

    <!-- 식물 시스템 스크립트 -->
    <script defer src="plant-system.js"></script>
    <script defer src="weakness-learning.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .font-game {
            font-family: 'Noto Sans KR', 'Comic Sans MS', cursive;
            font-weight: 600;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.1) 0%, 
                rgba(255, 152, 0, 0.1) 50%, 
                rgba(33, 150, 243, 0.1) 100%
            );
        }
        
        .option-btn {
            transition: all 0.2s ease;
        }
        
        .option-btn:hover {
            transform: scale(1.02);
        }
        
        .option-btn.correct {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .option-btn.incorrect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .option-btn.neutral {
            background-color: #e5e7eb;
            border-color: #e5e7eb;
            color: #6b7280;
        }
        
        .correct-animation {
            animation: gentleBounce 0.6s ease-out;
        }
        
        @keyframes gentleBounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.08); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1.02); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-fill {
            transition: width 0.8s ease-out;
        }
        
        .difficulty-badge {
            position: relative;
        }
        
        .difficulty-badge.easy {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .difficulty-badge.medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .difficulty-badge.hard {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .achievement-popup {
            animation: achievementSlide 2s ease-out;
        }

        @keyframes achievementSlide {
            0% { transform: translateY(-100px); opacity: 0; }
            20% { transform: translateY(0); opacity: 1; }
            80% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        /* 해설 모달 애니메이션 */
        #explanation-modal-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#4CAF50', 600: '#16a34a' },
                        secondary: { 500: '#FF9800', 600: '#ea580c' }
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Firebase 통합 스크립트 -->
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-auth.js"></script>
    <script defer src="firebase-integration.js"></script>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-2xl animate-spin">🌱</div>
            <div class="mt-2 font-bold text-gray-700">데이터를 불러오는 중...</div>
        </div>
    </div>
    <!-- 성취 알림 -->
    <div id="achievement-popup" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full shadow-lg achievement-popup">
            <div class="flex items-center space-x-2">
                <span class="text-lg">🏆</span>
                <span class="font-bold" id="achievement-text">난이도 상승!</span>
            </div>
        </div>
    </div>

    <!-- 퀴즈 컨테이너 -->
    <div class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- 헤더 -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <button onclick="confirmExit()" class="p-2 rounded-lg hover:bg-white hover:shadow-md transition-all">
                    ← 나가기
                </button>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium" id="current-subject">
                        🇺🇸 영어
                    </span>
                    <span class="px-2 py-1 rounded-full text-xs font-medium difficulty-badge" id="difficulty-badge">
                        쉬움
                    </span>
                    <!-- 추가 학습 모드 배지 -->
                    <span id="extra-mode-badge" class="hidden px-3 py-1 bg-orange-500 text-white rounded-full text-xs font-bold">
                        ✨ 추가 학습
                    </span>
                </div>
            </div>

            <div class="text-right">
                <div class="flex items-center justify-end space-x-2 mb-2">
                    <!-- 추가 학습 모드 종료 버튼 -->
                    <button id="extra-mode-exit-btn" onclick="exitExtraMode()"
                            class="hidden px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-bold transition-all shadow-md">
                        🏁 학습 종료
                    </button>
                    <button onclick="toggleVibration()" id="vibration-toggle"
                            class="p-2 rounded-lg transition-all text-sm"
                            title="진동 설정">
                        📳
                    </button>
                </div>

            </div>
        </div>

        <!-- 진행률 및 통계 -->
        <div class="bg-white rounded-xl p-4 mb-6 shadow-md">
            <!-- 전체 진행률 -->
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-gray-700">학습 진행률</span>
                <span class="text-sm font-bold text-primary-600" id="overall-progress">1 / 30 문제</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                <div class="bg-primary-500 h-3 rounded-full progress-fill" id="overall-progress-bar" style="width: 3.33%;"></div>
            </div>
            
            <!-- 난이도별 현황 -->
            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="p-3 bg-green-50 rounded-lg border border-green-200" id="easy-status">
                    <div class="text-lg font-bold text-green-600">0/10</div>
                    <div class="text-xs text-green-700">쉬움 정답</div>
                </div>
                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200" id="medium-status">
                    <div class="text-lg font-bold text-yellow-600">0/5</div>
                    <div class="text-xs text-yellow-700">보통 정답</div>
                </div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-200" id="hard-status">
                    <div class="text-lg font-bold text-red-600">0/1</div>
                    <div class="text-xs text-red-700">어려움 정답</div>
                </div>
            </div>
        </div>

        <!-- 퀴즈 카드 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 slide-in" id="quiz-card">
            <!-- 문제 -->
            <div class="mb-6">
                <div class="flex items-start justify-between">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex-1" id="question-text">
                        문제를 불러오는 중...
                    </h2>

                    <div class="flex items-start space-x-2 ml-4">
                        <!-- 힌트 버튼 -->
                        <button id="hint-btn" onclick="showQuizHint()" class="px-3 py-1 border-2 border-yellow-500 text-yellow-600 rounded-lg text-sm hover:bg-yellow-500 hover:text-white transition-all hidden">
                            💡 힌트
                        </button>

                        <!-- TTS 버튼 -->
                        <button id="tts-btn" onclick="playTTS()" class="px-3 py-1 border-2 border-primary-500 text-primary-500 rounded-lg text-sm hover:bg-primary-500 hover:text-white transition-all hidden">
                            🔊 발음
                        </button>
                    </div>
                </div>

                <!-- 힌트 표시 영역 -->
                <div id="hint-display" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <span class="text-2xl">💡</span>
                        <div class="flex-1">
                            <div class="font-bold text-yellow-900 mb-1">힌트</div>
                            <div class="text-sm text-yellow-800" id="hint-text"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 보기 -->
            <div class="space-y-3 mb-6" id="options-container">
                <!-- 동적으로 생성됩니다 -->
            </div>
        </div>

        <!-- 학습 통계 -->
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <span class="font-medium text-gray-700">현재 세션 통계</span>
                <span class="text-sm text-blue-600" id="session-accuracy">정답률 0%</span>
            </div>
            <div class="grid grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-xl font-bold text-green-600" id="total-correct">0</div>
                    <div class="text-xs text-gray-600">정답</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-red-600" id="total-incorrect">0</div>
                    <div class="text-xs text-gray-600">오답</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-purple-600" id="difficulty-level">1</div>
                    <div class="text-xs text-gray-600">현재 레벨</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-orange-600" id="time-elapsed">0:00</div>
                    <div class="text-xs text-gray-600">소요 시간</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 전역 변수
        let selectedSubjects = [];
        let currentSubjectIndex = 0;
        let questions = {};
        let currentDifficulty = 1; // 1: 쉬움, 2: 보통, 3: 어려움
        let questionCounts = { easy: 0, medium: 0, hard: 0 };
        let targetCounts = { easy: 10, medium: 5, hard: 1 }; // 정답 기준 완료 목표
        let currentQuestionPool = [];
        let currentQuestionIndex = 0;
        let isAnswered = false;
        let shuffledOptions = [];
        let sessionStats = {
            correct: 0,
            incorrect: 0,
            startTime: Date.now(),
            difficultyHistory: [], // 난이도 변화 추적
            completionType: null // 완료 타입 추적
        };
        let consecutiveCorrectAnswers = 0;
        let consecutiveIncorrectAnswers = 0;
        let vibrationEnabled = true; // 진동 기능 활성화 여부
        let extraLearningMode = false; // 추가 학습 모드 (완료한 과목 추가 학습)

        // 정답 사운드 및 진동 효과 함수
        function playCorrectSound() {
            // 진동 효과 (모바일)
            if (vibrationEnabled && navigator.vibrate) {
                // 정답: 경쾌한 패턴 - 짧게 2번 (성취감)
                navigator.vibrate([100, 50, 100]); // 진동 100ms → 멈춤 50ms → 진동 100ms
            }
            
            try {
                // Web Audio API를 사용하여 경쾌한 효과음 생성
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 첫 번째 음 (높은 음)
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();
                
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);
                
                oscillator1.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator1.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                
                gainNode1.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode1.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.3);
                
                // 두 번째 음 (화음)
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator2.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode2.gain.setValueAtTime(0, audioContext.currentTime + 0.1);
                gainNode2.gain.linearRampToValueAtTime(0.25, audioContext.currentTime + 0.11);
                gainNode2.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
                
                oscillator2.start(audioContext.currentTime + 0.1);
                oscillator2.stop(audioContext.currentTime + 0.4);
                
            } catch (error) {
                // Web Audio API를 지원하지 않는 경우 무시
                console.log('Audio not supported:', error);
            }
        }

        // 오답 사운드 및 진동 효과 함수 (띠띠 경고음)
        function playIncorrectSound() {
            // 진동 효과 (모바일)
            if (vibrationEnabled && navigator.vibrate) {
                // 오답: 길게 한 번 (알림, 하지만 너무 강하지 않게)
                navigator.vibrate(200); // 진동 200ms
            }
            
            try {
                // Web Audio API를 사용하여 경고음 생성
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 첫 번째 "띠" 소리 (낮은 경고음)
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();
                
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);
                
                oscillator1.frequency.setValueAtTime(220, audioContext.currentTime); // A3 (낮은 톤)
                oscillator1.type = 'square'; // 경고음 느낌의 사각파
                
                gainNode1.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode1.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                
                // 두 번째 "띠" 소리 (약간의 간격 후)
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.setValueAtTime(220, audioContext.currentTime + 0.2); // 같은 톤 반복
                oscillator2.type = 'square';
                
                gainNode2.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
                gainNode2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.21);
                gainNode2.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.35);
                
                oscillator2.start(audioContext.currentTime + 0.2);
                oscillator2.stop(audioContext.currentTime + 0.35);
                
            } catch (error) {
                // Web Audio API를 지원하지 않는 경우 무시
                console.log('Audio not supported:', error);
            }
        }

        // 과목 정보
        const subjects = {
            english: { name: '영어', icon: '🇺🇸' },
            listening: { name: '영어(듣기)', icon: '🎧' },
            math: { name: '수학', icon: '🔢' },
            skill: { name: '수학(실력)', icon: '🎯' },
            science: { name: '과학', icon: '🔬' },
            korean: { name: '국어', icon: '📚' },
            social: { name: '사회', icon: '🏛️' },
            common: { name: '상식', icon: '🧠' },
            idiom: { name: '사자성어', icon: '📜' },
            economy: { name: '경제', icon: '💰' },
            production: { name: '생산', icon: '🏭' },
            ai: { name: 'AI', icon: '🤖' }
        };

        // 난이도별 설정 (정답 기준)
        const difficultyConfig = {
            1: { name: '쉬움', class: 'easy', targetCount: 10, timePerQuestion: 20 },
            2: { name: '보통', class: 'medium', targetCount: 5, timePerQuestion: 22.5 },
            3: { name: '어려움', class: 'hard', targetCount: 1, timePerQuestion: 45 }
        };

        // 초기화
        async function initializeQuiz() {
            // localStorage에서 선택된 과목 가져오기
            const stored = localStorage.getItem('selectedSubjects');
            if (!stored) {
                selectedSubjects = ['english']; // 기본값
            } else {
                selectedSubjects = JSON.parse(stored);
            }

            currentSubjectIndex = parseInt(localStorage.getItem('currentSubjectIndex') || '0');

            // 추가 학습 모드 확인
            const extraMode = localStorage.getItem('extraLearningMode');
            extraLearningMode = extraMode === 'true';

            // 수수께끼 데이터 로드
            await loadRiddles();

            // 과목 시작 시 수수께끼 플래그 리셋
            riddleShownThisSubject = false;

            // 문제 데이터 로드
            await loadQuestions();

            // 진동 설정 로드
            const savedVibration = localStorage.getItem('quizVibrationEnabled');
            if (savedVibration !== null) {
                vibrationEnabled = JSON.parse(savedVibration);
            }

            // UI 초기화
            updateUI();
            updateVibrationButton(); // 진동 버튼 상태 초기화
            generateQuestionPool();
            loadCurrentQuestion();
            startTimer();
        }

        // 문제 데이터 로드
        async function loadQuestions() {
            try {
                const today = new Date();
                const dayOfMonth = today.getDate();
                const daySuffix = dayOfMonth % 2 !== 0 ? '-1' : '-2';

                const currentSubject = selectedSubjects[currentSubjectIndex];

                // 학년별 경로 설정
                const userGrade = localStorage.getItem('userGrade') || '4'; // 기본값 4학년
                const gradePath = `grade${userGrade}`;

                const easyFile = `level1${daySuffix}.json`;
                const mediumFile = `level2${daySuffix}.json`;
                const hardFile = `level3${daySuffix}.json`;

                console.log(`📚 문제 로딩: ${gradePath}/${currentSubject}`);

                const [easyQuestions, mediumQuestions, hardQuestions] = await Promise.all([
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${easyFile}`).then(res => res.json()),
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${mediumFile}`).then(res => res.json()),
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${hardFile}`).then(res => res.json())
                ]);

                questions = {
                    easy: easyQuestions,
                    medium: mediumQuestions,
                    hard: hardQuestions
                };

                console.log('문제 로드 완료:', {
                    easy: questions.easy.length,
                    medium: questions.medium.length,
                    hard: questions.hard.length
                });
            } catch (error) {
                console.error('문제 로드 실패:', error);
                // 폴백으로 기본 문제 사용
                loadFallbackQuestions();
            }
        }

        // 폴백 문제
        function loadFallbackQuestions() {
            questions = {
                easy: Array(30).fill().map((_, i) => ({
                    id: `eng_easy_${i+1}`,
                    subject: 'english',
                    question: `쉬운 영어 문제 ${i+1}번입니다.`,
                    options: ['정답', '오답1', '오답2', '오답3'],
                    correctIndex: 0,
                    explanation: `문제 ${i+1}번의 해설입니다.`,
                    difficulty: 1,
                    audioText: 'sample'
                })),
                medium: Array(20).fill().map((_, i) => ({
                    id: `eng_medium_${i+1}`,
                    subject: 'english', 
                    question: `보통 영어 문제 ${i+1}번입니다.`,
                    options: ['정답', '오답1', '오답2', '오답3'],
                    correctIndex: 0,
                    explanation: `문제 ${i+1}번의 해설입니다.`,
                    difficulty: 2
                })),
                hard: Array(10).fill().map((_, i) => ({
                    id: `eng_hard_${i+1}`,
                    subject: 'english',
                    question: `어려운 영어 문제 ${i+1}번입니다.`,
                    options: ['정답', '오답1', '오답2', '오답3'],
                    correctIndex: 0,
                    explanation: `문제 ${i+1}번의 해설입니다.`,
                    difficulty: 3
                }))
            };
        }

        // 문제 풀 생성
        function generateQuestionPool() {
            const config = difficultyConfig[currentDifficulty];
            const difficultyKey = config.class;
            
            currentQuestionPool = [...questions[difficultyKey]];
            // 문제 순서 셔플
            for (let i = currentQuestionPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuestionPool[i], currentQuestionPool[j]] = [currentQuestionPool[j], currentQuestionPool[i]];
            }
            
            currentQuestionIndex = 0;
        }

        // 현재 문제 로드
        function loadCurrentQuestion() {
            if (isSessionComplete()) {
                completeSession();
                return;
            }



            if (currentQuestionIndex >= currentQuestionPool.length) {
                // 문제 풀 재생성
                generateQuestionPool();
            }

            const question = currentQuestionPool[currentQuestionIndex];
            shuffledOptions = shuffleOptions(question);
            isAnswered = false;

            // 힌트 버튼 초기화 (새 문제마다 재활성화)
            const hintBtn = document.getElementById('hint-btn');
            if (hintBtn) {
                hintBtn.disabled = false;
                hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                hintBtn.textContent = '💡 힌트';
            }

            // UI 업데이트
            updateQuestionDisplay(question);
            updateProgressDisplay();
        }

        // 문제 표시 업데이트
        function updateQuestionDisplay(question) {
            document.getElementById('question-text').textContent = question.question;

            // 보기 생성
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = shuffledOptions.map((option, index) => `
                <button class="option-btn w-full p-4 text-left rounded-xl border-2 border-gray-300 hover:border-primary-500 hover:bg-primary-50 font-medium transition-all" onclick="selectOption(${index})">
                    <span class="inline-block w-8 h-8 rounded-full bg-gray-100 text-center leading-8 mr-3 text-sm font-bold">
                        ${String.fromCharCode(65 + index)}
                    </span>
                    ${option.text}
                </button>
            `).join('');

            // 힌트 버튼 표시 조건: 난이도 2(보통) 또는 3(어려움) 이상
            const hintBtn = document.getElementById('hint-btn');
            const hintDisplay = document.getElementById('hint-display');

            // 힌트 영역 초기화 (새 문제 로드 시 숨김)
            hintDisplay.classList.add('hidden');

            // 실력(skill) 과목은 모든 난이도에서 힌트 표시, 다른 과목은 난이도 2 이상에서만 표시
            const isSkillSubject = question.subject === 'skill';
            const shouldShowHint = isSkillSubject || currentDifficulty >= 2;

            if (shouldShowHint && question.hint) {
                // 힌트가 있고 조건 충족 시 버튼 표시
                hintBtn.classList.remove('hidden');
            } else if (shouldShowHint && !question.hint) {
                // 힌트가 없지만 조건 충족 시에도 버튼 표시 (클릭 시 "힌트 없음" 메시지)
                hintBtn.classList.remove('hidden');
            } else {
                // 조건 미충족 시 힌트 버튼 숨김
                hintBtn.classList.add('hidden');
            }

            // TTS 버튼
            const ttsBtn = document.getElementById('tts-btn');
            if (question.audioText) {
                ttsBtn.classList.remove('hidden');
            } else {
                ttsBtn.classList.add('hidden');
            }
        }

        // 진행률 표시 업데이트
        function updateProgressDisplay() {
            const totalCompleted = questionCounts.easy + questionCounts.medium + questionCounts.hard;
            const totalTarget = 10; // 총 10개 정답 완료 목표

            document.getElementById('overall-progress').textContent = `${totalCompleted} / ${totalTarget} 문제`;

            const progress = (totalCompleted / totalTarget) * 100;
            document.getElementById('overall-progress-bar').style.width = progress + '%';

            // 난이도별 현황 업데이트
            document.getElementById('easy-status').innerHTML = `
                <div class="text-lg font-bold text-green-600">${questionCounts.easy}</div>
                <div class="text-xs text-green-700">쉬움 정답</div>
            `;
            document.getElementById('medium-status').innerHTML = `
                <div class="text-lg font-bold text-yellow-600">${questionCounts.medium}</div>
                <div class="text-xs text-yellow-700">보통 정답</div>
            `;
            document.getElementById('hard-status').innerHTML = `
                <div class="text-lg font-bold text-red-600">${questionCounts.hard}</div>
                <div class="text-xs text-red-700">어려움 정답</div>
            `;
        }

        // UI 업데이트
        function updateUI() {
            const currentSubject = selectedSubjects[currentSubjectIndex];
            const subjectInfo = subjects[currentSubject];

            document.getElementById('current-subject').textContent = `${subjectInfo.icon} ${subjectInfo.name}`;


            const config = difficultyConfig[currentDifficulty];
            const difficultyBadge = document.getElementById('difficulty-badge');
            difficultyBadge.textContent = config.name;
            difficultyBadge.className = `px-2 py-1 rounded-full text-xs font-medium difficulty-badge ${config.class}`;

            // 추가 학습 모드 UI 표시
            if (extraLearningMode) {
                document.getElementById('extra-mode-badge').classList.remove('hidden');
                document.getElementById('extra-mode-exit-btn').classList.remove('hidden');
            } else {
                document.getElementById('extra-mode-badge').classList.add('hidden');
                document.getElementById('extra-mode-exit-btn').classList.add('hidden');
            }

            // 세션 통계 업데이트
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = totalAnswered > 0 ? Math.round((sessionStats.correct / totalAnswered) * 100) : 0;

            document.getElementById('total-correct').textContent = sessionStats.correct;
            document.getElementById('total-incorrect').textContent = sessionStats.incorrect;
            document.getElementById('difficulty-level').textContent = currentDifficulty;
            document.getElementById('session-accuracy').textContent = `정답률 ${accuracy}%`;
        }

        // 보기 셔플
        function shuffleOptions(question) {
            const options = question.options.map((text, index) => ({ text, originalIndex: index }));
            const shuffled = [...options];
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled;
        }

        // 옵션 선택
        function selectOption(shuffledIndex) {
            if (isAnswered) return;

            const question = currentQuestionPool[currentQuestionIndex];
            const selectedOriginalIndex = shuffledOptions[shuffledIndex].originalIndex;
            const isCorrect = selectedOriginalIndex === question.correctIndex;
            
            isAnswered = true;

            // 난이도 설정 가져오기
            const config = difficultyConfig[currentDifficulty];
            const difficultyKey = config.class;

            // 통계 업데이트
            if (isCorrect) {
                sessionStats.correct++;
                consecutiveCorrectAnswers++;
                consecutiveIncorrectAnswers = 0;

                // 난이도별 정답 카운트 증가 (정답일 때만 카운트)
                questionCounts[difficultyKey]++;
            } else {
                sessionStats.incorrect++;
                consecutiveIncorrectAnswers++;
                consecutiveCorrectAnswers = 0;
            }

            // 난이도 히스토리 기록
            sessionStats.difficultyHistory.push({
                difficulty: currentDifficulty,
                difficultyName: config.name,
                isCorrect: isCorrect,
                consecutiveCorrect: consecutiveCorrectAnswers,
                timestamp: Date.now()
            });

            // 버튼 상태 업데이트
            updateOptionButtons(shuffledIndex, question.correctIndex);
            
            // 해설 표시
            setTimeout(() => {
                showExplanation(isCorrect, question.explanation);
                updateUI();
                updateProgressDisplay();
                checkDifficultyAdjustment();
            }, 1000);
        }

        // 옵션 버튼 상태 업데이트
        function updateOptionButtons(selectedIndex, correctIndex) {
            const options = document.querySelectorAll('.option-btn');
            
            options.forEach((btn, index) => {
                const originalIndex = shuffledOptions[index].originalIndex;
                
                if (originalIndex === correctIndex) {
                    btn.classList.add('correct');
                    btn.innerHTML += ' <span class="ml-2 text-xl">✅</span>';
                } else if (index === selectedIndex) {
                    btn.classList.add('incorrect');
                    btn.innerHTML += ' <span class="ml-2 text-xl">❌</span>';
                } else {
                    btn.classList.add('neutral');
                }
                
                btn.onclick = null;
            });

            if (selectedIndex !== -1 && shuffledOptions[selectedIndex].originalIndex === correctIndex) {
                options[selectedIndex].classList.add('correct-animation');
                
                // 정답 사운드 효과 (Web Audio API 사용)
                playCorrectSound();
            } else if (selectedIndex !== -1) {
                // 오답 사운드 효과 (띠띠 경고음)
                playIncorrectSound();
            }
        }

        // 해설 표시 (모달 팝업)
        function showExplanation(isCorrect, explanation) {
            const modal = document.getElementById('explanation-modal');
            const modalCard = document.getElementById('explanation-modal-card');
            const modalIcon = document.getElementById('modal-result-icon');
            const modalTitle = document.getElementById('modal-result-text');
            const modalExplanation = document.getElementById('modal-explanation-text');

            if (isCorrect) {
                modalIcon.textContent = '🎉';
                modalTitle.textContent = '정답입니다!';
                modalTitle.className = 'text-3xl font-bold mb-2 text-green-600';
            } else {
                modalIcon.textContent = '😅';
                modalTitle.textContent = '아쉽네요!';
                modalTitle.className = 'text-3xl font-bold mb-2 text-blue-600';
            }

            modalExplanation.textContent = explanation;

            // 모달 표시
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // 카드 애니메이션
            setTimeout(() => {
                modalCard.style.transform = 'scale(1)';
                modalCard.style.opacity = '1';
            }, 10);
        }

        // 해설 모달 닫기 및 다음 문제로
        function closeExplanationModal() {
            const modal = document.getElementById('explanation-modal');
            const modalCard = document.getElementById('explanation-modal-card');

            // 애니메이션
            modalCard.style.transform = 'scale(0.9)';
            modalCard.style.opacity = '0';

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // 다음 문제로 이동
                nextQuestion();
            }, 200);
        }

        // 난이도 조정 확인
        function checkDifficultyAdjustment() {
            if (consecutiveCorrectAnswers >= 3 && currentDifficulty < 3) {
                upgradeDifficulty();
                showAchievement('🚀 난이도 상승!');
            } else if (consecutiveIncorrectAnswers >= 1 && currentDifficulty > 1) {
                // 1문제만 틀려도 난이도 하락
                downgradeDifficulty();
                showAchievement('📖 난이도 하락');
            }
        }

        // 난이도 상승
        function upgradeDifficulty() {
            if (currentDifficulty < 3) {
                currentDifficulty++;
                generateQuestionPool();
                consecutiveCorrectAnswers = 0;
            }
        }

        // 난이도 하락
        function downgradeDifficulty() {
            if (currentDifficulty > 1) {
                currentDifficulty--;
                generateQuestionPool();
                consecutiveIncorrectAnswers = 0;
            }
        }

        // 성취 알림 표시
        function showAchievement(message) {
            const popup = document.getElementById('achievement-popup');
            document.getElementById('achievement-text').textContent = message;
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 2000);
        }

        // 세션 완료 확인
        function isSessionComplete() {
            // 추가 학습 모드에서는 세션을 완료하지 않고 계속 학습
            if (extraLearningMode) {
                return false;
            }

            const totalCorrect = questionCounts.easy + questionCounts.medium + questionCounts.hard;

            // 완료 조건: 총 10개 정답 (난이도 무관)
            if (totalCorrect >= 10) {
                sessionStats.completionType = 'complete';
                return true;
            }

            return false;
        }

        // 다음 문제
        function nextQuestion() {
            // 수수께끼 체크 (연속 오답 기반)
            if (checkRiddleTrigger()) {
                showRiddle();
                return; // 수수께끼 표시 후 리턴 (수수께끼 완료 후 nextQuestion 재호출)
            }

            currentQuestionIndex++;
            loadCurrentQuestion();
        }

        // 다음 문제 (모달 없이 직접 호출용)
        function nextQuestionDirect() {
            currentQuestionIndex++;
            loadCurrentQuestion();
        }

        // 추가 학습 모드 종료 함수
        function exitExtraMode() {
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = totalAnswered > 0 ? Math.round((sessionStats.correct / totalAnswered) * 100) : 0;
            const timeSpent = Math.round((Date.now() - sessionStats.startTime) / 1000 / 60 * 10) / 10;

            // 학습 시간만 저장 (보상 없음)
            const currentSubject = selectedSubjects[currentSubjectIndex];

            // 학습 진행률 업데이트 (시간만)
            updateLearningProgress(currentSubject, sessionStats.correct, totalAnswered);

            alert(`✨ 추가 학습 완료!\n\n` +
                  `총 ${totalAnswered}문제 풀이\n` +
                  `정답률: ${accuracy}%\n` +
                  `학습 시간: ${timeSpent}분\n\n` +
                  `학습 시간이 기록되었습니다!`);

            // localStorage 정리
            localStorage.removeItem('extraLearningMode');
            localStorage.removeItem('selectedSubjects');
            localStorage.removeItem('currentSubjectIndex');

            // 홈으로 이동
            window.location.href = 'index.html';
        }

        // 세션 완료
        function completeSession() {
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = Math.round((sessionStats.correct / totalAnswered) * 100);
            const timeSpent = Math.round((Date.now() - sessionStats.startTime) / 1000 / 60 * 10) / 10;
            const currentSubject = selectedSubjects[currentSubjectIndex];

            // ✅ CRITICAL: 학습 진행률 업데이트 (progress-dashboard.html용)
            updateLearningProgress(currentSubject, sessionStats.correct, totalAnswered);

            // ✅ CRITICAL: PlantSystem 보상 처리
            let plantSystemMessage = '';
            const rewardSummary = {
                completedCount: 0,
                growthTickets: 0,
                normalGacha: 0,
                premiumGacha: 0,
                newRewards: {}
            };

            if (typeof plantSystem !== 'undefined') {
                try {
                    const subjectName = selectedSubjects[currentSubjectIndex];
                    const user = plantSystem.getUserData();

                    // 추가 학습 모드에서는 과목 완료 처리 안 함
                    if (!extraLearningMode) {
                        // 난이도별 코인 계산 (쉬움 1코인, 보통 2코인, 어려움 10코인)
                        const earnedCoins = (questionCounts.easy * 1) + (questionCounts.medium * 2) + (questionCounts.hard * 10);

                        // 과목 완료 처리 (코인 포함)
                        const result = plantSystem.completeSubject(user, subjectName, subjectName, earnedCoins);

                        if (result.success) {
                            rewardSummary.completedCount = result.completedCount;
                            rewardSummary.newRewards = result.rewards;

                            plantSystemMessage = `\n\n📚 과목 완료 (${result.completedCount}/9)`;

                            // 코인 획득 메시지 추가 (결과값 기반)
                            if (result.rewards.earnedCoins > 0) {
                                plantSystemMessage += `\n💰 ${result.rewards.earnedCoins}코인 획득! (쉬움 ${questionCounts.easy}×1 + 보통 ${questionCounts.medium}×2 + 어려움 ${questionCounts.hard}×10)`;
                            }

                            if (result.rewards.growthTickets) {
                                rewardSummary.growthTickets = result.rewards.growthTickets;
                                plantSystemMessage += `\n🎫 성장권 ${result.rewards.growthTickets}개 획득!`;
                            }
                            if (result.rewards.normalGacha) {
                                rewardSummary.normalGacha = result.rewards.normalGacha;
                                plantSystemMessage += `\n🎁 일반 뽑기권 ${result.rewards.normalGacha}개 획득!`;
                            }
                            if (result.rewards.premiumGacha) {
                                rewardSummary.premiumGacha = result.rewards.premiumGacha;
                                plantSystemMessage += `\n💎 프리미엄 뽑기권 ${result.rewards.premiumGacha}개 획득!`;
                            }

                            // Firebase 동기화 (비동기 처리)
                            if (window.eduPetFirebaseIntegration && window.plantSystemFirebase) {
                                // 1. 퀴즈 통계 업데이트 (일일 통계, 과목별 통계, 그룹 통계 포함)
                                eduPetFirebaseIntegration.updateQuizStats({
                                    subject: subjectName,
                                    correctAnswers: sessionStats.correct,
                                    totalQuestions: totalAnswered,
                                    timeSpent: timeSpent
                                }).catch(err => {
                                    console.warn('⚠️ Firebase 퀴즈 통계 동기화 실패 (나중에 재시도됩니다):', err);
                                });

                                // 2. 식물 시스템 상태 저장 (돈, 티켓 정보 포함)
                                plantSystemFirebase.save().catch(err => {
                                    console.warn('⚠️ Firebase 식물 시스템 동기화 실패 (나중에 재시도됩니다):', err);
                                });

                                console.log('✅ Firebase 동기화 완료: 퀴즈 통계 + 식물 시스템 상태');
                            }
                        } else if (result.alreadyCompleted) {
                            plantSystemMessage = '\n\n⚠️ 이미 완료한 과목입니다';
                        }
                    } else {
                        plantSystemMessage = '\n\n✨ 추가 학습 모드 (보상 없음)';
                    }

                    // 약점 학습 업데이트
                    if (typeof weaknessLearning !== 'undefined') {
                        weaknessLearning.updateLearningProgress(user, subjectName, sessionStats.correct > 0);
                    }
                } catch (error) {
                    console.error('식물 시스템 연동 오류:', error);
                }
            }

            alert(`🎉 과목 학습 완료!\n\n총 ${totalAnswered}문제 풀이\n정답률: ${accuracy}%\n소요시간: ${timeSpent}분${plantSystemMessage}`);

            // ✅ CRITICAL: 분석 데이터 저장 (analytics-console.html용)
            const quizAnalytics = {
                subject: currentSubject,
                subjectName: subjects[currentSubject]?.name || currentSubject,
                completionType: sessionStats.completionType,
                stats: {
                    correct: sessionStats.correct,
                    incorrect: sessionStats.incorrect,
                    totalAnswered: totalAnswered,
                    accuracy: accuracy,
                    timeSpent: timeSpent
                },
                questionCounts: questionCounts,
                difficultyHistory: sessionStats.difficultyHistory,
                completedAt: new Date().toISOString()
            };

            // 기존 분석 데이터 로드
            let analyticsHistory = JSON.parse(localStorage.getItem('quizAnalyticsHistory') || '[]');
            analyticsHistory.push(quizAnalytics);

            // 최근 100개만 유지
            if (analyticsHistory.length > 100) {
                analyticsHistory = analyticsHistory.slice(-100);
            }

            localStorage.setItem('quizAnalyticsHistory', JSON.stringify(analyticsHistory));

            // Firebase에도 분석 데이터 저장 (users 하위에 저장)
            if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                const userId = firebase.auth().currentUser.uid;
                firebase.database().ref(`users/${userId}/analytics`).set(analyticsHistory)
                    .then(() => console.log('✅ Firebase 분석 데이터 업로드 완료'))
                    .catch(err => console.error('❌ Firebase 분석 데이터 업로드 실패:', err));
            }

            // 그룹 멤버 진행 상황 업데이트
            if (typeof eduPetSocial !== 'undefined') {
                eduPetSocial.updateGroupMemberProgress().catch(err => {
                    console.warn('그룹 진행 상황 업데이트 실패:', err);
                });
            }

            // 다음 행동 선택
            showNextActionDialog(rewardSummary);
        }

        // 다음 행동 선택 다이얼로그
        function showNextActionDialog(rewardSummary) {
            const { completedCount, growthTickets, normalGacha, premiumGacha, newRewards } = rewardSummary;

            // 9과목 완료 시 (프리미엄 뽑기권) - 학습 완료
            if (completedCount === 9 && premiumGacha) {
                const choice = confirm(`🏆 최고입니다! 9과목 모두 완료!\n💎 프리미엄 동물 뽑기권 ${premiumGacha}개 획득!\n🎫 성장권 1개 추가 획득!\n\n식물에게 물을 주러 가시겠습니까?\n(취소를 누르면 홈으로 이동합니다)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    window.location.href = 'index.html';
                }
                return;
            }

            // 3과목 완료 시 (성장권 1개)
            if (completedCount === 3 && newRewards.growthTickets) {
                const choice = confirm(`🎊 축하합니다! 3과목 완료!\n🎫 성장권 ${growthTickets}개를 획득했습니다!\n\n식물에게 물을 주러 가시겠습니까?\n(취소를 누르면 다음 과목으로 이동합니다)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    moveToNextSubject();
                }
                return;
            }

            // 6과목 완료 시 (성장권 추가 1개)
            if (completedCount === 6 && newRewards.growthTickets) {
                const choice = confirm(`🎊 대단합니다! 6과목 완료!\n🎫 성장권 ${growthTickets}개를 추가로 획득했습니다!\n(누적 성장권: 2개)\n\n식물에게 물을 주러 가시겠습니까?\n(취소를 누르면 다음 과목으로 이동합니다)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    moveToNextSubject();
                }
                return;
            }

            // 5과목 완료 시 (일반 뽑기권) - 축하 후 자동으로 다음 과목
            if (completedCount === 5 && normalGacha) {
                alert(`🎉 훌륭합니다! 5과목 완료!\n🎁 일반 동물 뽑기권 ${normalGacha}개를 획득했습니다!\n\n다음 과목으로 이동합니다.`);
                setTimeout(() => {
                    moveToNextSubject();
                }, 500);
                return;
            }

            // 일반적인 경우 - 자동으로 다음 과목으로 이동 (9과목까지)
            if (completedCount < 9) {
                setTimeout(() => {
                    moveToNextSubject();
                }, 1000);
            } else {
                // 9과목 초과 시 홈으로
                window.location.href = 'index.html';
            }
        }

        // 다음 과목으로 이동
        function moveToNextSubject() {
            currentSubjectIndex++;

            if (currentSubjectIndex >= selectedSubjects.length) {
                // 모든 선택된 과목 완료
                alert('선택한 모든 과목을 완료했습니다!\n홈으로 이동합니다.');
                window.location.href = 'index.html';
                return;
            }

            // 순발력 게임 표시 (과목 전환 시)
            startReflexGame();
        }

        // 순발력 게임 후 다음 과목 로드
        function loadNextSubject() {
            // 다음 과목 데이터 저장
            localStorage.setItem('currentSubjectIndex', currentSubjectIndex.toString());

            // 페이지 새로고침하여 다음 과목 시작
            window.location.reload();
        }

        // 진동 설정 토글
        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            updateVibrationButton();
            
            // 설정을 localStorage에 저장
            localStorage.setItem('quizVibrationEnabled', vibrationEnabled);
            
            // 테스트 진동 (설정 피드백)
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50); // 짧은 확인 진동
            }
        }

        // 학습 진행률 업데이트 함수
        function updateLearningProgress(subject, correctAnswers, totalQuestions) {
            // 기존 진행률 데이터 로드
            let progressData = JSON.parse(localStorage.getItem('learningProgress') || '{}');

            // 오늘 날짜 (ISO format: YYYY-MM-DD)
            const today = new Date().toISOString().split('T')[0];

            // 기본 구조 초기화
            if (!progressData.subjectStats) progressData.subjectStats = {};
            if (!progressData.dailyActivity) progressData.dailyActivity = {};
            if (!progressData.unlockedAchievements) progressData.unlockedAchievements = [];

            // 과목별 통계 초기화 (subjectStats와 루트 레벨 모두에 저장)
            if (!progressData.subjectStats[subject]) {
                progressData.subjectStats[subject] = {
                    questions: 0,
                    correct: 0,
                    lastStudied: null,
                    lastStudyDate: null,
                    level: 1,
                    experience: 0
                };
            }

            // 루트 레벨에도 과목 데이터 저장 (index.html 호환성)
            if (!progressData[subject]) {
                progressData[subject] = {
                    questions: 0,
                    correct: 0,
                    lastStudyDate: null
                };
            }

            // 전체 통계 업데이트
            progressData.totalQuestions = (progressData.totalQuestions || 0) + totalQuestions;
            progressData.correctAnswers = (progressData.correctAnswers || 0) + correctAnswers;

            // 날짜가 바뀌면 오늘 데이터 리셋
            if (progressData.lastActivityDate !== today) {
                progressData.totalMinutesToday = 0;
                progressData.totalCorrectToday = 0;
                progressData.lastActivityDate = today;
            }

            // 오늘 총 학습 시간 업데이트 (문제당 약 10초 = totalQuestions * 10 / 60분)
            const estimatedMinutes = Math.ceil(totalQuestions * 10 / 60);
            progressData.totalMinutesToday = (progressData.totalMinutesToday || 0) + estimatedMinutes;

            // 오늘 총 정답 수 업데이트
            progressData.totalCorrectToday = (progressData.totalCorrectToday || 0) + correctAnswers;

            // 과목별 통계 업데이트 (subjectStats)
            const subjectStats = progressData.subjectStats[subject];
            subjectStats.questions += totalQuestions;
            subjectStats.correct += correctAnswers;
            subjectStats.experience += correctAnswers * 10; // 정답 1개당 10 경험치
            subjectStats.lastStudied = Date.now();
            subjectStats.lastStudyDate = today;

            // 루트 레벨 과목 데이터도 업데이트
            progressData[subject].questions += totalQuestions;
            progressData[subject].correct += correctAnswers;
            progressData[subject].lastStudyDate = today;

            // 일일 활동 업데이트
            progressData.dailyActivity[today] = (progressData.dailyActivity[today] || 0) + totalQuestions;

            // 연속 학습일 업데이트
            if (!progressData.lastStudyDate || progressData.lastStudyDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (progressData.lastStudyDate === yesterdayStr) {
                    // 어제 공부했으면 연속일 증가
                    progressData.streakDays = (progressData.streakDays || 0) + 1;
                } else {
                    // 연속일 리셋
                    progressData.streakDays = 1;
                }

                progressData.lastStudyDate = today;
            }
            
            // 새로운 성취 확인 및 알림
            checkNewAchievements(progressData);
            
            // 업데이트된 진행률 저장
            localStorage.setItem('learningProgress', JSON.stringify(progressData));

            // Firebase에 전체 진행률 동기화
            if (window.updateFirebaseStats) {
                window.updateFirebaseStats.learningProgress(progressData);
            }
            
            console.log('학습 진행률 업데이트 완료:', {
                subject,
                correctAnswers,
                totalQuestions,
                streakDays: progressData.streakDays,
                totalExp: subjectStats.experience
            });
        }
        
        // 새로운 성취 확인
        function checkNewAchievements(progressData) {
            const achievements = [
                { id: 'first_correct', name: '첫 발걸음', requirement: 1, type: 'correct_answers', emoji: '👶' },
                { id: 'streak_3', name: '꾸준함의 시작', requirement: 3, type: 'streak_days', emoji: '🌱' },
                { id: 'streak_7', name: '일주일 챌린저', requirement: 7, type: 'streak_days', emoji: '🔥' },
                { id: 'correct_25', name: '실력자', requirement: 25, type: 'correct_answers', emoji: '⭐' },
                { id: 'correct_100', name: '백점 만점', requirement: 100, type: 'correct_answers', emoji: '🌟' }
            ];
            
            achievements.forEach(achievement => {
                if (progressData.unlockedAchievements.includes(achievement.id)) return;
                
                let isUnlocked = false;
                switch (achievement.type) {
                    case 'correct_answers':
                        isUnlocked = progressData.correctAnswers >= achievement.requirement;
                        break;
                    case 'streak_days':
                        isUnlocked = progressData.streakDays >= achievement.requirement;
                        break;
                    case 'accuracy':
                        const accuracy = progressData.totalQuestions > 0 
                            ? (progressData.correctAnswers / progressData.totalQuestions) * 100 
                            : 0;
                        isUnlocked = accuracy >= achievement.requirement;
                        break;
                }
                
                if (isUnlocked) {
                    progressData.unlockedAchievements.push(achievement.id);
                    
                    // 성취 알림 표시
                    setTimeout(() => {
                        showAchievementUnlock(achievement);
                    }, 2000); // 퀴즈 완료 메시지 후에 표시
                }
            });
        }
        
        // 성취 해제 알림 표시
        function showAchievementUnlock(achievement) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-400 text-yellow-900 px-6 py-4 rounded-xl shadow-lg z-50 achievement-unlock';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">${achievement.emoji}</span>
                    <div>
                        <div class="font-bold">🏆 새로운 성취!</div>
                        <div class="text-sm">${achievement.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3초 후 제거
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // 성취 사운드 재생
            playCorrectSound();
        }

        // 진동 버튼 UI 업데이트
        function updateVibrationButton() {
            const button = document.getElementById('vibration-toggle');
            
            // 진동 API 지원 여부 확인
            if (!navigator.vibrate) {
                button.textContent = '📵';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-gray-100 text-gray-400 cursor-not-allowed';
                button.title = '이 기기는 진동을 지원하지 않습니다';
                button.disabled = true;
                return;
            }
            
            button.disabled = false;
            if (vibrationEnabled) {
                button.textContent = '📳';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-blue-100 text-blue-700 hover:bg-blue-200';
                button.title = '진동 켜짐 (클릭하여 끄기)';
            } else {
                button.textContent = '🔇';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-gray-100 text-gray-500 hover:bg-gray-200';
                button.title = '진동 꺼짐 (클릭하여 켜기)';
            }
        }

        // 타이머
        function startTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStats.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('time-elapsed').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // 힌트 표시
        function showQuizHint() {
            const question = currentQuestionPool[currentQuestionIndex];
            const hintDisplay = document.getElementById('hint-display');
            const hintText = document.getElementById('hint-text');
            const hintBtn = document.getElementById('hint-btn');

            if (question.hint) {
                // 힌트가 있는 경우
                hintText.textContent = question.hint;
                hintDisplay.classList.remove('hidden');

                // 힌트 버튼 비활성화 (한 번만 볼 수 있음)
                hintBtn.disabled = true;
                hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
                hintBtn.textContent = '✓ 힌트 확인';

                console.log('💡 힌트 표시:', question.hint);
            } else {
                // 힌트가 없는 경우
                hintText.textContent = '이 문제에는 힌트가 제공되지 않습니다. 문제를 다시 읽어보세요!';
                hintDisplay.classList.remove('hidden');

                // 힌트 버튼 비활성화
                hintBtn.disabled = true;
                hintBtn.classList.add('opacity-50', 'cursor-not-allowed');

                console.log('💡 힌트 없음');
            }

            // 진동 피드백 (힌트 확인 시)
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // TTS 재생
        function playTTS() {
            const question = currentQuestionPool[currentQuestionIndex];

            if (question.audioText && 'speechSynthesis' in window) {
                // 영어 음성 사용 강제
                const utterance = new SpeechSynthesisUtterance(question.audioText);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;

                // 영어 음성만 필터링
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice =>
                    voice.lang.startsWith('en-') &&
                    (voice.name.includes('English') || voice.name.includes('US') || voice.name.includes('GB'))
                );

                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                speechSynthesis.speak(utterance);
            }
        }

        // ========== 수수께끼 시스템 ==========
        let riddlesData = [];
        let usedRiddleIds = [];
        let currentRiddle = null;
        let riddleShownThisSubject = false; // 과목당 1회 제한

        // 수수께끼 데이터 로드
        async function loadRiddles() {
            try {
                const response = await fetch('src/data/riddles.json');
                const data = await response.json();
                riddlesData = data.riddles;
                console.log('✅ 수수께끼 데이터 로드 완료:', riddlesData.length + '개');
            } catch (error) {
                console.error('❌ 수수께끼 데이터 로드 실패:', error);
                riddlesData = [];
            }
        }

        // 수수께끼 발현 체크 (오답 기반)
        function checkRiddleTrigger() {
            // 이미 이번 과목에서 수수께끼를 보여줬으면 발현 안함
            if (riddleShownThisSubject) return false;

            // 추가 학습 모드에서는 수수께끼 안나옴
            if (extraLearningMode) return false;

            // 총 틀린 문제 3개 이상 -> 100% 발현
            if (sessionStats.incorrect >= 3) {
                console.log('🎪 수수께끼 100% 발현 (총 오답 3회 이상)');
                return true;
            }

            // 연속 오답 2회 -> 50% 발현
            if (consecutiveIncorrectAnswers === 2) {
                const shouldShow = Math.random() < 0.5;
                console.log(`🎪 수수께끼 50% 발현 체크 (연속 오답 2회): ${shouldShow ? '발현!' : '통과'}`);
                return shouldShow;
            }

            return false;
        }

        // 수수께끼 표시
        function showRiddle() {
            if (riddlesData.length === 0) {
                console.warn('수수께끼 데이터 없음');
                return;
            }

            // 사용하지 않은 수수께끼 필터링
            const availableRiddles = riddlesData.filter(r => !usedRiddleIds.includes(r.id));

            // 모두 사용했으면 리셋
            if (availableRiddles.length === 0) {
                usedRiddleIds = [];
                availableRiddles.push(...riddlesData);
            }

            // 랜덤 선택
            currentRiddle = availableRiddles[Math.floor(Math.random() * availableRiddles.length)];
            usedRiddleIds.push(currentRiddle.id);

            // UI 업데이트
            document.getElementById('riddle-question').textContent = currentRiddle.q;
            document.getElementById('riddle-hint-text').textContent = currentRiddle.hint;
            document.getElementById('riddle-answer-input').value = '';
            document.getElementById('riddle-hint').classList.add('hidden');
            document.getElementById('riddle-result').classList.add('hidden');
            document.getElementById('riddle-hint-btn').classList.remove('hidden');
            document.getElementById('riddle-submit-btn').classList.remove('hidden');
            document.getElementById('riddle-skip-btn').classList.remove('hidden');

            // 모달 표시
            document.getElementById('riddle-modal').classList.remove('hidden');

            // 입력창에 포커스
            setTimeout(() => {
                document.getElementById('riddle-answer-input').focus();
            }, 300);

            riddleShownThisSubject = true;

            console.log('🎪 수수께끼 표시:', currentRiddle.q);
        }

        // 힌트 보기
        function showRiddleHint() {
            document.getElementById('riddle-hint').classList.remove('hidden');
            document.getElementById('riddle-hint-btn').classList.add('hidden');
        }

        // 정답 확인
        function checkRiddleAnswer() {
            const userAnswer = document.getElementById('riddle-answer-input').value.trim().toLowerCase();

            if (!userAnswer) {
                alert('답을 입력해주세요!');
                return;
            }

            // 정답 체크 (여러 정답 가능)
            const isCorrect = currentRiddle.a.some(answer =>
                answer.toLowerCase() === userAnswer
            );

            const resultDiv = document.getElementById('riddle-result');
            resultDiv.classList.remove('hidden');

            if (isCorrect) {
                // 정답!
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 animate-bounce">
                        <div class="flex items-center space-x-3">
                            <span class="text-4xl">🎉</span>
                            <div>
                                <div class="font-bold text-green-900 text-lg">정답입니다!</div>
                                <div class="text-sm text-green-800 mt-1">일반 뽑기권 1개를 받았어요! 🎁</div>
                            </div>
                        </div>
                    </div>
                `;

                // 보상 지급
                giveRiddleReward();

                // 버튼 숨기기
                document.getElementById('riddle-hint-btn').classList.add('hidden');
                document.getElementById('riddle-submit-btn').classList.add('hidden');
                document.getElementById('riddle-answer-input').disabled = true;

                // 2초 후 자동 닫기
                setTimeout(() => {
                    closeRiddle();
                }, 2000);

            } else {
                // 오답
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">😅</span>
                            <div>
                                <div class="font-bold text-red-900">아쉬워요!</div>
                                <div class="text-sm text-red-800 mt-1">다시 생각해보세요</div>
                            </div>
                        </div>
                    </div>
                `;

                // 1초 후 결과 숨기기
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 1500);
            }

            // 진동 피드백
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(isCorrect ? [100, 50, 100] : [200]);
            }
        }

        // 수수께끼 보상 지급
        function giveRiddleReward() {
            try {
                const user = plantSystem.getUserData();

                if (!user.rewards) {
                    user.rewards = {
                        growthTickets: [],
                        normalGachaTickets: 0,
                        premiumGachaTickets: 0
                    };
                }

                // 일반 뽑기권 1개 지급
                user.rewards.normalGachaTickets = (user.rewards.normalGachaTickets || 0) + 1;
                plantSystem.saveUserData(user);

                console.log('🎁 수수께끼 보상 지급: 일반 뽑기권 +1');

            } catch (error) {
                console.error('보상 지급 오류:', error);
            }
        }

        // 수수께끼 건너뛰기
        function skipRiddle() {
            closeRiddle();
        }

        // 수수께끼 모달 닫기
        function closeRiddle() {
            document.getElementById('riddle-modal').classList.add('hidden');
            document.getElementById('riddle-answer-input').disabled = false;

            // 다음 문제 진행
            nextQuestion();
        }

        // ========== 순발력 게임 시스템 ==========
        let reflexGameScore = 0;
        let reflexGameTimeLeft = 0;
        let reflexGameInterval = null;
        let reflexTargetColor = '';

        // 순발력 게임 시작 (과목 전환 시)
        function startReflexGame() {
            // 추가 학습 모드에서는 순발력 게임 안함
            if (extraLearningMode) {
                loadNextSubject();
                return;
            }

            reflexGameScore = 0;
            reflexGameTimeLeft = 10; // 10초 게임

            document.getElementById('reflex-score').textContent = '점수: 0';
            document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;
            document.getElementById('reflex-continue-btn').classList.add('hidden');
            document.getElementById('reflex-instruction').textContent = '준비하세요...';

            // 모달 표시
            document.getElementById('reflex-modal').classList.remove('hidden');

            // 3초 카운트다운
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('reflex-timer').textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startReflexRound();
                }
            }, 1000);

            console.log('⚡ 순발력 게임 시작');
        }

        // 순발력 게임 라운드 시작
        function startReflexRound() {
            document.getElementById('reflex-instruction').textContent = '같은 색깔을 빠르게 찾으세요!';

            // 색깔 목록
            const colors = [
                { name: '빨강', bg: 'bg-red-500', code: '#ef4444' },
                { name: '파랑', bg: 'bg-blue-500', code: '#3b82f6' },
                { name: '초록', bg: 'bg-green-500', code: '#22c55e' },
                { name: '노랑', bg: 'bg-yellow-400', code: '#facc15' },
                { name: '보라', bg: 'bg-purple-500', code: '#a855f7' },
                { name: '분홍', bg: 'bg-pink-500', code: '#ec4899' }
            ];

            // 랜덤 타겟 색깔 선택
            reflexTargetColor = colors[Math.floor(Math.random() * colors.length)];

            // 버튼 4개 생성 (1개는 정답, 나머지는 오답)
            const buttons = [reflexTargetColor];
            const otherColors = colors.filter(c => c.name !== reflexTargetColor.name);

            // 3개 오답 추가
            for (let i = 0; i < 3 && otherColors.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * otherColors.length);
                buttons.push(otherColors[randomIndex]);
                otherColors.splice(randomIndex, 1);
            }

            // 버튼 셔플
            buttons.sort(() => Math.random() - 0.5);

            // 게임 영역에 버튼 생성
            const gameArea = document.getElementById('reflex-game-area');
            gameArea.innerHTML = buttons.map(color => `
                <button onclick="checkReflexAnswer('${color.name}')"
                        class="${color.bg} text-white rounded-lg p-6 text-center font-bold hover:opacity-80 transition-all transform hover:scale-105">
                    ${color.name}
                </button>
            `).join('');

            // 타이머 시작
            reflexGameTimeLeft = 10;
            document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;

            if (reflexGameInterval) clearInterval(reflexGameInterval);

            reflexGameInterval = setInterval(() => {
                reflexGameTimeLeft--;
                document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;

                if (reflexGameTimeLeft <= 0) {
                    clearInterval(reflexGameInterval);
                    endReflexGame();
                }
            }, 1000);
        }

        // 순발력 게임 정답 체크
        function checkReflexAnswer(selectedColor) {
            if (reflexGameTimeLeft <= 0) return;

            if (selectedColor === reflexTargetColor.name) {
                // 정답!
                reflexGameScore += 10;
                document.getElementById('reflex-score').textContent = '점수: ' + reflexGameScore;

                // 진동 피드백
                if (vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([50]);
                }

                // 새 라운드 시작
                startReflexRound();
            } else {
                // 오답 - 아무 일도 일어나지 않음 (페널티 없음)
                if (vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            }
        }

        // 순발력 게임 종료
        function endReflexGame() {
            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            document.getElementById('reflex-instruction').textContent =
                `게임 종료! 최종 점수: ${reflexGameScore}점`;
            document.getElementById('reflex-game-area').innerHTML = '';
            document.getElementById('reflex-continue-btn').classList.remove('hidden');

            console.log('⚡ 순발력 게임 종료 - 점수:', reflexGameScore);
        }

        // 순발력 게임 건너뛰기
        function skipReflexGame() {
            // 게임 타이머 정리
            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            // 모달 닫기
            document.getElementById('reflex-modal').classList.add('hidden');

            // 다음 과목으로 바로 이동
            loadNextSubject();

            console.log('⚡ 순발력 게임 건너뛰기');
        }

        // 순발력 게임 모달 닫기 및 다음 과목 로드
        function closeReflexGame() {
            document.getElementById('reflex-modal').classList.add('hidden');

            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            // 다음 과목 로드
            loadNextSubject();
        }

        // ========== 기존 함수 수정 ==========

        // 나가기 확인
        function confirmExit() {
            if (confirm('학습을 중단하시겠습니까? 진행 상황이 저장되지 않을 수 있습니다.')) {
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if(loadingOverlay) loadingOverlay.classList.remove('hidden');

            try {
                // eduPetFirebaseIntegration가 정의될 때까지 기다림
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        if (typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // Firebase 통합 기능을 초기화합니다. (이 과정에서 익명 로그인이 트리거될 수 있습니다)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

                // 이제 퀴즈를 초기화합니다.
                await initializeQuiz();

            } catch (error) {
                console.error('초기화 중 오류 발생:', error);
                // 오프라인 모드로 계속 진행
                await initializeQuiz();
            } finally {
                // 데이터 로드가 완료되면 로딩 오버레이를 숨깁니다.
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        });
    </script>

    <!-- 수수께끼 모달 -->
    <div id="riddle-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">🎪</div>
                <h2 class="text-2xl font-bold text-purple-900 mb-2">잠깐! 수수께끼 타임!</h2>
                <p class="text-sm text-purple-700">맞히면 특별 보상이 있어요 🎁</p>
            </div>

            <div class="bg-white rounded-xl p-6 mb-6 shadow-md">
                <p class="text-lg text-gray-800 font-medium leading-relaxed mb-4" id="riddle-question">
                    수수께끼가 여기에 표시됩니다
                </p>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">답을 입력하세요:</label>
                    <input type="text" id="riddle-answer-input"
                           class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg"
                           placeholder="정답을 입력하세요"
                           onkeypress="if(event.key==='Enter') checkRiddleAnswer()">
                </div>

                <div id="riddle-hint" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 mb-4">
                    <div class="flex items-start space-x-2">
                        <span class="text-lg">💡</span>
                        <div>
                            <div class="font-bold text-yellow-900 text-sm">힌트</div>
                            <div class="text-sm text-yellow-800" id="riddle-hint-text"></div>
                        </div>
                    </div>
                </div>

                <div id="riddle-result" class="hidden mb-4"></div>
            </div>

            <div class="flex space-x-3">
                <button onclick="showRiddleHint()" id="riddle-hint-btn"
                        class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition-all">
                    💡 힌트 보기
                </button>
                <button onclick="checkRiddleAnswer()" id="riddle-submit-btn"
                        class="flex-1 px-4 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition-all">
                    ✅ 확인
                </button>
            </div>

            <button onclick="skipRiddle()" id="riddle-skip-btn"
                    class="w-full mt-3 px-4 py-2 text-gray-500 hover:text-gray-700 text-sm transition-all">
                건너뛰기 →
            </button>
        </div>
    </div>

    <!-- 해설 모달 -->
    <div id="explanation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div id="explanation-modal-card" class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full transform transition-all">
            <!-- 결과 아이콘 & 텍스트 -->
            <div class="text-center mb-6">
                <div class="text-7xl mb-4 animate-bounce" id="modal-result-icon">🎉</div>
                <h2 class="text-3xl font-bold mb-2" id="modal-result-text">정답입니다!</h2>
            </div>

            <!-- 해설 내용 -->
            <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <span class="text-2xl mr-2">💡</span>
                    <span>해설</span>
                </h3>
                <p class="text-gray-700 leading-relaxed text-lg" id="modal-explanation-text">
                    해설이 여기에 표시됩니다.
                </p>
            </div>

            <!-- 다음 문제 버튼 -->
            <button onclick="closeExplanationModal()"
                    class="w-full px-8 py-4 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl text-lg font-bold hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg transform hover:scale-105">
                다음 문제로 ➡️
            </button>
        </div>
    </div>

    <!-- 순발력 게임 모달 -->
    <div id="reflex-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">⚡</div>
                <h2 class="text-2xl font-bold text-blue-900 mb-2">순발력 테스트!</h2>
                <p class="text-sm text-blue-700">다음 과목 시작 전 잠깐 쉬어가요</p>
            </div>

            <div class="bg-white rounded-xl p-6 mb-6 shadow-md">
                <div class="text-center mb-4">
                    <p class="text-lg font-medium text-gray-800 mb-4" id="reflex-instruction">
                        준비하세요...
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-4" id="reflex-game-area">
                        <!-- 게임 버튼들이 여기에 동적으로 생성됩니다 -->
                    </div>

                    <div id="reflex-timer" class="text-3xl font-bold text-blue-600 mb-2">3</div>
                    <div id="reflex-score" class="text-sm text-gray-600">점수: 0</div>
                </div>
            </div>

            <button onclick="closeReflexGame()" id="reflex-continue-btn"
                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-all shadow-lg hidden">
                다음 과목으로 계속하기 →
            </button>

            <!-- 건너뛰기 버튼 (항상 표시) -->
            <button onclick="skipReflexGame()" id="reflex-skip-btn"
                    class="w-full mt-3 px-4 py-2 text-gray-500 hover:text-gray-700 text-sm transition-all">
                건너뛰기 →
            </button>
        </div>
    </div>
</body>
</html>