<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ì‘í˜• í•™ìŠµ - EduPet Collection</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- í•œê¸€ í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- MathJax for LaTeX support -->
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['\\(','\\)']],
                displayMath: [['\\[','\\]']],
                processEscapes: true
            },
            "HTML-CSS": {
                linebreaks: { automatic: true }
            },
            SVG: {
                linebreaks: { automatic: true }
            }
        });
    </script>

    <!-- ë¡œê±° ì‹œìŠ¤í…œ (ê°€ì¥ ë¨¼ì € ë¡œë“œ) -->
    <script src="logger.js"></script>

    <!-- ì‹ë¬¼ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ -->
    <script defer src="plant-system.js"></script>
    <script defer src="weakness-learning.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .font-game {
            font-family: 'Noto Sans KR', 'Comic Sans MS', cursive;
            font-weight: 600;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.1) 0%, 
                rgba(255, 152, 0, 0.1) 50%, 
                rgba(33, 150, 243, 0.1) 100%
            );
        }
        
        .option-btn {
            transition: all 0.2s ease;
        }
        
        .option-btn:hover {
            transform: scale(1.02);
        }
        
        .option-btn.correct {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .option-btn.incorrect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .option-btn.neutral {
            background-color: #e5e7eb;
            border-color: #e5e7eb;
            color: #6b7280;
        }
        
        .correct-animation {
            animation: gentleBounce 0.6s ease-out;
        }
        
        @keyframes gentleBounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.08); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1.02); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-fill {
            transition: width 0.8s ease-out;
        }
        
        .difficulty-badge {
            position: relative;
        }
        
        .difficulty-badge.easy {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .difficulty-badge.medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .difficulty-badge.hard {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .achievement-popup {
            animation: achievementSlide 2s ease-out;
        }

        @keyframes achievementSlide {
            0% { transform: translateY(-100px); opacity: 0; }
            20% { transform: translateY(0); opacity: 1; }
            80% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        /* í•´ì„¤ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        #explanation-modal-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#4CAF50', 600: '#16a34a' },
                        secondary: { 500: '#FF9800', 600: '#ea580c' }
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Firebase í†µí•© ìŠ¤í¬ë¦½íŠ¸ -->
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-auth.js"></script>
    <script defer src="firebase-integration.js"></script>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-2xl animate-spin">ğŸŒ±</div>
            <div class="mt-2 font-bold text-gray-700">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    <!-- ì„±ì·¨ ì•Œë¦¼ -->
    <div id="achievement-popup" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full shadow-lg achievement-popup">
            <div class="flex items-center space-x-2">
                <span class="text-lg">ğŸ†</span>
                <span class="font-bold" id="achievement-text">ë‚œì´ë„ ìƒìŠ¹!</span>
            </div>
        </div>
    </div>

    <!-- í€´ì¦ˆ ì»¨í…Œì´ë„ˆ -->
    <div class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <button onclick="confirmExit()" class="p-2 rounded-lg hover:bg-white hover:shadow-md transition-all">
                    â† ë‚˜ê°€ê¸°
                </button>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium" id="current-subject">
                        ğŸ‡ºğŸ‡¸ ì˜ì–´
                    </span>
                    <span class="px-2 py-1 rounded-full text-xs font-medium difficulty-badge" id="difficulty-badge">
                        ì‰¬ì›€
                    </span>
                    <!-- ì¶”ê°€ í•™ìŠµ ëª¨ë“œ ë°°ì§€ -->
                    <span id="extra-mode-badge" class="hidden px-3 py-1 bg-orange-500 text-white rounded-full text-xs font-bold">
                        âœ¨ ì¶”ê°€ í•™ìŠµ
                    </span>
                </div>
            </div>

            <div class="text-right">
                <div class="flex items-center justify-end space-x-2 mb-2">
                    <!-- ì¶”ê°€ í•™ìŠµ ëª¨ë“œ ì¢…ë£Œ ë²„íŠ¼ -->
                    <button id="extra-mode-exit-btn" onclick="exitExtraMode()"
                            class="hidden px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-bold transition-all shadow-md">
                        ğŸ í•™ìŠµ ì¢…ë£Œ
                    </button>
                    <button onclick="toggleVibration()" id="vibration-toggle"
                            class="p-2 rounded-lg transition-all text-sm"
                            title="ì§„ë™ ì„¤ì •">
                        ğŸ“³
                    </button>
                </div>

            </div>
        </div>

        <!-- ì§„í–‰ë¥  ë° í†µê³„ -->
        <div class="bg-white rounded-xl p-4 mb-6 shadow-md">
            <!-- ì „ì²´ ì§„í–‰ë¥  -->
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-gray-700">í•™ìŠµ ì§„í–‰ë¥ </span>
                <span class="text-sm font-bold text-primary-600" id="overall-progress">1 / 30 ë¬¸ì œ</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                <div class="bg-primary-500 h-3 rounded-full progress-fill" id="overall-progress-bar" style="width: 3.33%;"></div>
            </div>
            
            <!-- ë‚œì´ë„ë³„ í˜„í™© -->
            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="p-3 bg-green-50 rounded-lg border border-green-200" id="easy-status">
                    <div class="text-lg font-bold text-green-600">0/10</div>
                    <div class="text-xs text-green-700">ì‰¬ì›€ ì •ë‹µ</div>
                </div>
                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200" id="medium-status">
                    <div class="text-lg font-bold text-yellow-600">0/5</div>
                    <div class="text-xs text-yellow-700">ë³´í†µ ì •ë‹µ</div>
                </div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-200" id="hard-status">
                    <div class="text-lg font-bold text-red-600">0/1</div>
                    <div class="text-xs text-red-700">ì–´ë ¤ì›€ ì •ë‹µ</div>
                </div>
            </div>
        </div>

        <!-- í€´ì¦ˆ ì¹´ë“œ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 slide-in" id="quiz-card">
            <!-- ë¬¸ì œ -->
            <div class="mb-6">
                <div class="flex items-start justify-between">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex-1" id="question-text">
                        ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </h2>

                    <div class="flex items-start space-x-2 ml-4">
                        <!-- íŒíŠ¸ ë²„íŠ¼ -->
                        <button id="hint-btn" onclick="showQuizHint()" class="px-3 py-1 border-2 border-yellow-500 text-yellow-600 rounded-lg text-sm hover:bg-yellow-500 hover:text-white transition-all hidden">
                            ğŸ’¡ íŒíŠ¸
                        </button>

                        <!-- TTS ë²„íŠ¼ -->
                        <button id="tts-btn" onclick="playTTS()" class="px-3 py-1 border-2 border-primary-500 text-primary-500 rounded-lg text-sm hover:bg-primary-500 hover:text-white transition-all hidden">
                            ğŸ”Š ë°œìŒ
                        </button>
                    </div>
                </div>

                <!-- íŒíŠ¸ í‘œì‹œ ì˜ì—­ -->
                <div id="hint-display" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <span class="text-2xl">ğŸ’¡</span>
                        <div class="flex-1">
                            <div class="font-bold text-yellow-900 mb-1">íŒíŠ¸</div>
                            <div class="text-sm text-yellow-800" id="hint-text"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë³´ê¸° -->
            <div class="space-y-3 mb-6" id="options-container">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- í•™ìŠµ í†µê³„ -->
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <span class="font-medium text-gray-700">í˜„ì¬ ì„¸ì…˜ í†µê³„</span>
                <span class="text-sm text-blue-600" id="session-accuracy">ì •ë‹µë¥  0%</span>
            </div>
            <div class="grid grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-xl font-bold text-green-600" id="total-correct">0</div>
                    <div class="text-xs text-gray-600">ì •ë‹µ</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-red-600" id="total-incorrect">0</div>
                    <div class="text-xs text-gray-600">ì˜¤ë‹µ</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-purple-600" id="difficulty-level">1</div>
                    <div class="text-xs text-gray-600">í˜„ì¬ ë ˆë²¨</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-orange-600" id="time-elapsed">0:00</div>
                    <div class="text-xs text-gray-600">ì†Œìš” ì‹œê°„</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let selectedSubjects = [];
        let currentSubjectIndex = 0;
        let questions = {};
        let currentDifficulty = 1; // 1: ì‰¬ì›€, 2: ë³´í†µ, 3: ì–´ë ¤ì›€
        let questionCounts = { easy: 0, medium: 0, hard: 0 };
        let targetCounts = { easy: 10, medium: 5, hard: 1 }; // ì •ë‹µ ê¸°ì¤€ ì™„ë£Œ ëª©í‘œ
        let currentQuestionPool = [];
        let currentQuestionIndex = 0;
        let isAnswered = false;
        let shuffledOptions = [];
        let sessionStats = {
            correct: 0,
            incorrect: 0,
            startTime: Date.now(),
            difficultyHistory: [], // ë‚œì´ë„ ë³€í™” ì¶”ì 
            completionType: null // ì™„ë£Œ íƒ€ì… ì¶”ì 
        };
        let consecutiveCorrectAnswers = 0;
        let consecutiveIncorrectAnswers = 0;
        let vibrationEnabled = true; // ì§„ë™ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€
        let extraLearningMode = false; // ì¶”ê°€ í•™ìŠµ ëª¨ë“œ (ì™„ë£Œí•œ ê³¼ëª© ì¶”ê°€ í•™ìŠµ)

        // ì •ë‹µ ì‚¬ìš´ë“œ ë° ì§„ë™ íš¨ê³¼ í•¨ìˆ˜
        function playCorrectSound() {
            // ì§„ë™ íš¨ê³¼ (ëª¨ë°”ì¼)
            if (vibrationEnabled && navigator.vibrate) {
                // ì •ë‹µ: ê²½ì¾Œí•œ íŒ¨í„´ - ì§§ê²Œ 2ë²ˆ (ì„±ì·¨ê°)
                navigator.vibrate([100, 50, 100]); // ì§„ë™ 100ms â†’ ë©ˆì¶¤ 50ms â†’ ì§„ë™ 100ms
            }
            
            try {
                // Web Audio APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ì¾Œí•œ íš¨ê³¼ìŒ ìƒì„±
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ì²« ë²ˆì§¸ ìŒ (ë†’ì€ ìŒ)
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();
                
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);
                
                oscillator1.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator1.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                
                gainNode1.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode1.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.3);
                
                // ë‘ ë²ˆì§¸ ìŒ (í™”ìŒ)
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator2.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode2.gain.setValueAtTime(0, audioContext.currentTime + 0.1);
                gainNode2.gain.linearRampToValueAtTime(0.25, audioContext.currentTime + 0.11);
                gainNode2.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
                
                oscillator2.start(audioContext.currentTime + 0.1);
                oscillator2.stop(audioContext.currentTime + 0.4);
                
            } catch (error) {
                // Web Audio APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë¬´ì‹œ
                console.log('Audio not supported:', error);
            }
        }

        // ì˜¤ë‹µ ì‚¬ìš´ë“œ ë° ì§„ë™ íš¨ê³¼ í•¨ìˆ˜ (ë ë  ê²½ê³ ìŒ)
        function playIncorrectSound() {
            // ì§„ë™ íš¨ê³¼ (ëª¨ë°”ì¼)
            if (vibrationEnabled && navigator.vibrate) {
                // ì˜¤ë‹µ: ê¸¸ê²Œ í•œ ë²ˆ (ì•Œë¦¼, í•˜ì§€ë§Œ ë„ˆë¬´ ê°•í•˜ì§€ ì•Šê²Œ)
                navigator.vibrate(200); // ì§„ë™ 200ms
            }
            
            try {
                // Web Audio APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ê³ ìŒ ìƒì„±
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ì²« ë²ˆì§¸ "ë " ì†Œë¦¬ (ë‚®ì€ ê²½ê³ ìŒ)
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();
                
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);
                
                oscillator1.frequency.setValueAtTime(220, audioContext.currentTime); // A3 (ë‚®ì€ í†¤)
                oscillator1.type = 'square'; // ê²½ê³ ìŒ ëŠë‚Œì˜ ì‚¬ê°íŒŒ
                
                gainNode1.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode1.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode1.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                
                // ë‘ ë²ˆì§¸ "ë " ì†Œë¦¬ (ì•½ê°„ì˜ ê°„ê²© í›„)
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.setValueAtTime(220, audioContext.currentTime + 0.2); // ê°™ì€ í†¤ ë°˜ë³µ
                oscillator2.type = 'square';
                
                gainNode2.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
                gainNode2.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.21);
                gainNode2.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.35);
                
                oscillator2.start(audioContext.currentTime + 0.2);
                oscillator2.stop(audioContext.currentTime + 0.35);
                
            } catch (error) {
                // Web Audio APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë¬´ì‹œ
                console.log('Audio not supported:', error);
            }
        }

        // ê³¼ëª© ì •ë³´
        const subjects = {
            english: { name: 'ì˜ì–´', icon: 'ğŸ‡ºğŸ‡¸' },
            listening: { name: 'ì˜ì–´(ë“£ê¸°)', icon: 'ğŸ§' },
            math: { name: 'ìˆ˜í•™', icon: 'ğŸ”¢' },
            skill: { name: 'ìˆ˜í•™(ì‹¤ë ¥)', icon: 'ğŸ¯' },
            science: { name: 'ê³¼í•™', icon: 'ğŸ”¬' },
            korean: { name: 'êµ­ì–´', icon: 'ğŸ“š' },
            social: { name: 'ì‚¬íšŒ', icon: 'ğŸ›ï¸' },
            common: { name: 'ìƒì‹', icon: 'ğŸ§ ' },
            idiom: { name: 'ì‚¬ìì„±ì–´', icon: 'ğŸ“œ' },
            economy: { name: 'ê²½ì œ', icon: 'ğŸ’°' },
            production: { name: 'ìƒì‚°', icon: 'ğŸ­' },
            ai: { name: 'AI', icon: 'ğŸ¤–' }
        };

        // ë‚œì´ë„ë³„ ì„¤ì • (ì •ë‹µ ê¸°ì¤€)
        const difficultyConfig = {
            1: { name: 'ì‰¬ì›€', class: 'easy', targetCount: 10, timePerQuestion: 20 },
            2: { name: 'ë³´í†µ', class: 'medium', targetCount: 5, timePerQuestion: 22.5 },
            3: { name: 'ì–´ë ¤ì›€', class: 'hard', targetCount: 1, timePerQuestion: 45 }
        };

        // ì´ˆê¸°í™”
        async function initializeQuiz() {
            // localStorageì—ì„œ ì„ íƒëœ ê³¼ëª© ê°€ì ¸ì˜¤ê¸°
            const stored = localStorage.getItem('selectedSubjects');
            if (!stored) {
                selectedSubjects = ['english']; // ê¸°ë³¸ê°’
            } else {
                selectedSubjects = JSON.parse(stored);
            }

            currentSubjectIndex = parseInt(localStorage.getItem('currentSubjectIndex') || '0');

            // ì¶”ê°€ í•™ìŠµ ëª¨ë“œ í™•ì¸
            const extraMode = localStorage.getItem('extraLearningMode');
            extraLearningMode = extraMode === 'true';

            // ìˆ˜ìˆ˜ê»˜ë¼ ë°ì´í„° ë¡œë“œ
            await loadRiddles();

            // ê³¼ëª© ì‹œì‘ ì‹œ ìˆ˜ìˆ˜ê»˜ë¼ í”Œë˜ê·¸ ë¦¬ì…‹
            riddleShownThisSubject = false;

            // ë¬¸ì œ ë°ì´í„° ë¡œë“œ
            await loadQuestions();

            // ì§„ë™ ì„¤ì • ë¡œë“œ
            const savedVibration = localStorage.getItem('quizVibrationEnabled');
            if (savedVibration !== null) {
                vibrationEnabled = JSON.parse(savedVibration);
            }

            // UI ì´ˆê¸°í™”
            updateUI();
            updateVibrationButton(); // ì§„ë™ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            generateQuestionPool();
            loadCurrentQuestion();
            startTimer();
        }

        // ë¬¸ì œ ë°ì´í„° ë¡œë“œ
        async function loadQuestions() {
            try {
                const today = new Date();
                const dayOfMonth = today.getDate();
                const daySuffix = dayOfMonth % 2 !== 0 ? '-1' : '-2';

                const currentSubject = selectedSubjects[currentSubjectIndex];

                // í•™ë…„ë³„ ê²½ë¡œ ì„¤ì •
                const userGrade = localStorage.getItem('userGrade') || '4'; // ê¸°ë³¸ê°’ 4í•™ë…„
                const gradePath = `grade${userGrade}`;

                const easyFile = `level1${daySuffix}.json`;
                const mediumFile = `level2${daySuffix}.json`;
                const hardFile = `level3${daySuffix}.json`;

                console.log(`ğŸ“š ë¬¸ì œ ë¡œë”©: ${gradePath}/${currentSubject}`);

                const [easyQuestions, mediumQuestions, hardQuestions] = await Promise.all([
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${easyFile}`).then(res => res.json()),
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${mediumFile}`).then(res => res.json()),
                    fetch(`src/data/questions/${gradePath}/${currentSubject}/${hardFile}`).then(res => res.json())
                ]);

                questions = {
                    easy: easyQuestions,
                    medium: mediumQuestions,
                    hard: hardQuestions
                };

                console.log('ë¬¸ì œ ë¡œë“œ ì™„ë£Œ:', {
                    easy: questions.easy.length,
                    medium: questions.medium.length,
                    hard: questions.hard.length
                });
            } catch (error) {
                console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', error);
                // í´ë°±ìœ¼ë¡œ ê¸°ë³¸ ë¬¸ì œ ì‚¬ìš©
                loadFallbackQuestions();
            }
        }

        // í´ë°± ë¬¸ì œ
        function loadFallbackQuestions() {
            questions = {
                easy: Array(30).fill().map((_, i) => ({
                    id: `eng_easy_${i+1}`,
                    subject: 'english',
                    question: `ì‰¬ìš´ ì˜ì–´ ë¬¸ì œ ${i+1}ë²ˆì…ë‹ˆë‹¤.`,
                    options: ['ì •ë‹µ', 'ì˜¤ë‹µ1', 'ì˜¤ë‹µ2', 'ì˜¤ë‹µ3'],
                    correctIndex: 0,
                    explanation: `ë¬¸ì œ ${i+1}ë²ˆì˜ í•´ì„¤ì…ë‹ˆë‹¤.`,
                    difficulty: 1,
                    audioText: 'sample'
                })),
                medium: Array(20).fill().map((_, i) => ({
                    id: `eng_medium_${i+1}`,
                    subject: 'english', 
                    question: `ë³´í†µ ì˜ì–´ ë¬¸ì œ ${i+1}ë²ˆì…ë‹ˆë‹¤.`,
                    options: ['ì •ë‹µ', 'ì˜¤ë‹µ1', 'ì˜¤ë‹µ2', 'ì˜¤ë‹µ3'],
                    correctIndex: 0,
                    explanation: `ë¬¸ì œ ${i+1}ë²ˆì˜ í•´ì„¤ì…ë‹ˆë‹¤.`,
                    difficulty: 2
                })),
                hard: Array(10).fill().map((_, i) => ({
                    id: `eng_hard_${i+1}`,
                    subject: 'english',
                    question: `ì–´ë ¤ìš´ ì˜ì–´ ë¬¸ì œ ${i+1}ë²ˆì…ë‹ˆë‹¤.`,
                    options: ['ì •ë‹µ', 'ì˜¤ë‹µ1', 'ì˜¤ë‹µ2', 'ì˜¤ë‹µ3'],
                    correctIndex: 0,
                    explanation: `ë¬¸ì œ ${i+1}ë²ˆì˜ í•´ì„¤ì…ë‹ˆë‹¤.`,
                    difficulty: 3
                }))
            };
        }

        // ë¬¸ì œ í’€ ìƒì„±
        function generateQuestionPool() {
            const config = difficultyConfig[currentDifficulty];
            const difficultyKey = config.class;
            
            currentQuestionPool = [...questions[difficultyKey]];
            // ë¬¸ì œ ìˆœì„œ ì…”í”Œ
            for (let i = currentQuestionPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuestionPool[i], currentQuestionPool[j]] = [currentQuestionPool[j], currentQuestionPool[i]];
            }
            
            currentQuestionIndex = 0;
        }

        // í˜„ì¬ ë¬¸ì œ ë¡œë“œ
        function loadCurrentQuestion() {
            if (isSessionComplete()) {
                completeSession();
                return;
            }



            if (currentQuestionIndex >= currentQuestionPool.length) {
                // ë¬¸ì œ í’€ ì¬ìƒì„±
                generateQuestionPool();
            }

            const question = currentQuestionPool[currentQuestionIndex];
            shuffledOptions = shuffleOptions(question);
            isAnswered = false;

            // íŒíŠ¸ ë²„íŠ¼ ì´ˆê¸°í™” (ìƒˆ ë¬¸ì œë§ˆë‹¤ ì¬í™œì„±í™”)
            const hintBtn = document.getElementById('hint-btn');
            if (hintBtn) {
                hintBtn.disabled = false;
                hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                hintBtn.textContent = 'ğŸ’¡ íŒíŠ¸';
            }

            // UI ì—…ë°ì´íŠ¸
            updateQuestionDisplay(question);
            updateProgressDisplay();
        }

        // ë¬¸ì œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateQuestionDisplay(question) {
            document.getElementById('question-text').textContent = question.question;

            // ë³´ê¸° ìƒì„±
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = shuffledOptions.map((option, index) => `
                <button class="option-btn w-full p-4 text-left rounded-xl border-2 border-gray-300 hover:border-primary-500 hover:bg-primary-50 font-medium transition-all" onclick="selectOption(${index})">
                    <span class="inline-block w-8 h-8 rounded-full bg-gray-100 text-center leading-8 mr-3 text-sm font-bold">
                        ${String.fromCharCode(65 + index)}
                    </span>
                    ${option.text}
                </button>
            `).join('');

            // íŒíŠ¸ ë²„íŠ¼ í‘œì‹œ ì¡°ê±´: ë‚œì´ë„ 2(ë³´í†µ) ë˜ëŠ” 3(ì–´ë ¤ì›€) ì´ìƒ
            const hintBtn = document.getElementById('hint-btn');
            const hintDisplay = document.getElementById('hint-display');

            // íŒíŠ¸ ì˜ì—­ ì´ˆê¸°í™” (ìƒˆ ë¬¸ì œ ë¡œë“œ ì‹œ ìˆ¨ê¹€)
            hintDisplay.classList.add('hidden');

            // ì‹¤ë ¥(skill) ê³¼ëª©ì€ ëª¨ë“  ë‚œì´ë„ì—ì„œ íŒíŠ¸ í‘œì‹œ, ë‹¤ë¥¸ ê³¼ëª©ì€ ë‚œì´ë„ 2 ì´ìƒì—ì„œë§Œ í‘œì‹œ
            const isSkillSubject = question.subject === 'skill';
            const shouldShowHint = isSkillSubject || currentDifficulty >= 2;

            if (shouldShowHint && question.hint) {
                // íŒíŠ¸ê°€ ìˆê³  ì¡°ê±´ ì¶©ì¡± ì‹œ ë²„íŠ¼ í‘œì‹œ
                hintBtn.classList.remove('hidden');
            } else if (shouldShowHint && !question.hint) {
                // íŒíŠ¸ê°€ ì—†ì§€ë§Œ ì¡°ê±´ ì¶©ì¡± ì‹œì—ë„ ë²„íŠ¼ í‘œì‹œ (í´ë¦­ ì‹œ "íŒíŠ¸ ì—†ìŒ" ë©”ì‹œì§€)
                hintBtn.classList.remove('hidden');
            } else {
                // ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ íŒíŠ¸ ë²„íŠ¼ ìˆ¨ê¹€
                hintBtn.classList.add('hidden');
            }

            // TTS ë²„íŠ¼
            const ttsBtn = document.getElementById('tts-btn');
            if (question.audioText) {
                ttsBtn.classList.remove('hidden');
            } else {
                ttsBtn.classList.add('hidden');
            }
        }

        // ì§„í–‰ë¥  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProgressDisplay() {
            const totalCompleted = questionCounts.easy + questionCounts.medium + questionCounts.hard;
            const totalTarget = 10; // ì´ 10ê°œ ì •ë‹µ ì™„ë£Œ ëª©í‘œ

            document.getElementById('overall-progress').textContent = `${totalCompleted} / ${totalTarget} ë¬¸ì œ`;

            const progress = (totalCompleted / totalTarget) * 100;
            document.getElementById('overall-progress-bar').style.width = progress + '%';

            // ë‚œì´ë„ë³„ í˜„í™© ì—…ë°ì´íŠ¸
            document.getElementById('easy-status').innerHTML = `
                <div class="text-lg font-bold text-green-600">${questionCounts.easy}</div>
                <div class="text-xs text-green-700">ì‰¬ì›€ ì •ë‹µ</div>
            `;
            document.getElementById('medium-status').innerHTML = `
                <div class="text-lg font-bold text-yellow-600">${questionCounts.medium}</div>
                <div class="text-xs text-yellow-700">ë³´í†µ ì •ë‹µ</div>
            `;
            document.getElementById('hard-status').innerHTML = `
                <div class="text-lg font-bold text-red-600">${questionCounts.hard}</div>
                <div class="text-xs text-red-700">ì–´ë ¤ì›€ ì •ë‹µ</div>
            `;
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const currentSubject = selectedSubjects[currentSubjectIndex];
            const subjectInfo = subjects[currentSubject];

            document.getElementById('current-subject').textContent = `${subjectInfo.icon} ${subjectInfo.name}`;


            const config = difficultyConfig[currentDifficulty];
            const difficultyBadge = document.getElementById('difficulty-badge');
            difficultyBadge.textContent = config.name;
            difficultyBadge.className = `px-2 py-1 rounded-full text-xs font-medium difficulty-badge ${config.class}`;

            // ì¶”ê°€ í•™ìŠµ ëª¨ë“œ UI í‘œì‹œ
            if (extraLearningMode) {
                document.getElementById('extra-mode-badge').classList.remove('hidden');
                document.getElementById('extra-mode-exit-btn').classList.remove('hidden');
            } else {
                document.getElementById('extra-mode-badge').classList.add('hidden');
                document.getElementById('extra-mode-exit-btn').classList.add('hidden');
            }

            // ì„¸ì…˜ í†µê³„ ì—…ë°ì´íŠ¸
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = totalAnswered > 0 ? Math.round((sessionStats.correct / totalAnswered) * 100) : 0;

            document.getElementById('total-correct').textContent = sessionStats.correct;
            document.getElementById('total-incorrect').textContent = sessionStats.incorrect;
            document.getElementById('difficulty-level').textContent = currentDifficulty;
            document.getElementById('session-accuracy').textContent = `ì •ë‹µë¥  ${accuracy}%`;
        }

        // ë³´ê¸° ì…”í”Œ
        function shuffleOptions(question) {
            const options = question.options.map((text, index) => ({ text, originalIndex: index }));
            const shuffled = [...options];
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled;
        }

        // ì˜µì…˜ ì„ íƒ
        function selectOption(shuffledIndex) {
            if (isAnswered) return;

            const question = currentQuestionPool[currentQuestionIndex];
            const selectedOriginalIndex = shuffledOptions[shuffledIndex].originalIndex;
            const isCorrect = selectedOriginalIndex === question.correctIndex;
            
            isAnswered = true;

            // ë‚œì´ë„ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const config = difficultyConfig[currentDifficulty];
            const difficultyKey = config.class;

            // í†µê³„ ì—…ë°ì´íŠ¸
            if (isCorrect) {
                sessionStats.correct++;
                consecutiveCorrectAnswers++;
                consecutiveIncorrectAnswers = 0;

                // ë‚œì´ë„ë³„ ì •ë‹µ ì¹´ìš´íŠ¸ ì¦ê°€ (ì •ë‹µì¼ ë•Œë§Œ ì¹´ìš´íŠ¸)
                questionCounts[difficultyKey]++;
            } else {
                sessionStats.incorrect++;
                consecutiveIncorrectAnswers++;
                consecutiveCorrectAnswers = 0;
            }

            // ë‚œì´ë„ íˆìŠ¤í† ë¦¬ ê¸°ë¡
            sessionStats.difficultyHistory.push({
                difficulty: currentDifficulty,
                difficultyName: config.name,
                isCorrect: isCorrect,
                consecutiveCorrect: consecutiveCorrectAnswers,
                timestamp: Date.now()
            });

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateOptionButtons(shuffledIndex, question.correctIndex);
            
            // í•´ì„¤ í‘œì‹œ
            setTimeout(() => {
                showExplanation(isCorrect, question.explanation);
                updateUI();
                updateProgressDisplay();
                checkDifficultyAdjustment();
            }, 1000);
        }

        // ì˜µì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateOptionButtons(selectedIndex, correctIndex) {
            const options = document.querySelectorAll('.option-btn');
            
            options.forEach((btn, index) => {
                const originalIndex = shuffledOptions[index].originalIndex;
                
                if (originalIndex === correctIndex) {
                    btn.classList.add('correct');
                    btn.innerHTML += ' <span class="ml-2 text-xl">âœ…</span>';
                } else if (index === selectedIndex) {
                    btn.classList.add('incorrect');
                    btn.innerHTML += ' <span class="ml-2 text-xl">âŒ</span>';
                } else {
                    btn.classList.add('neutral');
                }
                
                btn.onclick = null;
            });

            if (selectedIndex !== -1 && shuffledOptions[selectedIndex].originalIndex === correctIndex) {
                options[selectedIndex].classList.add('correct-animation');
                
                // ì •ë‹µ ì‚¬ìš´ë“œ íš¨ê³¼ (Web Audio API ì‚¬ìš©)
                playCorrectSound();
            } else if (selectedIndex !== -1) {
                // ì˜¤ë‹µ ì‚¬ìš´ë“œ íš¨ê³¼ (ë ë  ê²½ê³ ìŒ)
                playIncorrectSound();
            }
        }

        // í•´ì„¤ í‘œì‹œ (ëª¨ë‹¬ íŒì—…)
        function showExplanation(isCorrect, explanation) {
            const modal = document.getElementById('explanation-modal');
            const modalCard = document.getElementById('explanation-modal-card');
            const modalIcon = document.getElementById('modal-result-icon');
            const modalTitle = document.getElementById('modal-result-text');
            const modalExplanation = document.getElementById('modal-explanation-text');

            if (isCorrect) {
                modalIcon.textContent = 'ğŸ‰';
                modalTitle.textContent = 'ì •ë‹µì…ë‹ˆë‹¤!';
                modalTitle.className = 'text-3xl font-bold mb-2 text-green-600';
            } else {
                modalIcon.textContent = 'ğŸ˜…';
                modalTitle.textContent = 'ì•„ì‰½ë„¤ìš”!';
                modalTitle.className = 'text-3xl font-bold mb-2 text-blue-600';
            }

            modalExplanation.textContent = explanation;

            // ëª¨ë‹¬ í‘œì‹œ
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                modalCard.style.transform = 'scale(1)';
                modalCard.style.opacity = '1';
            }, 10);
        }

        // í•´ì„¤ ëª¨ë‹¬ ë‹«ê¸° ë° ë‹¤ìŒ ë¬¸ì œë¡œ
        function closeExplanationModal() {
            const modal = document.getElementById('explanation-modal');
            const modalCard = document.getElementById('explanation-modal-card');

            // ì• ë‹ˆë©”ì´ì…˜
            modalCard.style.transform = 'scale(0.9)';
            modalCard.style.opacity = '0';

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                nextQuestion();
            }, 200);
        }

        // ë‚œì´ë„ ì¡°ì • í™•ì¸
        function checkDifficultyAdjustment() {
            if (consecutiveCorrectAnswers >= 3 && currentDifficulty < 3) {
                upgradeDifficulty();
                showAchievement('ğŸš€ ë‚œì´ë„ ìƒìŠ¹!');
            } else if (consecutiveIncorrectAnswers >= 1 && currentDifficulty > 1) {
                // 1ë¬¸ì œë§Œ í‹€ë ¤ë„ ë‚œì´ë„ í•˜ë½
                downgradeDifficulty();
                showAchievement('ğŸ“– ë‚œì´ë„ í•˜ë½');
            }
        }

        // ë‚œì´ë„ ìƒìŠ¹
        function upgradeDifficulty() {
            if (currentDifficulty < 3) {
                currentDifficulty++;
                generateQuestionPool();
                consecutiveCorrectAnswers = 0;
            }
        }

        // ë‚œì´ë„ í•˜ë½
        function downgradeDifficulty() {
            if (currentDifficulty > 1) {
                currentDifficulty--;
                generateQuestionPool();
                consecutiveIncorrectAnswers = 0;
            }
        }

        // ì„±ì·¨ ì•Œë¦¼ í‘œì‹œ
        function showAchievement(message) {
            const popup = document.getElementById('achievement-popup');
            document.getElementById('achievement-text').textContent = message;
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 2000);
        }

        // ì„¸ì…˜ ì™„ë£Œ í™•ì¸
        function isSessionComplete() {
            // ì¶”ê°€ í•™ìŠµ ëª¨ë“œì—ì„œëŠ” ì„¸ì…˜ì„ ì™„ë£Œí•˜ì§€ ì•Šê³  ê³„ì† í•™ìŠµ
            if (extraLearningMode) {
                return false;
            }

            const totalCorrect = questionCounts.easy + questionCounts.medium + questionCounts.hard;

            // ì™„ë£Œ ì¡°ê±´: ì´ 10ê°œ ì •ë‹µ (ë‚œì´ë„ ë¬´ê´€)
            if (totalCorrect >= 10) {
                sessionStats.completionType = 'complete';
                return true;
            }

            return false;
        }

        // ë‹¤ìŒ ë¬¸ì œ
        function nextQuestion() {
            // ìˆ˜ìˆ˜ê»˜ë¼ ì²´í¬ (ì—°ì† ì˜¤ë‹µ ê¸°ë°˜)
            if (checkRiddleTrigger()) {
                showRiddle();
                return; // ìˆ˜ìˆ˜ê»˜ë¼ í‘œì‹œ í›„ ë¦¬í„´ (ìˆ˜ìˆ˜ê»˜ë¼ ì™„ë£Œ í›„ nextQuestion ì¬í˜¸ì¶œ)
            }

            currentQuestionIndex++;
            loadCurrentQuestion();
        }

        // ë‹¤ìŒ ë¬¸ì œ (ëª¨ë‹¬ ì—†ì´ ì§ì ‘ í˜¸ì¶œìš©)
        function nextQuestionDirect() {
            currentQuestionIndex++;
            loadCurrentQuestion();
        }

        // ì¶”ê°€ í•™ìŠµ ëª¨ë“œ ì¢…ë£Œ í•¨ìˆ˜
        function exitExtraMode() {
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = totalAnswered > 0 ? Math.round((sessionStats.correct / totalAnswered) * 100) : 0;
            const timeSpent = Math.round((Date.now() - sessionStats.startTime) / 1000 / 60 * 10) / 10;

            // í•™ìŠµ ì‹œê°„ë§Œ ì €ì¥ (ë³´ìƒ ì—†ìŒ)
            const currentSubject = selectedSubjects[currentSubjectIndex];

            // í•™ìŠµ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹œê°„ë§Œ)
            updateLearningProgress(currentSubject, sessionStats.correct, totalAnswered);

            alert(`âœ¨ ì¶”ê°€ í•™ìŠµ ì™„ë£Œ!\n\n` +
                  `ì´ ${totalAnswered}ë¬¸ì œ í’€ì´\n` +
                  `ì •ë‹µë¥ : ${accuracy}%\n` +
                  `í•™ìŠµ ì‹œê°„: ${timeSpent}ë¶„\n\n` +
                  `í•™ìŠµ ì‹œê°„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);

            // localStorage ì •ë¦¬
            localStorage.removeItem('extraLearningMode');
            localStorage.removeItem('selectedSubjects');
            localStorage.removeItem('currentSubjectIndex');

            // í™ˆìœ¼ë¡œ ì´ë™
            window.location.href = 'index.html';
        }

        // ì„¸ì…˜ ì™„ë£Œ
        function completeSession() {
            const totalAnswered = sessionStats.correct + sessionStats.incorrect;
            const accuracy = Math.round((sessionStats.correct / totalAnswered) * 100);
            const timeSpent = Math.round((Date.now() - sessionStats.startTime) / 1000 / 60 * 10) / 10;
            const currentSubject = selectedSubjects[currentSubjectIndex];

            // âœ… CRITICAL: í•™ìŠµ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (progress-dashboard.htmlìš©)
            updateLearningProgress(currentSubject, sessionStats.correct, totalAnswered);

            // âœ… CRITICAL: PlantSystem ë³´ìƒ ì²˜ë¦¬
            let plantSystemMessage = '';
            const rewardSummary = {
                completedCount: 0,
                growthTickets: 0,
                normalGacha: 0,
                premiumGacha: 0,
                newRewards: {}
            };

            if (typeof plantSystem !== 'undefined') {
                try {
                    const subjectName = selectedSubjects[currentSubjectIndex];
                    const user = plantSystem.getUserData();

                    // ì¶”ê°€ í•™ìŠµ ëª¨ë“œì—ì„œëŠ” ê³¼ëª© ì™„ë£Œ ì²˜ë¦¬ ì•ˆ í•¨
                    if (!extraLearningMode) {
                        // ë‚œì´ë„ë³„ ì½”ì¸ ê³„ì‚° (ì‰¬ì›€ 1ì½”ì¸, ë³´í†µ 2ì½”ì¸, ì–´ë ¤ì›€ 10ì½”ì¸)
                        const earnedCoins = (questionCounts.easy * 1) + (questionCounts.medium * 2) + (questionCounts.hard * 10);

                        // ê³¼ëª© ì™„ë£Œ ì²˜ë¦¬ (ì½”ì¸ í¬í•¨)
                        const result = plantSystem.completeSubject(user, subjectName, subjectName, earnedCoins);

                        if (result.success) {
                            rewardSummary.completedCount = result.completedCount;
                            rewardSummary.newRewards = result.rewards;

                            plantSystemMessage = `\n\nğŸ“š ê³¼ëª© ì™„ë£Œ (${result.completedCount}/9)`;

                            // ì½”ì¸ íšë“ ë©”ì‹œì§€ ì¶”ê°€ (ê²°ê³¼ê°’ ê¸°ë°˜)
                            if (result.rewards.earnedCoins > 0) {
                                plantSystemMessage += `\nğŸ’° ${result.rewards.earnedCoins}ì½”ì¸ íšë“! (ì‰¬ì›€ ${questionCounts.easy}Ã—1 + ë³´í†µ ${questionCounts.medium}Ã—2 + ì–´ë ¤ì›€ ${questionCounts.hard}Ã—10)`;
                            }

                            if (result.rewards.growthTickets) {
                                rewardSummary.growthTickets = result.rewards.growthTickets;
                                plantSystemMessage += `\nğŸ« ì„±ì¥ê¶Œ ${result.rewards.growthTickets}ê°œ íšë“!`;
                            }
                            if (result.rewards.normalGacha) {
                                rewardSummary.normalGacha = result.rewards.normalGacha;
                                plantSystemMessage += `\nğŸ ì¼ë°˜ ë½‘ê¸°ê¶Œ ${result.rewards.normalGacha}ê°œ íšë“!`;
                            }
                            if (result.rewards.premiumGacha) {
                                rewardSummary.premiumGacha = result.rewards.premiumGacha;
                                plantSystemMessage += `\nğŸ’ í”„ë¦¬ë¯¸ì—„ ë½‘ê¸°ê¶Œ ${result.rewards.premiumGacha}ê°œ íšë“!`;
                            }

                            // Firebase ë™ê¸°í™” (ë¹„ë™ê¸° ì²˜ë¦¬)
                            if (window.eduPetFirebaseIntegration && window.plantSystemFirebase) {
                                // 1. í€´ì¦ˆ í†µê³„ ì—…ë°ì´íŠ¸ (ì¼ì¼ í†µê³„, ê³¼ëª©ë³„ í†µê³„, ê·¸ë£¹ í†µê³„ í¬í•¨)
                                eduPetFirebaseIntegration.updateQuizStats({
                                    subject: subjectName,
                                    correctAnswers: sessionStats.correct,
                                    totalQuestions: totalAnswered,
                                    timeSpent: timeSpent
                                }).catch(err => {
                                    console.warn('âš ï¸ Firebase í€´ì¦ˆ í†µê³„ ë™ê¸°í™” ì‹¤íŒ¨ (ë‚˜ì¤‘ì— ì¬ì‹œë„ë©ë‹ˆë‹¤):', err);
                                });

                                // 2. ì‹ë¬¼ ì‹œìŠ¤í…œ ìƒíƒœ ì €ì¥ (ëˆ, í‹°ì¼“ ì •ë³´ í¬í•¨)
                                plantSystemFirebase.save().catch(err => {
                                    console.warn('âš ï¸ Firebase ì‹ë¬¼ ì‹œìŠ¤í…œ ë™ê¸°í™” ì‹¤íŒ¨ (ë‚˜ì¤‘ì— ì¬ì‹œë„ë©ë‹ˆë‹¤):', err);
                                });

                                console.log('âœ… Firebase ë™ê¸°í™” ì™„ë£Œ: í€´ì¦ˆ í†µê³„ + ì‹ë¬¼ ì‹œìŠ¤í…œ ìƒíƒœ');
                            }
                        } else if (result.alreadyCompleted) {
                            plantSystemMessage = '\n\nâš ï¸ ì´ë¯¸ ì™„ë£Œí•œ ê³¼ëª©ì…ë‹ˆë‹¤';
                        }
                    } else {
                        plantSystemMessage = '\n\nâœ¨ ì¶”ê°€ í•™ìŠµ ëª¨ë“œ (ë³´ìƒ ì—†ìŒ)';
                    }

                    // ì•½ì  í•™ìŠµ ì—…ë°ì´íŠ¸
                    if (typeof weaknessLearning !== 'undefined') {
                        weaknessLearning.updateLearningProgress(user, subjectName, sessionStats.correct > 0);
                    }
                } catch (error) {
                    console.error('ì‹ë¬¼ ì‹œìŠ¤í…œ ì—°ë™ ì˜¤ë¥˜:', error);
                }
            }

            alert(`ğŸ‰ ê³¼ëª© í•™ìŠµ ì™„ë£Œ!\n\nì´ ${totalAnswered}ë¬¸ì œ í’€ì´\nì •ë‹µë¥ : ${accuracy}%\nì†Œìš”ì‹œê°„: ${timeSpent}ë¶„${plantSystemMessage}`);

            // âœ… CRITICAL: ë¶„ì„ ë°ì´í„° ì €ì¥ (analytics-console.htmlìš©)
            const quizAnalytics = {
                subject: currentSubject,
                subjectName: subjects[currentSubject]?.name || currentSubject,
                completionType: sessionStats.completionType,
                stats: {
                    correct: sessionStats.correct,
                    incorrect: sessionStats.incorrect,
                    totalAnswered: totalAnswered,
                    accuracy: accuracy,
                    timeSpent: timeSpent
                },
                questionCounts: questionCounts,
                difficultyHistory: sessionStats.difficultyHistory,
                completedAt: new Date().toISOString()
            };

            // ê¸°ì¡´ ë¶„ì„ ë°ì´í„° ë¡œë“œ
            let analyticsHistory = JSON.parse(localStorage.getItem('quizAnalyticsHistory') || '[]');
            analyticsHistory.push(quizAnalytics);

            // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
            if (analyticsHistory.length > 100) {
                analyticsHistory = analyticsHistory.slice(-100);
            }

            localStorage.setItem('quizAnalyticsHistory', JSON.stringify(analyticsHistory));

            // Firebaseì—ë„ ë¶„ì„ ë°ì´í„° ì €ì¥ (users í•˜ìœ„ì— ì €ì¥)
            if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                const userId = firebase.auth().currentUser.uid;
                firebase.database().ref(`users/${userId}/analytics`).set(analyticsHistory)
                    .then(() => console.log('âœ… Firebase ë¶„ì„ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ'))
                    .catch(err => console.error('âŒ Firebase ë¶„ì„ ë°ì´í„° ì—…ë¡œë“œ ì‹¤íŒ¨:', err));
            }

            // ê·¸ë£¹ ë©¤ë²„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            if (typeof eduPetSocial !== 'undefined') {
                eduPetSocial.updateGroupMemberProgress().catch(err => {
                    console.warn('ê·¸ë£¹ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
                });
            }

            // ë‹¤ìŒ í–‰ë™ ì„ íƒ
            showNextActionDialog(rewardSummary);
        }

        // ë‹¤ìŒ í–‰ë™ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
        function showNextActionDialog(rewardSummary) {
            const { completedCount, growthTickets, normalGacha, premiumGacha, newRewards } = rewardSummary;

            // 9ê³¼ëª© ì™„ë£Œ ì‹œ (í”„ë¦¬ë¯¸ì—„ ë½‘ê¸°ê¶Œ) - í•™ìŠµ ì™„ë£Œ
            if (completedCount === 9 && premiumGacha) {
                const choice = confirm(`ğŸ† ìµœê³ ì…ë‹ˆë‹¤! 9ê³¼ëª© ëª¨ë‘ ì™„ë£Œ!\nğŸ’ í”„ë¦¬ë¯¸ì—„ ë™ë¬¼ ë½‘ê¸°ê¶Œ ${premiumGacha}ê°œ íšë“!\nğŸ« ì„±ì¥ê¶Œ 1ê°œ ì¶”ê°€ íšë“!\n\nì‹ë¬¼ì—ê²Œ ë¬¼ì„ ì£¼ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    window.location.href = 'index.html';
                }
                return;
            }

            // 3ê³¼ëª© ì™„ë£Œ ì‹œ (ì„±ì¥ê¶Œ 1ê°œ)
            if (completedCount === 3 && newRewards.growthTickets) {
                const choice = confirm(`ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! 3ê³¼ëª© ì™„ë£Œ!\nğŸ« ì„±ì¥ê¶Œ ${growthTickets}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n\nì‹ë¬¼ì—ê²Œ ë¬¼ì„ ì£¼ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    moveToNextSubject();
                }
                return;
            }

            // 6ê³¼ëª© ì™„ë£Œ ì‹œ (ì„±ì¥ê¶Œ ì¶”ê°€ 1ê°œ)
            if (completedCount === 6 && newRewards.growthTickets) {
                const choice = confirm(`ğŸŠ ëŒ€ë‹¨í•©ë‹ˆë‹¤! 6ê³¼ëª© ì™„ë£Œ!\nğŸ« ì„±ì¥ê¶Œ ${growthTickets}ê°œë¥¼ ì¶”ê°€ë¡œ íšë“í–ˆìŠµë‹ˆë‹¤!\n(ëˆ„ì  ì„±ì¥ê¶Œ: 2ê°œ)\n\nì‹ë¬¼ì—ê²Œ ë¬¼ì„ ì£¼ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤)`);

                if (choice) {
                    window.location.href = 'simple-farm.html';
                } else {
                    moveToNextSubject();
                }
                return;
            }

            // 5ê³¼ëª© ì™„ë£Œ ì‹œ (ì¼ë°˜ ë½‘ê¸°ê¶Œ) - ì¶•í•˜ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ê³¼ëª©
            if (completedCount === 5 && normalGacha) {
                alert(`ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤! 5ê³¼ëª© ì™„ë£Œ!\nğŸ ì¼ë°˜ ë™ë¬¼ ë½‘ê¸°ê¶Œ ${normalGacha}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n\në‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                setTimeout(() => {
                    moveToNextSubject();
                }, 500);
                return;
            }

            // ì¼ë°˜ì ì¸ ê²½ìš° - ìë™ìœ¼ë¡œ ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ì´ë™ (9ê³¼ëª©ê¹Œì§€)
            if (completedCount < 9) {
                setTimeout(() => {
                    moveToNextSubject();
                }, 1000);
            } else {
                // 9ê³¼ëª© ì´ˆê³¼ ì‹œ í™ˆìœ¼ë¡œ
                window.location.href = 'index.html';
            }
        }

        // ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ì´ë™
        function moveToNextSubject() {
            currentSubjectIndex++;

            if (currentSubjectIndex >= selectedSubjects.length) {
                // ëª¨ë“  ì„ íƒëœ ê³¼ëª© ì™„ë£Œ
                alert('ì„ íƒí•œ ëª¨ë“  ê³¼ëª©ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!\ní™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            // ìˆœë°œë ¥ ê²Œì„ í‘œì‹œ (ê³¼ëª© ì „í™˜ ì‹œ)
            startReflexGame();
        }

        // ìˆœë°œë ¥ ê²Œì„ í›„ ë‹¤ìŒ ê³¼ëª© ë¡œë“œ
        function loadNextSubject() {
            // ë‹¤ìŒ ê³¼ëª© ë°ì´í„° ì €ì¥
            localStorage.setItem('currentSubjectIndex', currentSubjectIndex.toString());

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ìŒ ê³¼ëª© ì‹œì‘
            window.location.reload();
        }

        // ì§„ë™ ì„¤ì • í† ê¸€
        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            updateVibrationButton();
            
            // ì„¤ì •ì„ localStorageì— ì €ì¥
            localStorage.setItem('quizVibrationEnabled', vibrationEnabled);
            
            // í…ŒìŠ¤íŠ¸ ì§„ë™ (ì„¤ì • í”¼ë“œë°±)
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50); // ì§§ì€ í™•ì¸ ì§„ë™
            }
        }

        // í•™ìŠµ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLearningProgress(subject, correctAnswers, totalQuestions) {
            // ê¸°ì¡´ ì§„í–‰ë¥  ë°ì´í„° ë¡œë“œ
            let progressData = JSON.parse(localStorage.getItem('learningProgress') || '{}');

            // ì˜¤ëŠ˜ ë‚ ì§œ (ISO format: YYYY-MM-DD)
            const today = new Date().toISOString().split('T')[0];

            // ê¸°ë³¸ êµ¬ì¡° ì´ˆê¸°í™”
            if (!progressData.subjectStats) progressData.subjectStats = {};
            if (!progressData.dailyActivity) progressData.dailyActivity = {};
            if (!progressData.unlockedAchievements) progressData.unlockedAchievements = [];

            // ê³¼ëª©ë³„ í†µê³„ ì´ˆê¸°í™” (subjectStatsì™€ ë£¨íŠ¸ ë ˆë²¨ ëª¨ë‘ì— ì €ì¥)
            if (!progressData.subjectStats[subject]) {
                progressData.subjectStats[subject] = {
                    questions: 0,
                    correct: 0,
                    lastStudied: null,
                    lastStudyDate: null,
                    level: 1,
                    experience: 0
                };
            }

            // ë£¨íŠ¸ ë ˆë²¨ì—ë„ ê³¼ëª© ë°ì´í„° ì €ì¥ (index.html í˜¸í™˜ì„±)
            if (!progressData[subject]) {
                progressData[subject] = {
                    questions: 0,
                    correct: 0,
                    lastStudyDate: null
                };
            }

            // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            progressData.totalQuestions = (progressData.totalQuestions || 0) + totalQuestions;
            progressData.correctAnswers = (progressData.correctAnswers || 0) + correctAnswers;

            // ë‚ ì§œê°€ ë°”ë€Œë©´ ì˜¤ëŠ˜ ë°ì´í„° ë¦¬ì…‹
            if (progressData.lastActivityDate !== today) {
                progressData.totalMinutesToday = 0;
                progressData.totalCorrectToday = 0;
                progressData.lastActivityDate = today;
            }

            // ì˜¤ëŠ˜ ì´ í•™ìŠµ ì‹œê°„ ì—…ë°ì´íŠ¸ (ë¬¸ì œë‹¹ ì•½ 10ì´ˆ = totalQuestions * 10 / 60ë¶„)
            const estimatedMinutes = Math.ceil(totalQuestions * 10 / 60);
            progressData.totalMinutesToday = (progressData.totalMinutesToday || 0) + estimatedMinutes;

            // ì˜¤ëŠ˜ ì´ ì •ë‹µ ìˆ˜ ì—…ë°ì´íŠ¸
            progressData.totalCorrectToday = (progressData.totalCorrectToday || 0) + correctAnswers;

            // ê³¼ëª©ë³„ í†µê³„ ì—…ë°ì´íŠ¸ (subjectStats)
            const subjectStats = progressData.subjectStats[subject];
            subjectStats.questions += totalQuestions;
            subjectStats.correct += correctAnswers;
            subjectStats.experience += correctAnswers * 10; // ì •ë‹µ 1ê°œë‹¹ 10 ê²½í—˜ì¹˜
            subjectStats.lastStudied = Date.now();
            subjectStats.lastStudyDate = today;

            // ë£¨íŠ¸ ë ˆë²¨ ê³¼ëª© ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
            progressData[subject].questions += totalQuestions;
            progressData[subject].correct += correctAnswers;
            progressData[subject].lastStudyDate = today;

            // ì¼ì¼ í™œë™ ì—…ë°ì´íŠ¸
            progressData.dailyActivity[today] = (progressData.dailyActivity[today] || 0) + totalQuestions;

            // ì—°ì† í•™ìŠµì¼ ì—…ë°ì´íŠ¸
            if (!progressData.lastStudyDate || progressData.lastStudyDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (progressData.lastStudyDate === yesterdayStr) {
                    // ì–´ì œ ê³µë¶€í–ˆìœ¼ë©´ ì—°ì†ì¼ ì¦ê°€
                    progressData.streakDays = (progressData.streakDays || 0) + 1;
                } else {
                    // ì—°ì†ì¼ ë¦¬ì…‹
                    progressData.streakDays = 1;
                }

                progressData.lastStudyDate = today;
            }
            
            // ìƒˆë¡œìš´ ì„±ì·¨ í™•ì¸ ë° ì•Œë¦¼
            checkNewAchievements(progressData);
            
            // ì—…ë°ì´íŠ¸ëœ ì§„í–‰ë¥  ì €ì¥
            localStorage.setItem('learningProgress', JSON.stringify(progressData));

            // Firebaseì— ì „ì²´ ì§„í–‰ë¥  ë™ê¸°í™”
            if (window.updateFirebaseStats) {
                window.updateFirebaseStats.learningProgress(progressData);
            }
            
            console.log('í•™ìŠµ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
                subject,
                correctAnswers,
                totalQuestions,
                streakDays: progressData.streakDays,
                totalExp: subjectStats.experience
            });
        }
        
        // ìƒˆë¡œìš´ ì„±ì·¨ í™•ì¸
        function checkNewAchievements(progressData) {
            const achievements = [
                { id: 'first_correct', name: 'ì²« ë°œê±¸ìŒ', requirement: 1, type: 'correct_answers', emoji: 'ğŸ‘¶' },
                { id: 'streak_3', name: 'ê¾¸ì¤€í•¨ì˜ ì‹œì‘', requirement: 3, type: 'streak_days', emoji: 'ğŸŒ±' },
                { id: 'streak_7', name: 'ì¼ì£¼ì¼ ì±Œë¦°ì €', requirement: 7, type: 'streak_days', emoji: 'ğŸ”¥' },
                { id: 'correct_25', name: 'ì‹¤ë ¥ì', requirement: 25, type: 'correct_answers', emoji: 'â­' },
                { id: 'correct_100', name: 'ë°±ì  ë§Œì ', requirement: 100, type: 'correct_answers', emoji: 'ğŸŒŸ' }
            ];
            
            achievements.forEach(achievement => {
                if (progressData.unlockedAchievements.includes(achievement.id)) return;
                
                let isUnlocked = false;
                switch (achievement.type) {
                    case 'correct_answers':
                        isUnlocked = progressData.correctAnswers >= achievement.requirement;
                        break;
                    case 'streak_days':
                        isUnlocked = progressData.streakDays >= achievement.requirement;
                        break;
                    case 'accuracy':
                        const accuracy = progressData.totalQuestions > 0 
                            ? (progressData.correctAnswers / progressData.totalQuestions) * 100 
                            : 0;
                        isUnlocked = accuracy >= achievement.requirement;
                        break;
                }
                
                if (isUnlocked) {
                    progressData.unlockedAchievements.push(achievement.id);
                    
                    // ì„±ì·¨ ì•Œë¦¼ í‘œì‹œ
                    setTimeout(() => {
                        showAchievementUnlock(achievement);
                    }, 2000); // í€´ì¦ˆ ì™„ë£Œ ë©”ì‹œì§€ í›„ì— í‘œì‹œ
                }
            });
        }
        
        // ì„±ì·¨ í•´ì œ ì•Œë¦¼ í‘œì‹œ
        function showAchievementUnlock(achievement) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-400 text-yellow-900 px-6 py-4 rounded-xl shadow-lg z-50 achievement-unlock';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">${achievement.emoji}</span>
                    <div>
                        <div class="font-bold">ğŸ† ìƒˆë¡œìš´ ì„±ì·¨!</div>
                        <div class="text-sm">${achievement.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // ì„±ì·¨ ì‚¬ìš´ë“œ ì¬ìƒ
            playCorrectSound();
        }

        // ì§„ë™ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
        function updateVibrationButton() {
            const button = document.getElementById('vibration-toggle');
            
            // ì§„ë™ API ì§€ì› ì—¬ë¶€ í™•ì¸
            if (!navigator.vibrate) {
                button.textContent = 'ğŸ“µ';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-gray-100 text-gray-400 cursor-not-allowed';
                button.title = 'ì´ ê¸°ê¸°ëŠ” ì§„ë™ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                button.disabled = true;
                return;
            }
            
            button.disabled = false;
            if (vibrationEnabled) {
                button.textContent = 'ğŸ“³';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-blue-100 text-blue-700 hover:bg-blue-200';
                button.title = 'ì§„ë™ ì¼œì§ (í´ë¦­í•˜ì—¬ ë„ê¸°)';
            } else {
                button.textContent = 'ğŸ”‡';
                button.className = 'p-2 rounded-lg transition-all text-sm bg-gray-100 text-gray-500 hover:bg-gray-200';
                button.title = 'ì§„ë™ êº¼ì§ (í´ë¦­í•˜ì—¬ ì¼œê¸°)';
            }
        }

        // íƒ€ì´ë¨¸
        function startTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStats.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('time-elapsed').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // íŒíŠ¸ í‘œì‹œ
        function showQuizHint() {
            const question = currentQuestionPool[currentQuestionIndex];
            const hintDisplay = document.getElementById('hint-display');
            const hintText = document.getElementById('hint-text');
            const hintBtn = document.getElementById('hint-btn');

            if (question.hint) {
                // íŒíŠ¸ê°€ ìˆëŠ” ê²½ìš°
                hintText.textContent = question.hint;
                hintDisplay.classList.remove('hidden');

                // íŒíŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™” (í•œ ë²ˆë§Œ ë³¼ ìˆ˜ ìˆìŒ)
                hintBtn.disabled = true;
                hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
                hintBtn.textContent = 'âœ“ íŒíŠ¸ í™•ì¸';

                console.log('ğŸ’¡ íŒíŠ¸ í‘œì‹œ:', question.hint);
            } else {
                // íŒíŠ¸ê°€ ì—†ëŠ” ê²½ìš°
                hintText.textContent = 'ì´ ë¬¸ì œì—ëŠ” íŒíŠ¸ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”!';
                hintDisplay.classList.remove('hidden');

                // íŒíŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
                hintBtn.disabled = true;
                hintBtn.classList.add('opacity-50', 'cursor-not-allowed');

                console.log('ğŸ’¡ íŒíŠ¸ ì—†ìŒ');
            }

            // ì§„ë™ í”¼ë“œë°± (íŒíŠ¸ í™•ì¸ ì‹œ)
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // TTS ì¬ìƒ
        function playTTS() {
            const question = currentQuestionPool[currentQuestionIndex];

            if (question.audioText && 'speechSynthesis' in window) {
                // ì˜ì–´ ìŒì„± ì‚¬ìš© ê°•ì œ
                const utterance = new SpeechSynthesisUtterance(question.audioText);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;

                // ì˜ì–´ ìŒì„±ë§Œ í•„í„°ë§
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice =>
                    voice.lang.startsWith('en-') &&
                    (voice.name.includes('English') || voice.name.includes('US') || voice.name.includes('GB'))
                );

                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                speechSynthesis.speak(utterance);
            }
        }

        // ========== ìˆ˜ìˆ˜ê»˜ë¼ ì‹œìŠ¤í…œ ==========
        let riddlesData = [];
        let usedRiddleIds = [];
        let currentRiddle = null;
        let riddleShownThisSubject = false; // ê³¼ëª©ë‹¹ 1íšŒ ì œí•œ

        // ìˆ˜ìˆ˜ê»˜ë¼ ë°ì´í„° ë¡œë“œ
        async function loadRiddles() {
            try {
                const response = await fetch('src/data/riddles.json');
                const data = await response.json();
                riddlesData = data.riddles;
                console.log('âœ… ìˆ˜ìˆ˜ê»˜ë¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', riddlesData.length + 'ê°œ');
            } catch (error) {
                console.error('âŒ ìˆ˜ìˆ˜ê»˜ë¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                riddlesData = [];
            }
        }

        // ìˆ˜ìˆ˜ê»˜ë¼ ë°œí˜„ ì²´í¬ (ì˜¤ë‹µ ê¸°ë°˜)
        function checkRiddleTrigger() {
            // ì´ë¯¸ ì´ë²ˆ ê³¼ëª©ì—ì„œ ìˆ˜ìˆ˜ê»˜ë¼ë¥¼ ë³´ì—¬ì¤¬ìœ¼ë©´ ë°œí˜„ ì•ˆí•¨
            if (riddleShownThisSubject) return false;

            // ì¶”ê°€ í•™ìŠµ ëª¨ë“œì—ì„œëŠ” ìˆ˜ìˆ˜ê»˜ë¼ ì•ˆë‚˜ì˜´
            if (extraLearningMode) return false;

            // ì´ í‹€ë¦° ë¬¸ì œ 3ê°œ ì´ìƒ -> 100% ë°œí˜„
            if (sessionStats.incorrect >= 3) {
                console.log('ğŸª ìˆ˜ìˆ˜ê»˜ë¼ 100% ë°œí˜„ (ì´ ì˜¤ë‹µ 3íšŒ ì´ìƒ)');
                return true;
            }

            // ì—°ì† ì˜¤ë‹µ 2íšŒ -> 50% ë°œí˜„
            if (consecutiveIncorrectAnswers === 2) {
                const shouldShow = Math.random() < 0.5;
                console.log(`ğŸª ìˆ˜ìˆ˜ê»˜ë¼ 50% ë°œí˜„ ì²´í¬ (ì—°ì† ì˜¤ë‹µ 2íšŒ): ${shouldShow ? 'ë°œí˜„!' : 'í†µê³¼'}`);
                return shouldShow;
            }

            return false;
        }

        // ìˆ˜ìˆ˜ê»˜ë¼ í‘œì‹œ
        function showRiddle() {
            if (riddlesData.length === 0) {
                console.warn('ìˆ˜ìˆ˜ê»˜ë¼ ë°ì´í„° ì—†ìŒ');
                return;
            }

            // ì‚¬ìš©í•˜ì§€ ì•Šì€ ìˆ˜ìˆ˜ê»˜ë¼ í•„í„°ë§
            const availableRiddles = riddlesData.filter(r => !usedRiddleIds.includes(r.id));

            // ëª¨ë‘ ì‚¬ìš©í–ˆìœ¼ë©´ ë¦¬ì…‹
            if (availableRiddles.length === 0) {
                usedRiddleIds = [];
                availableRiddles.push(...riddlesData);
            }

            // ëœë¤ ì„ íƒ
            currentRiddle = availableRiddles[Math.floor(Math.random() * availableRiddles.length)];
            usedRiddleIds.push(currentRiddle.id);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('riddle-question').textContent = currentRiddle.q;
            document.getElementById('riddle-hint-text').textContent = currentRiddle.hint;
            document.getElementById('riddle-answer-input').value = '';
            document.getElementById('riddle-hint').classList.add('hidden');
            document.getElementById('riddle-result').classList.add('hidden');
            document.getElementById('riddle-hint-btn').classList.remove('hidden');
            document.getElementById('riddle-submit-btn').classList.remove('hidden');
            document.getElementById('riddle-skip-btn').classList.remove('hidden');

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('riddle-modal').classList.remove('hidden');

            // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('riddle-answer-input').focus();
            }, 300);

            riddleShownThisSubject = true;

            console.log('ğŸª ìˆ˜ìˆ˜ê»˜ë¼ í‘œì‹œ:', currentRiddle.q);
        }

        // íŒíŠ¸ ë³´ê¸°
        function showRiddleHint() {
            document.getElementById('riddle-hint').classList.remove('hidden');
            document.getElementById('riddle-hint-btn').classList.add('hidden');
        }

        // ì •ë‹µ í™•ì¸
        function checkRiddleAnswer() {
            const userAnswer = document.getElementById('riddle-answer-input').value.trim().toLowerCase();

            if (!userAnswer) {
                alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ì •ë‹µ ì²´í¬ (ì—¬ëŸ¬ ì •ë‹µ ê°€ëŠ¥)
            const isCorrect = currentRiddle.a.some(answer =>
                answer.toLowerCase() === userAnswer
            );

            const resultDiv = document.getElementById('riddle-result');
            resultDiv.classList.remove('hidden');

            if (isCorrect) {
                // ì •ë‹µ!
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 animate-bounce">
                        <div class="flex items-center space-x-3">
                            <span class="text-4xl">ğŸ‰</span>
                            <div>
                                <div class="font-bold text-green-900 text-lg">ì •ë‹µì…ë‹ˆë‹¤!</div>
                                <div class="text-sm text-green-800 mt-1">ì¼ë°˜ ë½‘ê¸°ê¶Œ 1ê°œë¥¼ ë°›ì•˜ì–´ìš”! ğŸ</div>
                            </div>
                        </div>
                    </div>
                `;

                // ë³´ìƒ ì§€ê¸‰
                giveRiddleReward();

                // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                document.getElementById('riddle-hint-btn').classList.add('hidden');
                document.getElementById('riddle-submit-btn').classList.add('hidden');
                document.getElementById('riddle-answer-input').disabled = true;

                // 2ì´ˆ í›„ ìë™ ë‹«ê¸°
                setTimeout(() => {
                    closeRiddle();
                }, 2000);

            } else {
                // ì˜¤ë‹µ
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">ğŸ˜…</span>
                            <div>
                                <div class="font-bold text-red-900">ì•„ì‰¬ì›Œìš”!</div>
                                <div class="text-sm text-red-800 mt-1">ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”</div>
                            </div>
                        </div>
                    </div>
                `;

                // 1ì´ˆ í›„ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 1500);
            }

            // ì§„ë™ í”¼ë“œë°±
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(isCorrect ? [100, 50, 100] : [200]);
            }
        }

        // ìˆ˜ìˆ˜ê»˜ë¼ ë³´ìƒ ì§€ê¸‰
        function giveRiddleReward() {
            try {
                const user = plantSystem.getUserData();

                if (!user.rewards) {
                    user.rewards = {
                        growthTickets: [],
                        normalGachaTickets: 0,
                        premiumGachaTickets: 0
                    };
                }

                // ì¼ë°˜ ë½‘ê¸°ê¶Œ 1ê°œ ì§€ê¸‰
                user.rewards.normalGachaTickets = (user.rewards.normalGachaTickets || 0) + 1;
                plantSystem.saveUserData(user);

                console.log('ğŸ ìˆ˜ìˆ˜ê»˜ë¼ ë³´ìƒ ì§€ê¸‰: ì¼ë°˜ ë½‘ê¸°ê¶Œ +1');

            } catch (error) {
                console.error('ë³´ìƒ ì§€ê¸‰ ì˜¤ë¥˜:', error);
            }
        }

        // ìˆ˜ìˆ˜ê»˜ë¼ ê±´ë„ˆë›°ê¸°
        function skipRiddle() {
            closeRiddle();
        }

        // ìˆ˜ìˆ˜ê»˜ë¼ ëª¨ë‹¬ ë‹«ê¸°
        function closeRiddle() {
            document.getElementById('riddle-modal').classList.add('hidden');
            document.getElementById('riddle-answer-input').disabled = false;

            // ë‹¤ìŒ ë¬¸ì œ ì§„í–‰
            nextQuestion();
        }

        // ========== ìˆœë°œë ¥ ê²Œì„ ì‹œìŠ¤í…œ ==========
        let reflexGameScore = 0;
        let reflexGameTimeLeft = 0;
        let reflexGameInterval = null;
        let reflexTargetColor = '';

        // ìˆœë°œë ¥ ê²Œì„ ì‹œì‘ (ê³¼ëª© ì „í™˜ ì‹œ)
        function startReflexGame() {
            // ì¶”ê°€ í•™ìŠµ ëª¨ë“œì—ì„œëŠ” ìˆœë°œë ¥ ê²Œì„ ì•ˆí•¨
            if (extraLearningMode) {
                loadNextSubject();
                return;
            }

            reflexGameScore = 0;
            reflexGameTimeLeft = 10; // 10ì´ˆ ê²Œì„

            document.getElementById('reflex-score').textContent = 'ì ìˆ˜: 0';
            document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;
            document.getElementById('reflex-continue-btn').classList.add('hidden');
            document.getElementById('reflex-instruction').textContent = 'ì¤€ë¹„í•˜ì„¸ìš”...';

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('reflex-modal').classList.remove('hidden');

            // 3ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('reflex-timer').textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startReflexRound();
                }
            }, 1000);

            console.log('âš¡ ìˆœë°œë ¥ ê²Œì„ ì‹œì‘');
        }

        // ìˆœë°œë ¥ ê²Œì„ ë¼ìš´ë“œ ì‹œì‘
        function startReflexRound() {
            document.getElementById('reflex-instruction').textContent = 'ê°™ì€ ìƒ‰ê¹”ì„ ë¹ ë¥´ê²Œ ì°¾ìœ¼ì„¸ìš”!';

            // ìƒ‰ê¹” ëª©ë¡
            const colors = [
                { name: 'ë¹¨ê°•', bg: 'bg-red-500', code: '#ef4444' },
                { name: 'íŒŒë‘', bg: 'bg-blue-500', code: '#3b82f6' },
                { name: 'ì´ˆë¡', bg: 'bg-green-500', code: '#22c55e' },
                { name: 'ë…¸ë‘', bg: 'bg-yellow-400', code: '#facc15' },
                { name: 'ë³´ë¼', bg: 'bg-purple-500', code: '#a855f7' },
                { name: 'ë¶„í™', bg: 'bg-pink-500', code: '#ec4899' }
            ];

            // ëœë¤ íƒ€ê²Ÿ ìƒ‰ê¹” ì„ íƒ
            reflexTargetColor = colors[Math.floor(Math.random() * colors.length)];

            // ë²„íŠ¼ 4ê°œ ìƒì„± (1ê°œëŠ” ì •ë‹µ, ë‚˜ë¨¸ì§€ëŠ” ì˜¤ë‹µ)
            const buttons = [reflexTargetColor];
            const otherColors = colors.filter(c => c.name !== reflexTargetColor.name);

            // 3ê°œ ì˜¤ë‹µ ì¶”ê°€
            for (let i = 0; i < 3 && otherColors.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * otherColors.length);
                buttons.push(otherColors[randomIndex]);
                otherColors.splice(randomIndex, 1);
            }

            // ë²„íŠ¼ ì…”í”Œ
            buttons.sort(() => Math.random() - 0.5);

            // ê²Œì„ ì˜ì—­ì— ë²„íŠ¼ ìƒì„±
            const gameArea = document.getElementById('reflex-game-area');
            gameArea.innerHTML = buttons.map(color => `
                <button onclick="checkReflexAnswer('${color.name}')"
                        class="${color.bg} text-white rounded-lg p-6 text-center font-bold hover:opacity-80 transition-all transform hover:scale-105">
                    ${color.name}
                </button>
            `).join('');

            // íƒ€ì´ë¨¸ ì‹œì‘
            reflexGameTimeLeft = 10;
            document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;

            if (reflexGameInterval) clearInterval(reflexGameInterval);

            reflexGameInterval = setInterval(() => {
                reflexGameTimeLeft--;
                document.getElementById('reflex-timer').textContent = reflexGameTimeLeft;

                if (reflexGameTimeLeft <= 0) {
                    clearInterval(reflexGameInterval);
                    endReflexGame();
                }
            }, 1000);
        }

        // ìˆœë°œë ¥ ê²Œì„ ì •ë‹µ ì²´í¬
        function checkReflexAnswer(selectedColor) {
            if (reflexGameTimeLeft <= 0) return;

            if (selectedColor === reflexTargetColor.name) {
                // ì •ë‹µ!
                reflexGameScore += 10;
                document.getElementById('reflex-score').textContent = 'ì ìˆ˜: ' + reflexGameScore;

                // ì§„ë™ í”¼ë“œë°±
                if (vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([50]);
                }

                // ìƒˆ ë¼ìš´ë“œ ì‹œì‘
                startReflexRound();
            } else {
                // ì˜¤ë‹µ - ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ (í˜ë„í‹° ì—†ìŒ)
                if (vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            }
        }

        // ìˆœë°œë ¥ ê²Œì„ ì¢…ë£Œ
        function endReflexGame() {
            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            document.getElementById('reflex-instruction').textContent =
                `ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: ${reflexGameScore}ì `;
            document.getElementById('reflex-game-area').innerHTML = '';
            document.getElementById('reflex-continue-btn').classList.remove('hidden');

            console.log('âš¡ ìˆœë°œë ¥ ê²Œì„ ì¢…ë£Œ - ì ìˆ˜:', reflexGameScore);
        }

        // ìˆœë°œë ¥ ê²Œì„ ê±´ë„ˆë›°ê¸°
        function skipReflexGame() {
            // ê²Œì„ íƒ€ì´ë¨¸ ì •ë¦¬
            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('reflex-modal').classList.add('hidden');

            // ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ë°”ë¡œ ì´ë™
            loadNextSubject();

            console.log('âš¡ ìˆœë°œë ¥ ê²Œì„ ê±´ë„ˆë›°ê¸°');
        }

        // ìˆœë°œë ¥ ê²Œì„ ëª¨ë‹¬ ë‹«ê¸° ë° ë‹¤ìŒ ê³¼ëª© ë¡œë“œ
        function closeReflexGame() {
            document.getElementById('reflex-modal').classList.add('hidden');

            if (reflexGameInterval) {
                clearInterval(reflexGameInterval);
                reflexGameInterval = null;
            }

            // ë‹¤ìŒ ê³¼ëª© ë¡œë“œ
            loadNextSubject();
        }

        // ========== ê¸°ì¡´ í•¨ìˆ˜ ìˆ˜ì • ==========

        // ë‚˜ê°€ê¸° í™•ì¸
        function confirmExit() {
            if (confirm('í•™ìŠµì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if(loadingOverlay) loadingOverlay.classList.remove('hidden');

            try {
                // eduPetFirebaseIntegrationê°€ ì •ì˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        if (typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // Firebase í†µí•© ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ì´ ê³¼ì •ì—ì„œ ìµëª… ë¡œê·¸ì¸ì´ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
                await eduPetFirebaseIntegration.initialize();
                console.log('Firebase Integration is ready.');

                // ì´ì œ í€´ì¦ˆë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                await initializeQuiz();

            } catch (error) {
                console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ê³„ì† ì§„í–‰
                await initializeQuiz();
            } finally {
                // ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ë¡œë”© ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                if(loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        });
    </script>

    <!-- ìˆ˜ìˆ˜ê»˜ë¼ ëª¨ë‹¬ -->
    <div id="riddle-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">ğŸª</div>
                <h2 class="text-2xl font-bold text-purple-900 mb-2">ì ê¹! ìˆ˜ìˆ˜ê»˜ë¼ íƒ€ì„!</h2>
                <p class="text-sm text-purple-700">ë§íˆë©´ íŠ¹ë³„ ë³´ìƒì´ ìˆì–´ìš” ğŸ</p>
            </div>

            <div class="bg-white rounded-xl p-6 mb-6 shadow-md">
                <p class="text-lg text-gray-800 font-medium leading-relaxed mb-4" id="riddle-question">
                    ìˆ˜ìˆ˜ê»˜ë¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                </p>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‹µì„ ì…ë ¥í•˜ì„¸ìš”:</label>
                    <input type="text" id="riddle-answer-input"
                           class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg"
                           placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"
                           onkeypress="if(event.key==='Enter') checkRiddleAnswer()">
                </div>

                <div id="riddle-hint" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 mb-4">
                    <div class="flex items-start space-x-2">
                        <span class="text-lg">ğŸ’¡</span>
                        <div>
                            <div class="font-bold text-yellow-900 text-sm">íŒíŠ¸</div>
                            <div class="text-sm text-yellow-800" id="riddle-hint-text"></div>
                        </div>
                    </div>
                </div>

                <div id="riddle-result" class="hidden mb-4"></div>
            </div>

            <div class="flex space-x-3">
                <button onclick="showRiddleHint()" id="riddle-hint-btn"
                        class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition-all">
                    ğŸ’¡ íŒíŠ¸ ë³´ê¸°
                </button>
                <button onclick="checkRiddleAnswer()" id="riddle-submit-btn"
                        class="flex-1 px-4 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition-all">
                    âœ… í™•ì¸
                </button>
            </div>

            <button onclick="skipRiddle()" id="riddle-skip-btn"
                    class="w-full mt-3 px-4 py-2 text-gray-500 hover:text-gray-700 text-sm transition-all">
                ê±´ë„ˆë›°ê¸° â†’
            </button>
        </div>
    </div>

    <!-- í•´ì„¤ ëª¨ë‹¬ -->
    <div id="explanation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div id="explanation-modal-card" class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full transform transition-all">
            <!-- ê²°ê³¼ ì•„ì´ì½˜ & í…ìŠ¤íŠ¸ -->
            <div class="text-center mb-6">
                <div class="text-7xl mb-4 animate-bounce" id="modal-result-icon">ğŸ‰</div>
                <h2 class="text-3xl font-bold mb-2" id="modal-result-text">ì •ë‹µì…ë‹ˆë‹¤!</h2>
            </div>

            <!-- í•´ì„¤ ë‚´ìš© -->
            <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <span class="text-2xl mr-2">ğŸ’¡</span>
                    <span>í•´ì„¤</span>
                </h3>
                <p class="text-gray-700 leading-relaxed text-lg" id="modal-explanation-text">
                    í•´ì„¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ -->
            <button onclick="closeExplanationModal()"
                    class="w-full px-8 py-4 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl text-lg font-bold hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg transform hover:scale-105">
                ë‹¤ìŒ ë¬¸ì œë¡œ â¡ï¸
            </button>
        </div>
    </div>

    <!-- ìˆœë°œë ¥ ê²Œì„ ëª¨ë‹¬ -->
    <div id="reflex-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">âš¡</div>
                <h2 class="text-2xl font-bold text-blue-900 mb-2">ìˆœë°œë ¥ í…ŒìŠ¤íŠ¸!</h2>
                <p class="text-sm text-blue-700">ë‹¤ìŒ ê³¼ëª© ì‹œì‘ ì „ ì ê¹ ì‰¬ì–´ê°€ìš”</p>
            </div>

            <div class="bg-white rounded-xl p-6 mb-6 shadow-md">
                <div class="text-center mb-4">
                    <p class="text-lg font-medium text-gray-800 mb-4" id="reflex-instruction">
                        ì¤€ë¹„í•˜ì„¸ìš”...
                    </p>

                    <div class="grid grid-cols-2 gap-3 mb-4" id="reflex-game-area">
                        <!-- ê²Œì„ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>

                    <div id="reflex-timer" class="text-3xl font-bold text-blue-600 mb-2">3</div>
                    <div id="reflex-score" class="text-sm text-gray-600">ì ìˆ˜: 0</div>
                </div>
            </div>

            <button onclick="closeReflexGame()" id="reflex-continue-btn"
                    class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-all shadow-lg hidden">
                ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ ê³„ì†í•˜ê¸° â†’
            </button>

            <!-- ê±´ë„ˆë›°ê¸° ë²„íŠ¼ (í•­ìƒ í‘œì‹œ) -->
            <button onclick="skipReflexGame()" id="reflex-skip-btn"
                    class="w-full mt-3 px-4 py-2 text-gray-500 hover:text-gray-700 text-sm transition-all">
                ê±´ë„ˆë›°ê¸° â†’
            </button>
        </div>
    </div>
</body>
</html>