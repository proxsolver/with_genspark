<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Stats ë””ë²„ê·¸</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .info { color: #4fc1ff; }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š Daily Stats ë””ë²„ê·¸</h1>

    <div class="section">
        <h2>ë‚ ì§œ ì •ë³´</h2>
        <div id="date-info"></div>
    </div>

    <div class="section">
        <h2>Firebase ì—°ê²° ìƒíƒœ</h2>
        <div id="firebase-status">í™•ì¸ ì¤‘...</div>
    </div>

    <div class="section">
        <h2>ì˜¤ëŠ˜ì˜ Daily Stats ë°ì´í„°</h2>
        <button onclick="checkTodayStats()">ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸ (UTC)</button>
        <button onclick="checkLocalStats()">ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸ (ë¡œì»¬)</button>
        <button onclick="checkAllRecentStats()">ìµœê·¼ 3ì¼ ëª¨ë‘ í™•ì¸</button>
        <div id="stats-data" style="margin-top: 15px;"></div>
    </div>

    <div class="section">
        <h2>ë‚´ ì‚¬ìš©ì í†µê³„</h2>
        <button onclick="checkMyUserStats()">ë‚´ í†µê³„ í™•ì¸</button>
        <div id="user-stats" style="margin-top: 15px;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let db;
        let auth;

        // ë‚ ì§œ ì •ë³´ í‘œì‹œ
        function showDateInfo() {
            const now = new Date();
            const utcDate = now.toISOString().split('T')[0];
            const localDate = now.toLocaleDateString('en-CA');
            const koreaDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];

            document.getElementById('date-info').innerHTML = `
                <div class="info">í˜„ì¬ ì‹œê°„: ${now.toLocaleString('ko-KR')}</div>
                <div class="warning">UTC ë‚ ì§œ: ${utcDate}</div>
                <div class="success">ë¡œì»¬ ë‚ ì§œ (en-CA): ${localDate}</div>
                <div class="success">í•œêµ­ ë‚ ì§œ (UTC+9): ${koreaDate}</div>
                <div style="margin-top: 10px;">íƒ€ì„ì¡´ ì˜¤í”„ì…‹: ${-now.getTimezoneOffset() / 60}ì‹œê°„</div>
            `;
        }

        // Firebase ì´ˆê¸°í™”
        async function initFirebase() {
            try {
                if (typeof firebase_config === 'undefined') {
                    throw new Error('firebase-config.jsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebase_config);
                }

                db = firebase.database();
                auth = firebase.auth();

                // ìµëª… ë¡œê·¸ì¸
                await auth.signInAnonymously();

                document.getElementById('firebase-status').innerHTML =
                    '<div class="success">âœ… Firebase ì—°ê²° ì„±ê³µ</div>' +
                    '<div class="info">ì‚¬ìš©ì UID: ' + auth.currentUser.uid + '</div>';

            } catch (error) {
                document.getElementById('firebase-status').innerHTML =
                    '<div class="error">âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message + '</div>';
            }
        }

        // ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸ (UTC)
        async function checkTodayStats() {
            const statsDiv = document.getElementById('stats-data');
            const today = new Date().toISOString().split('T')[0];

            statsDiv.innerHTML = '<div class="info">â³ ë¡œë”© ì¤‘...</div>';

            try {
                const snapshot = await db.ref(`daily_stats/${today}`).once('value');
                const data = snapshot.val();

                if (!data) {
                    statsDiv.innerHTML = `<div class="warning">âš ï¸ ${today} (UTC) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
                    return;
                }

                const userCount = Object.keys(data).length;
                statsDiv.innerHTML = `
                    <div class="success">âœ… ${today} (UTC) ë°ì´í„° ë°œê²¬: ${userCount}ëª…</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸ (ë¡œì»¬)
        async function checkLocalStats() {
            const statsDiv = document.getElementById('stats-data');
            const localDate = new Date().toLocaleDateString('en-CA');

            statsDiv.innerHTML = '<div class="info">â³ ë¡œë”© ì¤‘...</div>';

            try {
                const snapshot = await db.ref(`daily_stats/${localDate}`).once('value');
                const data = snapshot.val();

                if (!data) {
                    statsDiv.innerHTML = `<div class="warning">âš ï¸ ${localDate} (ë¡œì»¬) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
                    return;
                }

                const userCount = Object.keys(data).length;
                statsDiv.innerHTML = `
                    <div class="success">âœ… ${localDate} (ë¡œì»¬) ë°ì´í„° ë°œê²¬: ${userCount}ëª…</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ìµœê·¼ 3ì¼ ëª¨ë‘ í™•ì¸
        async function checkAllRecentStats() {
            const statsDiv = document.getElementById('stats-data');
            statsDiv.innerHTML = '<div class="info">â³ ìµœê·¼ 3ì¼ ë°ì´í„° í™•ì¸ ì¤‘...</div>';

            try {
                const results = [];
                const now = new Date();

                for (let i = 0; i < 3; i++) {
                    const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                    const dateStr = date.toLocaleDateString('en-CA');

                    const snapshot = await db.ref(`daily_stats/${dateStr}`).once('value');
                    const data = snapshot.val();

                    if (data) {
                        const userCount = Object.keys(data).length;
                        results.push(`
                            <div class="success">âœ… ${dateStr}: ${userCount}ëª…</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `);
                    } else {
                        results.push(`<div class="warning">âš ï¸ ${dateStr}: ë°ì´í„° ì—†ìŒ</div>`);
                    }
                }

                statsDiv.innerHTML = results.join('<hr style="border-color: #3e3e42; margin: 15px 0;">');
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ë‚´ ì‚¬ìš©ì í†µê³„ í™•ì¸
        async function checkMyUserStats() {
            const userStatsDiv = document.getElementById('user-stats');
            userStatsDiv.innerHTML = '<div class="info">â³ ë¡œë”© ì¤‘...</div>';

            try {
                const uid = auth.currentUser.uid;
                const snapshot = await db.ref(`users/${uid}/stats`).once('value');
                const data = snapshot.val();

                if (!data) {
                    userStatsDiv.innerHTML = '<div class="warning">âš ï¸ í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                userStatsDiv.innerHTML = `
                    <div class="success">âœ… ì‚¬ìš©ì í†µê³„ ë°œê²¬</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                userStatsDiv.innerHTML = `<div class="error">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            showDateInfo();
            await initFirebase();
        });
    </script>
</body>
</html>
