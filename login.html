<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Plant System & Firebase Integration -->
    <script src="plant-system.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .btn-google {
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="login-card bg-white rounded-2xl shadow-2xl p-8 md:p-12 max-w-md w-full">
        <!-- ë¡œê³  ë° ì œëª© -->
        <div class="text-center mb-8">
            <div class="floating-icon text-6xl mb-4">ğŸ°</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">EduPet Collection</h1>
            <p class="text-gray-600">í•™ìŠµí•˜ê³  ë™ë¬¼ ì¹œêµ¬ë“¤ì„ ëª¨ì•„ë³´ì„¸ìš”!</p>
        </div>

        <!-- ë¡œê·¸ì¸ ë²„íŠ¼ ì˜ì—­ -->
        <div class="space-y-4">
            <!-- êµ¬ê¸€ ë¡œê·¸ì¸ -->
            <button onclick="signInWithGoogle()" class="btn-google w-full px-6 py-4 bg-white text-gray-700 rounded-xl font-semibold border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 shadow-md">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                    <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z" fill="#4285F4"/>
                    <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                    <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                </svg>
                êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">ë˜ëŠ”</span>
                </div>
            </div>

            <!-- ìµëª… ë¡œê·¸ì¸ -->
            <button onclick="signInAnonymously()" class="w-full px-6 py-4 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all shadow-md">
                ğŸ­ ìµëª…ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">ë˜ëŠ”</span>
                </div>
            </div>

            <!-- ì˜¤í”„ë¼ì¸ ëª¨ë“œ -->
            <button onclick="continueOffline()" class="w-full px-6 py-4 bg-gray-50 text-gray-600 rounded-xl font-semibold hover:bg-gray-100 transition-all border-2 border-gray-200">
                ğŸ“´ ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê³„ì†í•˜ê¸°
            </button>
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="message" class="mt-6 text-center text-sm hidden"></div>

        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
        <div class="mt-8 text-center text-xs text-gray-500 space-y-2">
            <p>âœ¨ êµ¬ê¸€/ìµëª… ë¡œê·¸ì¸: ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ê¸°í™” + ê·¸ë£¹ ê¸°ëŠ¥</p>
            <p>ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ì €ì¥ë§Œ (ì¸í„°ë„· ë¶ˆí•„ìš”)</p>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 9999;">
        <div class="bg-white rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">ë¡œê·¸ì¸ ì¤‘...</p>
        </div>
    </div>

    <script>
        let firebaseInitialized = false;

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
        async function waitForFirebase() {
            console.log('[Login] waitForFirebase ì‹œì‘');
            console.log('[Login] firebase:', typeof firebase);
            console.log('[Login] eduPetAuth:', typeof eduPetAuth);
            console.log('[Login] eduPetFirebaseIntegration:', typeof eduPetFirebaseIntegration);

            if (typeof firebase === 'undefined' || typeof eduPetAuth === 'undefined' || typeof eduPetFirebaseIntegration === 'undefined') {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        console.log(`[Login] Firebase ëŒ€ê¸° ì¤‘... (ì‹œë„ ${attempts}/50)`);
                        console.log('[Login] firebase:', typeof firebase);
                        console.log('[Login] eduPetAuth:', typeof eduPetAuth);
                        console.log('[Login] eduPetFirebaseIntegration:', typeof eduPetFirebaseIntegration);

                        if (typeof firebase !== 'undefined' && typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('[Login] âœ… Firebase ê°ì²´ ë¡œë“œ ì™„ë£Œ');
                            resolve();
                        } else if (attempts > 50) { // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                            clearInterval(checkInterval);
                            console.error('[Login] âŒ Firebase ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
                            showMessage('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
                            resolve();
                        }
                    }, 100);
                });
            } else {
                console.log('[Login] âœ… Firebase ê°ì²´ ì´ë¯¸ ë¡œë“œë¨');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Login] ========== í˜ì´ì§€ ë¡œë“œ ì‹œì‘ ==========');

            // Firebase ëŒ€ê¸°
            console.log('[Login] Firebase ê°ì²´ ëŒ€ê¸° ì¤‘...');
            await waitForFirebase();
            console.log('[Login] Firebase ê°ì²´ ëŒ€ê¸° ì™„ë£Œ');

            // Firebase Integration ì´ˆê¸°í™”
            if (window.eduPetFirebaseIntegration) {
                console.log('[Login] eduPetFirebaseIntegration ë°œê²¬, ì´ˆê¸°í™” ì‹œì‘...');
                try {
                    const initResult = await eduPetFirebaseIntegration.initialize();
                    console.log('[Login] eduPetFirebaseIntegration.initialize() ê²°ê³¼:', initResult);

                    firebaseInitialized = true;
                    console.log('[Login] âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                    console.log('[Login] firebase_auth:', typeof firebase_auth);
                    console.log('[Login] firebase_db:', typeof firebase_db);
                    console.log('[Login] eduPetAuth.currentUser:', eduPetAuth.currentUser);

                    // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (eduPetAuth.currentUser) {
                        console.log('[Login] ì´ë¯¸ ë¡œê·¸ì¸ë¨, index.htmlë¡œ ì´ë™');
                        window.location.href = 'index.html';
                        return;
                    }
                } catch (error) {
                    console.error('[Login] âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    console.error('[Login] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
                }
            } else {
                console.error('[Login] âŒ eduPetFirebaseIntegrationì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

            console.log('[Login] ========== ì´ˆê¸°í™” ì™„ë£Œ ==========');
        });

        // êµ¬ê¸€ ë¡œê·¸ì¸
        async function signInWithGoogle() {
            console.log('[Login] ========== êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘ ==========');
            console.log('[Login] firebaseInitialized:', firebaseInitialized);
            console.log('[Login] typeof firebase:', typeof firebase);
            console.log('[Login] typeof firebase_auth:', typeof firebase_auth);
            console.log('[Login] typeof firebase_db:', typeof firebase_db);
            console.log('[Login] typeof eduPetAuth:', typeof eduPetAuth);
            console.log('[Login] eduPetAuth:', eduPetAuth);
            console.log('[Login] eduPetAuth.signInWithGoogle:', typeof eduPetAuth?.signInWithGoogle);

            if (!firebaseInitialized) {
                console.warn('[Login] âš ï¸ Firebaseê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                showMessage('Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');

                // Firebase ì´ˆê¸°í™” ì¬ì‹œë„
                try {
                    console.log('[Login] Firebase ì¬ì´ˆê¸°í™” ì‹œë„...');
                    await waitForFirebase();
                    if (window.eduPetFirebaseIntegration) {
                        const initResult = await eduPetFirebaseIntegration.initialize();
                        console.log('[Login] ì¬ì´ˆê¸°í™” ê²°ê³¼:', initResult);
                        firebaseInitialized = true;
                        console.log('[Login] âœ… Firebase ì¬ì´ˆê¸°í™” ì„±ê³µ');
                    } else {
                        console.error('[Login] âŒ eduPetFirebaseIntegrationì´ ì—†ìŒ');
                    }
                } catch (error) {
                    console.error('[Login] âŒ Firebase ì¬ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    showMessage('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
            }

            if (!eduPetAuth || typeof eduPetAuth.signInWithGoogle !== 'function') {
                console.error('[Login] âŒ eduPetAuth.signInWithGoogle í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                console.error('[Login] eduPetAuth ê°ì²´:', eduPetAuth);
                console.error('[Login] typeof eduPetAuth:', typeof eduPetAuth);
                if (eduPetAuth) {
                    console.error('[Login] eduPetAuthì˜ ë©”ì„œë“œë“¤:', Object.keys(eduPetAuth));
                }
                showMessage('ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoading(true);
                console.log('[Login] âœ… eduPetAuth.signInWithGoogle() í˜¸ì¶œ ì‹œì‘');

                const result = await eduPetAuth.signInWithGoogle();

                console.log('[Login] âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ');
                console.log('[Login] ë¡œê·¸ì¸ ê²°ê³¼:', result);
                showMessage('ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    console.log('[Login] index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('[Login] âŒ êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                console.error('[Login] ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
                console.error('[Login] ì—ëŸ¬ ì½”ë“œ:', error.code);
                console.error('[Login] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
                showLoading(false);

                if (error.message === 'ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤') {
                    showMessage('ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                } else {
                    showMessage('êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                }
            }

            console.log('[Login] ========== êµ¬ê¸€ ë¡œê·¸ì¸ ì¢…ë£Œ ==========');
        }

        // ìµëª… ë¡œê·¸ì¸
        async function signInAnonymously() {
            if (!firebaseInitialized) {
                showMessage('Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                showLoading(true);
                await eduPetAuth.signInAnonymously();

                showMessage('ìµëª… ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('[Login] ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                showLoading(false);
                showMessage('ìµëª… ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê³„ì†í•˜ê¸°
        function continueOffline() {
            if (confirm('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜ì‚¬í•­:\n- ë°ì´í„°ê°€ ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤\n- ë‹¤ë¥¸ ê¸°ê¸°ì™€ ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n- ê·¸ë£¹ í•™ìŠµ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n- ìˆœìœ„í‘œì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                localStorage.setItem('offlineMode', 'true');

                showMessage('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 text-center text-sm px-4 py-2 rounded-lg';

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'warning') {
                messageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }

            messageDiv.classList.remove('hidden');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
