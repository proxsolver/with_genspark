<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Plant System & Firebase Integration -->
    <script src="plant-system.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .btn-google {
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="login-card bg-white rounded-2xl shadow-2xl p-8 md:p-12 max-w-md w-full">
        <!-- 로고 및 제목 -->
        <div class="text-center mb-8">
            <div class="floating-icon text-6xl mb-4">🐰</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">EduPet Collection</h1>
            <p class="text-gray-600">학습하고 동물 친구들을 모아보세요!</p>
        </div>

        <!-- 로그인 버튼 영역 -->
        <div class="space-y-4">
            <!-- 구글 로그인 -->
            <button onclick="signInWithGoogle()" class="btn-google w-full px-6 py-4 bg-white text-gray-700 rounded-xl font-semibold border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 shadow-md">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                    <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z" fill="#4285F4"/>
                    <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                    <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                </svg>
                구글 계정으로 로그인
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">또는</span>
                </div>
            </div>

            <!-- 익명 로그인 -->
            <button onclick="signInAnonymously()" class="w-full px-6 py-4 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all shadow-md">
                🎭 익명으로 시작하기
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">또는</span>
                </div>
            </div>

            <!-- 오프라인 모드 -->
            <button onclick="continueOffline()" class="w-full px-6 py-4 bg-gray-50 text-gray-600 rounded-xl font-semibold hover:bg-gray-100 transition-all border-2 border-gray-200">
                📴 오프라인으로 계속하기
            </button>
        </div>

        <!-- 메시지 영역 -->
        <div id="message" class="mt-6 text-center text-sm hidden"></div>

        <!-- 안내 문구 -->
        <div class="mt-8 text-center text-xs text-gray-500 space-y-2">
            <p>✨ 구글/익명 로그인: 여러 기기에서 동기화 + 그룹 기능</p>
            <p>📴 오프라인 모드: 로컬 저장만 (인터넷 불필요)</p>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 9999;">
        <div class="bg-white rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">로그인 중...</p>
        </div>
    </div>

    <script>
        let firebaseInitialized = false;

        // Firebase SDK 로드 대기
        async function waitForFirebase() {
            console.log('[Login] Firebase SDK 로드 대기 시작');

            if (typeof firebase === 'undefined') {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        console.log(`[Login] Firebase SDK 대기 중... (시도 ${attempts}/50)`);

                        if (typeof firebase !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('[Login] ✅ Firebase SDK 로드 완료');
                            resolve();
                        } else if (attempts > 50) { // 5초 타임아웃
                            clearInterval(checkInterval);
                            console.error('[Login] ❌ Firebase SDK 로드 타임아웃');
                            showMessage('Firebase 로드 실패', 'error');
                            resolve();
                        }
                    }, 100);
                });
            } else {
                console.log('[Login] ✅ Firebase SDK 이미 로드됨');
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Login] ========== 페이지 로드 시작 ==========');

            // 오프라인 모드에서 온 경우 체크
            const offlineMode = localStorage.getItem('offlineMode');
            const comingFromOffline = offlineMode === 'true';

            if (comingFromOffline) {
                console.log('[Login] ⚠️ 오프라인 모드에서 로그인 전환 시도');
                // 오프라인 모드 임시 표시
                showMessage('오프라인 데이터를 유지하며 로그인합니다...', 'info');
            }

            // Firebase SDK 대기
            console.log('[Login] Firebase SDK 대기 중...');
            await waitForFirebase();
            console.log('[Login] Firebase SDK 대기 완료');

            // Firebase 앱 초기화 (firebase-config.js의 initFirebase 호출)
            try {
                console.log('[Login] Firebase 앱 초기화 시작...');
                const firebaseReady = await initFirebase();
                console.log('[Login] initFirebase() 결과:', firebaseReady);
                console.log('[Login] firebase_app:', firebase_app);
                console.log('[Login] firebase_auth:', firebase_auth);
                console.log('[Login] firebase_db:', firebase_db);

                if (firebaseReady) {
                    firebaseInitialized = true;
                    console.log('[Login] ✅ Firebase 앱 초기화 완료');

                    // 오프라인 모드에서 온 경우: 기존 인증 세션 로그아웃
                    if (comingFromOffline && firebase_auth.currentUser) {
                        console.log('[Login] 오프라인 모드 전환: 기존 인증 세션 종료');
                        await firebase_auth.signOut();
                    }

                    // 인증 상태 리스너 등록 (오프라인 모드 전환 시에는 바로 리다이렉트 안함)
                    firebase_auth.onAuthStateChanged(async (user) => {
                        console.log('[Login] 인증 상태 변경:', user ? user.uid : 'null');
                        // 오프라인 모드 전환이 아닌 경우에만 자동 리다이렉트
                        if (user && !comingFromOffline) {
                            console.log('[Login] 이미 로그인됨, index.html로 이동');
                            window.location.href = 'index.html';
                        }
                    });
                } else {
                    console.error('[Login] ❌ Firebase 앱 초기화 실패');
                }
            } catch (error) {
                console.error('[Login] ❌ Firebase 초기화 실패:', error);
                console.error('[Login] 에러 스택:', error.stack);
            }

            console.log('[Login] ========== 초기화 완료 ==========');
        });

        // 오프라인 데이터 마이그레이션
        async function migrateOfflineData() {
            const offlineMode = localStorage.getItem('offlineMode');
            if (offlineMode !== 'true') {
                return; // 오프라인 모드가 아니면 마이그레이션 불필요
            }

            console.log('[Login] 🔄 오프라인 데이터 마이그레이션 시작...');

            try {
                // PlantSystem 데이터가 있으면 Firebase로 동기화
                const plantSystemUser = localStorage.getItem('plantSystemUser');
                if (plantSystemUser && eduPetAuth.currentUser) {
                    const userData = JSON.parse(plantSystemUser);
                    console.log('[Login] 마이그레이션할 데이터:', userData);

                    // Firebase에 통계 동기화
                    if (userData.wallet) {
                        await eduPetAuth.setUserStats({
                            totalMoney: userData.wallet.money || 0,
                            totalWater: userData.wallet.water || 0
                        });
                    }

                    console.log('[Login] ✅ 오프라인 데이터 마이그레이션 완료');
                }

                // 오프라인 모드 플래그 제거
                localStorage.removeItem('offlineMode');
                console.log('[Login] 오프라인 모드 플래그 제거됨');

            } catch (error) {
                console.error('[Login] ❌ 데이터 마이그레이션 실패:', error);
                // 실패해도 계속 진행 (나중에 동기화 가능)
            }
        }

        // 구글 로그인
        async function signInWithGoogle() {
            console.log('[Login] ========== 구글 로그인 시작 ==========');

            if (!firebaseInitialized) {
                showMessage('Firebase 초기화 중입니다. 잠시 후 다시 시도해주세요.', 'warning');
                return;
            }

            try {
                showLoading(true);
                console.log('[Login] eduPetAuth.signInWithGoogle() 호출');

                const result = await eduPetAuth.signInWithGoogle();

                console.log('[Login] ✅ 구글 로그인 성공:', result);

                // 오프라인 데이터 마이그레이션
                await migrateOfflineData();

                showMessage('로그인 성공! 데이터를 동기화하고 메인 페이지로 이동합니다...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                console.error('[Login] ❌ 구글 로그인 실패:', error);
                showLoading(false);

                if (error.message === '로그인이 취소되었습니다') {
                    showMessage('로그인이 취소되었습니다.', 'warning');
                } else {
                    showMessage('구글 로그인에 실패했습니다. 다시 시도해주세요.', 'error');
                }
            }

            console.log('[Login] ========== 구글 로그인 종료 ==========');
        }

        // 익명 로그인
        async function signInAnonymously() {
            if (!firebaseInitialized) {
                showMessage('Firebase 초기화 중입니다. 잠시 후 다시 시도해주세요.', 'warning');
                return;
            }

            try {
                showLoading(true);
                await eduPetAuth.signInAnonymously();

                // 오프라인 데이터 마이그레이션
                await migrateOfflineData();

                showMessage('익명 로그인 성공! 메인 페이지로 이동합니다...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('[Login] 익명 로그인 실패:', error);
                showLoading(false);
                showMessage('익명 로그인에 실패했습니다. 다시 시도해주세요.', 'error');
            }
        }

        // 오프라인으로 계속하기
        function continueOffline() {
            if (confirm('오프라인 모드로 계속하시겠습니까?\n\n⚠️ 주의사항:\n- 데이터가 이 기기에만 저장됩니다\n- 다른 기기와 동기화되지 않습니다\n- 그룹 학습 기능을 사용할 수 없습니다\n- 순위표에 참여할 수 없습니다')) {
                // 오프라인 모드 플래그 설정
                localStorage.setItem('offlineMode', 'true');

                showMessage('오프라인 모드로 시작합니다...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // 메시지 표시
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 text-center text-sm px-4 py-2 rounded-lg';

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'warning') {
                messageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }

            messageDiv.classList.remove('hidden');
        }

        // 로딩 표시
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
