<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Plant System & Firebase Integration -->
    <script src="plant-system.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .btn-google {
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="login-card bg-white rounded-2xl shadow-2xl p-8 md:p-12 max-w-md w-full">
        <!-- ë¡œê³  ë° ì œëª© -->
        <div class="text-center mb-8">
            <div class="floating-icon text-6xl mb-4">ğŸ°</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">EduPet Collection</h1>
            <p class="text-gray-600">í•™ìŠµí•˜ê³  ë™ë¬¼ ì¹œêµ¬ë“¤ì„ ëª¨ì•„ë³´ì„¸ìš”!</p>
        </div>

        <!-- ë¡œê·¸ì¸ ë²„íŠ¼ ì˜ì—­ -->
        <div class="space-y-4">
            <!-- êµ¬ê¸€ ë¡œê·¸ì¸ -->
            <button onclick="signInWithGoogle()" class="btn-google w-full px-6 py-4 bg-white text-gray-700 rounded-xl font-semibold border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 shadow-md">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                    <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z" fill="#4285F4"/>
                    <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                    <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                </svg>
                êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">ë˜ëŠ”</span>
                </div>
            </div>

            <!-- ìµëª… ë¡œê·¸ì¸ -->
            <button onclick="signInAnonymously()" class="w-full px-6 py-4 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all shadow-md">
                ğŸ­ ìµëª…ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
            </button>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">ë˜ëŠ”</span>
                </div>
            </div>

            <!-- ì˜¤í”„ë¼ì¸ ëª¨ë“œ -->
            <button onclick="continueOffline()" class="w-full px-6 py-4 bg-gray-50 text-gray-600 rounded-xl font-semibold hover:bg-gray-100 transition-all border-2 border-gray-200">
                ğŸ“´ ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê³„ì†í•˜ê¸°
            </button>
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="message" class="mt-6 text-center text-sm hidden"></div>

        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
        <div class="mt-8 text-center text-xs text-gray-500 space-y-2">
            <p>âœ¨ êµ¬ê¸€/ìµëª… ë¡œê·¸ì¸: ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ê¸°í™” + ê·¸ë£¹ ê¸°ëŠ¥</p>
            <p>ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ì €ì¥ë§Œ (ì¸í„°ë„· ë¶ˆí•„ìš”)</p>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 9999;">
        <div class="bg-white rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">ë¡œê·¸ì¸ ì¤‘...</p>
        </div>
    </div>

    <script>
        let firebaseInitialized = false;

        // Firebase SDK ë¡œë“œ ëŒ€ê¸°
        async function waitForFirebase() {
            console.log('[Login] Firebase SDK ë¡œë“œ ëŒ€ê¸° ì‹œì‘');

            if (typeof firebase === 'undefined') {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        console.log(`[Login] Firebase SDK ëŒ€ê¸° ì¤‘... (ì‹œë„ ${attempts}/50)`);

                        if (typeof firebase !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('[Login] âœ… Firebase SDK ë¡œë“œ ì™„ë£Œ');
                            resolve();
                        } else if (attempts > 50) { // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                            clearInterval(checkInterval);
                            console.error('[Login] âŒ Firebase SDK ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
                            showMessage('Firebase ë¡œë“œ ì‹¤íŒ¨', 'error');
                            resolve();
                        }
                    }, 100);
                });
            } else {
                console.log('[Login] âœ… Firebase SDK ì´ë¯¸ ë¡œë“œë¨');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Login] ========== í˜ì´ì§€ ë¡œë“œ ì‹œì‘ ==========');

            // ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œ ì˜¨ ê²½ìš° ì²´í¬
            const offlineMode = localStorage.getItem('offlineMode');
            const comingFromOffline = offlineMode === 'true';

            if (comingFromOffline) {
                console.log('[Login] âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œ ë¡œê·¸ì¸ ì „í™˜ ì‹œë„');
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì„ì‹œ í‘œì‹œ
                showMessage('ì˜¤í”„ë¼ì¸ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë©° ë¡œê·¸ì¸í•©ë‹ˆë‹¤...', 'info');
            }

            // Firebase SDK ëŒ€ê¸°
            console.log('[Login] Firebase SDK ëŒ€ê¸° ì¤‘...');
            await waitForFirebase();
            console.log('[Login] Firebase SDK ëŒ€ê¸° ì™„ë£Œ');

            // Firebase ì•± ì´ˆê¸°í™” (firebase-config.jsì˜ initFirebase í˜¸ì¶œ)
            try {
                console.log('[Login] Firebase ì•± ì´ˆê¸°í™” ì‹œì‘...');
                const firebaseReady = await initFirebase();
                console.log('[Login] initFirebase() ê²°ê³¼:', firebaseReady);
                console.log('[Login] firebase_app:', firebase_app);
                console.log('[Login] firebase_auth:', firebase_auth);
                console.log('[Login] firebase_db:', firebase_db);

                if (firebaseReady) {
                    firebaseInitialized = true;
                    console.log('[Login] âœ… Firebase ì•± ì´ˆê¸°í™” ì™„ë£Œ');

                    // ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œ ì˜¨ ê²½ìš°: ê¸°ì¡´ ì¸ì¦ ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ
                    if (comingFromOffline && firebase_auth.currentUser) {
                        console.log('[Login] ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜: ê¸°ì¡´ ì¸ì¦ ì„¸ì…˜ ì¢…ë£Œ');
                        await firebase_auth.signOut();
                    }

                    // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜ ì‹œì—ëŠ” ë°”ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì•ˆí•¨)
                    firebase_auth.onAuthStateChanged(async (user) => {
                        console.log('[Login] ì¸ì¦ ìƒíƒœ ë³€ê²½:', user ? user.uid : 'null');
                        // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        if (user && !comingFromOffline) {
                            console.log('[Login] ì´ë¯¸ ë¡œê·¸ì¸ë¨, index.htmlë¡œ ì´ë™');
                            window.location.href = 'index.html';
                        }
                    });
                } else {
                    console.error('[Login] âŒ Firebase ì•± ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('[Login] âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                console.error('[Login] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
            }

            console.log('[Login] ========== ì´ˆê¸°í™” ì™„ë£Œ ==========');
        });

        // ì˜¤í”„ë¼ì¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
        async function migrateOfflineData() {
            const offlineMode = localStorage.getItem('offlineMode');
            if (offlineMode !== 'true') {
                return; // ì˜¤í”„ë¼ì¸ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶ˆí•„ìš”
            }

            console.log('[Login] ğŸ”„ ì˜¤í”„ë¼ì¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');

            try {
                // PlantSystem ë°ì´í„°ê°€ ìˆìœ¼ë©´ Firebaseë¡œ ë™ê¸°í™”
                const plantSystemUser = localStorage.getItem('plantSystemUser');
                if (plantSystemUser && eduPetAuth.currentUser) {
                    const userData = JSON.parse(plantSystemUser);
                    console.log('[Login] ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë°ì´í„°:', userData);

                    // Firebaseì— í†µê³„ ë™ê¸°í™”
                    if (userData.wallet) {
                        await eduPetAuth.setUserStats({
                            totalMoney: userData.wallet.money || 0,
                            totalWater: userData.wallet.water || 0
                        });
                    }

                    console.log('[Login] âœ… ì˜¤í”„ë¼ì¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
                }

                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ í”Œë˜ê·¸ ì œê±°
                localStorage.removeItem('offlineMode');
                console.log('[Login] ì˜¤í”„ë¼ì¸ ëª¨ë“œ í”Œë˜ê·¸ ì œê±°ë¨');

            } catch (error) {
                console.error('[Login] âŒ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
                // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ë‚˜ì¤‘ì— ë™ê¸°í™” ê°€ëŠ¥)
            }
        }

        // êµ¬ê¸€ ë¡œê·¸ì¸
        async function signInWithGoogle() {
            console.log('[Login] ========== êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘ ==========');

            if (!firebaseInitialized) {
                showMessage('Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                showLoading(true);
                console.log('[Login] eduPetAuth.signInWithGoogle() í˜¸ì¶œ');

                const result = await eduPetAuth.signInWithGoogle();

                console.log('[Login] âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ:', result);

                // ì˜¤í”„ë¼ì¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
                await migrateOfflineData();

                showMessage('ë¡œê·¸ì¸ ì„±ê³µ! ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                console.error('[Login] âŒ êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                showLoading(false);

                if (error.message === 'ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤') {
                    showMessage('ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                } else {
                    showMessage('êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                }
            }

            console.log('[Login] ========== êµ¬ê¸€ ë¡œê·¸ì¸ ì¢…ë£Œ ==========');
        }

        // ìµëª… ë¡œê·¸ì¸
        async function signInAnonymously() {
            if (!firebaseInitialized) {
                showMessage('Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                showLoading(true);
                await eduPetAuth.signInAnonymously();

                // ì˜¤í”„ë¼ì¸ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
                await migrateOfflineData();

                showMessage('ìµëª… ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('[Login] ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                showLoading(false);
                showMessage('ìµëª… ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê³„ì†í•˜ê¸°
        function continueOffline() {
            if (confirm('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜ì‚¬í•­:\n- ë°ì´í„°ê°€ ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤\n- ë‹¤ë¥¸ ê¸°ê¸°ì™€ ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n- ê·¸ë£¹ í•™ìŠµ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n- ìˆœìœ„í‘œì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                localStorage.setItem('offlineMode', 'true');

                showMessage('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 text-center text-sm px-4 py-2 rounded-lg';

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'warning') {
                messageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }

            messageDiv.classList.remove('hidden');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
