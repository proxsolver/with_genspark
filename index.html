<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet Collection - í•™ìŠµìœ¼ë¡œ í‚¤ìš°ëŠ” ê²½ì œ ìƒíƒœê³„</title>
    <meta name="description" content="ì´ˆë“±í•™ìƒì„ ìœ„í•œ í†µí•© í•™ìŠµ ê²Œì„ ì•±. í•™ìŠµ, ë†ì¥ ê²½ì˜, ë™ë¬¼ ìˆ˜ì§‘ì´ í•˜ë‚˜ë¡œ!">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- í•œê¸€ í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PWA ê´€ë ¨ ë©”íƒ€íƒœê·¸ -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EduPet Collection">

    <!-- ë¡œê±° ì‹œìŠ¤í…œ (ê°€ì¥ ë¨¼ì € ë¡œë“œ) -->
    <script src="logger.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .font-game {
            font-family: 'Noto Sans KR', 'Comic Sans MS', cursive;
            font-weight: 600;
        }

        .gradient-bg {
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.1) 0%,
                rgba(255, 152, 0, 0.1) 50%,
                rgba(33, 150, 243, 0.1) 100%
            );
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .progress-bar {
            transition: width 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes coinBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-fade-in {
            animation: fadeIn 1s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 1s ease-out forwards;
        }

        .harvest-modal-show {
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .coin-bounce {
            animation: coinBounce 0.6s ease-in-out infinite;
        }

        /* ì¶•í•˜ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .celebration-modal {
            animation: modalZoomIn 0.5s ease-out;
        }

        @keyframes modalZoomIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .glow-pulse {
            animation: glowPulse 2s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% {
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
                transform: scale(1.05);
            }
        }

        /* ì»¨í˜í‹° ì• ë‹ˆë©”ì´ì…˜ */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }
    </style>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            500: '#4CAF50',
                            600: '#16a34a',
                        },
                        secondary: {
                            50: '#fff7ed',
                            500: '#FF9800',
                            600: '#ea580c',
                        },
                        accent: {
                            50: '#eff6ff',
                            500: '#2196F3',
                            600: '#2563eb',
                        },
                        danger: {
                            50: '#fef2f2',
                            500: '#F44336',
                            600: '#dc2626',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="gradient-bg min-h-screen">
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- íƒ€ì´í‹€ ì„¹ì…˜ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 opacity-0 animate-fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 font-game mb-2">
                        ğŸŒ± EduPet Collection
                    </h1>
                    <p class="text-sm text-gray-600"><span id="userAvatarDisplay" style="font-size: 1.2rem;">ğŸ°</span> <span id="userNameDisplay">í•™ìŠµì</span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</p>
                </div>

                <div class="text-right">
                    <div class="flex items-center justify-end space-x-2 mb-2">
                        <span class="text-2xl">ğŸ’°</span>
                        <span id="moneyDisplay" class="text-2xl font-bold text-primary-600">0 ì½”ì¸</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-1">
                        ğŸ”¥ <span id="streakDisplay">0ì¼ì§¸</span> í”Œë ˆì´ ì¤‘
                    </div>
                    <div class="text-sm text-gray-600">
                        ğŸ¾ <span id="animalCountDisplay">0ë§ˆë¦¬</span>ì˜ íŒ» ë³´ìœ 
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ í•™ìŠµ (ì•½ì  ë³´ì™„) -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 0.2s forwards;">
            <div class="flex items-start space-x-4">
                <div class="text-6xl" id="highestAnimalDisplay">ğŸ°</div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-3">
                        <span class="text-xl">ğŸ’¡</span>
                        <h2 class="text-xl font-bold font-game">ì˜¤ëŠ˜ì˜ í•™ìŠµ</h2>
                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">ì•½ì  ë³´ì™„</span>
                    </div>

                    <!-- ë§í’ì„  ìŠ¤íƒ€ì¼ì˜ ë¬¸ì œ í‘œì‹œ -->
                    <div class="bg-white rounded-xl p-4 mb-3 shadow-md relative">
                        <div class="absolute -left-3 top-4">
                            <div class="w-0 h-0 border-t-8 border-b-8 border-r-8 border-transparent border-r-white"></div>
                        </div>

                        <div class="mb-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg" id="weaknessSubjectIcon">ğŸ“š</span>
                                <span class="font-bold text-gray-800" id="weaknessSubjectName">ì•½ì  ê³¼ëª©</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">ë³´í†µ</span>
                            </div>
                            <p class="text-gray-700 mb-3" id="weaknessQuestion">
                                ì˜¤ëŠ˜ì˜ ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                            </p>
                        </div>

                        <!-- ì •ë‹µ í‘œì‹œ -->
                        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-3 mb-2">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-lg">âœ…</span>
                                <span class="font-bold text-green-900">ì •ë‹µ</span>
                            </div>
                            <p class="text-sm text-green-800" id="weaknessAnswer">ì •ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>

                        <!-- í•´ì„¤ í‘œì‹œ -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-lg">ğŸ’¡</span>
                                <span class="font-bold text-blue-900">í•´ì„¤</span>
                            </div>
                            <p class="text-sm text-gray-700" id="weaknessExplanation">í•´ì„¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>
                    </div>

                    <button onclick="loadNewWeaknessQuestion()" class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition-colors">
                        ë‹¤ìŒ ë¬¸ì œ ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ í•™ìŠµ ë¯¸ì…˜ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 0.4s forwards;">
            <div class="flex items-center space-x-2 mb-4">
                <span class="text-xl">ğŸ“š</span>
                <h2 class="text-xl font-bold font-game">ì˜¤ëŠ˜ì˜ í•™ìŠµ ë¯¸ì…˜</h2>
                <span id="dailyProgressDisplay" class="px-3 py-1 bg-secondary-100 text-secondary-800 rounded-full text-sm font-semibold">0/9 ê³¼ëª©</span>
            </div>

            <!-- ì§„í–‰ë¥  ë°” -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600">í•™ìŠµ ì§„í–‰ë¥ </span>
                    <span id="progressPercentDisplay" class="text-sm font-medium">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBarDisplay" class="bg-primary-500 h-3 rounded-full progress-bar" style="width: 0%;"></div>
                </div>
            </div>

            <!-- í•„ìˆ˜ ê³¼ëª© -->
            <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">í•„ìˆ˜ ê³¼ëª©</h4>
                <div class="grid grid-cols-3 gap-3">
                    <button id="english-btn" onclick="startQuickQuiz('english')" class="border-2 border-gray-300 text-gray-700 p-4 rounded-xl h-20 flex flex-col items-center justify-center card-hover hover:border-primary-500 hover:bg-primary-50">
                        <div class="flex items-center space-x-1 mb-1">
                            <span>ğŸ‡ºğŸ‡¸</span>
                            <span class="font-medium">ì˜ì–´</span>
                        </div>
                        <div id="english-status" class="text-xs opacity-80">í•„ìˆ˜</div>
                    </button>

                    <button id="weakness-btn" onclick="startWeaknessQuiz()" class="border-2 border-orange-300 text-gray-700 p-4 rounded-xl h-20 flex flex-col items-center justify-center card-hover hover:border-orange-500 hover:bg-orange-50">
                        <div class="flex items-center space-x-1 mb-1">
                            <span id="weaknessIcon">ğŸ“Š</span>
                            <span class="font-medium" id="weaknessLabel">ì•½í•œê³¼ëª©</span>
                        </div>
                        <div id="weakness-status" class="text-xs opacity-80">í•„ìˆ˜</div>
                    </button>

                    <button id="all-subjects-btn" onclick="window.location.href='subject-select.html'" class="border-2 border-gray-300 text-gray-500 p-4 rounded-xl h-20 flex flex-col items-center justify-center card-hover hover:border-primary-500 hover:bg-primary-50">
                        <div class="flex items-center space-x-1 mb-1">
                            <span>ğŸ“š</span>
                            <span class="font-medium">ê³¼ëª©ì„ íƒ</span>
                        </div>
                        <div id="all-subjects-status" class="text-xs opacity-80">ì„ íƒí•˜ê¸°</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ë‚˜ì˜ ë†ì¥ -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 0.6s forwards;">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <span class="text-xl">ğŸŒ±</span>
                    <h2 class="text-xl font-bold font-game">ë‚˜ì˜ ë†ì¥</h2>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">ğŸ« ì„±ì¥ê¶Œ</div>
                        <div class="font-bold text-green-600" id="farm-growth-tickets">0ê°œ</div>
                    </div>
                    <button onclick="showHomeFarmDevMenu()" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm border border-red-200">
                        âš™ï¸
                    </button>
                </div>
            </div>

            <!-- ë‹¤ìŒ ë³´ìƒ ì•ˆë‚´ -->
            <div class="bg-blue-50 rounded-lg p-3 mb-4 border border-blue-200">
                <div class="flex items-center space-x-2">
                    <span class="text-lg">ğŸ¯</span>
                    <div class="flex-1">
                        <p class="text-xs text-blue-700" id="farm-next-reward">3ê³¼ëª© ë‹¬ì„± ì‹œ: ì„±ì¥ê¶Œ 1ê°œ</p>
                    </div>
                </div>
            </div>

            <!-- í™”ë¶„ ì˜ì—­ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- í™”ë¶„ 1 -->
                <div class="bg-white rounded-lg p-4 shadow-md border-2 border-green-200">
                    <div class="text-center mb-2">
                        <h3 class="text-sm font-bold text-gray-800">ğŸª´ í™”ë¶„ #1</h3>
                    </div>

                    <div class="relative" id="home-pot1-container">
                        <div class="bg-amber-100 rounded-lg border-4 border-amber-300 h-32 flex flex-col items-center justify-end p-3 relative overflow-hidden"
                             id="home-pot1" style="cursor: pointer;">
                            <div id="home-plant1-display" class="absolute bottom-3 left-1/2 transform -translate-x-1/2"></div>
                            <div id="home-empty-pot1" class="text-center">
                                <div class="text-3xl mb-1">ğŸ•³ï¸</div>
                                <div class="text-xs text-gray-500">ì”¨ì•— ì‹¬ê¸°</div>
                            </div>
                        </div>

                        <div id="home-plant1-info" class="mt-2 text-center hidden">
                            <div class="text-xs text-gray-600 mb-1" id="home-plant1-status">ì„±ì¥ ì¤‘</div>
                            <div class="mb-2">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>ğŸ’§ ë¬¼</span>
                                    <span id="home-plant1-water">0/20</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-500 h-1.5 rounded-full transition-all" id="home-plant1-water-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600" id="home-plant1-time">â° 24ì‹œê°„</div>
                        </div>

                        <div class="mt-2" id="home-pot1-actions">
                            <button onclick="homePlantSeed(1)" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg text-xs hover:bg-green-600 transition-all">
                                ğŸŒ° ì”¨ì•— ì‹¬ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- í™”ë¶„ 2 -->
                <div class="bg-white rounded-lg p-4 shadow-md border-2 border-green-200">
                    <div class="text-center mb-2">
                        <h3 class="text-sm font-bold text-gray-800">ğŸª´ í™”ë¶„ #2</h3>
                    </div>

                    <div class="relative" id="home-pot2-container">
                        <div class="bg-amber-100 rounded-lg border-4 border-amber-300 h-32 flex flex-col items-center justify-end p-3 relative overflow-hidden"
                             id="home-pot2" style="cursor: pointer;">
                            <div id="home-plant2-display" class="absolute bottom-3 left-1/2 transform -translate-x-1/2"></div>
                            <div id="home-empty-pot2" class="text-center">
                                <div class="text-3xl mb-1">ğŸ•³ï¸</div>
                                <div class="text-xs text-gray-500">ì”¨ì•— ì‹¬ê¸°</div>
                            </div>
                        </div>

                        <div id="home-plant2-info" class="mt-2 text-center hidden">
                            <div class="text-xs text-gray-600 mb-1" id="home-plant2-status">ì„±ì¥ ì¤‘</div>
                            <div class="mb-2">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>ğŸ’§ ë¬¼</span>
                                    <span id="home-plant2-water">0/20</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-500 h-1.5 rounded-full transition-all" id="home-plant2-water-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600" id="home-plant2-time">â° 24ì‹œê°„</div>
                        </div>

                        <div class="mt-2" id="home-pot2-actions">
                            <button onclick="homePlantSeed(2)" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg text-xs hover:bg-green-600 transition-all">
                                ğŸŒ° ì”¨ì•— ì‹¬ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë¬¼ì£¼ê¸° ì•ˆë‚´ -->
            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                <div class="text-center">
                    <p class="text-xs text-blue-700 mb-1">
                        ğŸ’§ ì‹ë¬¼ì„ í´ë¦­í•˜ë©´ ì•½ì  ê³¼ëª© ë¬¸ì œë¡œ ë¬¼ì„ ì¤„ ìˆ˜ ìˆì–´ìš”!
                    </p>
                    <div class="text-xs text-blue-600">
                        ğŸ’¡ ë¬¼ 20ê°œ + 24ì‹œê°„ + ì„±ì¥ê¶Œ 1ê°œ = ì„±ì¥!
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„±ê³¼ ë° ì—…ì  -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 0.8s forwards;">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <span class="text-xl">ğŸ†</span>
                    <h2 class="text-xl font-bold font-game">ì„±ê³¼ ë° ì—…ì </h2>
                </div>
                <button onclick="window.location.href='achievements.html'" class="px-3 py-1 bg-yellow-500 text-white rounded-full text-sm hover:bg-yellow-600 transition-colors">
                    ì „ì²´ë³´ê¸°
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <!-- ìµœê·¼ ì„±ê³¼ -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-3">
                    <div class="text-2xl mb-2">ğŸ“ˆ</div>
                    <div class="text-xs text-gray-600 mb-1">ìµœê·¼ ì„±ê³¼</div>
                    <div class="font-bold text-blue-900" id="recentAchievement">ì²« í•™ìŠµ ì™„ë£Œ</div>
                </div>

                <!-- íšë“ ë±ƒì§€ -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-lg p-3">
                    <div class="text-2xl mb-2">ğŸ–ï¸</div>
                    <div class="text-xs text-gray-600 mb-1">íšë“ ë±ƒì§€</div>
                    <div class="font-bold text-purple-900" id="badgeCount">3ê°œ</div>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ í•™ìŠµ í™œë™ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 0.9s forwards;">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">ğŸ“…</span>
                ìµœê·¼ í•™ìŠµ í™œë™
            </h2>

            <!-- ì˜¤ëŠ˜ì˜ í•™ìŠµ í˜„í™© -->
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">ì˜¤ëŠ˜ í‘¼ ë¬¸ì œ</div>
                    <div class="text-2xl font-bold text-blue-600" id="todayQuestions">0</div>
                    <div class="text-xs text-gray-500">ë¬¸ì œ</div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">ì •ë‹µë¥ </div>
                    <div class="text-2xl font-bold text-purple-600" id="todayAccuracy">0</div>
                    <div class="text-xs text-gray-500">%</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3 text-center">
                    <div class="text-xs text-gray-600 mb-1">í•™ìŠµ ì‹œê°„</div>
                    <div class="text-2xl font-bold text-green-600" id="todayMinutes">0</div>
                    <div class="text-xs text-gray-500">ë¶„</div>
                </div>
            </div>

            <!-- ì£¼ê°„ í™œë™ ê·¸ë˜í”„ -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-700">ìµœê·¼ 7ì¼ í™œë™</h3>
                <div class="text-sm">
                    <span class="text-orange-600 font-bold" id="streakDays">0</span>
                    <span class="text-gray-600">ì¼ ì—°ì† ğŸ”¥</span>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center">
                <div id="weeklyLabels" class="contents">
                    <!-- Day labels will be inserted here -->
                </div>

                <div id="weeklyActivity" class="contents">
                    <!-- Weekly activity cells will be inserted here -->
                </div>
            </div>
        </div>

        <!-- ë™ë¬¼ ìˆ˜ì§‘ -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 1s forwards;">
            <div class="flex items-start space-x-4">
                <div class="text-6xl" id="topAnimalDisplay">ğŸ¦</div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-3">
                        <span class="text-xl">âœ¨</span>
                        <h2 class="text-xl font-bold font-game">ë™ë¬¼ ìˆ˜ì§‘</h2>
                    </div>

                    <div class="bg-white rounded-xl p-4 mb-3 shadow-md">
                        <p class="text-sm text-gray-700 mb-3" id="animalMessage">
                            "ì•ˆë…•! ë‚˜ëŠ” <span id="topAnimalName">ë„ë§ˆë±€</span>ì´ì•¼! í˜„ì¬ ë½‘ê¸°ê¶Œì´ <span id="ticketCount" class="font-bold text-purple-600">0ì¥</span> ìˆì–´. 25ë¬¸ì œë¥¼ í’€ë©´ ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ë§Œë‚  ìˆ˜ ìˆì–´!"
                        </p>

                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div class="bg-gray-50 rounded p-2">
                                <div class="text-gray-600">ì¼ë°˜ ë½‘ê¸°ê¶Œ</div>
                                <div class="font-bold" id="normalTickets">0ì¥</div>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded p-2">
                                <div class="text-gray-600">í”„ë¦¬ë¯¸ì—„ ë½‘ê¸°ê¶Œ</div>
                                <div class="font-bold text-yellow-700" id="premiumTickets">0ì¥</div>
                            </div>
                        </div>

                        <button onclick="window.location.href='animal-collection.html'" class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition-colors">
                            ë™ë¬¼ ì»¬ë ‰ì…˜ ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê·¸ ì™¸ ë©”ë‰´ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 opacity-0" style="animation: slideUp 1s ease-out 1.2s forwards;">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center space-x-2">
                <span>âš™ï¸</span>
                <span>ê·¸ ì™¸ ë©”ë‰´</span>
            </h3>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.location.href='progress-dashboard.html'" class="border-2 border-gray-200 text-gray-700 p-3 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-left">
                    <div class="text-2xl mb-1">ğŸ“Š</div>
                    <div class="text-sm font-semibold">í•™ìŠµ í˜„í™©</div>
                </button>

                <button onclick="window.location.href='social-hub.html'" class="border-2 border-gray-200 text-gray-700 p-3 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-left">
                    <div class="text-2xl mb-1">ğŸ’¬</div>
                    <div class="text-sm font-semibold">ì†Œí†µí•˜ê¸°</div>
                </button>

                <button onclick="window.location.href='data-manager.html'" class="border-2 border-gray-200 text-gray-700 p-3 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-left">
                    <div class="text-2xl mb-1">ğŸ’¾</div>
                    <div class="text-sm font-semibold">ë°ì´í„° ê´€ë¦¬</div>
                </button>

                <button onclick="window.location.href='analytics-console.html'" class="border-2 border-gray-200 text-gray-700 p-3 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-left">
                    <div class="text-2xl mb-1">ğŸ“ˆ</div>
                    <div class="text-sm font-semibold">í•™ìŠµ ë¶„ì„</div>
                </button>

                <button onclick="restartTutorial()" class="border-2 border-gray-200 text-gray-700 p-3 rounded-lg hover:border-cyan-500 hover:bg-cyan-50 transition-colors text-left">
                    <div class="text-2xl mb-1">ğŸ“–</div>
                    <div class="text-sm font-semibold">íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°</div>
                </button>
            </div>

            <div class="mt-3 text-center space-y-2">
                <button class="text-sm text-gray-400 hover:text-gray-600 cursor-not-allowed" disabled>
                    ğŸ’° ë³´ìƒ ìš”ì²­ (í–¥í›„ êµ¬í˜„)
                </button>
                <div class="flex flex-col space-y-1">
                    <button onclick="window.location.href='debug-console.html'" class="text-xs text-blue-500 hover:text-blue-700">
                        ğŸ› ë””ë²„ê·¸ ì½˜ì†”
                    </button>
                    <button onclick="window.location.href='clear-offline-queue.html'" class="text-xs text-red-500 hover:text-red-700">
                        ğŸ”§ ì˜¤í”„ë¼ì¸ í ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬¼ì£¼ê¸° í•™ìŠµ ëª¨ë‹¬ -->
    <div id="home-watering-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">ğŸŒ±</div>
                <h3 class="text-lg font-bold">ë¬¼ì£¼ê¸° í•™ìŠµ</h3>
            </div>

            <div class="bg-blue-50 rounded-lg p-4 mb-4">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2" id="home-question-subject-icon">ğŸ“š</span>
                    <div class="font-bold text-blue-900" id="home-question-title">ì•½ì  ê³¼ëª© í•™ìŠµ</div>
                </div>
                <div class="text-sm text-blue-800 mb-3" id="home-question-text">
                    ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                </div>

                <div class="mb-3 p-3 bg-green-50 border-2 border-green-300 rounded-lg">
                    <div class="flex items-start space-x-2 mb-2">
                        <span class="text-lg">âœ…</span>
                        <div>
                            <div class="font-bold text-green-900 mb-1">ì •ë‹µ</div>
                            <div class="text-sm text-green-800" id="home-correct-answer"></div>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2 mt-2 pt-2 border-t border-green-200">
                        <span class="text-lg">ğŸ’¡</span>
                        <div>
                            <div class="font-bold text-blue-900 mb-1">í•´ì„¤</div>
                            <div class="text-sm text-gray-700" id="home-explanation-text"></div>
                        </div>
                    </div>
                </div>

                <button id="home-water-confirm-btn" onclick="homeConfirmWater()" disabled
                        class="w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all">
                    <span id="home-water-btn-text">ğŸ’§ ë¬¸ì œë¥¼ ì½ì–´ì£¼ì„¸ìš” (<span id="home-countdown">3</span>ì´ˆ)</span>
                </button>
            </div>

            <div class="text-center">
                <button onclick="homeCloseWateringModal()" class="text-gray-500 text-sm hover:text-gray-700">
                    ë‚˜ì¤‘ì— í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ê°œë°œì ë©”ë‰´ ëª¨ë‹¬ -->
    <div id="home-dev-menu-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-red-600">âš™ï¸ ë†ì¥ ê°œë°œì ë©”ë‰´</h3>
                <button onclick="closeHomeFarmDevMenu()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>

            <div class="space-y-3">
                <button onclick="homeResetAllData()" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-left">
                    ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”
                    <div class="text-xs text-red-100 mt-1">ëª¨ë“  ë°ì´í„° ì‚­ì œ (ì‚¬ìš©ì, ì‹ë¬¼, í•™ìŠµ ê¸°ë¡ ì „ì²´)</div>
                </button>

                <button onclick="homeResetSelectedData()" class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-left">
                    ğŸ¯ ì„ íƒí•œ ë°ì´í„°ë§Œ ì´ˆê¸°í™”
                    <div class="text-xs text-orange-100 mt-1">ì›í•˜ëŠ” í•­ëª©ë§Œ ì„ íƒí•˜ì—¬ ì´ˆê¸°í™”</div>
                </button>

                <button onclick="homeSkipPlantTime()" class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-left">
                    â° ì‹ë¬¼ ì‹œê°„ ê±´ë„ˆë›°ê¸° (24ì‹œê°„)
                    <div class="text-xs text-blue-100 mt-1">ëª¨ë“  ì‹ë¬¼ì„ 24ì‹œê°„ ê²½ê³¼ ìƒíƒœë¡œ ë³€ê²½</div>
                </button>

                <button onclick="homeAddTestTickets()" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-left">
                    ğŸ« í…ŒìŠ¤íŠ¸ ì„±ì¥ê¶Œ ì¶”ê°€
                    <div class="text-xs text-green-100 mt-1">ì„±ì¥ê¶Œ 5ê°œ ì¦‰ì‹œ ì§€ê¸‰</div>
                </button>

                <button onclick="homeResetPlants()" class="w-full px-4 py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 text-left">
                    ğŸŒ± ì‹ë¬¼ë§Œ ì´ˆê¸°í™”
                    <div class="text-xs text-teal-100 mt-1">ëª¨ë“  ì‹ë¬¼ ì œê±° (ë³´ìƒì€ ìœ ì§€)</div>
                </button>

                <button onclick="homeResetDaily()" class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-left">
                    ğŸ“… ì¼ì¼ ì§„í–‰ë¥  ì´ˆê¸°í™”
                    <div class="text-xs text-yellow-100 mt-1">ì˜¤ëŠ˜ ì™„ë£Œí•œ ê³¼ëª© ë¦¬ì…‹</div>
                </button>

                <button onclick="homeAddWaterToPlant()" class="w-full px-4 py-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 text-left">
                    ğŸ’§ ì‹ë¬¼ì— ë¬¼ 10ê°œ ì¶”ê°€
                    <div class="text-xs text-cyan-100 mt-1">ì²« ë²ˆì§¸ ì‹ë¬¼ì— ë¬¼ 10ê°œ ì¦‰ì‹œ ì§€ê¸‰</div>
                </button>

                <button onclick="homeTestHarvestPopup()" class="w-full px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-left">
                    ğŸ‰ ìˆ˜í™• íŒì—… í…ŒìŠ¤íŠ¸
                    <div class="text-xs text-purple-100 mt-1">ìˆ˜í™• ë³´ìƒ íŒì—… ë¯¸ë¦¬ë³´ê¸° (100ì›)</div>
                </button>

                <button onclick="homeAddTestMoney()" class="w-full px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 text-left">
                    ğŸ’° í…ŒìŠ¤íŠ¸ ëˆ ì¶”ê°€
                    <div class="text-xs text-pink-100 mt-1">1000ì› ì¦‰ì‹œ ì§€ê¸‰</div>
                </button>

                <button onclick="homeCompleteLearningMissions()" class="w-full px-4 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-left">
                    âœ… í•™ìŠµ ë¯¸ì…˜ ëª¨ë‘ ì™„ë£Œ
                    <div class="text-xs text-indigo-100 mt-1">9ê³¼ëª© ëª¨ë‘ ì™„ë£Œ ì²˜ë¦¬ (ë³´ìƒ í¬í•¨)</div>
                </button>

                <button onclick="homeResetLearningMissions()" class="w-full px-4 py-3 bg-slate-500 text-white rounded-lg hover:bg-slate-600 text-left">
                    ğŸ”„ í•™ìŠµ ë¯¸ì…˜ ì´ˆê¸°í™”
                    <div class="text-xs text-slate-100 mt-1">ëª¨ë“  ê³¼ëª© ë¯¸ì™„ë£Œ ìƒíƒœë¡œ ë¦¬ì…‹</div>
                </button>
            </div>

            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                âš ï¸ ì´ ë©”ë‰´ëŠ” ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ê°€ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ì‹ë¬¼ ì§„í™” ì¶•í•˜ ëª¨ë‹¬ -->
    <div id="home-celebration-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-yellow-50 to-green-50 rounded-2xl p-8 max-w-md w-full celebration-modal relative overflow-hidden">
            <!-- ë°°ê²½ ì¥ì‹ -->
            <div id="home-confetti-container" class="absolute inset-0 pointer-events-none"></div>

            <div class="relative z-10">
                <!-- ì¶•í•˜ ì•„ì´ì½˜ -->
                <div class="text-center mb-4">
                    <div class="text-8xl mb-4 glow-pulse" id="home-celebration-emoji">ğŸ‰</div>
                    <div class="text-2xl font-bold text-gray-800 mb-2" id="home-celebration-title">ì¶•í•˜í•©ë‹ˆë‹¤!</div>
                    <div class="text-lg text-gray-600 mb-4" id="home-celebration-message">ì‹ë¬¼ì´ ì„±ì¥í–ˆìŠµë‹ˆë‹¤!</div>
                </div>

                <!-- ë³€í™” í‘œì‹œ -->
                <div class="bg-white rounded-xl p-4 mb-6 shadow-lg">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="text-center">
                            <div class="text-4xl mb-2" id="home-celebration-before">ğŸŒ°</div>
                            <div class="text-xs text-gray-500">ì´ì „</div>
                        </div>
                        <div class="text-3xl text-green-500">â†’</div>
                        <div class="text-center">
                            <div class="text-5xl mb-2 glow-pulse" id="home-celebration-after">ğŸŒ±</div>
                            <div class="text-xs text-gray-500">í˜„ì¬</div>
                        </div>
                    </div>
                </div>

                <!-- ì§„í–‰ë¥  í‘œì‹œ -->
                <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-3 mb-4">
                    <div class="text-center">
                        <div class="text-sm font-semibold text-gray-700 mb-2" id="home-celebration-progress">ì§„í–‰ë¥ </div>
                        <div class="flex justify-center items-center space-x-2">
                            <div class="flex space-x-1" id="home-celebration-stages">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë‹¤ìŒ ëª©í‘œ -->
                <div class="bg-blue-50 rounded-lg p-3 mb-4 border-2 border-blue-200">
                    <div class="text-center text-sm">
                        <div class="font-semibold text-blue-800 mb-1">ë‹¤ìŒ ëª©í‘œ</div>
                        <div class="text-blue-700" id="home-celebration-next-goal">ê³„ì† ë¬¼ì£¼ê¸°!</div>
                    </div>
                </div>

                <!-- ë‹«ê¸° ë²„íŠ¼ -->
                <button onclick="homeCloseCelebrationModal()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- ìˆ˜í™• ë³´ìƒ íŒì—… -->
    <div id="home-harvest-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-center transform transition-all scale-95" id="home-harvest-content">
            <div class="text-7xl mb-4 animate-bounce">ğŸ‰</div>
            <h2 class="text-3xl font-bold text-gray-900 mb-3">ìˆ˜í™• ì™„ë£Œ!</h2>

            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-6 mb-4">
                <div class="text-6xl mb-3">ğŸ’°</div>
                <div class="text-4xl font-bold text-orange-600" id="home-harvest-money">+100 ì½”ì¸</div>
            </div>

            <div class="text-gray-600 mb-6" id="home-harvest-message">
                ì‹ë¬¼ì„ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í™•í–ˆìŠµë‹ˆë‹¤!
            </div>

            <button onclick="closeHarvestModal()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-bold hover:from-green-600 hover:to-green-700 transition-all shadow-lg">
                í™•ì¸
            </button>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="home-toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div id="home-toast-message"></div>
    </div>

    <!-- í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="plant-system.js"></script>
    <script src="daily-reset.js"></script>
    <script src="weakness-learning.js"></script>

    <!-- ë©”ì¸ JavaScript -->
    <script>
        let currentUser = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì²« ë°©ë¬¸ ì²´í¬
            if (!checkFirstVisit()) return;

            // ë°ì´í„° ë¡œë“œ
            loadUserData();
            loadWeaknessQuestion();
            updateAllDisplays();

            // ì´ë²¤íŠ¸ ê¸°ë°˜ ì—…ë°ì´íŠ¸ ë“±ë¡
            setupEventListeners();

            // Firebase ë° ì•„ë°”íƒ€ ë¡œë“œ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                loadUserAvatarForDisplay();
                updateUserAvatar();
            }, 1000);
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // localStorage ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œì˜ ë³€ê²½)
            window.addEventListener('storage', function(e) {
                if (e.key === 'simpleFarmState' ||
                    e.key === 'plantSystemUser' ||
                    e.key === 'animalCollection' ||
                    e.key === 'quizProgress' ||
                    e.key === 'learningProgress') {
                    updateAllDisplays();
                }
            });

            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ë³µê·€ ì‹œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ í˜ì´ì§€ ë‹¤ë…€ì˜¨ í›„)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    loadUserData();
                    updateAllDisplays();
                }
            });

            // í˜ì´ì§€ë¡œ ëŒì•„ì˜¬ ë•Œ ì—…ë°ì´íŠ¸ (ë’¤ë¡œê°€ê¸° ë“±)
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    loadUserData();
                    updateAllDisplays();
                }
            });

            // plant-system.js ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë‹
            window.addEventListener('plantSystemUpdated', function() {
                updateDailyProgress();
                updatePlantStatus();
            });

            // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: í€´ì¦ˆ ì™„ë£Œ ì‹œ
            window.addEventListener('quizCompleted', function() {
                updateTickets();
                updateDailyProgress();
                updateStreak();
            });

            // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: ë™ë¬¼ íšë“ ì‹œ
            window.addEventListener('animalObtained', function() {
                updateAnimalCount();
                updateHighestAnimal();
            });
        }

        // ì²« ë°©ë¬¸ ì²´í¬
        function checkFirstVisit() {
            if (localStorage.getItem('eduPetOnboardingCompleted') !== 'true') {
                window.location.href = 'tutorial.html';
                return false;
            }
            return true;
        }

        // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        function loadUserData() {
            if (typeof plantSystem !== 'undefined') {
                currentUser = plantSystem.getUserData();
            }
        }

        // ëª¨ë“  ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateAllDisplays() {
            updateUserName();
            updateMoney();
            updateStreak();
            updateAnimalCount();
            updateDailyProgress();
            updateHighestAnimal();
            updatePlantStatus();
            updateTickets();
            updateWeaknessSubject();
            loadWeaknessQuestion();
            updateTodayActivity();
            updateWeeklyActivity();
        }

        // ì‚¬ìš©ì ì´ë¦„ ë° ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
        function updateUserName() {
            let userName = 'í•™ìŠµì';

            const localSettings = localStorage.getItem('eduPetSettings');
            if (localSettings) {
                try {
                    const settings = JSON.parse(localSettings);
                    if (settings.userName) userName = settings.userName;
                } catch (error) {}
            }

            const firebaseUser = localStorage.getItem('eduPetFirebaseUser');
            if (firebaseUser && userName === 'í•™ìŠµì') {
                try {
                    const userData = JSON.parse(firebaseUser);
                    if (userData.userData?.profile?.nickname) {
                        userName = userData.userData.profile.nickname;
                    }
                } catch (error) {}
            }

            document.getElementById('userNameDisplay').textContent = userName;

            // ì•„ë°”íƒ€ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
            updateUserAvatar();
        }

        // ì‚¬ìš©ì ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ (í—¤ë”)
        async function updateUserAvatar() {
            try {
                console.log('updateUserAvatar called');

                // Firebase ì²´í¬
                if (typeof firebase === 'undefined' || typeof firebase.database === 'undefined') {
                    console.log('Firebase not loaded yet for header avatar');
                    return;
                }

                const db = firebase.database();
                let uid = null;

                // eduPetAuthì—ì„œ uid ê°€ì ¸ì˜¤ê¸°
                if (typeof eduPetAuth !== 'undefined' && eduPetAuth.currentUser) {
                    uid = eduPetAuth.currentUser.uid;
                } else {
                    // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const firebaseUser = localStorage.getItem('eduPetFirebaseUser');
                    if (firebaseUser) {
                        try {
                            const userData = JSON.parse(firebaseUser);
                            uid = userData.userId || userData.uid;
                        } catch (e) {
                            console.error('localStorage parsing error:', e);
                        }
                    }
                }

                if (uid) {
                    const avatarSnapshot = await db.ref(`users/${uid}/profile/avatarAnimal`).once('value');
                    const avatarId = avatarSnapshot.val();

                    if (avatarId) {
                        const avatarEmoji = getAvatarEmoji(avatarId);
                        const avatarDisplay = document.getElementById('userAvatarDisplay');
                        if (avatarDisplay) {
                            avatarDisplay.textContent = avatarEmoji;
                            console.log('Avatar updated (í—¤ë”):', avatarEmoji);
                        }
                    }
                } else {
                    console.log('No user ID available for avatar update');
                }
            } catch (error) {
                console.error('ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ëˆ ì—…ë°ì´íŠ¸
        function updateMoney() {
            if (typeof plantSystem === 'undefined') {
                document.getElementById('moneyDisplay').textContent = '0 ì½”ì¸';
                return;
            }

            const user = plantSystem.getUserData();

            // wallet í•„ë“œê°€ ì—†ìœ¼ë©´ ìƒì„± (í•˜ìœ„ í˜¸í™˜ì„±)
            if (!user.wallet) {
                user.wallet = { money: 0, water: 0 };
                plantSystem.saveUserData(user);
            }

            const money = user.wallet.money || 0;
            document.getElementById('moneyDisplay').textContent = `${money.toLocaleString()} ì½”ì¸`;
        }

        // ì—°ì† í•™ìŠµì¼ ì—…ë°ì´íŠ¸
        function updateStreak() {
            const progressData = JSON.parse(localStorage.getItem('learningProgress') || '{}');
            const streakDays = progressData.streakDays || 0;
            document.getElementById('streakDisplay').textContent = streakDays + 'ì¼ì§¸';
        }

        // ë™ë¬¼ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateAnimalCount() {
            const animalState = JSON.parse(localStorage.getItem('animalCollection') || '{"collection": {}}');

            // collection ê°ì²´ì—ì„œ ê° ë™ë¬¼ì˜ countë¥¼ í•©ì‚°
            let totalCount = 0;
            if (animalState.collection) {
                Object.values(animalState.collection).forEach(animal => {
                    totalCount += animal.count || 0;
                });
            }

            document.getElementById('animalCountDisplay').textContent = totalCount + 'ë§ˆë¦¬';
        }

        // ì¼ì¼ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateDailyProgress() {
            if (typeof plantSystem === 'undefined') return;

            const user = plantSystem.getUserData();
            const completedSubjectIds = user?.daily?.completedSubjectIds || [];

            // production, ai, toeic ì œì™¸í•œ ê³¼ëª©ë§Œ ì¹´ìš´íŠ¸
            const excludedSubjects = ['production', 'ai', 'toeic'];
            const validCompletedSubjects = completedSubjectIds.filter(subject => !excludedSubjects.includes(subject));

            const completed = validCompletedSubjects.length;
            const total = 9; // english, math, science, korean, social, common, idiom, person, economy
            const percent = Math.round((completed / total) * 100);

            document.getElementById('dailyProgressDisplay').textContent = `${completed}/${total} ê³¼ëª©`;
            document.getElementById('progressPercentDisplay').textContent = `${percent}%`;
            document.getElementById('progressBarDisplay').style.width = `${percent}%`;
        }

        // ê°€ì¥ ë†’ì€ ë“±ê¸‰ ë™ë¬¼ í‘œì‹œ
        function updateHighestAnimal() {
            const animalState = JSON.parse(localStorage.getItem('animalCollection') || '{"animals": []}');
            const animals = animalState.animals || [];

            const rarityOrder = { 'legendary': 4, 'epic': 3, 'rare': 2, 'common': 1 };
            let highestAnimal = null;
            let highestRarity = 0;

            animals.forEach(animal => {
                const rarity = rarityOrder[animal.rarity] || 0;
                if (rarity > highestRarity) {
                    highestRarity = rarity;
                    highestAnimal = animal;
                }
            });

            // í”„ë¡œí•„ì—ì„œ ì„¤ì •í•œ ì•„ë°”íƒ€ í™•ì¸
            loadUserAvatarForDisplay();

            // ìµœê³  ë“±ê¸‰ ë™ë¬¼ë„ í‘œì‹œ (í•˜ìœ„ í˜¸í™˜)
            if (highestAnimal) {
                document.getElementById('topAnimalDisplay').textContent = highestAnimal.emoji || 'ğŸ¦';
                document.getElementById('topAnimalName').textContent = highestAnimal.name || 'ë™ë¬¼';
            }
        }

        // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì•„ë°”íƒ€ë¥¼ ë¡œë“œí•˜ì—¬ í‘œì‹œ
        async function loadUserAvatarForDisplay() {
            try {
                console.log('loadUserAvatarForDisplay called');

                // Firebase ì²´í¬
                if (typeof firebase === 'undefined' || typeof firebase.database === 'undefined') {
                    console.log('Firebase not loaded yet');
                    return;
                }

                const db = firebase.database();

                // eduPetAuth ì²´í¬
                if (typeof eduPetAuth === 'undefined') {
                    console.log('eduPetAuth not available, trying to get user from localStorage');

                    // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const firebaseUser = localStorage.getItem('eduPetFirebaseUser');
                    if (firebaseUser) {
                        try {
                            const userData = JSON.parse(firebaseUser);
                            const uid = userData.userId || userData.uid;

                            if (uid) {
                                const avatarSnapshot = await db.ref(`users/${uid}/profile/avatarAnimal`).once('value');
                                const avatarId = avatarSnapshot.val();

                                if (avatarId) {
                                    const avatarEmoji = getAvatarEmoji(avatarId);
                                    const displayElement = document.getElementById('highestAnimalDisplay');
                                    if (displayElement) {
                                        displayElement.textContent = avatarEmoji;
                                        console.log('Avatar updated (ì˜¤ëŠ˜ì˜ í•™ìŠµ):', avatarEmoji);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('localStorage parsing error:', e);
                        }
                    }
                    return;
                }

                // eduPetAuth ì‚¬ìš©
                if (eduPetAuth.currentUser) {
                    const avatarSnapshot = await db.ref(`users/${eduPetAuth.currentUser.uid}/profile/avatarAnimal`).once('value');
                    const avatarId = avatarSnapshot.val();

                    if (avatarId) {
                        const avatarEmoji = getAvatarEmoji(avatarId);
                        const displayElement = document.getElementById('highestAnimalDisplay');
                        if (displayElement) {
                            displayElement.textContent = avatarEmoji;
                            console.log('Avatar updated (ì˜¤ëŠ˜ì˜ í•™ìŠµ):', avatarEmoji);
                        }
                    }
                } else {
                    console.log('No current user');
                }
            } catch (error) {
                console.error('ì•„ë°”íƒ€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì•„ë°”íƒ€ IDë¥¼ ì´ëª¨ì§€ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function getAvatarEmoji(avatarId) {
            const avatarMap = {
                'bunny': 'ğŸ°', 'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'fox': 'ğŸ¦Š',
                'lion': 'ğŸ¦', 'tiger': 'ğŸ…', 'bear': 'ğŸ»', 'panda': 'ğŸ¼',
                'koala': 'ğŸ¨', 'monkey': 'ğŸµ', 'elephant': 'ğŸ˜', 'giraffe': 'ğŸ¦’',
                'zebra': 'ğŸ¦“', 'horse': 'ğŸ', 'cow': 'ğŸ„', 'pig': 'ğŸ·',
                'sheep': 'ğŸ‘', 'chicken': 'ğŸ”', 'penguin': 'ğŸ§', 'owl': 'ğŸ¦‰'
            };
            return avatarMap[avatarId] || 'ğŸ°';
        }

        // ì‹ë¬¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë†ì¥ í™”ë¶„)
        function updatePlantStatus() {
            if (typeof plantSystem === 'undefined') {
                console.warn('plantSystem not loaded');
                return;
            }

            try {
                const user = plantSystem.getUserData();
                const plants = plantSystem.getUserPlants(user.userId);
                const dashboard = plantSystem.getDashboardState(user.userId);

                // ì„±ì¥ê¶Œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                document.getElementById('farm-growth-tickets').textContent = dashboard.tickets.growthTickets + 'ê°œ';

                // ë‹¤ìŒ ë³´ìƒ ë©”ì‹œì§€
                document.getElementById('farm-next-reward').textContent = dashboard.learning.nextReward.message;

                // ê° í™”ë¶„ ë Œë”ë§
                [1, 2].forEach(potNum => {
                    renderHomePot(potNum, plants, dashboard);
                });

            } catch (error) {
                console.error('ë†ì¥ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // í™ˆ í™”ë©´ í™”ë¶„ ë Œë”ë§
        function renderHomePot(potNum, allPlants, dashboard) {
            const plant = dashboard.plants[potNum - 1] || null;

            const emptyElement = document.getElementById(`home-empty-pot${potNum}`);
            const plantDisplay = document.getElementById(`home-plant${potNum}-display`);
            const plantInfo = document.getElementById(`home-plant${potNum}-info`);
            const actions = document.getElementById(`home-pot${potNum}-actions`);
            const potElement = document.getElementById(`home-pot${potNum}`);

            if (!plant) {
                // ë¹ˆ í™”ë¶„
                emptyElement.classList.remove('hidden');
                plantDisplay.innerHTML = '';
                plantInfo.classList.add('hidden');
                potElement.onclick = () => homePlantSeed(potNum);
                actions.innerHTML = `
                    <button onclick="homePlantSeed(${potNum})" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg text-xs hover:bg-green-600 transition-all">
                        ğŸŒ° ì”¨ì•— ì‹¬ê¸°
                    </button>
                `;
            } else {
                // ì‹ë¬¼ì´ ìˆëŠ” í™”ë¶„
                emptyElement.classList.add('hidden');
                plantInfo.classList.remove('hidden');

                const plantEmoji = plant.type || 'ğŸŒ±';
                plantDisplay.innerHTML = `<div class="text-5xl">${plantEmoji}</div>`;

                // í´ë¦­ ì´ë²¤íŠ¸
                if (plant.status === 'PLANTED') {
                    potElement.onclick = () => homeWaterPlant(potNum, plant.id);
                } else {
                    potElement.onclick = null;
                }

                // ìƒíƒœ í…ìŠ¤íŠ¸
                const statusText = {
                    'PLANTED': 'ğŸŒ± ì„±ì¥ ì¤‘',
                    'READY': 'âœ¨ ì„±ì¥ ì¤€ë¹„ ì™„ë£Œ',
                    'GROWN': 'ğŸŒº ì„±ì¥ ì™„ë£Œ'
                }[plant.status];
                document.getElementById(`home-plant${potNum}-status`).textContent = statusText;

                // ë¬¼ ì •ë³´ - ëª¨ë“  ë‹¨ê³„ì—ì„œ 5ë²ˆì”© ë¬¼ì£¼ê¸°
                const maxWater = 5;
                const waterPercent = (plant.waterCount / maxWater) * 100;
                document.getElementById(`home-plant${potNum}-water`).textContent = `${plant.waterCount}/${maxWater}`;
                document.getElementById(`home-plant${potNum}-water-bar`).style.width = waterPercent + '%';

                // ì‹œê°„ ì •ë³´
                document.getElementById(`home-plant${potNum}-time`).textContent = `â° ${plant.timeRemaining}`;

                // ë²„íŠ¼
                if (plant.status === 'READY') {
                    actions.innerHTML = `
                        <button onclick="homeGrowPlant('${plant.id}')" class="w-full px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-xs font-bold hover:from-green-600 hover:to-green-700 transition-all">
                            ğŸŒ± ì„±ì¥ì‹œí‚¤ê¸°
                        </button>
                    `;
                } else if (plant.status === 'PLANTED') {
                    actions.innerHTML = `
                        <button onclick="homeWaterPlant(${potNum}, '${plant.id}')" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg text-xs font-bold hover:bg-blue-600 transition-all">
                            ğŸ’§ ë¬¼ì£¼ê¸° (${plant.waterCount}/${maxWater})
                        </button>
                    `;
                } else {
                    actions.innerHTML = `
                        <button onclick="homeHarvestPlant('${plant.id}')" class="w-full px-3 py-2 bg-yellow-500 text-white rounded-lg text-xs font-bold hover:bg-yellow-600 transition-all">
                            ğŸŒº ìˆ˜í™•í•˜ê¸°
                        </button>
                    `;
                }
            }
        }

        // í‹°ì¼“ ì—…ë°ì´íŠ¸
        function updateTickets() {
            let normalTickets = 0;
            let premiumTickets = 0;

            // plant-systemì—ì„œ í‹°ì¼“ ì •ë³´ ì½ê¸°
            if (typeof plantSystem !== 'undefined') {
                const user = plantSystem.getUserData();
                normalTickets = user?.rewards?.normalGachaTickets || 0;
                premiumTickets = user?.rewards?.premiumGachaTickets || 0;
            } else {
                // plantSystemì´ ì—†ìœ¼ë©´ localStorageì—ì„œ ì§ì ‘ ì½ê¸°
                try {
                    const userData = JSON.parse(localStorage.getItem('plantSystemUser') || '{}');
                    normalTickets = userData?.rewards?.normalGachaTickets || 0;
                    premiumTickets = userData?.rewards?.premiumGachaTickets || 0;
                } catch (e) {
                    console.error('Error reading tickets:', e);
                }
            }

            document.getElementById('ticketCount').textContent = normalTickets + premiumTickets;
            document.getElementById('normalTickets').textContent = normalTickets + 'ì¥';
            document.getElementById('premiumTickets').textContent = premiumTickets + 'ì¥';
        }

        // ì•½ì  ê³¼ëª© ì—…ë°ì´íŠ¸
        function updateWeaknessSubject() {
            if (typeof weaknessLearning === 'undefined' || typeof plantSystem === 'undefined') return;

            const user = plantSystem.getUserData();
            // ë²„íŠ¼ìš©: ì˜ì–´ í¬í•¨
            const weakestSubject = weaknessLearning.analyzeWeakestArea(user, false);

            console.log('ğŸ¯ ì•½ì  ê³¼ëª© ë¶„ì„ ê²°ê³¼:', weakestSubject);
            console.log('ğŸ“Š ê³¼ëª©ë³„ ì ìˆ˜:', user.learning.subjectScores);

            const subjectIcons = {
                'ì˜ì–´': 'ğŸ‡ºğŸ‡¸',
                'ìˆ˜í•™': 'ğŸ”¢',
                'ê³¼í•™': 'ğŸ”¬',
                'êµ­ì–´': 'ğŸ“š',
                'ì‚¬íšŒ': 'ğŸ›ï¸',
                'ìƒì‹': 'ğŸ§ ',
                'ì‚¬ìì„±ì–´': 'ğŸ“œ',
                'ì¸ë¬¼': 'ğŸ‘¤',
                'ê²½ì œ': 'ğŸ’°'
            };

            const subjectIds = {
                'ì˜ì–´': 'english',
                'ìˆ˜í•™': 'math',
                'ê³¼í•™': 'science',
                'êµ­ì–´': 'korean',
                'ì‚¬íšŒ': 'social',
                'ìƒì‹': 'common',
                'ì‚¬ìì„±ì–´': 'idiom',
                'ì¸ë¬¼': 'person',
                'ê²½ì œ': 'economy'
            };

            document.getElementById('weaknessIcon').textContent = subjectIcons[weakestSubject] || 'ğŸ“Š';
            document.getElementById('weaknessLabel').textContent = weakestSubject || 'ì•½í•œê³¼ëª©';

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
            window.currentWeakestSubject = subjectIds[weakestSubject] || 'math';
            window.currentWeakestSubjectName = weakestSubject;
        }

        // ì•½ì  ë¬¸ì œ ë¡œë“œ
        async function loadWeaknessQuestion() {
            if (typeof weaknessLearning === 'undefined' || typeof plantSystem === 'undefined') return;

            const user = plantSystem.getUserData();
            // ì˜¤ëŠ˜ì˜ í•™ìŠµìš©: ì˜ì–´ ì œì™¸ (ì˜ì–´ëŠ” ì´ë¯¸ í•„ìˆ˜ ê³¼ëª©)
            const weakestSubjectName = weaknessLearning.analyzeWeakestArea(user, true);

            // í•œê¸€ ê³¼ëª©ëª…ì„ ì˜ì–´ IDë¡œ ë³€í™˜
            const subjectIds = {
                'ì˜ì–´': 'english',
                'ìˆ˜í•™': 'math',
                'ê³¼í•™': 'science',
                'êµ­ì–´': 'korean',
                'ì‚¬íšŒ': 'social',
                'ìƒì‹': 'common',
                'ì‚¬ìì„±ì–´': 'idiom',
                'ì¸ë¬¼': 'person',
                'ê²½ì œ': 'economy'
            };

            const subjectId = subjectIds[weakestSubjectName] || 'math';

            // ì‹¤ì œ ë¬¸ì œ ì€í–‰ì—ì„œ ë¬¸ì œ ë¡œë“œ
            const question = await weaknessLearning.getRandomQuestionFromBank(subjectId, 'medium');

            if (question) {
                const subjectIcons = {
                    'ì˜ì–´': 'ğŸ‡ºğŸ‡¸',
                    'ìˆ˜í•™': 'ğŸ”¢',
                    'ê³¼í•™': 'ğŸ”¬',
                    'êµ­ì–´': 'ğŸ“š',
                    'ì‚¬íšŒ': 'ğŸ›ï¸',
                    'ìƒì‹': 'ğŸ§ ',
                    'ì‚¬ìì„±ì–´': 'ğŸ“œ',
                    'ì¸ë¬¼': 'ğŸ‘¤',
                    'ê²½ì œ': 'ğŸ’°'
                };

                document.getElementById('weaknessSubjectIcon').textContent = subjectIcons[weakestSubjectName] || 'ğŸ“š';
                document.getElementById('weaknessSubjectName').textContent = weakestSubjectName || 'ê³¼ëª©';
                document.getElementById('weaknessQuestion').textContent = question.q || 'ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

                const correctAnswer = question.a?.[question.correct];
                document.getElementById('weaknessAnswer').textContent = correctAnswer || 'ì •ë‹µ';
                document.getElementById('weaknessExplanation').textContent = question.explanation || 'ì´ ë¬¸ì œë¥¼ ì˜ ê¸°ì–µí•˜ê³  ì´í•´í•´ë³´ì„¸ìš”!';

                console.log('âœ… ì•½ì  ë¬¸ì œ ë¡œë“œ ì™„ë£Œ:', {
                    ê³¼ëª©: weakestSubjectName,
                    ë¬¸ì œ: question.q,
                    ì •ë‹µ: correctAnswer
                });
            }
        }

        // ìƒˆ ì•½ì  ë¬¸ì œ ë¡œë“œ
        function loadNewWeaknessQuestion() {
            loadWeaknessQuestion();
        }

        // ë¹ ë¥¸ í€´ì¦ˆ ì‹œì‘
        function startQuickQuiz(subject) {
            localStorage.setItem('selectedSubjects', JSON.stringify([subject]));
            localStorage.setItem('currentSubjectIndex', '0');
            window.location.href = 'quiz-adaptive.html';
        }

        // ì•½ì  í€´ì¦ˆ ì‹œì‘
        function startWeaknessQuiz() {
            if (typeof weaknessLearning === 'undefined' || typeof plantSystem === 'undefined') {
                alert('ì•½ì  í•™ìŠµ ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const user = plantSystem.getUserData();
            // í€´ì¦ˆ ì‹œì‘ìš©: ì˜ì–´ í¬í•¨
            const weakestSubjectName = weaknessLearning.analyzeWeakestArea(user, false);

            // í•œê¸€ ê³¼ëª©ëª…ì„ ì˜ì–´ IDë¡œ ë³€í™˜
            const subjectIds = {
                'ì˜ì–´': 'english',
                'ìˆ˜í•™': 'math',
                'ê³¼í•™': 'science',
                'êµ­ì–´': 'korean',
                'ì‚¬íšŒ': 'social',
                'ìƒì‹': 'common',
                'ì‚¬ìì„±ì–´': 'idiom',
                'ì¸ë¬¼': 'person',
                'ê²½ì œ': 'economy'
            };

            const weakestSubjectId = subjectIds[weakestSubjectName] || 'math';
            startQuickQuiz(weakestSubjectId);
        }

        // íŠœí† ë¦¬ì–¼ ë‹¤ì‹œ ë³´ê¸°
        function restartTutorial() {
            if (confirm('íŠœí† ë¦¬ì–¼ì„ ë‹¤ì‹œ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(í˜„ì¬ ê²Œì„ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
                localStorage.removeItem('eduPetOnboardingCompleted');
                window.location.href = 'tutorial.html';
            }
        }

        // ì˜¤ëŠ˜ì˜ í•™ìŠµ í˜„í™© ì—…ë°ì´íŠ¸
        function updateTodayActivity() {
            try {
                const userData = JSON.parse(localStorage.getItem('plantSystemUser') || '{}');
                const learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');

                // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸ (ISO format: YYYY-MM-DD)
                const today = new Date().toISOString().split('T')[0];

                // ì˜¤ëŠ˜ í‘¼ ë¬¸ì œ ìˆ˜ì™€ í•™ìŠµ ì‹œê°„ ê³„ì‚°
                let todayQuestions = 0;
                let todayCorrect = 0;
                let todayMinutes = 0;

                // dailyActivityì—ì„œ ì˜¤ëŠ˜ í‘¼ ë¬¸ì œ ìˆ˜ í™•ì¸
                if (learningProgress.dailyActivity && learningProgress.dailyActivity[today]) {
                    todayQuestions = learningProgress.dailyActivity[today];
                }

                // totalMinutesTodayê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                if (learningProgress.totalMinutesToday && learningProgress.lastActivityDate === today) {
                    todayMinutes = learningProgress.totalMinutesToday;
                } else {
                    // ì—†ìœ¼ë©´ ë¬¸ì œ ìˆ˜ë¡œ ì¶”ì • (ë¬¸ì œë‹¹ ì•½ 10ì´ˆ = 60ë¬¸ì œë‹¹ 10ë¶„)
                    todayMinutes = Math.ceil(todayQuestions * 10 / 60);
                }

                // ì˜¤ëŠ˜ ì •ë‹µ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                if (learningProgress.totalCorrectToday && learningProgress.lastActivityDate === today) {
                    todayCorrect = learningProgress.totalCorrectToday;
                }

                // ì •ë‹µë¥  ê³„ì‚°
                const accuracy = todayQuestions > 0 ? Math.round((todayCorrect / todayQuestions) * 100) : 0;

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('todayQuestions').textContent = todayQuestions;
                document.getElementById('todayAccuracy').textContent = accuracy;
                document.getElementById('todayMinutes').textContent = todayMinutes;

            } catch (e) {
                console.error('ì˜¤ëŠ˜ í™œë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
                document.getElementById('todayQuestions').textContent = '0';
                document.getElementById('todayAccuracy').textContent = '0';
                document.getElementById('todayMinutes').textContent = '0';
            }
        }

        // ===== ë†ì¥ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ =====

        let homeCurrentPlantId = null;
        let homeCountdownInterval = null;

        // ì”¨ì•— ì‹¬ê¸°
        function homePlantSeed(potNum) {
            try {
                if (!currentUser) {
                    homeShowToast('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤');
                    return;
                }

                const plants = plantSystem.getUserPlants(currentUser.userId);
                const existingPlant = plants[potNum - 1];

                if (existingPlant) {
                    homeShowToast('âŒ ì´ë¯¸ ì‹ë¬¼ì´ ì‹¬ì–´ì ¸ ìˆìŠµë‹ˆë‹¤');
                    return;
                }

                const plant = plantSystem.plantSeed(currentUser.userId);
                homeShowToast('ğŸŒ° ì”¨ì•—ì„ ì‹¬ì—ˆìŠµë‹ˆë‹¤!');
                updatePlantStatus();
            } catch (error) {
                console.error('ì”¨ì•— ì‹¬ê¸° ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì”¨ì•— ì‹¬ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ë¬¼ì£¼ê¸°
        async function homeWaterPlant(potNum, plantId) {
            try {
                if (!currentUser) {
                    homeShowToast('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤');
                    return;
                }

                homeCurrentPlantId = plantId;

                const questionData = await weaknessLearning.generateWaterQuestion(currentUser, plantId);

                if (!questionData.success) {
                    homeShowToast('âŒ ' + questionData.message);
                    return;
                }

                window.homeCurrentQuestionSubject = questionData.subjectName;

                const subjectIcons = {
                    'math': 'ğŸ”¢', 'korean': 'ğŸ“š', 'english': 'ğŸ”¤',
                    'science': 'ğŸ”¬', 'social': 'ğŸŒ', 'common': 'ğŸ§ ',
                    'idiom': 'ğŸ“œ', 'person': 'ğŸ‘¤', 'economy': 'ğŸ’°'
                };

                document.getElementById('home-question-subject-icon').textContent = subjectIcons[questionData.subjectId] || 'ğŸ“š';
                document.getElementById('home-question-title').textContent = questionData.subjectName + ' í•™ìŠµ';
                document.getElementById('home-question-text').textContent = questionData.question.q;

                const correctAnswer = questionData.question.a[questionData.question.correct];
                document.getElementById('home-correct-answer').textContent = `${questionData.question.correct + 1}. ${correctAnswer}`;

                const explanation = questionData.question.explanation || 'ì´ ë¬¸ì œë¥¼ ì˜ ê¸°ì–µí•˜ê³  ì´í•´í•´ë³´ì„¸ìš”!';
                document.getElementById('home-explanation-text').textContent = explanation;

                const waterBtn = document.getElementById('home-water-confirm-btn');
                const waterBtnText = document.getElementById('home-water-btn-text');
                if (waterBtn) {
                    waterBtn.disabled = true;
                    waterBtn.className = 'w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all';
                }
                if (waterBtnText) {
                    waterBtnText.innerHTML = 'ğŸ’§ ë¬¸ì œë¥¼ ì½ì–´ì£¼ì„¸ìš” (<span id="home-countdown">3</span>ì´ˆ)';
                }

                document.getElementById('home-watering-modal').classList.remove('hidden');

                setTimeout(() => {
                    homeStartCountdown();
                }, 100);

            } catch (error) {
                console.error('ë¬¼ì£¼ê¸° ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ë¬¼ì£¼ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´
        function homeStartCountdown() {
            const btn = document.getElementById('home-water-confirm-btn');
            const countdownSpan = document.getElementById('home-countdown');
            const btnText = document.getElementById('home-water-btn-text');

            if (!btn || !countdownSpan || !btnText) return;

            let timeLeft = 3;

            btn.disabled = true;
            btn.className = 'w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed transition-all';
            countdownSpan.textContent = timeLeft;

            if (homeCountdownInterval) {
                clearInterval(homeCountdownInterval);
            }

            homeCountdownInterval = setInterval(() => {
                timeLeft--;

                if (!countdownSpan) {
                    clearInterval(homeCountdownInterval);
                    homeCountdownInterval = null;
                    return;
                }

                countdownSpan.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(homeCountdownInterval);
                    homeCountdownInterval = null;

                    if (btn) {
                        btn.disabled = false;
                        btn.className = 'w-full px-4 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-all';
                    }
                    if (btnText) {
                        btnText.innerHTML = 'ğŸ’§ ì´í•´í–ˆì–´ìš”! ë¬¼ì£¼ê¸°';
                    }
                }
            }, 1000);
        }

        // ë¬¼ì£¼ê¸° í™•ì¸
        function homeConfirmWater() {
            // ë¬¼ì£¼ê¸° ì „ ì‹ë¬¼ ìƒíƒœ ì €ì¥
            const plantBefore = plantSystem.getPlant(homeCurrentPlantId);
            const stageBefore = plantBefore ? plantBefore.stage : 0;

            const result = plantSystem.waterPlant(homeCurrentPlantId);

            if (result.success) {
                // ë¬¼ì£¼ê¸° í›„ ì‹ë¬¼ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                const plantAfter = plantSystem.getPlant(homeCurrentPlantId);
                const stageAfter = plantAfter ? plantAfter.stage : 0;

                // ìŠ¤í…Œì´ì§€ ë³€ê²½ ì²´í¬
                if (result.stageChanged || stageAfter > stageBefore) {
                    // ì¶•í•˜ ëª¨ë‹¬ í‘œì‹œ
                    homeCloseWateringModal();
                    homeShowCelebrationModal(plantAfter);
                } else {
                    // ëª¨ë“  ë‹¨ê³„ì—ì„œ 5ë²ˆì”© ë¬¼ì£¼ê¸°
                    const maxWater = 5;
                    homeShowToast(`âœ… í•™ìŠµ ì™„ë£Œ! ë¬¼ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤ (${result.waterCount}/${maxWater})`);
                    homeCloseWateringModal();
                }

                updatePlantStatus();

                if (window.homeCurrentQuestionSubject) {
                    weaknessLearning.updateLearningProgress(currentUser, window.homeCurrentQuestionSubject, true);
                }

                // Firebase ë™ê¸°í™” (ì„ íƒì )
                if (typeof plantSystemFirebase !== 'undefined' && plantSystemFirebase.savePlantSystemState) {
                    plantSystemFirebase.savePlantSystemState();
                }
            } else {
                homeShowToast('âŒ ' + result.message);
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function homeCloseWateringModal() {
            if (homeCountdownInterval) {
                clearInterval(homeCountdownInterval);
                homeCountdownInterval = null;
            }
            document.getElementById('home-watering-modal').classList.add('hidden');
            homeCurrentPlantId = null;
        }

        // ì„±ì¥ì‹œí‚¤ê¸°
        function homeGrowPlant(plantId) {
            try {
                if (!currentUser) {
                    homeShowToast('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤');
                    return;
                }

                // ì„±ì¥ ì „ ì‹ë¬¼ ìƒíƒœ ì €ì¥
                const plantBefore = plantSystem.getPlant(plantId);
                const stageBefore = plantBefore ? plantBefore.stage : 0;

                const result = plantSystem.growPlant(currentUser, plantId);

                if (result.success) {
                    // ì„±ì¥ í›„ ì‹ë¬¼ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
                    const plantAfter = plantSystem.getPlant(plantId);
                    const stageAfter = plantAfter ? plantAfter.stage : 0;

                    // ìŠ¤í…Œì´ì§€ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì¶•í•˜ ëª¨ë‹¬ í‘œì‹œ
                    if (stageAfter > stageBefore) {
                        homeShowCelebrationModal(plantAfter);
                    } else {
                        homeShowToast('ğŸ‰ ' + result.message);
                    }

                    // Firebase ë™ê¸°í™” (ì„ íƒì )
                    if (typeof plantSystemFirebase !== 'undefined' && plantSystemFirebase.syncPlantGrowth) {
                        plantSystemFirebase.syncPlantGrowth({plantId});
                    }

                    updatePlantStatus();
                } else {
                    homeShowToast('âŒ ' + result.message);
                }
            } catch (error) {
                console.error('ì„±ì¥ ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì„±ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ìˆ˜í™•í•˜ê¸°
        function homeHarvestPlant(plantId) {
            try {
                if (!currentUser) {
                    homeShowToast('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤');
                    return;
                }

                const result = plantSystem.harvestPlant(plantId);

                if (result.success) {
                    // ë³´ìƒ íŒì—… í‘œì‹œ
                    showHarvestModal(result.moneyEarned || 100);

                    // Firebase ë™ê¸°í™” (ì„ íƒì )
                    if (typeof plantSystemFirebase !== 'undefined' && plantSystemFirebase.savePlantSystemState) {
                        plantSystemFirebase.savePlantSystemState();
                    }

                    updatePlantStatus();
                    updateMoney();
                } else {
                    homeShowToast('âŒ ' + result.message);
                }
            } catch (error) {
                console.error('ìˆ˜í™• ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ìˆ˜í™• ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ìˆ˜í™• ë³´ìƒ ëª¨ë‹¬ í‘œì‹œ
        function showHarvestModal(moneyEarned) {
            const modal = document.getElementById('home-harvest-modal');
            const content = document.getElementById('home-harvest-content');
            const moneyDisplay = document.getElementById('home-harvest-money');

            moneyDisplay.textContent = `+${moneyEarned.toLocaleString()} ì½”ì¸`;

            modal.classList.remove('hidden');
            content.classList.add('harvest-modal-show');

            // ì½”ì¸ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
            setTimeout(() => {
                const coinIcon = modal.querySelector('.text-6xl');
                if (coinIcon) {
                    coinIcon.classList.add('coin-bounce');
                }
            }, 200);
        }

        // ìˆ˜í™• ëª¨ë‹¬ ë‹«ê¸°
        function closeHarvestModal() {
            const modal = document.getElementById('home-harvest-modal');
            const content = document.getElementById('home-harvest-content');

            content.classList.remove('harvest-modal-show');
            modal.classList.add('hidden');

            // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°
            const coinIcon = modal.querySelector('.text-6xl');
            if (coinIcon) {
                coinIcon.classList.remove('coin-bounce');
            }
        }

        // ì¶•í•˜ ëª¨ë‹¬ í‘œì‹œ
        function homeShowCelebrationModal(plant) {
            const stageEmojis = ['ğŸŒ°', 'ğŸŒ±', 'ğŸŒ¿', 'ğŸŒ¸', 'ğŸ'];
            const stageNames = ['ì”¨ì•—', 'ìƒˆì‹¹', 'ì„±ì¥', 'ê°œí™”', 'ì—´ë§¤'];

            const currentStage = plant.stage || 0;
            const previousStage = Math.max(0, currentStage - 1);

            // ì´ëª¨ì§€ ë° íƒ€ì´í‹€ ì„¤ì •
            document.getElementById('home-celebration-emoji').textContent = stageEmojis[currentStage];
            document.getElementById('home-celebration-title').textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰';
            document.getElementById('home-celebration-message').textContent =
                `ì‹ë¬¼ì´ ${stageNames[currentStage]} ë‹¨ê³„ë¡œ ì„±ì¥í–ˆìŠµë‹ˆë‹¤!`;

            // ì´ì „/í˜„ì¬ ë‹¨ê³„ í‘œì‹œ
            document.getElementById('home-celebration-before').textContent = stageEmojis[previousStage];
            document.getElementById('home-celebration-after').textContent = stageEmojis[currentStage];

            // ì§„í–‰ë¥  í‘œì‹œ (ëª¨ë“  ë‹¨ê³„)
            const stagesContainer = document.getElementById('home-celebration-stages');
            stagesContainer.innerHTML = stageEmojis.map((emoji, idx) => {
                const opacity = idx <= currentStage ? 'opacity-100' : 'opacity-30';
                const scale = idx === currentStage ? 'text-2xl' : 'text-xl';
                return `<span class="${opacity} ${scale} transition-all">${emoji}</span>`;
            }).join('');

            document.getElementById('home-celebration-progress').textContent =
                `${currentStage + 1} / ${stageEmojis.length} ë‹¨ê³„`;

            // ë‹¤ìŒ ëª©í‘œ ì„¤ì • - ëª¨ë“  ë‹¨ê³„ì—ì„œ 5ë²ˆì”©
            if (currentStage < 4) {
                const nextWater = 5 - (plant.waterCount || 0);
                document.getElementById('home-celebration-next-goal').textContent =
                    `${stageNames[currentStage + 1]} ë‹¨ê³„ê¹Œì§€ ë¬¼ ${nextWater}ê°œ ë” ì£¼ê¸°`;
            } else {
                document.getElementById('home-celebration-next-goal').textContent = 'ìˆ˜í™• ê°€ëŠ¥! ğŸ‰';
            }

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('home-celebration-modal').classList.remove('hidden');

            // ì»¨í˜í‹° ìƒì„±
            homeCreateConfetti();

            // ì‚¬ìš´ë“œ íš¨ê³¼
            homePlaySuccessSound();
        }

        // ì¶•í•˜ ëª¨ë‹¬ ë‹«ê¸°
        function homeCloseCelebrationModal() {
            document.getElementById('home-celebration-modal').classList.add('hidden');
            document.getElementById('home-confetti-container').innerHTML = '';
        }

        // ì»¨í˜í‹° ì• ë‹ˆë©”ì´ì…˜ ìƒì„±
        function homeCreateConfetti() {
            const container = document.getElementById('home-confetti-container');
            container.innerHTML = '';

            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];
            const emojis = ['â­', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’–', 'ğŸŠ', 'ğŸ‰'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';

                if (Math.random() > 0.5) {
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                } else {
                    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    confetti.style.fontSize = '20px';
                }

                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';

                container.appendChild(confetti);

                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // ì„±ê³µ ì‚¬ìš´ë“œ
        function homePlaySuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                let startTime = audioContext.currentTime;

                notes.forEach((freq, idx) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.2);

                    startTime += 0.15;
                });
            } catch (e) {
                console.log('ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨');
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function homeShowToast(message) {
            const toast = document.getElementById('home-toast');
            document.getElementById('home-toast-message').textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ===== ê°œë°œì ë©”ë‰´ í•¨ìˆ˜ë“¤ =====

        function showHomeFarmDevMenu() {
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ìš”êµ¬
            const password = prompt('ê°œë°œì ëª¨ë“œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (password !== '8253') {
                homeShowToast('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            document.getElementById('home-dev-menu-modal').classList.remove('hidden');
        }

        function closeHomeFarmDevMenu() {
            document.getElementById('home-dev-menu-modal').classList.add('hidden');
        }

        // ì‹ë¬¼ ì‹œê°„ ê±´ë„ˆë›°ê¸°
        function homeSkipPlantTime() {
            try {
                const plants = plantSystem.getAllPlants();
                let updated = 0;

                Object.values(plants).forEach(plant => {
                    if (plant.status === 'PLANTED') {
                        plant.plantedAt = plantSystem.getCurrentTimestamp() - (25 * 60 * 60 * 1000);
                        plantSystem.savePlant(plant);
                        plantSystem.checkReadyStatus(plant);
                        plantSystem.savePlant(plant);
                        updated++;
                    }
                });

                homeShowToast(`âœ… ${updated}ê°œ ì‹ë¬¼ì˜ ì‹œê°„ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤`);
                closeHomeFarmDevMenu();
                updatePlantStatus();
            } catch (error) {
                console.error('ì‹œê°„ ê±´ë„ˆë›°ê¸° ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì‹œê°„ ê±´ë„ˆë›°ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í…ŒìŠ¤íŠ¸ ì„±ì¥ê¶Œ ì¶”ê°€
        function homeAddTestTickets() {
            try {
                const user = plantSystem.getUserData();
                const currentTime = plantSystem.getCurrentTimestamp();
                const expiresAt = currentTime + (24 * 60 * 60 * 1000);

                for (let i = 0; i < 5; i++) {
                    user.rewards.growthTickets.push({
                        ticketId: plantSystem.generateUUID(),
                        issuedAt: currentTime,
                        expiresAt: expiresAt
                    });
                }

                plantSystem.saveUserData(user);
                homeShowToast('âœ… ì„±ì¥ê¶Œ 5ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                closeHomeFarmDevMenu();
                updatePlantStatus();
            } catch (error) {
                console.error('ì„±ì¥ê¶Œ ì¶”ê°€ ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì„±ì¥ê¶Œ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì‹ë¬¼ë§Œ ì´ˆê¸°í™”
        function homeResetPlants() {
            if (!confirm('ëª¨ë“  ì‹ë¬¼ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                localStorage.removeItem('plantSystemPlants');
                homeShowToast('âœ… ì‹ë¬¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                closeHomeFarmDevMenu();
                updatePlantStatus();
            } catch (error) {
                console.error('ì‹ë¬¼ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì‹ë¬¼ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¼ì¼ ì§„í–‰ë¥  ì´ˆê¸°í™”
        function homeResetDaily() {
            if (!confirm('ì¼ì¼ ì§„í–‰ë¥ ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const user = plantSystem.getUserData();
                user.daily.completedSubjects = 0;
                user.daily.completedSubjectIds = [];
                user.daily.lastResetDate = plantSystem.getCurrentDate();
                plantSystem.saveUserData(user);

                homeShowToast('âœ… ì¼ì¼ ì§„í–‰ë¥ ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                closeHomeFarmDevMenu();
                updateAllDisplays();
            } catch (error) {
                console.error('ì¼ì¼ ì§„í–‰ë¥  ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ì¼ì¼ ì§„í–‰ë¥  ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì‹ë¬¼ì— ë¬¼ ì¶”ê°€
        function homeAddWaterToPlant() {
            try {
                const user = plantSystem.getUserData();
                const plants = plantSystem.getUserPlants(user.userId);

                if (plants.length === 0) {
                    homeShowToast('âŒ ì‹¬ì–´ì§„ ì‹ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                const firstPlant = plants[0];
                const plantData = plantSystem.getPlantById(firstPlant.plantId);

                if (!plantData) {
                    homeShowToast('âŒ ì‹ë¬¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                const maxWater = 5;
                plantData.waterCount = Math.min(plantData.waterCount + 10, maxWater);
                plantSystem.savePlant(plantData);

                homeShowToast(`âœ… ì‹ë¬¼ì— ë¬¼ 10ê°œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤ (í˜„ì¬: ${plantData.waterCount}/${maxWater})`);
                closeHomeFarmDevMenu();
                updatePlantStatus();
            } catch (error) {
                console.error('ë¬¼ ì¶”ê°€ ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ë¬¼ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ìˆ˜í™• íŒì—… í…ŒìŠ¤íŠ¸
        function homeTestHarvestPopup() {
            closeHomeFarmDevMenu();
            showHarvestModal(100);
        }

        // í…ŒìŠ¤íŠ¸ ëˆ ì¶”ê°€
        function homeAddTestMoney() {
            try {
                const user = plantSystem.getUserData();

                if (!user.wallet) {
                    user.wallet = { money: 0, water: 0 };
                }

                user.wallet.money += 1000;
                plantSystem.saveUserData(user);

                homeShowToast('âœ… 1000ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                closeHomeFarmDevMenu();
                updateMoney();
            } catch (error) {
                console.error('ëˆ ì¶”ê°€ ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ëˆ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í•™ìŠµ ë¯¸ì…˜ ëª¨ë‘ ì™„ë£Œ
        function homeCompleteLearningMissions() {
            try {
                const user = plantSystem.getUserData();

                // 9ê³¼ëª© ëª¨ë‘ ì™„ë£Œ ì²˜ë¦¬
                const allSubjects = ['english', 'math', 'science', 'korean', 'social', 'common', 'idiom', 'person', 'economy'];

                allSubjects.forEach((subject, index) => {
                    if (!user.daily.completedSubjectIds.includes(subject)) {
                        plantSystem.completeSubject(user, subject, subject);
                    }
                });

                homeShowToast('âœ… 9ê³¼ëª© ëª¨ë‘ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤ (ë³´ìƒ í¬í•¨)');
                closeHomeFarmDevMenu();
                updateAllDisplays();
            } catch (error) {
                console.error('í•™ìŠµ ë¯¸ì…˜ ì™„ë£Œ ì˜¤ë¥˜:', error);
                homeShowToast('âŒ í•™ìŠµ ë¯¸ì…˜ ì™„ë£Œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”
        function homeResetAllData() {
            if (!confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©° ë‹¤ìŒ í•­ëª©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\n- ì‚¬ìš©ì ì •ë³´\n- ì‹ë¬¼ ë° ì •ì›\n- í•™ìŠµ ê¸°ë¡\n- ë™ë¬¼ ì»¬ë ‰ì…˜\n- ë³´ìƒ ë° ì¬í™”')) {
                return;
            }

            try {
                // ëª¨ë“  localStorage í‚¤ ì‚­ì œ
                const keysToRemove = [
                    'plantSystemUser',
                    'plantSystemPlants',
                    'learningProgress',
                    'animalCollection',
                    'selectedSubjects',
                    'extraLearningMode',
                    'eduPetSettings',
                    'eduPetOnboardingCompleted'
                ];

                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });

                homeShowToast('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                closeHomeFarmDevMenu();

                setTimeout(() => {
                    window.location.href = 'tutorial.html';
                }, 1500);
            } catch (error) {
                console.error('ì „ì²´ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                homeShowToast('âŒ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í•™ìŠµ ë¯¸ì…˜ ì´ˆê¸°í™”
        function homeResetLearningMissions() {
            if (!confirm('ëª¨ë“  í•™ìŠµ ë¯¸ì…˜ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³´ìƒì€ ìœ ì§€ë©ë‹ˆë‹¤)')) {
                return;
            }

            try {
                const user = plantSystem.getUserData();

                // ì¼ì¼ ì§„í–‰ë¥ ë§Œ ì´ˆê¸°í™” (ë³´ìƒì€ ìœ ì§€)
                user.daily.completedSubjects = 0;
                user.daily.completedSubjectIds = [];
                user.daily.lastResetDate = plantSystem.getCurrentDate();

                plantSystem.saveUserData(user);

                homeShowToast('âœ… í•™ìŠµ ë¯¸ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                closeHomeFarmDevMenu();
                updateAllDisplays();
            } catch (error) {
                console.error('í•™ìŠµ ë¯¸ì…˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                homeShowToast('âŒ í•™ìŠµ ë¯¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ =====

        // ìµœê·¼ í•™ìŠµ í™œë™ ì—…ë°ì´íŠ¸
        function updateWeeklyActivity() {
            const labelsContainer = document.getElementById('weeklyLabels');
            const activityContainer = document.getElementById('weeklyActivity');
            if (!labelsContainer || !activityContainer) return;

            labelsContainer.innerHTML = '';
            activityContainer.innerHTML = '';

            try {
                const learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');
                const dailyActivity = learningProgress.dailyActivity || {};

                // ì—°ì† í•™ìŠµì¼ ê³„ì‚°
                let streakDays = 0;
                const today = new Date();
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() - i);
                    const dateStr = checkDate.toISOString().split('T')[0];

                    if (dailyActivity[dateStr] && dailyActivity[dateStr] > 0) {
                        streakDays++;
                    } else {
                        break;
                    }
                }

                // ì—°ì† í•™ìŠµì¼ UI ì—…ë°ì´íŠ¸
                document.getElementById('streakDays').textContent = streakDays;

                // ìµœê·¼ 7ì¼ í™œë™ í‘œì‹œ
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];

                    // ìš”ì¼ ë¼ë²¨ ì¶”ê°€
                    const label = document.createElement('div');
                    label.className = 'text-xs text-gray-500';
                    label.textContent = dayOfWeek;
                    labelsContainer.appendChild(label);

                    // í•´ë‹¹ ë‚ ì§œì˜ í•™ìŠµ ê¸°ë¡ í™•ì¸ (dailyActivityì—ì„œ)
                    const questionsCount = dailyActivity[dateStr] || 0;

                    let bgColor = 'bg-gray-100';
                    let textColor = 'text-gray-400';
                    if (questionsCount > 0) {
                        if (questionsCount >= 180) { // 3ê³¼ëª© ì´ìƒ
                            bgColor = 'bg-green-500';
                            textColor = 'text-white';
                        } else if (questionsCount >= 120) { // 2ê³¼ëª©
                            bgColor = 'bg-green-400';
                            textColor = 'text-white';
                        } else if (questionsCount >= 60) { // 1ê³¼ëª©
                            bgColor = 'bg-green-300';
                            textColor = 'text-white';
                        } else {
                            bgColor = 'bg-green-200';
                            textColor = 'text-gray-700';
                        }
                    }

                    const cell = document.createElement('div');
                    cell.className = `w-full aspect-square ${bgColor} rounded flex flex-col items-center justify-center ${textColor} text-xs font-bold`;

                    const questionsDiv = document.createElement('div');
                    questionsDiv.textContent = questionsCount || '';
                    questionsDiv.className = 'text-sm';

                    const labelDiv = document.createElement('div');
                    labelDiv.textContent = questionsCount > 0 ? 'ë¬¸ì œ' : '';
                    labelDiv.className = 'text-xs';

                    cell.appendChild(questionsDiv);
                    cell.appendChild(labelDiv);

                    const minutes = Math.round(questionsCount / 6); // 60ë¬¸ì œ = 10ë¶„
                    cell.title = `${date.toLocaleDateString('ko-KR')} (${dayOfWeek})\n${questionsCount}ë¬¸ì œ Â· ${minutes}ë¶„`;

                    activityContainer.appendChild(cell);
                }
            } catch (e) {
                console.error('ì£¼ê°„ í™œë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
            }
        }
    </script>
</body>
</html>
