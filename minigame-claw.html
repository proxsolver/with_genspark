<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸í˜•ë½‘ê¸° ê²Œì„ - EduPet Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #gameCanvas {
            background: linear-gradient(180deg, #FFF5E1 0%, #FFE4B5 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
            margin: 0 auto;
        }
        .prize-box {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .claw-moving {
            animation: swing 0.5s ease-in-out;
        }
        @keyframes swing {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-5px); }
        }
        .sparkle {
            animation: sparkle 1s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-2xl mx-auto">
        <!-- í—¤ë” -->
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-3xl">ğŸ</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">ì¸í˜•ë½‘ê¸° ê²Œì„</h1>
                        <p class="text-xs text-gray-600">ê·€ì—¬ìš´ ë™ë¬¼ ì¸í˜•ì„ ë½‘ì•„ë³´ì„¸ìš”!</p>
                    </div>
                </div>
                <button onclick="goBack()" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm">
                    ëŒì•„ê°€ê¸°
                </button>
            </div>

            <!-- ê²Œì„ ì •ë³´ -->
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-yellow-50 rounded-lg p-2 text-center">
                    <p class="text-xs text-gray-600">ë‚´ ì½”ì¸</p>
                    <p class="text-xl font-bold text-yellow-600" id="userCoins">0</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-2 text-center">
                    <p class="text-xs text-gray-600">ë‚¨ì€ íšŸìˆ˜</p>
                    <p class="text-xl font-bold text-blue-600" id="remaining">5</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-2 text-center">
                    <p class="text-xs text-gray-600">ì„±ê³µë¥ </p>
                    <p class="text-xl font-bold text-purple-600" id="successRate">0%</p>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
        <div id="gameArea" style="display: none;">
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <canvas id="gameCanvas" width="400" height="500"></canvas>
                <div class="text-center text-sm text-gray-600 mt-3">
                    <p id="gameInstruction">â¬…ï¸ ë§ˆìš°ìŠ¤ë‚˜ í„°ì¹˜ë¡œ ì§‘ê²Œë¥¼ ì›€ì§ì´ì„¸ìš” â¡ï¸</p>
                </div>
            </div>
        </div>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="startSection" class="bg-white rounded-2xl shadow-lg p-8 text-center">
            <div class="mb-6">
                <div class="flex justify-center gap-3 mb-4">
                    <span class="text-5xl prize-box">ğŸ°</span>
                    <span class="text-5xl prize-box" style="animation-delay: 0.3s;">ğŸ»</span>
                    <span class="text-5xl prize-box" style="animation-delay: 0.6s;">ğŸ¦</span>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ì¸í˜•ë½‘ê¸° ì±Œë¦°ì§€!</h2>
            <p class="text-gray-600 mb-6">ì§‘ê²Œë¥¼ ì¡°ì¢…í•´ì„œ ê·€ì—¬ìš´ ë™ë¬¼ ì¸í˜•ì„ ë½‘ì•„ë³´ì„¸ìš”</p>

            <div class="bg-pink-50 rounded-xl p-4 mb-6 border-2 border-pink-200">
                <ul class="text-sm text-gray-700 space-y-2 text-left">
                    <li>â€¢ ì…ì¥ë£Œ: <strong class="text-yellow-600">10ì½”ì¸</strong></li>
                    <li>â€¢ ì§‘ê²Œë¥¼ ì¢Œìš°ë¡œ ì›€ì§ì—¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
                    <li>â€¢ í´ë¦­í•˜ë©´ ì§‘ê²Œê°€ ë‚´ë ¤ê°€ì„œ ì¸í˜•ì„ ì¡ìŠµë‹ˆë‹¤</li>
                    <li>â€¢ ì„±ê³µí•˜ë©´ ë™ë¬¼ ì»¬ë ‰ì…˜ì— ì¶”ê°€ë©ë‹ˆë‹¤!</li>
                    <li class="text-xs text-gray-500">ğŸ’¡ íŒ: ì¸í˜• ì¤‘ì•™ì„ ë…¸ë¦¬ë©´ ì„±ê³µë¥ ì´ ë†’ì•„ìš”</li>
                </ul>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 mb-6 border border-yellow-200">
                <p class="text-sm font-bold text-gray-800 mb-2">ğŸ ë“±ê¸‰ë³„ í™•ë¥ </p>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="flex items-center gap-1">
                        <span class="text-gray-500">âšª</span>
                        <span>ì¼ë°˜: 60%</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-blue-500">ğŸ”µ</span>
                        <span>ë ˆì–´: 30%</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-purple-500">ğŸŸ£</span>
                        <span>ì—í”½: 9%</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-yellow-500 sparkle">â­</span>
                        <span>ì „ì„¤: 1%</span>
                    </div>
                </div>
            </div>

            <button onclick="startGame()" class="px-8 py-4 bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition font-bold text-lg shadow-lg">
                10ì½”ì¸ìœ¼ë¡œ ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
    <script src="plant-system.js"></script>
    <script src="minigame-system.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameStarted = false;
        let clawX = canvas.width / 2;
        let clawY = 50;
        let clawMoving = false;
        let clawDown = false;
        let prizes = [];
        let selectedPrize = null;
        let gamePhase = 'move'; // 'move', 'down', 'up', 'result'

        // ë™ë¬¼ ì´ëª¨ì§€ í’€ (ì¸í˜•ë½‘ê¸° ê¸°ê³„ì— í‘œì‹œë  ë™ë¬¼ë“¤)
        const animalEmojiPool = {
            common: ['ğŸ°', 'ğŸ»', 'ğŸ¦Š', 'ğŸ·', 'ğŸ®', 'ğŸ¶', 'ğŸ±'],
            rare: ['ğŸ¼', 'ğŸ¨', 'ğŸ¦’', 'ğŸ¦“', 'ğŸ˜'],
            epic: ['ğŸ¦', 'ğŸ¯', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦ˆ'],
            legendary: ['ğŸ¦„', 'ğŸ‰']
        };

        // ë™ë¬¼ ì´ë¦„ í’€
        const animalNamePool = {
            common: ['í† ë¼', 'ê³°', 'ì—¬ìš°', 'ë¼ì§€', 'ì†Œ', 'ê°œ', 'ê³ ì–‘ì´', 'ë³‘ì•„ë¦¬', 'ì˜¤ë¦¬', 'ì–‘'],
            rare: ['íŒë‹¤', 'ì½”ì•Œë¼', 'ê¸°ë¦°', 'ì–¼ë£©ë§', 'ì½”ë¼ë¦¬', 'í­ê·„', 'ë¬¼ê°œ', 'ìˆ˜ë‹¬'],
            epic: ['ì‚¬ì', 'í˜¸ë‘ì´', 'ë…ìˆ˜ë¦¬', 'ë¶€ì—‰ì´', 'ìƒì–´', 'ëŠ‘ëŒ€', 'ì¹˜íƒ€', 'ì•…ì–´'],
            legendary: ['ìœ ë‹ˆì½˜', 'ë“œë˜ê³¤', 'ë¶ˆì‚¬ì¡°', 'í˜ê°€ìˆ˜ìŠ¤']
        };

        // localStorageì— ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
        function initializeAnimalDatabase() {
            const existing = localStorage.getItem('animalCollection');
            if (existing) {
                const parsed = JSON.parse(existing);
                if (parsed.animals && parsed.animals.length > 0) {
                    return; // ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ
                }
            }

            // ê¸°ë³¸ ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
            const animals = [];
            let idCounter = 1;

            // Common (20ë§ˆë¦¬)
            for (let i = 0; i < 20; i++) {
                const emojiIndex = i % animalEmojiPool.common.length;
                const nameIndex = i % animalNamePool.common.length;
                animals.push({
                    id: `common_${idCounter++}`,
                    name: animalNamePool.common[nameIndex],
                    emoji: animalEmojiPool.common[emojiIndex],
                    rarity: 'common',
                    tier: 'common',
                    power: 1
                });
            }

            // Rare (10ë§ˆë¦¬)
            for (let i = 0; i < 10; i++) {
                const emojiIndex = i % animalEmojiPool.rare.length;
                const nameIndex = i % animalNamePool.rare.length;
                animals.push({
                    id: `rare_${idCounter++}`,
                    name: animalNamePool.rare[nameIndex],
                    emoji: animalEmojiPool.rare[emojiIndex],
                    rarity: 'rare',
                    tier: 'rare',
                    power: 2
                });
            }

            // Epic (5ë§ˆë¦¬)
            for (let i = 0; i < 5; i++) {
                const emojiIndex = i % animalEmojiPool.epic.length;
                const nameIndex = i % animalNamePool.epic.length;
                animals.push({
                    id: `epic_${idCounter++}`,
                    name: animalNamePool.epic[nameIndex],
                    emoji: animalEmojiPool.epic[emojiIndex],
                    rarity: 'epic',
                    tier: 'epic',
                    power: 5
                });
            }

            // Legendary (2ë§ˆë¦¬)
            for (let i = 0; i < 2; i++) {
                const emojiIndex = i % animalEmojiPool.legendary.length;
                const nameIndex = i % animalNamePool.legendary.length;
                animals.push({
                    id: `legendary_${idCounter++}`,
                    name: animalNamePool.legendary[nameIndex],
                    emoji: animalEmojiPool.legendary[emojiIndex],
                    rarity: 'legendary',
                    tier: 'legendary',
                    power: 10
                });
            }

            // localStorageì— ì €ì¥
            const initialState = {
                animals: animals,
                collection: {},
                stats: { totalDraws: 0, legendaryCount: 0 }
            };
            localStorage.setItem('animalCollection', JSON.stringify(initialState));
            console.log('âœ… ì¸í˜•ë½‘ê¸°ìš© ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ (ì´ ' + animals.length + 'ë§ˆë¦¬)');
        }

        // Fallback ë™ë¬¼ ìƒì„± í•¨ìˆ˜
        function getFallbackAnimal(rarity) {
            const tempEmojis = animalEmojiPool[rarity] || ['ğŸ¾'];
            const tempNames = animalNamePool[rarity] || ['ë™ë¬¼'];
            const tempEmoji = tempEmojis[Math.floor(Math.random() * tempEmojis.length)];
            const tempName = tempNames[Math.floor(Math.random() * tempNames.length)];

            return {
                id: `temp_${rarity}_${Date.now()}`,
                name: tempName,
                emoji: tempEmoji,
                rarity: rarity,
                tier: rarity,
                power: rarity === 'legendary' ? 10 : rarity === 'epic' ? 5 : rarity === 'rare' ? 2 : 1
            };
        }

        // ì‹¤ì œ ë™ë¬¼ ë°ì´í„°ëŠ” ë½‘ì•˜ì„ ë•Œ animal-collectionì˜ DBì—ì„œ ê°€ì ¸ì˜´
        function getRandomAnimalFromDB(rarity) {
            try {
                // localStorageì—ì„œ ë™ë¬¼ ì»¬ë ‰ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const animalState = JSON.parse(localStorage.getItem('animalCollection') || '{"animals": [], "collection": {}}');
                const allAnimals = animalState.animals || [];

                // ë°°ì—´ì¸ì§€ í™•ì¸
                if (!Array.isArray(allAnimals)) {
                    console.error('âš ï¸ animalsê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', allAnimals);
                    return getFallbackAnimal(rarity);
                }

                // ë“±ê¸‰ë³„ë¡œ í•„í„°ë§
                const tierAnimals = allAnimals.filter(a => {
                    // ìœ íš¨í•œ ë™ë¬¼ ê°ì²´ì¸ì§€ í™•ì¸
                    if (!a || typeof a.id !== 'string') {
                        return false;
                    }

                    if (rarity === 'common') return a.id.startsWith('common_');
                    if (rarity === 'rare') return a.id.startsWith('rare_');
                    if (rarity === 'epic') return a.id.startsWith('epic_');
                    if (rarity === 'legendary') return a.id.startsWith('legendary_');
                    return false;
                });

                // í•´ë‹¹ ë“±ê¸‰ ë™ë¬¼ì´ ìˆìœ¼ë©´ ëœë¤ ì„ íƒ
                if (tierAnimals.length > 0) {
                    const selectedAnimal = tierAnimals[Math.floor(Math.random() * tierAnimals.length)];
                    // rarityì™€ tier ì†ì„± ì¶”ê°€ (ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                    return {
                        ...selectedAnimal,
                        rarity: selectedAnimal.rarity || rarity,
                        tier: selectedAnimal.tier || rarity
                    };
                }

                // í•´ë‹¹ ë“±ê¸‰ ë™ë¬¼ì´ ì—†ìœ¼ë©´ fallback
                console.warn(`âš ï¸ ${rarity} ë“±ê¸‰ ë™ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Fallback ì‚¬ìš©.`);
                return getFallbackAnimal(rarity);

            } catch (error) {
                console.error('âŒ ë™ë¬¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                return getFallbackAnimal(rarity);
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeAnimalDatabase();
            updateUI();
        });

        function updateUI() {
            if (typeof plantSystem !== 'undefined') {
                const coins = plantSystem.getMoney();
                document.getElementById('userCoins').textContent = coins;
            }

            if (typeof minigameSystem !== 'undefined') {
                const stats = minigameSystem.getStats();
                document.getElementById('remaining').textContent = stats.remainingPlays.claw || 5;

                // ì„±ê³µë¥  ê³„ì‚°
                const played = stats.totalStats.claw?.played || 0;
                const won = stats.totalStats.claw?.won || 0;
                const rate = played > 0 ? Math.round((won / played) * 100) : 0;
                document.getElementById('successRate').textContent = rate + '%';
            }
        }

        function startGame() {
            // ì½”ì¸ í™•ì¸ ë° ì°¨ê°
            if (typeof minigameSystem !== 'undefined') {
                const result = minigameSystem.playClawGame();
                if (!result.success) {
                    alert(result.message);
                    return;
                }
            }

            gameStarted = true;
            gamePhase = 'move';
            clawX = canvas.width / 2;
            clawY = 50;
            selectedPrize = null;

            // í™”ë©´ ì „í™˜
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            // ì¸í˜•ë“¤ ìƒì„±
            createPrizes();
            updateUI();
            draw();
        }

        // ë“±ê¸‰ë³„ ê°€ì¤‘ì¹˜ë¡œ ëœë¤ ë™ë¬¼ ì„ íƒ
        function getRandomAnimalByRarity() {
            const rand = Math.random() * 100;

            // í™•ë¥ : ì¼ë°˜ 60%, ë ˆì–´ 30%, ì—í”½ 9%, ì „ì„¤ 1%
            let rarity;
            if (rand < 60) {
                rarity = 'common';
            } else if (rand < 90) {
                rarity = 'rare';
            } else if (rand < 99) {
                rarity = 'epic';
            } else {
                rarity = 'legendary';
            }

            // ë“±ê¸‰ì— ë§ëŠ” ë™ë¬¼ì„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
            return getRandomAnimalFromDB(rarity);
        }

        function createPrizes() {
            prizes = [];
            const positions = [
                { x: 80, y: 350 },
                { x: 160, y: 370 },
                { x: 240, y: 350 },
                { x: 320, y: 370 },
                { x: 120, y: 420 },
                { x: 200, y: 400 },
                { x: 280, y: 420 }
            ];

            positions.forEach(pos => {
                const randomAnimal = getRandomAnimalByRarity();
                prizes.push({
                    ...randomAnimal,
                    x: pos.x,
                    y: pos.y,
                    width: 50,
                    height: 50
                });
            });
        }

        function drawClaw() {
            // ì§‘ê²Œ ì¤„
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(clawX, 0);
            ctx.lineTo(clawX, clawY);
            ctx.stroke();

            // ì§‘ê²Œ
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#DAA520';
            ctx.lineWidth = 3;

            // ì§‘ê²Œ ëª¸í†µ
            ctx.beginPath();
            ctx.arc(clawX, clawY, 15, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ì§‘ê²Œ ë°œ
            ctx.beginPath();
            ctx.moveTo(clawX - 10, clawY + 10);
            ctx.lineTo(clawX - 15, clawY + 25);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(clawX + 10, clawY + 10);
            ctx.lineTo(clawX + 15, clawY + 25);
            ctx.stroke();
        }

        function drawPrizes() {
            prizes.forEach((prize, index) => {
                // ì„ íƒëœ ì¸í˜•ì€ ì§‘ê²Œë¥¼ ë”°ë¼ ì›€ì§ì„
                if (selectedPrize === index && gamePhase === 'up') {
                    prize.y = clawY + 40;
                    prize.x = clawX - 25;
                }

                // ì¸í˜• ê·¸ë¦¼ì
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.beginPath();
                ctx.ellipse(prize.x + 25, prize.y + 60, 20, 5, 0, 0, Math.PI * 2);
                ctx.fill();

                // ì¸í˜• ì´ëª¨ì§€
                ctx.font = '40px Arial';
                ctx.fillText(prize.emoji, prize.x, prize.y + 40);

                // ë“±ê¸‰ í‘œì‹œ
                const rarityColors = {
                    common: '#9CA3AF',
                    rare: '#3B82F6',
                    epic: '#8B5CF6',
                    legendary: '#F59E0B'
                };
                ctx.fillStyle = rarityColors[prize.rarity] || '#9CA3AF';
                ctx.fillRect(prize.x, prize.y, 50, 3);
            });
        }

        function draw() {
            if (!gameStarted) return;

            // ë°°ê²½ í´ë¦¬ì–´
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ìƒë‹¨ ë°”
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, 0, canvas.width, 30);

            // ì¸í˜•ë“¤ ê·¸ë¦¬ê¸°
            drawPrizes();

            // ì§‘ê²Œ ê·¸ë¦¬ê¸°
            drawClaw();

            // ê²Œì„ ë‹¨ê³„ì— ë”°ë¥¸ ë™ì‘
            if (gamePhase === 'down') {
                clawY += 5;
                if (clawY >= 300) {
                    // ì¸í˜• ì¡ê¸° ì‹œë„
                    checkPrizeCapture();
                    gamePhase = 'up';
                }
            } else if (gamePhase === 'up') {
                clawY -= 3;
                if (clawY <= 50) {
                    clawY = 50;
                    showResult();
                    return;
                }
            }

            requestAnimationFrame(draw);
        }

        function checkPrizeCapture() {
            // ì§‘ê²Œ ìœ„ì¹˜ì™€ ê°€ì¥ ê°€ê¹Œìš´ ì¸í˜• ì°¾ê¸°
            let closestIndex = -1;
            let closestDistance = Infinity;

            prizes.forEach((prize, index) => {
                const distance = Math.abs(prize.x + 25 - clawX);
                if (distance < closestDistance && distance < 40) {
                    closestDistance = distance;
                    closestIndex = index;
                }
            });

            // ì¡ê¸° ì„±ê³µ í™•ë¥  ê³„ì‚° (ì¤‘ì•™ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì„±ê³µë¥  ë†’ìŒ)
            if (closestIndex !== -1) {
                const grabChance = Math.max(0.3, 1 - (closestDistance / 40) * 0.7);

                // 1ë‹¨ê³„: ì§‘ê²Œë¡œ ì¡ê¸° ì„±ê³µ?
                if (Math.random() < grabChance) {
                    const prize = prizes[closestIndex];

                    // 2ë‹¨ê³„: ë“±ê¸‰ë³„ "ë¯¸ë„ëŸ¬ì ¸ ë–¨ì–´ì§" í™•ë¥  ì²´í¬
                    const holdChances = {
                        common: 0.90,      // ì¼ë°˜: 90% ìœ ì§€
                        rare: 0.70,        // ë ˆì–´: 70% ìœ ì§€
                        epic: 0.40,        // ì—í”½: 40% ìœ ì§€
                        legendary: 0.20    // ì „ì„¤: 20% ìœ ì§€ (80% ë–¨ì–´ì§!)
                    };

                    const holdChance = holdChances[prize.rarity] || 0.5;

                    // ëê¹Œì§€ ì¡ê³  ì˜¬ë¼ê°€ê¸° ì„±ê³µ!
                    if (Math.random() < holdChance) {
                        selectedPrize = closestIndex;
                    }
                }
            }
        }

        function showResult() {
            gameStarted = false;
            gamePhase = 'result';

            if (selectedPrize !== null) {
                const prize = prizes[selectedPrize];

                // ë™ë¬¼ ì»¬ë ‰ì…˜ì— ì¶”ê°€
                addToCollection(prize);

                // ì„±ê³µ ì²˜ë¦¬
                if (typeof minigameSystem !== 'undefined') {
                    minigameSystem.clawGameSuccess(prize);
                }

                const rarityNames = {
                    common: 'ì¼ë°˜',
                    rare: 'ë ˆì–´',
                    epic: 'ì—í”½',
                    legendary: 'ì „ì„¤'
                };

                const rarityEmojis = {
                    common: 'âšª',
                    rare: 'ğŸ”µ',
                    epic: 'ğŸŸ£',
                    legendary: 'â­'
                };

                const message = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!\n\n${prize.emoji} ${prize.name}ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n${rarityEmojis[prize.rarity]} ë“±ê¸‰: ${rarityNames[prize.rarity]}\n\në™ë¬¼ ì»¬ë ‰ì…˜ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`;

                alert(message);
            } else {
                // ì‹¤íŒ¨ ì²˜ë¦¬
                if (typeof minigameSystem !== 'undefined') {
                    minigameSystem.clawGameFailure();
                }

                alert('ğŸ˜¢ ì•„ì‰½ê²Œë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!\n\në‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
            }

            // ê²Œì„ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            setTimeout(() => {
                window.location.href = 'minigames.html';
            }, 1000);
        }

        function addToCollection(animal) {
            // animal-collection.htmlê³¼ ë™ì¼í•œ ì €ì¥ ë°©ì‹
            let savedData = JSON.parse(localStorage.getItem('animalCollection')) || null;

            // gameState êµ¬ì¡° ìƒì„± (ì—†ìœ¼ë©´)
            let gameState = {
                animals: savedData?.animals || [],
                collection: savedData?.collection || {},
                stats: savedData?.stats || { totalDraws: 0, legendaryCount: 0 }
            };

            // collectionì— ë™ë¬¼ ì¶”ê°€ (animal-collection.htmlê³¼ ë™ì¼í•œ êµ¬ì¡°)
            if (!gameState.collection[animal.id]) {
                // ì²˜ìŒ íšë“
                gameState.collection[animal.id] = {
                    id: animal.id,
                    name: animal.name,
                    emoji: animal.emoji,
                    rarity: animal.rarity,
                    tier: animal.rarity,
                    count: 1,
                    level: 1,
                    exp: 0,
                    duplicates: 0,
                    power: 1,  // ê¸°ë³¸ íŒŒì›Œ
                    totalPower: 1,
                    acquiredAt: Date.now(),
                    source: 'minigame-claw'
                };
                console.log(`âœ¨ ìƒˆ ë™ë¬¼ íšë“: ${animal.name} (${animal.rarity})`);
            } else {
                // ì¤‘ë³µ íšë“
                gameState.collection[animal.id].count++;
                gameState.collection[animal.id].duplicates++;
                gameState.collection[animal.id].acquiredAt = Date.now();
                console.log(`ğŸ”¥ ì¤‘ë³µ ì¹´ë“œ íšë“! ${animal.name} - ì¤‘ë³µ ${gameState.collection[animal.id].duplicates}ì¥`);
            }

            // ì „ì„¤ í†µê³„ ì—…ë°ì´íŠ¸
            if (animal.rarity === 'legendary' && gameState.collection[animal.id].count === 1) {
                gameState.stats.legendaryCount++;
            }

            // ì €ì¥
            localStorage.setItem('animalCollection', JSON.stringify(gameState));
            console.log('âœ… ë™ë¬¼ ì»¬ë ‰ì…˜ì— ì €ì¥ ì™„ë£Œ');
        }

        function goBack() {
            if (gameStarted && !confirm('ê²Œì„ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì½”ì¸ì€ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) {
                return;
            }
            window.location.href = 'minigames.html';
        }

        // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ì§‘ê²Œ ì´ë™
        canvas.addEventListener('mousemove', (e) => {
            if (!gameStarted || gamePhase !== 'move') return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            clawX = Math.max(30, Math.min(mouseX, canvas.width - 30));
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!gameStarted || gamePhase !== 'move') return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const touchX = touch.clientX - rect.left;
            clawX = Math.max(30, Math.min(touchX, canvas.width - 30));
        });

        // í´ë¦­ìœ¼ë¡œ ì§‘ê²Œ ë‚´ë¦¬ê¸°
        canvas.addEventListener('click', () => {
            if (!gameStarted || gamePhase !== 'move') return;

            gamePhase = 'down';
            document.getElementById('gameInstruction').textContent = 'ì§‘ê²Œê°€ ë‚´ë ¤ê°€ê³  ìˆìŠµë‹ˆë‹¤...';
        });

        canvas.addEventListener('touchstart', (e) => {
            if (!gameStarted || gamePhase !== 'move') return;

            e.preventDefault();
            gamePhase = 'down';
            document.getElementById('gameInstruction').textContent = 'ì§‘ê²Œê°€ ë‚´ë ¤ê°€ê³  ìˆìŠµë‹ˆë‹¤...';
        });
    </script>
</body>
</html>
