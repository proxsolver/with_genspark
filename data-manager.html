<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 관리 - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .data-section {
            transition: all 0.3s ease;
        }
        
        .success-animation {
            animation: success-pulse 1s ease-out;
        }
        
        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #dcfce7; }
            100% { transform: scale(1); }
        }
        
        .export-area {
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <div class="text-center mb-6">
            <button onclick="goHome()" class="absolute left-4 top-6 text-2xl hover:scale-110 transition-transform">
                🏠
            </button>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">💾 데이터 관리</h1>
            <div class="text-sm text-gray-600">
                진행 상황을 백업하고 복원하세요
            </div>
        </div>

        <!-- Current Data Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                📊 현재 데이터 상태
            </h2>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>학습 진행률:</span>
                    <span id="learningData" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                    <span>농장 상태:</span>
                    <span id="farmData" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                    <span>동물 컬렉션:</span>
                    <span id="collectionData" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                    <span>업적 달성:</span>
                    <span id="achievementData" class="font-medium">-</span>
                </div>
                <div class="flex justify-between border-t pt-2 mt-2">
                    <span>마지막 백업:</span>
                    <span id="lastBackup" class="font-medium text-blue-600">-</span>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 data-section">
            <h2 class="text-lg font-bold text-gray-800 mb-4">📤 데이터 내보내기</h2>
            <div class="text-sm text-gray-600 mb-4">
                현재 진행 상황을 안전하게 백업할 수 있습니다.
            </div>
            
            <button onclick="exportData()" class="w-full mb-4 px-4 py-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                📦 데이터 내보내기
            </button>
            
            <textarea id="exportArea" 
                      class="export-area w-full h-32 p-3 border rounded-lg text-xs bg-gray-50 resize-none"
                      placeholder="내보낸 데이터가 여기에 표시됩니다..."
                      readonly></textarea>
            
            <div class="flex space-x-2 mt-2">
                <button onclick="copyExportData()" 
                        class="flex-1 px-3 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors"
                        id="copyBtn" disabled>
                    📋 복사하기
                </button>
                <button onclick="saveAsFile()" 
                        class="flex-1 px-3 py-2 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 transition-colors"
                        id="saveBtn" disabled>
                    💾 파일 저장
                </button>
            </div>
        </div>

        <!-- Import Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 data-section">
            <h2 class="text-lg font-bold text-gray-800 mb-4">📥 데이터 가져오기</h2>
            <div class="text-sm text-gray-600 mb-4">
                백업한 데이터를 복원할 수 있습니다. ⚠️ 현재 데이터가 덮어써집니다!
            </div>
            
            <textarea id="importArea" 
                      class="export-area w-full h-32 p-3 border rounded-lg text-xs"
                      placeholder="백업한 데이터를 여기에 붙여넣으세요..."></textarea>
            
            <div class="flex space-x-2 mt-4">
                <button onclick="validateImportData()" 
                        class="flex-1 px-3 py-2 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600 transition-colors">
                    🔍 데이터 검증
                </button>
                <button onclick="importData()" 
                        class="flex-1 px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                    ⚡ 데이터 복원
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">⚡ 빠른 작업</h2>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="autoBackup()" 
                        class="px-3 py-3 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600 transition-colors">
                    🔄 자동 백업
                </button>
                <button onclick="resetAllData()" 
                        class="px-3 py-3 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600 transition-colors">
                    🗑️ 초기화
                </button>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 bg-gray-50 rounded p-3">
                💡 팁: 정기적으로 데이터를 백업하여 진행 상황을 안전하게 보관하세요!
            </div>
        </div>
    </div>

    <script>
        let exportedData = null;

        function loadCurrentDataStatus() {
            // Load and display current data status
            const learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');
            const quizProgress = JSON.parse(localStorage.getItem('quizProgress') || '{}');
            const farmState = JSON.parse(localStorage.getItem('simpleFarmState') || '{}');
            const animalCollection = JSON.parse(localStorage.getItem('animalCollection') || '{}');
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            
            // Update display
            document.getElementById('learningData').textContent = 
                `${quizProgress.totalCorrect || 0}문제 정답 / ${quizProgress.sessionCount || 0}세션`;
            
            document.getElementById('farmData').textContent = 
                `💰${farmState.money || 0}원 / 💧${farmState.water || 0}개`;
            
            const collectionCount = Object.keys(animalCollection.collection || {}).length;
            document.getElementById('collectionData').textContent = 
                `${collectionCount}종 수집`;
            
            const achievementCount = Object.values(achievements).filter(a => a.completed).length;
            document.getElementById('achievementData').textContent = 
                `${achievementCount}개 달성`;
            
            // Check last backup
            const lastBackup = localStorage.getItem('lastBackupTime');
            document.getElementById('lastBackup').textContent = 
                lastBackup ? new Date(parseInt(lastBackup)).toLocaleString() : '없음';
        }

        function exportData() {
            const gameData = {
                version: "1.0.0",
                timestamp: Date.now(),
                data: {
                    learningProgress: JSON.parse(localStorage.getItem('learningProgress') || '{}'),
                    quizProgress: JSON.parse(localStorage.getItem('quizProgress') || '{}'),
                    simpleFarmState: JSON.parse(localStorage.getItem('simpleFarmState') || '{}'),
                    animalCollection: JSON.parse(localStorage.getItem('animalCollection') || '{}'),
                    achievements: JSON.parse(localStorage.getItem('achievements') || '{}'),
                    eduPetOnboardingCompleted: localStorage.getItem('eduPetOnboardingCompleted')
                }
            };
            
            exportedData = JSON.stringify(gameData, null, 2);
            document.getElementById('exportArea').value = exportedData;
            
            // Enable action buttons
            document.getElementById('copyBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            
            // Show success animation
            const exportSection = document.querySelector('.data-section');
            exportSection.classList.add('success-animation');
            setTimeout(() => exportSection.classList.remove('success-animation'), 1000);
            
            alert('✅ 데이터 내보내기 완료!\n\n아래 텍스트 영역의 데이터를 복사하거나 파일로 저장하세요.');
        }

        function copyExportData() {
            const exportArea = document.getElementById('exportArea');
            exportArea.select();
            exportArea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('📋 클립보드에 복사되었습니다!\n\n안전한 곳에 보관하세요.');
            } catch (err) {
                alert('❌ 복사에 실패했습니다. 수동으로 텍스트를 선택해서 복사하세요.');
            }
        }

        function saveAsFile() {
            if (!exportedData) return;
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `EduPet_Backup_${timestamp}.json`;
            
            const blob = new Blob([exportedData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`💾 파일로 저장되었습니다!\n\n파일명: ${filename}`);
        }

        function validateImportData() {
            const importArea = document.getElementById('importArea');
            const data = importArea.value.trim();
            
            if (!data) {
                alert('❌ 가져올 데이터를 입력하세요.');
                return;
            }
            
            try {
                const gameData = JSON.parse(data);
                
                // Validate structure
                if (!gameData.version || !gameData.timestamp || !gameData.data) {
                    throw new Error('Invalid data format');
                }
                
                const backupDate = new Date(gameData.timestamp).toLocaleString();
                const dataKeys = Object.keys(gameData.data);
                
                alert(`✅ 유효한 백업 데이터입니다!\n\n백업 시간: ${backupDate}\n포함된 데이터: ${dataKeys.length}개 항목\n\n복원하시겠습니까?`);
                
            } catch (error) {
                alert('❌ 잘못된 데이터 형식입니다.\n\n올바른 백업 데이터를 입력하세요.');
            }
        }

        function importData() {
            const importArea = document.getElementById('importArea');
            const data = importArea.value.trim();
            
            if (!data) {
                alert('❌ 가져올 데이터를 입력하세요.');
                return;
            }
            
            if (!confirm('⚠️ 현재 모든 진행 상황이 덮어써집니다!\n\n정말로 데이터를 복원하시겠습니까?')) {
                return;
            }
            
            try {
                const gameData = JSON.parse(data);
                
                // Restore all data
                Object.entries(gameData.data).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        if (typeof value === 'object') {
                            localStorage.setItem(key, JSON.stringify(value));
                        } else {
                            localStorage.setItem(key, value);
                        }
                    }
                });
                
                // Update backup time
                localStorage.setItem('lastBackupTime', Date.now().toString());
                
                // Refresh display
                loadCurrentDataStatus();
                
                alert('✅ 데이터 복원이 완료되었습니다!\n\n페이지를 새로고침하여 변경사항을 확인하세요.');
                
                // Clear import area
                importArea.value = '';
                
            } catch (error) {
                alert('❌ 데이터 복원에 실패했습니다.\n\n올바른 백업 데이터인지 확인하세요.');
            }
        }

        function autoBackup() {
            exportData();
            
            // Set automatic backup timestamp
            localStorage.setItem('lastBackupTime', Date.now().toString());
            loadCurrentDataStatus();
            
            // Auto-save to a predictable format for regular backups
            const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            localStorage.setItem(`autoBackup_${timestamp}`, exportedData);
            
            alert('🔄 자동 백업이 완료되었습니다!\n\n브라우저 로컬 저장소에 오늘 날짜로 저장되었습니다.');
        }

        function resetAllData() {
            if (!confirm('⚠️ 모든 진행 상황이 삭제됩니다!\n\n정말로 초기화하시겠습니까?')) {
                return;
            }
            
            if (!confirm('🚨 마지막 확인!\n\n이 작업은 되돌릴 수 없습니다. 계속하시겠습니까?')) {
                return;
            }
            
            // Clear all EduPet related data
            const keysToRemove = [
                'learningProgress', 'quizProgress', 'simpleFarmState',
                'animalCollection', 'achievements', 'eduPetOnboardingCompleted',
                'lastBackupTime'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Also clear auto-backups
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('autoBackup_')) {
                    localStorage.removeItem(key);
                }
            });
            
            alert('🗑️ 모든 데이터가 초기화되었습니다!\n\n홈페이지로 이동하여 새로 시작하세요.');
            
            // Refresh display
            loadCurrentDataStatus();
            
            // Redirect to tutorial
            setTimeout(() => {
                window.location.href = 'tutorial.html';
            }, 2000);
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentDataStatus();
        });
    </script>
</body>
</html>