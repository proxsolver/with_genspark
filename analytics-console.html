<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ ë¶„ì„ ì½˜ì†” - EduPet Collection</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>

    <!-- í•œê¸€ í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.1) 0%,
                rgba(255, 152, 0, 0.1) 50%,
                rgba(33, 150, 243, 0.1) 100%
            );
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .difficulty-tag {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 600;
        }

        .difficulty-easy { background: #22c55e; color: white; }
        .difficulty-medium { background: #f59e0b; color: white; }
        .difficulty-hard { background: #ef4444; color: white; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ğŸ“Š í•™ìŠµ ë¶„ì„ ì½˜ì†”</h1>
                <p class="text-gray-600 mt-1">ê³¼ëª©ë³„ í•™ìŠµ íŒ¨í„´ ë° ë‚œì´ë„ ì¡°ì • ë°ì´í„° ë¶„ì„</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportData()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all">
                    ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                </button>
                <button onclick="clearData()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all">
                    ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                </button>
                <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">
                    ğŸ  í™ˆìœ¼ë¡œ
                </button>
            </div>
        </div>

        <!-- í•™ìŠµì/ê·¸ë£¹ ì„ íƒ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <span class="text-xl">ğŸ‘¥</span>
                    <h2 class="text-xl font-bold">ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ</h2>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="refreshLearners()" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-all">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ íƒ­ -->
            <div class="flex gap-2 mb-4">
                <button id="view-personal-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold" onclick="switchToPersonalView()">
                    ğŸ‘¤ ê°œì¸ ë°ì´í„°
                </button>
                <button id="view-group-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold" onclick="switchToGroupView()">
                    ğŸ¯ ê·¸ë£¹ ë°ì´í„°
                </button>
            </div>

            <!-- ê°œì¸ ì„ íƒ -->
            <div id="personal-selector" class="flex items-center space-x-3">
                <select id="learner-select" onchange="loadLearnerData()" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:outline-none">
                    <option value="local">í˜„ì¬ ê¸°ê¸° (ë¡œì»¬)</option>
                </select>
            </div>

            <!-- ê·¸ë£¹ ì„ íƒ -->
            <div id="group-selector" class="hidden flex items-center space-x-3">
                <select id="group-select" onchange="loadGroupData()" class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none">
                    <option value="">ê·¸ë£¹ ì„ íƒ...</option>
                </select>
            </div>

            <div id="learner-info" class="mt-4 text-sm text-gray-600">
                í˜„ì¬ ê¸°ê¸°ì˜ í•™ìŠµ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤
            </div>
        </div>

        <!-- ì „ì²´ í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl p-6 shadow-lg stat-card">
                <div class="text-sm text-gray-600 mb-2">ì´ í•™ìŠµ ì„¸ì…˜</div>
                <div class="text-3xl font-bold text-blue-600" id="total-sessions">0</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg stat-card">
                <div class="text-sm text-gray-600 mb-2">í‰ê·  ì •ë‹µë¥ </div>
                <div class="text-3xl font-bold text-green-600" id="avg-accuracy">0%</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg stat-card">
                <div class="text-sm text-gray-600 mb-2">í‰ê·  í•™ìŠµ ì‹œê°„</div>
                <div class="text-3xl font-bold text-orange-600" id="avg-time">0ë¶„</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg stat-card">
                <div class="text-sm text-gray-600 mb-2">ìµœë‹¤ ì™„ë£Œ íƒ€ì…</div>
                <div class="text-2xl font-bold text-purple-600" id="most-completion-type">-</div>
            </div>
        </div>

        <!-- ì™„ë£Œ íƒ€ì…ë³„ í†µê³„ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“ˆ ì™„ë£Œ íƒ€ì…ë³„ ë¶„í¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-4 bg-green-50 rounded-lg border-2 border-green-200">
                    <div class="text-sm text-green-700 mb-1">ì‰¬ì›€ë§Œ 20ë¬¸ì œ</div>
                    <div class="text-2xl font-bold text-green-600" id="type-easy-only">0</div>
                    <div class="text-xs text-green-600 mt-1" id="type-easy-percent">0%</div>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                    <div class="text-sm text-yellow-700 mb-1">ë³´í†µ 7ë¬¸ì œ ì™„ë£Œ</div>
                    <div class="text-2xl font-bold text-yellow-600" id="type-medium-complete">0</div>
                    <div class="text-xs text-yellow-600 mt-1" id="type-medium-percent">0%</div>
                </div>
                <div class="p-4 bg-red-50 rounded-lg border-2 border-red-200">
                    <div class="text-sm text-red-700 mb-1">ì–´ë ¤ì›€ 3ë¬¸ì œ ì™„ë£Œ</div>
                    <div class="text-2xl font-bold text-red-600" id="type-hard-complete">0</div>
                    <div class="text-xs text-red-600 mt-1" id="type-hard-percent">0%</div>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                    <div class="text-sm text-blue-700 mb-1">í˜¼í•© 15ë¬¸ì œ ì´ìƒ</div>
                    <div class="text-2xl font-bold text-blue-600" id="type-mixed-15">0</div>
                    <div class="text-xs text-blue-600 mt-1" id="type-mixed-percent">0%</div>
                </div>
            </div>
        </div>

        <!-- ê³¼ëª©ë³„ í†µê³„ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“š ê³¼ëª©ë³„ ë¶„ì„</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4">ê³¼ëª©</th>
                            <th class="text-center py-3 px-4">ì„¸ì…˜ ìˆ˜</th>
                            <th class="text-center py-3 px-4">í‰ê·  ì •ë‹µë¥ </th>
                            <th class="text-center py-3 px-4">í‰ê·  ì‹œê°„</th>
                            <th class="text-center py-3 px-4">ì£¼ìš” ì™„ë£Œ íƒ€ì…</th>
                            <th class="text-center py-3 px-4">ë‚œì´ë„ ë„ë‹¬</th>
                        </tr>
                    </thead>
                    <tbody id="subject-stats-table">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ìµœê·¼ í•™ìŠµ ê¸°ë¡ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">ğŸ“ ìµœê·¼ í•™ìŠµ ê¸°ë¡</h2>
                <select id="filter-subject" onchange="filterRecords()" class="px-4 py-2 border-2 border-gray-300 rounded-lg">
                    <option value="all">ì „ì²´ ê³¼ëª©</option>
                </select>
            </div>
            <div class="space-y-3" id="recent-records">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- ë¡œê±° ì‹œìŠ¤í…œ -->
    <script src="logger.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const subjects = {
            english: { name: 'ì˜ì–´', icon: 'ğŸ‡ºğŸ‡¸' },
            math: { name: 'ìˆ˜í•™', icon: 'ğŸ”¢' },
            science: { name: 'ê³¼í•™', icon: 'ğŸ”¬' },
            korean: { name: 'êµ­ì–´', icon: 'ğŸ“š' },
            social: { name: 'ì‚¬íšŒ', icon: 'ğŸ›ï¸' },
            common: { name: 'ìƒì‹', icon: 'ğŸ§ ' },
            idiom: { name: 'ì‚¬ìì„±ì–´', icon: 'ğŸ“œ' },
            person: { name: 'ì¸ë¬¼', icon: 'ğŸ‘¤' },
            economy: { name: 'ê²½ì œ', icon: 'ğŸ’°' },
            production: { name: 'ìƒì‚°', icon: 'ğŸ­' },
            toeic: { name: 'TOEIC', icon: 'ğŸ“–' },
            ai: { name: 'AI', icon: 'ğŸ¤–' }
        };

        const completionTypeNames = {
            'easy_only': 'ì‰¬ì›€ë§Œ 20ë¬¸ì œ',
            'medium_complete': 'ë³´í†µ 7ë¬¸ì œ ì™„ë£Œ',
            'hard_complete': 'ì–´ë ¤ì›€ 3ë¬¸ì œ ì™„ë£Œ',
            'mixed_15': 'í˜¼í•© 15ë¬¸ì œ ì´ìƒ'
        };

        let analyticsData = [];
        let currentLearnerId = 'local';
        let allLearners = {};

        // Firebase ì´ˆê¸°í™”
        async function initFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.log('Firebase not available');
                    return false;
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                // ìµëª… ë¡œê·¸ì¸
                const auth = firebase.auth();
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                return true;
            } catch (error) {
                console.error('Firebase init error:', error);
                return false;
            }
        }

        // ëª¨ë“  í•™ìŠµì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function refreshLearners() {
            try {
                const firebaseReady = await initFirebase();
                if (!firebaseReady) {
                    alert('Firebaseì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    return;
                }

                const db = firebase.database();
                const usersSnapshot = await db.ref('users').once('value');
                const users = usersSnapshot.val() || {};

                // ê·¸ë£¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const groupsSnapshot = await db.ref('groups').once('value');
                const groups = groupsSnapshot.val() || {};

                allLearners = { local: { name: 'í˜„ì¬ ê¸°ê¸° (ë¡œì»¬)', data: [] } };

                for (const [userId, userData] of Object.entries(users)) {
                    // ë‹‰ë„¤ì„ ì°¾ê¸° (social-hub.htmlê³¼ ë™ì¼í•œ ê²½ë¡œ)
                    let nickname = null;

                    // ê²½ë¡œ 1: userData.profile.nickname (social-hubì—ì„œ ì„¤ì •)
                    if (userData.profile?.nickname) {
                        nickname = userData.profile.nickname;
                    }
                    // ê²½ë¡œ 2: userData.userData.profile.nickname (í•˜ìœ„ í˜¸í™˜)
                    else if (userData.userData?.profile?.nickname) {
                        nickname = userData.userData.profile.nickname;
                    }
                    // ê²½ë¡œ 3: userData.nickname (ë ˆê±°ì‹œ)
                    else if (userData.nickname) {
                        nickname = userData.nickname;
                    }
                    // ê²½ë¡œ 4: settingsì—ì„œ (localStorage ë™ê¸°í™”)
                    else if (userData.settings?.userName) {
                        nickname = userData.settings.userName;
                    }
                    // ê¸°ë³¸ê°’: UID ì• 8ì
                    else {
                        nickname = `ì‚¬ìš©ì_${userId.substring(0, 8)}`;
                    }

                    // ê·¸ë£¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    let groupName = null;
                    if (userData.groups) {
                        // groupsëŠ” { groupId: memberInfo } í˜•íƒœ
                        const groupIds = Object.keys(userData.groups);
                        if (groupIds.length > 0) {
                            // ì²« ë²ˆì§¸ ê·¸ë£¹ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜´ (ì—¬ëŸ¬ ê·¸ë£¹ ê°€ëŠ¥í•˜ì§€ë§Œ ì¼ë‹¨ ì²« ë²ˆì§¸ ì‚¬ìš©)
                            const firstGroupId = groupIds[0];
                            // ê·¸ë£¹ ì •ë³´ëŠ” groups/{groupId}ì— ì €ì¥ë˜ì–´ ìˆìŒ
                            if (groups[firstGroupId]) {
                                groupName = groups[firstGroupId].name || firstGroupId;
                            } else {
                                groupName = firstGroupId; // ê·¸ë£¹ ì •ë³´ê°€ ì—†ìœ¼ë©´ ID ì‚¬ìš©
                            }
                        }
                    }

                    // analytics ë°ì´í„°ë¥¼ users í•˜ìœ„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    const analyticsHistory = userData.analytics || [];

                    console.log(`[Analytics Console] í•™ìŠµì ë°œê²¬: ${nickname} (${userId.substring(0, 8)}), ê·¸ë£¹: ${groupName || 'ì—†ìŒ'}, ì„¸ì…˜: ${Array.isArray(analyticsHistory) ? analyticsHistory.length : Object.keys(analyticsHistory).length}ê°œ`);

                    allLearners[userId] = {
                        name: nickname,
                        group: groupName,
                        uid: userId,
                        data: Array.isArray(analyticsHistory) ? analyticsHistory : Object.values(analyticsHistory)
                    };
                }

                updateLearnerSelect();
                alert(`âœ… ${Object.keys(allLearners).length - 1}ëª…ì˜ í•™ìŠµì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
            } catch (error) {
                console.error('í•™ìŠµì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('âŒ í•™ìŠµì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í•™ìŠµì ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateLearnerSelect() {
            const select = document.getElementById('learner-select');
            select.innerHTML = '<option value="local">í˜„ì¬ ê¸°ê¸° (ë¡œì»¬)</option>';

            // ë³„ëª… ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedLearners = Object.entries(allLearners)
                .filter(([userId]) => userId !== 'local')
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            for (const [userId, learner] of sortedLearners) {
                const option = document.createElement('option');
                option.value = userId;
                // ê·¸ë£¹ì´ ìˆìœ¼ë©´ "ë³„ëª…_ê·¸ë£¹ëª…", ì—†ìœ¼ë©´ "ë³„ëª…_ê·¸ë£¹"
                const displayName = learner.group ? `${learner.name}_${learner.group}` : `${learner.name}_ê·¸ë£¹`;
                option.textContent = displayName;
                select.appendChild(option);
            }

            console.log('[Analytics Console] í•™ìŠµì ëª©ë¡ ì—…ë°ì´íŠ¸:', sortedLearners.map(([id, l]) => l.name));
        }

        // ì„ íƒí•œ í•™ìŠµì ë°ì´í„° ë¡œë“œ
        function loadLearnerData() {
            const select = document.getElementById('learner-select');
            currentLearnerId = select.value;

            console.log('[Analytics Console] í•™ìŠµì ë°ì´í„° ë¡œë“œ:', currentLearnerId);

            if (currentLearnerId === 'local') {
                const stored = localStorage.getItem('quizAnalyticsHistory');
                console.log('[Analytics Console] localStorage ë°ì´í„°:', stored);

                analyticsData = JSON.parse(stored || '[]');
                console.log('[Analytics Console] ë¡œë“œëœ ë¶„ì„ ë°ì´í„°:', analyticsData);

                document.getElementById('learner-info').textContent = `í˜„ì¬ ê¸°ê¸°ì˜ í•™ìŠµ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤ (ì´ ${analyticsData.length}ê°œ ì„¸ì…˜)`;
            } else {
                analyticsData = allLearners[currentLearnerId]?.data || [];
                const learner = allLearners[currentLearnerId];
                const learnerName = learner?.name || 'Unknown';
                const groupName = learner?.group || 'ê·¸ë£¹';
                console.log('[Analytics Console] Firebase ë°ì´í„°:', analyticsData);
                document.getElementById('learner-info').textContent = `${learnerName}_${groupName}ì˜ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤ (ì´ ${analyticsData.length}ê°œ ì„¸ì…˜)`;
            }

            loadAnalytics();
        }

        function loadAnalytics() {
            if (analyticsData.length === 0) {
                showEmptyState();
                return;
            }

            updateOverallStats();
            updateCompletionTypeStats();
            updateSubjectStats();
            updateRecentRecords();
            populateSubjectFilter();
        }

        function showEmptyState() {
            document.getElementById('total-sessions').textContent = '0';
            document.getElementById('avg-accuracy').textContent = '0%';
            document.getElementById('avg-time').textContent = '0ë¶„';
            document.getElementById('most-completion-type').textContent = '-';

            document.getElementById('recent-records').innerHTML = `
                <div class="text-center py-12 text-gray-400">
                    <div class="text-4xl mb-4">ğŸ“­</div>
                    <div class="text-lg font-medium">í•™ìŠµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="text-sm mt-2">í€´ì¦ˆë¥¼ í’€ë©´ ë¶„ì„ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            `;
        }

        function updateOverallStats() {
            const totalSessions = analyticsData.length;
            const totalAccuracy = analyticsData.reduce((sum, session) => sum + session.stats.accuracy, 0);
            const avgAccuracy = totalSessions > 0 ? Math.round(totalAccuracy / totalSessions) : 0;
            const totalTime = analyticsData.reduce((sum, session) => sum + session.stats.timeSpent, 0);
            const avgTime = totalSessions > 0 ? (totalTime / totalSessions).toFixed(1) : 0;

            // ê°€ì¥ ë§ì€ ì™„ë£Œ íƒ€ì…
            const typeCounts = {};
            analyticsData.forEach(session => {
                const type = session.completionType || 'unknown';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const mostCommonType = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])[0];

            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';
            document.getElementById('avg-time').textContent = avgTime + 'ë¶„';
            document.getElementById('most-completion-type').textContent =
                mostCommonType ? completionTypeNames[mostCommonType[0]] || mostCommonType[0] : '-';
        }

        function updateCompletionTypeStats() {
            const typeCounts = {
                'easy_only': 0,
                'medium_complete': 0,
                'hard_complete': 0,
                'mixed_15': 0
            };

            analyticsData.forEach(session => {
                const type = session.completionType;
                if (typeCounts.hasOwnProperty(type)) {
                    typeCounts[type]++;
                }
            });

            const total = analyticsData.length;

            document.getElementById('type-easy-only').textContent = typeCounts.easy_only;
            document.getElementById('type-easy-percent').textContent =
                total > 0 ? Math.round(typeCounts.easy_only / total * 100) + '%' : '0%';

            document.getElementById('type-medium-complete').textContent = typeCounts.medium_complete;
            document.getElementById('type-medium-percent').textContent =
                total > 0 ? Math.round(typeCounts.medium_complete / total * 100) + '%' : '0%';

            document.getElementById('type-hard-complete').textContent = typeCounts.hard_complete;
            document.getElementById('type-hard-percent').textContent =
                total > 0 ? Math.round(typeCounts.hard_complete / total * 100) + '%' : '0%';

            document.getElementById('type-mixed-15').textContent = typeCounts.mixed_15;
            document.getElementById('type-mixed-percent').textContent =
                total > 0 ? Math.round(typeCounts.mixed_15 / total * 100) + '%' : '0%';
        }

        function updateSubjectStats() {
            const subjectData = {};

            analyticsData.forEach(session => {
                const subject = session.subject;
                if (!subjectData[subject]) {
                    subjectData[subject] = {
                        sessions: 0,
                        totalAccuracy: 0,
                        totalTime: 0,
                        completionTypes: {},
                        maxDifficulty: 1
                    };
                }

                const data = subjectData[subject];
                data.sessions++;
                data.totalAccuracy += session.stats.accuracy;
                data.totalTime += session.stats.timeSpent;

                const type = session.completionType || 'unknown';
                data.completionTypes[type] = (data.completionTypes[type] || 0) + 1;

                // ìµœëŒ€ ë‚œì´ë„ í™•ì¸
                if (session.difficultyHistory && session.difficultyHistory.length > 0) {
                    const maxDiff = Math.max(...session.difficultyHistory.map(h => h.difficulty));
                    data.maxDifficulty = Math.max(data.maxDifficulty, maxDiff);
                }
            });

            const tableBody = document.getElementById('subject-stats-table');
            tableBody.innerHTML = '';

            Object.entries(subjectData).forEach(([subjectId, data]) => {
                const avgAccuracy = Math.round(data.totalAccuracy / data.sessions);
                const avgTime = (data.totalTime / data.sessions).toFixed(1);

                const mostCommonType = Object.entries(data.completionTypes)
                    .sort((a, b) => b[1] - a[1])[0];

                const difficultyBadge = data.maxDifficulty === 3 ?
                    '<span class="difficulty-tag difficulty-hard">ì–´ë ¤ì›€</span>' :
                    data.maxDifficulty === 2 ?
                    '<span class="difficulty-tag difficulty-medium">ë³´í†µ</span>' :
                    '<span class="difficulty-tag difficulty-easy">ì‰¬ì›€</span>';

                const row = `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <span class="font-medium">${subjects[subjectId]?.icon || ''} ${subjects[subjectId]?.name || subjectId}</span>
                        </td>
                        <td class="text-center py-3 px-4">${data.sessions}</td>
                        <td class="text-center py-3 px-4 font-medium text-green-600">${avgAccuracy}%</td>
                        <td class="text-center py-3 px-4">${avgTime}ë¶„</td>
                        <td class="text-center py-3 px-4 text-sm">${completionTypeNames[mostCommonType[0]] || '-'}</td>
                        <td class="text-center py-3 px-4">${difficultyBadge}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function updateRecentRecords() {
            const recentData = [...analyticsData].reverse().slice(0, 20);
            const container = document.getElementById('recent-records');
            container.innerHTML = '';

            recentData.forEach(session => {
                const completedDate = new Date(session.completedAt);
                const dateStr = completedDate.toLocaleString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const difficultyBadges = {
                    'easy_only': '<span class="difficulty-tag difficulty-easy">ì‰¬ì›€ ì „ìš©</span>',
                    'medium_complete': '<span class="difficulty-tag difficulty-medium">ë³´í†µ ì™„ë£Œ</span>',
                    'hard_complete': '<span class="difficulty-tag difficulty-hard">ì–´ë ¤ì›€ ì™„ë£Œ</span>',
                    'mixed_15': '<span class="difficulty-tag difficulty-medium">í˜¼í•© 15+</span>'
                };

                const record = `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-all" data-subject="${session.subject}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${subjects[session.subject]?.icon || 'ğŸ“š'}</span>
                                <div>
                                    <div class="font-bold text-gray-900">${session.subjectName || subjects[session.subject]?.name}</div>
                                    <div class="text-sm text-gray-600">${dateStr}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-2 mb-1">
                                    ${difficultyBadges[session.completionType] || ''}
                                </div>
                                <div class="text-sm text-gray-600">
                                    ì •ë‹µë¥  <span class="font-bold text-green-600">${session.stats.accuracy}%</span> Â·
                                    ${session.stats.totalAnswered}ë¬¸ì œ Â·
                                    ${session.stats.timeSpent}ë¶„
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ì‰¬ì›€ ${session.questionCounts.easy} / ë³´í†µ ${session.questionCounts.medium} / ì–´ë ¤ì›€ ${session.questionCounts.hard}
                                </div>
                            </div>
                        </div>
                        ${session.difficultyHistory && session.difficultyHistory.length > 0 ? `
                            <details class="mt-3">
                                <summary class="cursor-pointer text-sm text-blue-600 hover:text-blue-700">ë‚œì´ë„ ë³€í™” íˆìŠ¤í† ë¦¬ ë³´ê¸°</summary>
                                <div class="mt-2 space-y-1">
                                    ${session.difficultyHistory.map((h, i) => `
                                        <div class="text-xs text-gray-600 pl-4">
                                            ${i + 1}ë²ˆ ë¬¸ì œ: ${h.difficultyName} ${h.isCorrect ? 'âœ…' : 'âŒ'}
                                            ${h.consecutiveCorrect >= 3 ? 'ğŸ”¥ 3ì—°ì†' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
                container.innerHTML += record;
            });
        }

        function populateSubjectFilter() {
            const subjects_set = new Set(analyticsData.map(s => s.subject));
            const filterSelect = document.getElementById('filter-subject');

            subjects_set.forEach(subjectId => {
                const option = document.createElement('option');
                option.value = subjectId;
                option.textContent = subjects[subjectId]?.name || subjectId;
                filterSelect.appendChild(option);
            });
        }

        function filterRecords() {
            const selectedSubject = document.getElementById('filter-subject').value;
            const records = document.querySelectorAll('#recent-records > div');

            records.forEach(record => {
                if (selectedSubject === 'all' || record.dataset.subject === selectedSubject) {
                    record.style.display = 'block';
                } else {
                    record.style.display = 'none';
                }
            });
        }

        // === ê·¸ë£¹ ë¶„ì„ ê¸°ëŠ¥ ===
        let currentViewMode = 'personal'; // 'personal' or 'group'
        let selectedGroupId = null;

        // Firebase ì´ˆê¸°í™”
        async function initFirebase() {
            try {
                // Firebase ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                if (typeof firebase === 'undefined') {
                    console.log('[Analytics Console] Firebase not loaded yet, waiting...');
                    await new Promise((resolve) => {
                        let attempts = 0;
                        const checkFirebase = setInterval(() => {
                            attempts++;
                            if (typeof firebase !== 'undefined') {
                                clearInterval(checkFirebase);
                                resolve();
                            } else if (attempts > 50) { // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                                clearInterval(checkFirebase);
                                console.warn('[Analytics Console] Firebase load timeout');
                                resolve();
                            }
                        }, 100);
                    });
                }

                if (typeof firebase === 'undefined') {
                    console.warn('[Analytics Console] Firebase not available - ê·¸ë£¹ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
                    return;
                }

                // Firebaseê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (firebase.apps.length === 0) {
                    // firebase-config.jsê°€ ë¡œë“œë˜ì—ˆë‹¤ê³  ê°€ì •
                    if (typeof firebaseConfig !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                    } else {
                        console.warn('[Analytics Console] firebaseConfig not found');
                        return;
                    }
                }

                // window.firebase_db ì‚¬ìš© (firebase-integration.jsì™€ ê³µìœ )
                if (!window.firebase_db) {
                    window.firebase_db = firebase.database();
                }

                console.log('[Analytics Console] Firebase initialized');

                // social-hubì—ì„œ ì „ë‹¬ëœ ê·¸ë£¹ ID í™•ì¸
                const savedGroupId = localStorage.getItem('selectedGroupId');
                const savedGroupName = localStorage.getItem('selectedGroupName');

                if (savedGroupId && savedGroupName) {
                    selectedGroupId = savedGroupId;
                    switchToGroupView();
                    await loadUserGroups();
                    document.getElementById('group-select').value = selectedGroupId;
                    await loadGroupData();

                    localStorage.removeItem('selectedGroupId');
                    localStorage.removeItem('selectedGroupName');
                }
            } catch (error) {
                console.error('[Analytics Console] Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // ê°œì¸ ë·°ë¡œ ì „í™˜
        function switchToPersonalView() {
            currentViewMode = 'personal';
            selectedGroupId = null;

            document.getElementById('view-personal-btn').className = 'px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold';
            document.getElementById('view-group-btn').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold';

            document.getElementById('personal-selector').classList.remove('hidden');
            document.getElementById('group-selector').classList.add('hidden');

            loadLearnerData();
        }

        // ê·¸ë£¹ ë·°ë¡œ ì „í™˜
        function switchToGroupView() {
            currentViewMode = 'group';

            document.getElementById('view-personal-btn').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold';
            document.getElementById('view-group-btn').className = 'px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold';

            document.getElementById('personal-selector').classList.add('hidden');
            document.getElementById('group-selector').classList.remove('hidden');

            loadUserGroups();
        }

        // ì‚¬ìš©ì ê·¸ë£¹ ëª©ë¡ ë¡œë“œ
        async function loadUserGroups() {
            if (!window.firebase_db) {
                await initFirebase();
            }

            if (!window.firebase_db) {
                console.warn('[Analytics Console] Firebase ì´ˆê¸°í™” ì‹¤íŒ¨');
                return;
            }

            try {
                const firebaseIntegration = window.eduPetFirebaseIntegration;

                // Firebase Integrationì´ ì´ˆê¸°í™”ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                if (!firebaseIntegration || !firebaseIntegration.currentUser) {
                    console.log('[Analytics Console] Firebase Integration ëŒ€ê¸° ì¤‘...');
                    await new Promise((resolve) => {
                        let attempts = 0;
                        const checkIntegration = setInterval(() => {
                            attempts++;
                            if (window.eduPetFirebaseIntegration?.currentUser) {
                                clearInterval(checkIntegration);
                                resolve();
                            } else if (attempts > 30) { // 3ì´ˆ íƒ€ì„ì•„ì›ƒ
                                clearInterval(checkIntegration);
                                console.log('[Analytics Console] Firebase ì¸ì¦ íƒ€ì„ì•„ì›ƒ');
                                resolve();
                            }
                        }, 100);
                    });
                }

                // ì¸ì¦ ì‚¬ìš©ì í™•ì¸
                const currentIntegration = window.eduPetFirebaseIntegration;
                if (!currentIntegration || !currentIntegration.currentUser) {
                    document.getElementById('learner-info').textContent = 'Firebase ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤ (ê·¸ë£¹ ê¸°ëŠ¥ë§Œ ì˜í–¥ë°›ìŒ).';
                    console.log('[Analytics Console] Firebase ì‚¬ìš©ì ì¸ì¦ ì—†ìŒ - ê·¸ë£¹ ê¸°ëŠ¥ ë¹„í™œì„±í™”');
                    return;
                }

                const userId = currentIntegration.currentUser.uid;
                const groupsSnapshot = await window.firebase_db.ref(`users/${userId}/social/groups`).once('value');
                const myGroups = groupsSnapshot.val();

                const groupSelect = document.getElementById('group-select');
                groupSelect.innerHTML = '<option value="">ê·¸ë£¹ ì„ íƒ...</option>';

                if (!myGroups || Object.keys(myGroups).length === 0) {
                    groupSelect.innerHTML = '<option value="">ì°¸ì—¬í•œ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                    return;
                }

                for (const [groupId, groupInfo] of Object.entries(myGroups)) {
                    const option = document.createElement('option');
                    option.value = groupId;
                    option.textContent = groupInfo.name;
                    groupSelect.appendChild(option);
                }

                if (selectedGroupId) {
                    groupSelect.value = selectedGroupId;
                }
            } catch (error) {
                console.error('[Analytics Console] ê·¸ë£¹ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê·¸ë£¹ ë°ì´í„° ë¡œë“œ
        async function loadGroupData() {
            const groupSelect = document.getElementById('group-select');
            selectedGroupId = groupSelect.value;

            if (!selectedGroupId) {
                document.getElementById('learner-info').textContent = 'ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }

            try {
                const groupSnapshot = await window.firebase_db.ref(`groups/${selectedGroupId}`).once('value');
                const groupData = groupSnapshot.val();

                if (!groupData) {
                    alert('ê·¸ë£¹ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                document.getElementById('learner-info').innerHTML = `
                    <div class="font-semibold text-purple-700">
                        ğŸ¯ ${groupData.name} ê·¸ë£¹ (ë©¤ë²„ ${groupData.memberCount}ëª…)
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ê·¸ë£¹ ì „ì²´ ë©¤ë²„ì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.
                    </div>
                `;

                // ê·¸ë£¹ ë©¤ë²„ë“¤ì˜ ë¶„ì„ ë°ì´í„° ì§‘ê³„
                await aggregateGroupAnalytics(groupData);

            } catch (error) {
                console.error('[Analytics Console] ê·¸ë£¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê·¸ë£¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê·¸ë£¹ ë©¤ë²„ë“¤ì˜ ë¶„ì„ ë°ì´í„° ì§‘ê³„
        async function aggregateGroupAnalytics(groupData) {
            try {
                const members = groupData.members || {};
                const memberIds = Object.keys(members);

                let groupAnalyticsData = [];
                let totalSessions = 0;
                let totalCorrectAnswers = 0;
                let totalQuestions = 0;
                let subjectData = {};

                // ê° ë©¤ë²„ì˜ ë¶„ì„ ë°ì´í„° ìˆ˜ì§‘
                for (const memberId of memberIds) {
                    try {
                        const statsSnapshot = await window.firebase_db.ref(`users/${memberId}/stats`).once('value');
                        const memberStats = statsSnapshot.val();

                        if (memberStats) {
                            totalCorrectAnswers += memberStats.correctAnswers || 0;

                            // ê³¼ëª©ë³„ ë°ì´í„° ì§‘ê³„
                            if (memberStats.subjectScores) {
                                for (const [subject, score] of Object.entries(memberStats.subjectScores)) {
                                    if (!subjectData[subject]) {
                                        subjectData[subject] = {
                                            correctCount: 0,
                                            totalCount: 0,
                                            sessions: 0
                                        };
                                    }
                                    subjectData[subject].correctCount += score || 0;
                                    subjectData[subject].sessions++;
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`ë©¤ë²„ ${memberId} ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
                    }
                }

                // ê³¼ëª©ë³„ ì„¸ì…˜ ìƒì„± (ë¶„ì„ìš©)
                for (const [subjectId, data] of Object.entries(subjectData)) {
                    if (data.sessions > 0) {
                        const avgAccuracy = data.totalCount > 0 ? Math.round((data.correctCount / data.totalCount) * 100) : 0;

                        groupAnalyticsData.push({
                            subject: subjectId,
                            subjectName: subjects[subjectId]?.name || subjectId,
                            completionType: 'group_aggregate',
                            timestamp: Date.now(),
                            stats: {
                                accuracy: avgAccuracy,
                                totalAnswered: data.correctCount,
                                correctAnswers: data.correctCount,
                                wrongAnswers: data.totalCount - data.correctCount,
                                timeSpent: 0 // ê·¸ë£¹ ë°ì´í„°ì—ì„œëŠ” ì‹œê°„ ì •ë³´ ì—†ìŒ
                            },
                            questionCounts: {
                                easy: 0,
                                medium: 0,
                                hard: 0
                            },
                            difficultyHistory: []
                        });

                        totalSessions += data.sessions;
                    }
                }

                // ë¶„ì„ ë°ì´í„° ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
                analyticsData = groupAnalyticsData;

                // í†µê³„ ì—…ë°ì´íŠ¸
                updateAnalytics();

            } catch (error) {
                console.error('[Analytics Console] ê·¸ë£¹ ë¶„ì„ ë°ì´í„° ì§‘ê³„ ì‹¤íŒ¨:', error);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(analyticsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quiz-analytics-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert('âœ… ë¶„ì„ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');
        }

        function clearData() {
            if (confirm('âš ï¸ ëª¨ë“  ë¶„ì„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                localStorage.removeItem('quizAnalyticsHistory');
                alert('âœ… ë¶„ì„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Analytics Console] í˜ì´ì§€ ë¡œë“œ - ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹œì‘');

            // ë¡œì»¬ ë°ì´í„° ë¨¼ì € ë¡œë“œ (Firebase ì—†ì´ë„ ì‘ë™)
            loadLearnerData();

            // Firebase ì´ˆê¸°í™” (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ë¡œì»¬ ë°ì´í„°ëŠ” í‘œì‹œë¨)
            setTimeout(async () => {
                try {
                    await initFirebase();
                } catch (error) {
                    console.error('[Analytics Console] Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
                }
            }, 2000); // 2ì´ˆ í›„ Firebase ì´ˆê¸°í™” ì‹œë„ (Integrationì´ ë¨¼ì € ì´ˆê¸°í™”ë˜ë„ë¡)
        });
    </script>
</body>
</html>
