<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ í˜„í™© - EduPet Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ì‹ë¬¼ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ -->
    <script defer src="plant-system.js"></script>
    <script defer src="daily-reset.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .progress-card {
            transition: all 0.3s ease;
        }
        
        .progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .skill-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.8s ease;
        }
        
        .badge-glow {
            animation: badge-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes badge-glow {
            from { box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
            to { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); }
        }
        
        .streak-flame {
            animation: flame-flicker 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes flame-flicker {
            from { transform: scale(1) rotate(-1deg); }
            to { transform: scale(1.05) rotate(1deg); }
        }
        
        .achievement-unlock {
            animation: achievement-unlock 1s ease-out;
        }
        
        @keyframes achievement-unlock {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <button onclick="goHome()" class="absolute left-4 top-6 text-2xl hover:scale-110 transition-transform">
                ğŸ 
            </button>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“Š í•™ìŠµ í˜„í™©</h1>
            <div class="text-sm text-gray-600">
                ì´ˆë¡±ì´ë‹˜ì˜ í•™ìŠµ ì—¬ì •
            </div>
        </div>

        <!-- ì¼ì¼ í•™ìŠµ ì§„í–‰ë¥  (ì‹ë¬¼ ì‹œìŠ¤í…œ ì—°ë™) -->
        <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-xl shadow-lg p-6 mb-6 border-2 border-green-200">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸŒ± ì˜¤ëŠ˜ì˜ í•™ìŠµ ë¯¸ì…˜</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center bg-white rounded-lg p-4">
                    <div class="text-3xl font-bold text-green-600" id="daily-completed">0</div>
                    <div class="text-sm text-gray-500">ì™„ë£Œ ê³¼ëª© / 9</div>
                </div>
                <div class="text-center bg-white rounded-lg p-4">
                    <div class="text-3xl font-bold text-blue-600" id="growth-tickets-count">0</div>
                    <div class="text-sm text-gray-500">ì„±ì¥ê¶Œ</div>
                </div>
                <div class="text-center bg-white rounded-lg p-4">
                    <div class="text-3xl font-bold text-purple-600" id="ready-plants-count">0</div>
                    <div class="text-sm text-gray-500">ì„±ì¥ ì¤€ë¹„ ì‹ë¬¼</div>
                </div>
                <div class="text-center bg-white rounded-lg p-4">
                    <div class="text-sm text-gray-600 mb-1">ë‹¤ìŒ ë³´ìƒ</div>
                    <div class="text-xs font-bold text-green-600" id="next-reward-text">3ê³¼ëª© ë‹¬ì„±</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center justify-between text-sm mb-2">
                    <span class="text-gray-700">ì˜¤ëŠ˜ì˜ ì§„í–‰ë¥ </span>
                    <span class="font-bold text-green-600" id="daily-progress-percent">0%</span>
                </div>
                <div class="bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all" id="daily-progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Overall Stats -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ¯ ì „ì²´ í†µê³„</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="totalQuestions">0</div>
                    <div class="text-sm text-gray-500">ì´ ë¬¸ì œ ìˆ˜</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="correctAnswers">0</div>
                    <div class="text-sm text-gray-500">ì •ë‹µ ìˆ˜</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="accuracyRate">0%</div>
                    <div class="text-sm text-gray-500">ì •ë‹µë¥ </div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center space-x-1">
                        <span class="text-2xl streak-flame" id="streakEmoji">ğŸ”¥</span>
                        <span class="text-2xl font-bold text-orange-600" id="streakDays">0</span>
                    </div>
                    <div class="text-sm text-gray-500">ì—°ì† í•™ìŠµì¼</div>
                </div>
            </div>
        </div>

        <!-- Subject Progress -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“š ê³¼ëª©ë³„ ì§„í–‰ë¥ </h2>
            <div id="subjectProgress" class="space-y-4">
                <!-- Subject progress bars will be inserted here -->
            </div>
        </div>

        <!-- Daily Learning Activity -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“… ìµœê·¼ í•™ìŠµ í™œë™</h2>
            <div class="grid grid-cols-7 gap-2 text-center">
                <div class="text-xs text-gray-500">ì›”</div>
                <div class="text-xs text-gray-500">í™”</div>
                <div class="text-xs text-gray-500">ìˆ˜</div>
                <div class="text-xs text-gray-500">ëª©</div>
                <div class="text-xs text-gray-500">ê¸ˆ</div>
                <div class="text-xs text-gray-500">í† </div>
                <div class="text-xs text-gray-500">ì¼</div>
                
                <div id="weeklyActivity" class="contents">
                    <!-- Weekly activity cells will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ† ì„±ì·¨ ë±ƒì§€</h2>
            <div id="achievementGrid" class="grid grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Achievement badges will be inserted here -->
            </div>
        </div>

        <!-- Learning Recommendations -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ’¡ í•™ìŠµ ì¶”ì²œ</h2>
            <div id="recommendations" class="space-y-3">
                <!-- Recommendations will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Achievement definitions
        const achievements = {
            first_correct: {
                id: 'first_correct',
                name: 'ì²« ë°œê±¸ìŒ',
                description: 'ì²« ë²ˆì§¸ ì •ë‹µ',
                emoji: 'ğŸ‘¶',
                requirement: 1,
                type: 'correct_answers'
            },
            streak_3: {
                id: 'streak_3',
                name: 'ê¾¸ì¤€í•¨ì˜ ì‹œì‘',
                description: '3ì¼ ì—°ì† í•™ìŠµ',
                emoji: 'ğŸŒ±',
                requirement: 3,
                type: 'streak_days'
            },
            streak_7: {
                id: 'streak_7',
                name: 'ì¼ì£¼ì¼ ì±Œë¦°ì €',
                description: '7ì¼ ì—°ì† í•™ìŠµ',
                emoji: 'ğŸ”¥',
                requirement: 7,
                type: 'streak_days'
            },
            streak_30: {
                id: 'streak_30',
                name: 'í•œ ë‹¬ ë§ˆìŠ¤í„°',
                description: '30ì¼ ì—°ì† í•™ìŠµ',
                emoji: 'ğŸ’',
                requirement: 30,
                type: 'streak_days'
            },
            correct_25: {
                id: 'correct_25',
                name: 'ì‹¤ë ¥ì',
                description: '25ê°œ ì •ë‹µ',
                emoji: 'â­',
                requirement: 25,
                type: 'correct_answers'
            },
            correct_100: {
                id: 'correct_100',
                name: 'ë°±ì  ë§Œì ',
                description: '100ê°œ ì •ë‹µ',
                emoji: 'ğŸŒŸ',
                requirement: 100,
                type: 'correct_answers'
            },
            accuracy_90: {
                id: 'accuracy_90',
                name: 'ì •í™•ë„ ë§ˆìŠ¤í„°',
                description: 'ì •ë‹µë¥  90% ì´ìƒ',
                emoji: 'ğŸ¯',
                requirement: 90,
                type: 'accuracy'
            },
            all_subjects: {
                id: 'all_subjects',
                name: 'ë§ŒëŠ¥ í•™ìŠµì',
                description: 'ëª¨ë“  ê³¼ëª© í•™ìŠµ',
                emoji: 'ğŸ§ ',
                requirement: 10,
                type: 'subjects_studied'
            }
        };

        // Subject configuration
        const subjects = {
            english: { name: 'ì˜ì–´', emoji: 'ğŸ‡ºğŸ‡¸', color: 'blue' },
            math: { name: 'ìˆ˜í•™', emoji: 'ğŸ”¢', color: 'green' },
            science: { name: 'ê³¼í•™', emoji: 'ğŸ”¬', color: 'purple' },
            korean: { name: 'êµ­ì–´', emoji: 'ğŸ‡°ğŸ‡·', color: 'red' },
            social: { name: 'ì‚¬íšŒ', emoji: 'ğŸŒ', color: 'yellow' },
            common: { name: 'ìƒì‹', emoji: 'ğŸ§©', color: 'indigo' },
            idiom: { name: 'ì‚¬ìì„±ì–´', emoji: 'ğŸ“œ', color: 'pink' },
            person: { name: 'ì¸ë¬¼', emoji: 'ğŸ‘¥', color: 'teal' },
            economy: { name: 'ê²½ì œ', emoji: 'ğŸ’°', color: 'orange' },
            production: { name: 'ìƒì‚°', emoji: 'ğŸ­', color: 'cyan' },
            toeic: { name: 'TOEIC', emoji: 'ğŸ“–', color: 'violet' },
            ai: { name: 'AI', emoji: 'ğŸ¤–', color: 'slate' }
        };

        // Game state
        let progressData = {
            totalQuestions: 0,
            correctAnswers: 0,
            subjectStats: {},
            dailyActivity: {},
            streakDays: 0,
            lastStudyDate: null,
            unlockedAchievements: [],
            studyStartDate: Date.now()
        };

                async function loadProgressData() {
                    // 1. Try to load from Firebase
                    let firebaseProgress = null;
                    if (window.eduPetFirebaseIntegration && eduPetFirebaseIntegration.isConnected()) {
                        firebaseProgress = await eduPetFirebaseIntegration.loadLearningProgress();
                    }

                    // 2. Load from localStorage (as fallback or base)
                    const saved = localStorage.getItem('learningProgress');
                    let localProgress = progressData; // Default empty progressData
                    if (saved) {
                        localProgress = { ...progressData, ...JSON.parse(saved) };
                    }

                    // 3. Decide which data to use and merge
                    if (firebaseProgress) {
                        // If Firebase data is newer, use it and update localStorage
                        if (!localProgress.lastUpdated || firebaseProgress.lastUpdated >= localProgress.lastUpdated) {
                            progressData = { ...localProgress, ...firebaseProgress };
                            localStorage.setItem('learningProgress', JSON.stringify(progressData));
                        } else {
                            // Local data is newer, so use it and push it to Firebase
                            progressData = localProgress;
                            if(window.eduPetFirebaseIntegration) {
                                eduPetFirebaseIntegration.saveLearningProgress(progressData);
                            }
                        }
                    } else {
                        // No Firebase data, just use local
                        progressData = localProgress;
                    }

                    // Ensure all subject stats objects exist
                    Object.keys(subjects).forEach(subjectId => {
                        if (!progressData.subjectStats[subjectId]) {
                            progressData.subjectStats[subjectId] = {
                                questions: 0,
                                correct: 0,
                                lastStudied: null,
                                level: 1,
                                experience: 0
                            };
                        }
                    });

                    // ì‹ë¬¼ ì‹œìŠ¤í…œ ì—°ë™
                    updatePlantSystemDisplay();

                    updateProgressDisplay();
                }

                // ì‹ë¬¼ ì‹œìŠ¤í…œ ì§„í–‰ë¥  í‘œì‹œ
                function updatePlantSystemDisplay() {
                    // plantSystemì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (typeof plantSystem === 'undefined') {
                        setTimeout(updatePlantSystemDisplay, 500);
                        return;
                    }

                    try {
                        const user = plantSystem.getUserData();
                        const dashboard = plantSystem.getDashboardState(user.userId);
                        const plants = plantSystem.getUserPlants(user.userId);

                        // ì¼ì¼ ì™„ë£Œ ê³¼ëª©
                        document.getElementById('daily-completed').textContent = dashboard.learning.completedCount;

                        // ì§„í–‰ë¥  %
                        const percent = Math.round((dashboard.learning.completedCount / 9) * 100);
                        document.getElementById('daily-progress-percent').textContent = percent + '%';
                        document.getElementById('daily-progress-bar').style.width = percent + '%';

                        // ì„±ì¥ê¶Œ
                        document.getElementById('growth-tickets-count').textContent = dashboard.tickets.growthTickets;

                        // ì„±ì¥ ì¤€ë¹„ ì‹ë¬¼
                        const readyPlants = plants.filter(p => p.status === 'READY');
                        document.getElementById('ready-plants-count').textContent = readyPlants.length;

                        // ë‹¤ìŒ ë³´ìƒ
                        const nextReward = dashboard.learning.nextReward;
                        document.getElementById('next-reward-text').textContent =
                            nextReward.remaining > 0 ? `${nextReward.remaining}ê³¼ëª© ë‚¨ìŒ` : nextReward.message;

                    } catch (error) {
                        console.error('ì‹ë¬¼ ì‹œìŠ¤í…œ ì—°ë™ ì˜¤ë¥˜:', error);
                    }
                }
        
                function saveProgressData() {
                    localStorage.setItem('learningProgress', JSON.stringify(progressData));
                    // Also save to firebase
                    if (window.eduPetFirebaseIntegration && eduPetFirebaseIntegration.isConnected()) {
                        eduPetFirebaseIntegration.saveLearningProgress(progressData);
                    }
                }
        function updateProgressDisplay() {
            updateOverallStats();
            updateSubjectProgress();
            updateWeeklyActivity();
            updateAchievements();
            updateRecommendations();
        }

        function updateOverallStats() {
            document.getElementById('totalQuestions').textContent = progressData.totalQuestions;
            document.getElementById('correctAnswers').textContent = progressData.correctAnswers;
            
            const accuracy = progressData.totalQuestions > 0 
                ? Math.round((progressData.correctAnswers / progressData.totalQuestions) * 100)
                : 0;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
            
            // Update streak
            updateStreakDays();
            document.getElementById('streakDays').textContent = progressData.streakDays;
        }

        function updateStreakDays() {
            const today = new Date().toDateString();
            const lastStudy = progressData.lastStudyDate ? new Date(progressData.lastStudyDate).toDateString() : null;
            
            if (lastStudy === today) {
                // Already studied today, maintain streak
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastStudy === yesterdayStr) {
                // Studied yesterday, can continue streak if study today
                // This will be handled when actually studying
            } else if (lastStudy && lastStudy !== today) {
                // Streak broken
                progressData.streakDays = 0;
            }
        }

        function updateSubjectProgress() {
            const container = document.getElementById('subjectProgress');
            container.innerHTML = '';

            Object.keys(subjects).forEach(subjectId => {
                const subject = subjects[subjectId];
                const stats = progressData.subjectStats[subjectId];
                
                const accuracy = stats.questions > 0 ? Math.round((stats.correct / stats.questions) * 100) : 0;
                const level = Math.floor(stats.experience / 100) + 1;
                const expProgress = stats.experience % 100;
                
                const card = document.createElement('div');
                card.className = 'progress-card bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-all';
                card.onclick = () => startSubjectQuiz(subjectId);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${subject.emoji}</span>
                            <div>
                                <div class="font-bold text-gray-800">${subject.name}</div>
                                <div class="text-sm text-gray-600">Lv.${level} (${stats.correct}/${stats.questions})</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-${subject.color}-600">${accuracy}%</div>
                            <div class="text-xs text-gray-500">ì •ë‹µë¥ </div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                        <div class="skill-bar h-2 rounded-full" style="width: ${expProgress}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 text-right">${expProgress}/100 EXP</div>
                `;
                
                container.appendChild(card);
            });
        }

        function updateWeeklyActivity() {
            const container = document.getElementById('weeklyActivity');
            container.innerHTML = '';
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                
                const hasActivity = progressData.dailyActivity[dateStr] > 0;
                const activityLevel = progressData.dailyActivity[dateStr] || 0;
                
                let bgColor = 'bg-gray-100';
                if (activityLevel > 0) {
                    if (activityLevel >= 20) bgColor = 'bg-green-500';
                    else if (activityLevel >= 10) bgColor = 'bg-green-400';
                    else if (activityLevel >= 5) bgColor = 'bg-green-300';
                    else bgColor = 'bg-green-200';
                }
                
                const cell = document.createElement('div');
                cell.className = `w-8 h-8 ${bgColor} rounded text-xs flex items-center justify-center text-white font-bold`;
                cell.textContent = activityLevel || '';
                cell.title = `${date.toLocaleDateString()} - ${activityLevel}ë¬¸ì œ`;
                
                container.appendChild(cell);
            }
        }

        function updateAchievements() {
            const container = document.getElementById('achievementGrid');
            container.innerHTML = '';

            Object.values(achievements).forEach(achievement => {
                const isUnlocked = checkAchievementUnlocked(achievement);
                
                const badge = document.createElement('div');
                badge.className = `text-center p-3 rounded-lg transition-all ${
                    isUnlocked 
                        ? 'bg-yellow-100 border-2 border-yellow-400 badge-glow cursor-pointer' 
                        : 'bg-gray-100 border-2 border-gray-300 opacity-50'
                }`;
                
                badge.innerHTML = `
                    <div class="text-3xl mb-1">${isUnlocked ? achievement.emoji : 'ğŸ”’'}</div>
                    <div class="text-xs font-bold ${isUnlocked ? 'text-yellow-800' : 'text-gray-500'}">${achievement.name}</div>
                    <div class="text-xs ${isUnlocked ? 'text-yellow-600' : 'text-gray-400'}">${achievement.description}</div>
                `;
                
                if (isUnlocked) {
                    badge.onclick = () => showAchievementDetail(achievement);
                }
                
                container.appendChild(badge);
            });
        }

        function checkAchievementUnlocked(achievement) {
            switch (achievement.type) {
                case 'correct_answers':
                    return progressData.correctAnswers >= achievement.requirement;
                case 'streak_days':
                    return progressData.streakDays >= achievement.requirement;
                case 'accuracy':
                    const accuracy = progressData.totalQuestions > 0 
                        ? (progressData.correctAnswers / progressData.totalQuestions) * 100 
                        : 0;
                    return accuracy >= achievement.requirement;
                case 'subjects_studied':
                    const studiedSubjects = Object.values(progressData.subjectStats)
                        .filter(stats => stats.questions > 0).length;
                    return studiedSubjects >= achievement.requirement;
                default:
                    return false;
            }
        }

        function showAchievementDetail(achievement) {
            alert(`ğŸ† ${achievement.name}\n\n${achievement.description}\n\nì¶•í•˜í•©ë‹ˆë‹¤! ì´ ë±ƒì§€ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤.`);
        }

        function updateRecommendations() {
            const container = document.getElementById('recommendations');
            const recommendations = generateRecommendations();
            
            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                    <span class="text-2xl">${rec.emoji}</span>
                    <div class="flex-1">
                        <div class="font-bold text-blue-800">${rec.title}</div>
                        <div class="text-sm text-blue-600">${rec.description}</div>
                    </div>
                    ${rec.action ? `
                        <button onclick="${rec.action}" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                            ì‹œì‘
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function generateRecommendations() {
            const recommendations = [];
            
            // Find weakest subject
            let weakestSubject = null;
            let lowestAccuracy = 100;
            
            Object.keys(subjects).forEach(subjectId => {
                const stats = progressData.subjectStats[subjectId];
                if (stats.questions >= 5) {
                    const accuracy = (stats.correct / stats.questions) * 100;
                    if (accuracy < lowestAccuracy) {
                        lowestAccuracy = accuracy;
                        weakestSubject = subjectId;
                    }
                }
            });
            
            if (weakestSubject && lowestAccuracy < 70) {
                recommendations.push({
                    emoji: 'ğŸ“ˆ',
                    title: `${subjects[weakestSubject].name} ë³µìŠµ ì¶”ì²œ`,
                    description: `ì •ë‹µë¥  ${Math.round(lowestAccuracy)}%ë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤`,
                    action: `startSubjectQuiz('${weakestSubject}')`
                });
            }
            
            // Streak recommendations
            if (progressData.streakDays === 0) {
                recommendations.push({
                    emoji: 'ğŸ”¥',
                    title: 'ì—°ì† í•™ìŠµ ì‹œì‘í•˜ê¸°',
                    description: 'ë§¤ì¼ ì¡°ê¸ˆì”© í•™ìŠµí•˜ì—¬ ì—°ì† ê¸°ë¡ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”',
                    action: `window.location.href='subject-select.html'`
                });
            } else if (progressData.streakDays < 7) {
                recommendations.push({
                    emoji: 'ğŸ¯',
                    title: 'ì¼ì£¼ì¼ ì±Œë¦°ì§€',
                    description: `í˜„ì¬ ${progressData.streakDays}ì¼ì§¸! ì¼ì£¼ì¼ ì—°ì† í•™ìŠµì„ ëª©í‘œë¡œ í•´ë³´ì„¸ìš”`,
                });
            }
            
            // New subject recommendation
            const unstudiedSubjects = Object.keys(subjects).filter(id => 
                progressData.subjectStats[id].questions === 0
            );
            
            if (unstudiedSubjects.length > 0) {
                const randomSubject = unstudiedSubjects[Math.floor(Math.random() * unstudiedSubjects.length)];
                recommendations.push({
                    emoji: 'ğŸŒŸ',
                    title: `ìƒˆë¡œìš´ ê³¼ëª© ë„ì „: ${subjects[randomSubject].name}`,
                    description: 'ì•„ì§ ì‹œë„í•˜ì§€ ì•Šì€ ê³¼ëª©ì— ë„ì „í•´ë³´ì„¸ìš”',
                    action: `startSubjectQuiz('${randomSubject}')`
                });
            }
            
            return recommendations;
        }

        function startSubjectQuiz(subjectId) {
            localStorage.setItem('selectedSubjects', JSON.stringify([subjectId]));
            localStorage.setItem('currentSubjectIndex', '0');
            window.location.href = 'quiz-adaptive.html';
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Simulate progress update (for demo)
        function addProgress(subject, correct, total) {
            const stats = progressData.subjectStats[subject];
            stats.questions += total;
            stats.correct += correct;
            stats.experience += correct * 10;
            stats.lastStudied = Date.now();
            
            progressData.totalQuestions += total;
            progressData.correctAnswers += correct;
            
            // Update daily activity
            const today = new Date().toDateString();
            progressData.dailyActivity[today] = (progressData.dailyActivity[today] || 0) + total;
            
            // Update streak
            if (!progressData.lastStudyDate || new Date(progressData.lastStudyDate).toDateString() !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (progressData.lastStudyDate && new Date(progressData.lastStudyDate).toDateString() === yesterday.toDateString()) {
                    progressData.streakDays++;
                } else {
                    progressData.streakDays = 1;
                }
                
                progressData.lastStudyDate = Date.now();
            }
            
            saveProgressData();
            updateProgressDisplay();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Firebase first
            if (window.eduPetFirebaseIntegration) {
                await eduPetFirebaseIntegration.initialize();
            }
            
            await loadProgressData(); // now it's async
            
            // Auto-refresh every 30 seconds
            setInterval(loadProgressData, 30000);
        });

        // For testing - remove in production
        window.addTestProgress = function() {
            addProgress('english', 8, 10);
            addProgress('math', 7, 10);
            addProgress('science', 9, 10);
        };
    </script>
</body>
</html>