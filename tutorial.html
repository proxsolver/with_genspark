<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPet Collection 시작하기</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Plant System & Firebase Integration -->
    <script src="plant-system.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-integration.js"></script>
    <script src="firebase-auth.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .tutorial-slide {
            transition: all 0.5s ease;
            min-height: 500px;
        }
        
        .slide-enter {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .floating-icon {
            animation: float 2s ease-in-out infinite alternate;
        }
        
        @keyframes float {
            from { transform: translateY(0px); }
            to { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Progress Bar -->
        <div class="mb-6">
            <div class="bg-gray-200 rounded-full h-2 mb-2">
                <div id="progressBar" class="progress-bar bg-blue-500 h-2 rounded-full" style="width: 16.67%"></div>
            </div>
            <div class="text-center text-sm text-gray-600">
                <span id="currentStep">1</span> / <span id="totalSteps"></span>
            </div>
        </div>

        <!-- Tutorial Slides -->
        <div id="tutorialContainer" class="bg-white rounded-xl shadow-lg p-6">
            <!-- Slide 1: Welcome -->
            <div id="slide1" class="tutorial-slide">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🌱</div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">EduPet Collection에<br>오신 것을 환영합니다!</h1>
                    <div class="text-gray-600 mb-6 space-y-2">
                        <p>학습하며 식물을 키우고</p>
                        <p>귀여운 동물들을 수집하는</p>
                        <p>교육 게임입니다</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="text-sm text-blue-700">
                            <div class="flex items-center justify-center space-x-2 mb-2">
                                <span>📚</span>
                                <span>→</span>
                                <span>🌱</span>
                                <span>→</span>
                                <span>🦎</span>
                                <span>→</span>
                                <span>🛡️</span>
                            </div>
                            <div class="font-medium">학습 → 성장 → 수집 → 보호</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 2: Grade Selection -->
            <div id="slide2" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🎓</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">학년을 선택해주세요</h2>
                    <div class="text-gray-600 mb-6">
                        <p class="mb-4">학년에 맞는 난이도로 문제가 제공됩니다.</p>
                        <p class="text-sm text-blue-600">💡 나중에 설정에서 변경할 수 있어요!</p>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <button onclick="selectGrade(1)" id="grade-1-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🌰</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">1학년</div>
                            <div class="text-xs text-gray-600">기초</div>
                        </button>

                        <button onclick="selectGrade(2)" id="grade-2-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🌱</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">2학년</div>
                            <div class="text-xs text-gray-600">쉬움</div>
                        </button>

                        <button onclick="selectGrade(3)" id="grade-3-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🪴</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">3학년</div>
                            <div class="text-xs text-gray-600">보통</div>
                        </button>

                        <button onclick="selectGrade(4)" id="grade-4-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🌳</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">4학년</div>
                            <div class="text-xs text-gray-600">표준</div>
                        </button>

                        <button onclick="selectGrade(5)" id="grade-5-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🌲</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">5학년</div>
                            <div class="text-xs text-gray-600">어려움</div>
                        </button>

                        <button onclick="selectGrade(6)" id="grade-6-btn"
                                class="grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="text-4xl mb-2">🌺</div>
                            <div class="text-lg font-bold text-gray-800 mb-1">6학년</div>
                            <div class="text-xs text-gray-600">고급</div>
                        </button>
                    </div>

                    <div id="grade-selection-message" class="text-sm text-green-600 font-medium hidden">
                        ✅ 선택 완료! 다음 버튼을 눌러주세요
                    </div>
                </div>
            </div>

            <!-- Slide 3: Learning -->
            <div id="slide3" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">📚</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">1단계: 학습하기</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="bg-yellow-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🎯</span>
                                <span class="font-medium">과목 완료하기</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                10개 과목 중 하나를 선택해<br>
                                퀴즈를 완료하세요!
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🎁</span>
                                <span class="font-medium">보상 받기</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                • 3과목 완료: 성장권 1장<br>
                                • 5과목 완료: 일반 뽑기권 1장<br>
                                • 6과목 완료: 성장권 1장 추가<br>
                                • 9과목 완료: 프리미엄 뽑기권 1장!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 4: Farming -->
            <div id="slide4" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🌱</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">2단계: 식물 키우기</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="bg-green-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🌰</span>
                                <span class="font-medium">씨앗 심고 물주기</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                화분에 씨앗을 심고<br>
                                20번의 물을 주세요!
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">⏰</span>
                                <span class="font-medium">24시간 기다리기</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                물 20개 + 24시간 경과하면<br>
                                식물이 성장 준비 완료!
                            </div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🎫</span>
                                <span class="font-medium">성장권 사용</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                학습으로 얻은 성장권으로<br>
                                식물을 즉시 성장시키세요!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 5: Collection -->
            <div id="slide5" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🦎</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">3단계: 동물 수집</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="bg-blue-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🎫</span>
                                <span class="font-medium">일반 뽑기</span>
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                5과목 완료 시 획득!
                            </div>
                            <div class="grid grid-cols-2 gap-1 text-xs">
                                <div>일반 60%</div>
                                <div>레어 30%</div>
                                <div>에픽 9%</div>
                                <div>전설 1%</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 text-left border-2 border-purple-200">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">✨</span>
                                <span class="font-medium text-purple-800">프리미엄 뽑기</span>
                            </div>
                            <div class="text-sm text-purple-700 mb-2">
                                9과목 완료 시 획득!
                            </div>
                            <div class="grid grid-cols-2 gap-1 text-xs text-purple-700">
                                <div>에픽 90%</div>
                                <div>전설 10%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 6: Daily System -->
            <div id="slide6" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">📅</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">4단계: 매일 새로운 시작</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="bg-green-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🔄</span>
                                <span class="font-medium">일일 초기화</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                매일 새벽 4시에 과목 진행도가<br>
                                초기화되어 다시 도전할 수 있어요!
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">⏰</span>
                                <span class="font-medium">성장권 유효기간</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                성장권은 24시간 후 만료되니<br>
                                빠르게 사용하세요!
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-left">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-2xl">🎯</span>
                                <span class="font-medium">꾸준한 학습</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                매일 조금씩 학습하면<br>
                                식물도 자라고 동물도 모을 수 있어요!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 7: Nickname Input -->
            <div id="slide7" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">👤</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">나만의 별명을 만들어보세요!</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="text-sm text-gray-600 mb-4">
                            별명을 설정하면 친구들과 순위표에서<br>
                            더 재미있게 소통할 수 있어요!
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-center space-x-2 mb-3">
                                <span class="text-2xl">🌐</span>
                                <span class="font-medium text-blue-800">소셜 기능 미리보기</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-blue-700">
                                <div>🏆 실시간 순위표</div>
                                <div>👥 친구 추가</div>
                                <div>🐾 동물 자랑하기</div>
                                <div>🎯 학습 그룹</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <input 
                                type="text" 
                                id="nicknameInput" 
                                placeholder="2-10자 사이로 입력하세요" 
                                maxlength="10"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-center text-lg"
                            >
                            <div class="text-xs text-gray-500 space-y-1">
                                <div>💡 나중에 소셜 허브에서 언제든 변경할 수 있어요!</div>
                                <div id="nicknameError" class="text-red-500 hidden"></div>
                                <div id="nicknameSuccess" class="text-green-600 hidden"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="setNicknameBtn" onclick="setUserNickname()" class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors">
                            ✨ 별명 설정하기
                        </button>

                        <button onclick="skipNickname()" class="w-full px-6 py-2 text-gray-500 hover:text-gray-700 transition-colors text-sm">
                            건너뛰기 (나중에 설정)
                        </button>

                        <div class="text-xs text-gray-500 text-center mt-4">
                            💡 구글 계정 연동은 소셜 허브에서 가능합니다
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide 8: Avatar Selection -->
            <div id="slide8" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🐾</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">나만의 대표 동물을 선택하세요!</h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="text-sm text-gray-600 mb-4">
                            선택한 동물은 프로필과 순위표에 표시됩니다.<br>
                            나중에 소셜 허브에서 언제든 변경할 수 있어요!
                        </div>
                        
                        <div id="avatar-selection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px;">
                            <!-- 동물 아바타 목록이 동적으로 추가됨 -->
                        </div>
                        <div id="avatarError" class="text-red-500 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Slide 9: Start -->
            <div id="slide9" class="tutorial-slide hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4 floating-icon">🎉</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <span id="welcomeMessage">이제 시작해보세요!</span>
                    </h2>
                    <div class="text-gray-600 mb-6 space-y-3">
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm text-green-700 space-y-1">
                                <div class="font-medium mb-2">🎁 시작 보너스</div>
                                <div>💰 초기 자금: 100원</div>
                                <div>🎫 프리미엄 뽑기권: 1장</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            언제든지 도움이 필요하면<br>
                            각 페이지의 안내를 확인하세요!
                        </div>
                    </div>
                    <button onclick="completeOnboarding()" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition-colors pulse-glow">
                        🚀 EduPet 세계로 출발!
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center space-x-4 mt-6">
            <button id="prevBtn" onclick="prevSlide()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                ← 이전
            </button>
            <button id="skipBtn" onclick="completeOnboarding()" class="px-4 py-2 text-gray-500 hover:text-gray-700 transition-colors">
                건너뛰기
            </button>
            <button id="nextBtn" onclick="nextSlide()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                다음 →
            </button>
        </div>
    </div>

    <script>
        let currentSlide = 1;
        const totalSlides = 9;
        let tempSelectedAvatar = null; // 임시 선택된 아바타
        let selectedGrade = null; // 선택된 학년

        // 사용 가능한 동물 아바타 목록 (social-hub.html에서 가져옴)
        const availableAvatars = [
            { id: 'bunny', emoji: '🐰', name: '토끼' },
            { id: 'cat', emoji: '🐱', name: '고양이' },
            { id: 'dog', emoji: '🐶', name: '강아지' },
            { id: 'fox', emoji: '🦊', name: '여우' },
            { id: 'lion', emoji: '🦁', name: '사자' },
            { id: 'tiger', emoji: '🐅', name: '호랑이' },
            { id: 'bear', emoji: '🐻', name: '곰' },
            { id: 'panda', emoji: '🐼', name: '판다' },
            { id: 'koala', emoji: '🐨', name: '코알라' },
            { id: 'monkey', emoji: '🐵', name: '원숭이' },
            { id: 'elephant', emoji: '🐘', name: '코끼리' },
            { id: 'giraffe', emoji: '🦒', name: '기린' },
            { id: 'zebra', emoji: '🦓', name: '얼룩말' },
            { id: 'horse', emoji: '🐎', name: '말' },
            { id: 'cow', emoji: '🐄', name: '소' },
            { id: 'pig', emoji: '🐷', name: '돼지' },
            { id: 'sheep', emoji: '🐑', name: '양' },
            { id: 'chicken', emoji: '🐔', name: '닭' },
            { id: 'penguin', emoji: '🐧', name: '펭귄' },
            { id: 'owl', emoji: '🦉', name: '올빼미' }
        ];

        function updateUI() {
            // Hide all slides
            for (let i = 1; i <= totalSlides; i++) {
                document.getElementById(`slide${i}`).classList.add('hidden');
            }
            
            // Show current slide with animation
            const currentSlideEl = document.getElementById(`slide${currentSlide}`);
            currentSlideEl.classList.remove('hidden');
            currentSlideEl.classList.add('slide-enter');
            
            setTimeout(() => {
                currentSlideEl.classList.remove('slide-enter');
            }, 500);
            
            // Update progress
            document.getElementById('progressBar').style.width = `${(currentSlide / totalSlides) * 100}%`;
            document.getElementById('currentStep').textContent = currentSlide;
            document.getElementById('totalSteps').textContent = totalSlides;
            
            // Update buttons
            document.getElementById('prevBtn').disabled = currentSlide === 1;
            const nextBtn = document.getElementById('nextBtn');
            if (currentSlide === totalSlides) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'block';
            }

            // Load avatar selection when on slide 8
            if (currentSlide === 8) {
                loadAvatarSelection();
            }
        }

        // 학년 선택 함수
        function selectGrade(grade) {
            selectedGrade = grade;
            localStorage.setItem('userGrade', grade.toString());

            // 모든 학년 버튼 스타일 초기화
            for (let i = 1; i <= 6; i++) {
                const btn = document.getElementById(`grade-${i}-btn`);
                if (btn) {
                    btn.className = 'grade-btn p-4 border-4 border-gray-300 rounded-xl hover:border-blue-500 transition-all transform hover:scale-105';
                }
            }

            // 선택된 버튼 하이라이트
            const selectedBtn = document.getElementById(`grade-${grade}-btn`);
            if (selectedBtn) {
                selectedBtn.className = 'grade-btn p-4 border-4 border-blue-500 bg-blue-50 rounded-xl transition-all transform scale-105';
            }

            // 선택 완료 메시지 표시
            document.getElementById('grade-selection-message').classList.remove('hidden');

            console.log(`✅ 학년 선택 완료: ${grade}학년`);
        }

        function nextSlide() {
            if (currentSlide < totalSlides) {
                currentSlide++;
                updateUI();
            }
        }

        function prevSlide() {
            if (currentSlide > 1) {
                currentSlide--;
                updateUI();
            }
        }

        // 아바타 선택 UI 로드 (social-hub.html에서 가져옴)
        function loadAvatarSelection() {
            const avatarContainer = document.getElementById('avatar-selection');
            if (!avatarContainer) return;

            // 기본 아바타 설정 (토끼)
            if (!tempSelectedAvatar) {
                tempSelectedAvatar = 'bunny';
            }

            const html = availableAvatars.map(avatar => {
                const isSelected = avatar.id === tempSelectedAvatar;
                return `
                    <div id="avatar-${avatar.id}" onclick="selectAvatarTemp('${avatar.id}')" style="
                        padding: 15px;
                        background: ${isSelected ? '#007bff' : 'white'};
                        border: 2px solid ${isSelected ? '#007bff' : '#dee2e6'};
                        border-radius: 10px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s;
                        ${isSelected ? 'transform: scale(1.1);' : ''}
                    " onmouseover="this.style.borderColor='#007bff'" onmouseout="if('${avatar.id}' !== '${tempSelectedAvatar}') this.style.borderColor='#dee2e6'">
                        <div style="font-size: 2rem; margin-bottom: 5px;">${avatar.emoji}</div>
                        <div style="font-size: 0.75rem; color: ${isSelected ? 'white' : '#495057'}; font-weight: ${isSelected ? 'bold' : 'normal'};">${avatar.name}</div>
                    </div>
                `;
            }).join('');

            avatarContainer.innerHTML = html;
        }

        // 아바타 임시 선택
        function selectAvatarTemp(avatarId) {
            tempSelectedAvatar = avatarId;

            // UI 업데이트
            document.querySelectorAll('[id^="avatar-"]').forEach(el => {
                const id = el.id.replace('avatar-', '');
                const isSelected = id === avatarId;

                el.style.background = isSelected ? '#007bff' : 'white';
                el.style.borderColor = isSelected ? '#007bff' : '#dee2e6';
                el.style.transform = isSelected ? 'scale(1.1)' : 'scale(1)';

                const nameElement = el.querySelector('div:last-child');
                if (nameElement) {
                    nameElement.style.color = isSelected ? 'white' : '#495057';
                    nameElement.style.fontWeight = isSelected ? 'bold' : 'normal';
                }
            });
        }

        // 별명 설정 함수
        function setUserNickname() {
            const nicknameInput = document.getElementById('nicknameInput');
            const nickname = nicknameInput.value.trim();
            const errorDiv = document.getElementById('nicknameError');
            const successDiv = document.getElementById('nicknameSuccess');
            const setBtn = document.getElementById('setNicknameBtn');
            
            // 에러/성공 메시지 초기화
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // 입력 검증
            if (!nickname) {
                showError('별명을 입력해주세요!');
                return;
            }
            
            if (nickname.length < 2) {
                showError('별명은 2글자 이상이어야 해요!');
                return;
            }
            
            if (nickname.length > 10) {
                showError('별명은 10글자 이하여야 해요!');
                return;
            }
            
            // 특수문자 검사 (한글, 영문, 숫자, 일부 특수문자만 허용)
            const allowedPattern = /^[가-힣a-zA-Z0-9_\s]+$/;
            if (!allowedPattern.test(nickname)) {
                showError('한글, 영문, 숫자, _만 사용할 수 있어요!');
                return;
            }
            
            // 별명 저장 (localStorage)
            const userSettings = {
                userName: nickname,
                setAt: Date.now()
            };
            localStorage.setItem('eduPetSettings', JSON.stringify(userSettings));

            // Firebase에 닉네임 동기화 (비동기)
            if (typeof eduPetAuth !== 'undefined' && eduPetAuth.currentUser) {
                eduPetAuth.setNickname(nickname).then(() => {
                    console.log('✅ Firebase에 닉네임 동기화 완료:', nickname);
                }).catch(err => {
                    console.warn('⚠️ Firebase 닉네임 동기화 실패 (나중에 재시도됩니다):', err);
                });
            }

            // 성공 메시지
            showSuccess(`✨ "${nickname}" 별명이 설정되었어요!`);
            
            // 환영 메시지 업데이트
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = `${nickname}님, 환영합니다!`;
            }
            
            // 버튼 변경
            setBtn.textContent = '✅ 설정 완료';
            setBtn.disabled = true;
            setBtn.classList.add('bg-green-500', 'hover:bg-green-500');
            setBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            
            // 다음 단계로 이동
            nextSlide();
            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                nicknameInput.classList.add('border-red-300');
                nicknameInput.focus();
            }
            
            function showSuccess(message) {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                nicknameInput.classList.remove('border-red-300');
                nicknameInput.classList.add('border-green-300');
            }
        }
        
        // 별명 설정 건너뛰기
        function skipNickname() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = '이제 시작해보세요!';
            }
            nextSlide();
        }

        // 엔터 키로 별명 설정
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && currentSlide === 7) {
                const nicknameInput = document.getElementById('nicknameInput');
                if (document.activeElement === nicknameInput) {
                    setUserNickname();
                }
            }
        });

        async function completeOnboarding() {
            // Validate grade selection
            if (!selectedGrade) {
                // 학년이 선택되지 않았으면 기본값 4학년 설정
                selectedGrade = 4;
                localStorage.setItem('userGrade', '4');
                console.log('⚠️ 학년 미선택 - 기본값 4학년 설정');
            }

            // Validate avatar selection
            if (!tempSelectedAvatar) {
                alert('대표 동물을 선택해주세요!');
                return;
            }

            // Get user nickname for personalized message
            let nickname = '학습자';
            try {
                const userSettings = JSON.parse(localStorage.getItem('eduPetSettings') || '{}');
                if (userSettings.userName) {
                    nickname = userSettings.userName;
                }
            } catch (error) {
                console.log('사용자 설정 로드 실패:', error);
            }

            try {
                // Update nickname and avatar in Firebase (선택적)
                if (typeof eduPetAuth !== 'undefined' && eduPetAuth.currentUser) {
                    try {
                        await eduPetAuth.setNickname(nickname);
                        console.log('✅ Firebase에 닉네임 동기화 완료');
                    } catch (nicknameError) {
                        // 이미 사용 중인 닉네임이거나 이미 설정된 경우 무시
                        console.warn('닉네임 설정 스킵:', nicknameError.message);
                    }

                    try {
                        await eduPetAuth.setAvatar(tempSelectedAvatar);
                        console.log('✅ Firebase에 아바타 동기화 완료');
                    } catch (avatarError) {
                        console.warn('아바타 설정 실패:', avatarError.message);
                    }
                } else {
                    console.log('⚠️ Firebase 오프라인 모드 - 로컬 저장소만 사용');
                }

                // Grant starter bonuses - 100원 + 프리미엄 뽑기권 (plantSystem 사용)
                // 이미 튜토리얼을 완료한 경우 보너스 지급 안 함
                const alreadyCompleted = localStorage.getItem('eduPetOnboardingCompleted') === 'true';

                if (typeof plantSystem !== 'undefined' && !alreadyCompleted) {
                    plantSystem.setMoney(100);
                    console.log('✅ 튜토리얼 완료: 100원 지급');

                    // ✅ 수정: plantSystem.grantRewards() 사용 (자동 성장 로직 포함)
                    const plantSystemUser = plantSystem.getUserData();
                    if (!plantSystemUser.rewards) {
                        plantSystemUser.rewards = {
                            growthTickets: [],
                            normalGachaTickets: 0,
                            premiumGachaTickets: 0
                        };
                    }

                    // grantRewards() 사용하여 프리미엄 뽑기권 지급
                    plantSystem.grantRewards(plantSystemUser, { premiumGacha: 1 });
                    plantSystem.saveUserData(plantSystemUser);
                    console.log('✅ 튜토리얼 완료: 프리미엄 뽑기권 1장 지급');

                    // Firebase에 보상 동기화 (선택적)
                    if (typeof plantSystemFirebase !== 'undefined') {
                        try {
                            await plantSystemFirebase.save();
                            console.log('✅ Firebase에 보상 동기화 완료');
                        } catch (syncError) {
                            console.warn('⚠️ Firebase 동기화 실패 (나중에 재시도됩니다):', syncError.message);
                        }
                    }
                } else if (alreadyCompleted) {
                    console.log('⚠️ 이미 튜토리얼 완료됨 - 보상 지급 스킵');
                } else {
                    console.error('❌ plantSystem이 로드되지 않았습니다!');
                    alert('게임 시스템 로드 중 오류가 발생했습니다. 페이지를 새로고침 해주세요.');
                    return;
                }

                // Initialize quiz progress
                const quizProgress = JSON.parse(localStorage.getItem('quizProgress') || '{}');
                if (!quizProgress.totalCorrect) quizProgress.totalCorrect = 0;
                if (!quizProgress.streakDays) quizProgress.streakDays = 0;
                localStorage.setItem('quizProgress', JSON.stringify(quizProgress));

                // Mark onboarding as completed
                localStorage.setItem('eduPetOnboardingCompleted', 'true');

                // Show completion message with delay to ensure data is saved
                setTimeout(() => {
                    alert(`🎉 ${nickname}님, EduPet Collection에 오신 것을 환영합니다!\n\n시작 보너스가 지급되었습니다:\n💰 100 코인\n🎫 프리미엄 뽑기권 1장\n\n이제 게임을 시작합니다!\n소셜 기능은 소셜 허브에서 사용하세요!`);

                    // Redirect to main page
                    window.location.href = 'index.html';
                }, 500);

            } catch (error) {
                console.error('튜토리얼 완료 중 오류 발생:', error);
                alert('튜토리얼 완료 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // Check if user has already completed onboarding
        function checkOnboarding() {
            // Allow revisiting tutorial for review purposes
            // Don't redirect if user explicitly came here
            return;
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'ArrowRight') nextSlide();
            if (e.key === 'Escape') completeOnboarding();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Firebase 모듈 로드 시도 (선택적)
            console.log('Waiting for Firebase modules to load in tutorial...');
            try {
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 100; // 5초 타임아웃
                    const interval = setInterval(() => {
                        attempts++;
                        if (typeof eduPetAuth !== 'undefined' && typeof eduPetFirebaseIntegration !== 'undefined') {
                            console.log('✅ Firebase modules loaded successfully in tutorial');
                            clearInterval(interval);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            reject(new Error('Firebase 모듈 로드 타임아웃 in tutorial'));
                        }
                    }, 50);
                });

                // Firebase 통합 기능을 초기화합니다.
                await eduPetFirebaseIntegration.initialize();
                console.log('✅ Firebase Integration is ready in tutorial.');
            } catch (error) {
                // Firebase 로드 실패 시 경고만 표시하고 계속 진행
                console.warn('⚠️ Firebase 로드 실패 (오프라인 모드로 계속 진행):', error.message);
            }

            checkOnboarding();
            updateUI();
        });
    </script>
</body>
</html>